{% extends "webapplication/kabsueats.html" %}
{% load static %}
{% load custom_filters %}

{% block search_visibility_control %}
{% with show_search=False %}{% endwith %}
{% endblock search_visibility_control %}

{% block title %}{{ establishment.name }} - KabsuEats{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/establishment_detail_phoneview.css' %}"/>
<link rel="stylesheet" href="{% static 'css/establishment_detail_desktopview.css' %}"/>

<style>
    /* ============================================================
   TIME-BASED STATUS BADGE STYLES
   ============================================================ */

/* ============================================================
   REVIEWS SECTION - NEW CARD DESIGN
   ============================================================ */
.reviews-header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 16px;
}
.review-login-prompt { margin: 0; font-size: 0.82em; color: #6b7280; }
.review-login-prompt a { color: var(--red, #B71C1C); font-weight: 600; text-decoration: none; }
.user-review-hint { margin: 0; font-size: 0.82em; color: #6b7280; }

.review-card {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 0;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.15s;
    position: relative;
}
.review-card:last-child { border-bottom: none; }
.review-card:hover { background: #fafafa; border-radius: 8px; padding-left: 8px; padding-right: 8px; margin: 0 -8px; }

.review-card--mine {
    background: #fff8f8;
    border-radius: 10px;
    padding: 14px 12px;
    border: 1.5px solid #fdd;
    margin-bottom: 8px;
}
.review-card--mine:hover { background: #fff3f3; margin: 0 0 8px; }

.review-card__avatar {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
}
.review-card__avatar img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #e5e7eb;
}
.review-card--mine .review-card__avatar img { border-color: #B71C1C; }

.review-card__body { flex: 1; min-width: 0; }

.review-card__top {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 6px;
}
.review-card__name {
    font-weight: 700;
    font-size: 0.88em;
    color: #1f2937;
}
.review-card__badge {
    background: #B71C1C;
    color: white;
    font-size: 0.68em;
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 700;
    letter-spacing: 0.3px;
}
.review-card__stars {
    display: flex;
    gap: 2px;
    align-items: center;
}
.review-card__stars i { color: #f59e0b; font-size: 0.78em; }
.review-card__stars i.empty { color: #d1d5db; }
.review-card__date {
    font-size: 0.75em;
    color: #9ca3af;
    margin-left: auto;
}
.review-card__comment {
    font-size: 0.85em;
    color: #374151;
    line-height: 1.55;
    margin: 0;
    word-break: break-word;
}

.review-card__actions {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex-shrink: 0;
    margin-left: 4px;
}
.review-action-btn {
    background: none;
    border: 1.5px solid #e5e7eb;
    border-radius: 7px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #9ca3af;
    font-size: 0.8em;
    transition: all 0.2s;
}
.review-action-btn:hover { background: #f3f4f6; color: #374151; border-color: #d1d5db; }
.review-action-btn--delete:hover { background: #fee2e2; color: #B71C1C; border-color: #fca5a5; }

.reviews-empty {
    text-align: center;
    padding: 30px 20px;
    color: #9ca3af;
}
.reviews-empty i { font-size: 2em; margin-bottom: 10px; display: block; opacity: 0.4; }
.reviews-empty p { font-size: 0.9em; margin: 0; }

.all-reviews-list-wrapper {
    max-height: 480px;
    overflow-y: auto;
    padding-right: 4px;
}
.all-reviews-list-wrapper::-webkit-scrollbar { width: 4px; }
.all-reviews-list-wrapper::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 4px; }

/* ============================================================ */

.status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 14px;
    margin: 5px 0;
}

.status-open {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
    border: 1px solid #28a745;
}

.status-closed {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
    border: 1px solid #dc3545;
}

/* Icon animations */
.status-open::before {
    content: "‚úÖ ";
}

.status-closed::before {
    content: "üîí ";
}
    .chat-popup-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 360px;
        height: 500px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.15);
        display: none;
        flex-direction: column;
        z-index: 9999;
        animation: slideUp 0.3s ease-out;
    }

    .chat-popup-container.active {
        display: flex;
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Chat Header */
    .chat-popup-header {
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: move;
    }

    .chat-popup-header img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid white;
        object-fit: cover;
    }

    .chat-popup-header-info {
        flex: 1;
    }

    .chat-popup-header-info h4 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .chat-popup-header-info p {
        margin: 2px 0 0 0;
        font-size: 0.75rem;
        opacity: 0.9;
    }

    .chat-popup-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.3rem;
        cursor: pointer;
        padding: 5px;
        line-height: 1;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .chat-popup-close:hover {
        opacity: 1;
    }

    /* ‚úÖ PINNED MESSAGES SECTION - Always at top */
    .chat-pinned-section {
        background: #f8f9fa;
        border-bottom: 1px solid #e4e6eb;
        padding: 10px 15px;
        display: none;
        flex-direction: column;
        gap: 8px;
        max-height: 150px;
        overflow-y: auto;
    }

    .chat-pinned-section.active {
        display: flex;
    }

    .chat-pinned-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }

    .chat-pinned-section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #667eea;
    }

    .chat-pinned-collapse {
        background: none;
        border: none;
        color: #667eea;
        cursor: pointer;
        font-size: 0.9rem;
        padding: 2px 5px;
    }

    .pinned-message-item {
        background: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .pinned-message-item:hover {
        background: #f0f2f5;
    }

    .pinned-message-item i {
        color: #667eea;
        font-size: 0.9rem;
    }

    .pinned-message-text {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .unpin-btn {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        padding: 4px;
        font-size: 0.9rem;
    }

    .unpin-btn:hover {
        color: #f02849;
    }

    /* ‚úÖ SEE ALL PINS LINK - Always at bottom */
    .chat-see-pins-link {
        background: #f0f2f5;
        padding: 10px 15px;
        border-top: 1px solid #e4e6eb;
        text-align: center;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
        font-weight: 600;
        color: #667eea;
        display: none;
    }

    .chat-see-pins-link.active {
        display: block;
    }

    .chat-see-pins-link:hover {
        background: #e4e6eb;
    }

    /* Messages Container */
    .chat-popup-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f5f7fa;
    }

    .chat-popup-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-popup-messages::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    /* ‚úÖ Chat Message with Three Dots Button */
    .chat-message {
        display: flex;
        margin-bottom: 12px;
        animation: messageSlide 0.25s ease-out;
        clear: both;
        width: 100%;
        position: relative;
        align-items: center;
    }

    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Customer's messages (current user) - RIGHT SIDE */
    .chat-message.sent {
        justify-content: flex-end;
    }

    /* Owner's messages (establishment) - LEFT SIDE */
    .chat-message.received {
        justify-content: flex-start;
    }

    /* Chat Bubble */
    .chat-bubble {
        max-width: 75%;
        padding: 10px 14px;
        border-radius: 18px;
        word-wrap: break-word;
        font-size: 0.9rem;
        line-height: 1.4;
        display: block;
        position: relative;
    }

    /* Customer's bubble - Purple gradient, right-aligned */
    .chat-message.sent .chat-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
        text-align: left;
    }

    /* Owner's bubble - Gray, left-aligned */
    .chat-message.received .chat-bubble {
        background: #e4e6eb;
        color: #050505;
        border-bottom-left-radius: 4px;
        text-align: left;
    }

    /* ‚úÖ Three Dots Button - NAKADIKIT TALAGA SA BUBBLE */
    .message-options-btn {
        background: rgba(0, 0, 0, 0.5);
        border: none;
        color: white;
        font-size: 14px;
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 50%;
        opacity: 0;
        transition: all 0.2s ease;
        z-index: 10;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    /* For sent messages - button sa KALIWA ng bubble */
    .chat-message.sent .message-options-btn {
        order: -1;
        margin-right: 10px;
    }

    /* For received messages - button sa KANAN ng bubble */
    .chat-message.received .message-options-btn {
        order: 1;
        margin-left: 10px;
    }

    /* Show on hover (Desktop) */
    @media (hover: hover) {
        .chat-message:hover .message-options-btn {
            opacity: 1;
        }

        .message-options-btn:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }
    }

    /* Always visible on touch devices when message is active */
    .chat-message.active .message-options-btn {
        opacity: 1;
    }

    /* Mobile: Show indicator when long-pressing */
    .chat-message.long-pressing .chat-bubble {
        transform: scale(0.98);
        opacity: 0.9;
    }

    /* ‚úÖ PINNED MESSAGE INDICATOR */
    .chat-message.pinned .chat-bubble::before {
        content: 'üìå ';
        margin-right: 4px;
    }

    /* Timestamp */
    .chat-timestamp {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 4px;
        display: block;
    }

    /* Typing Indicator */
    .chat-typing-indicator {
        display: none;
        padding: 8px 15px;
        font-size: 0.85rem;
        color: #65676b;
        font-style: italic;
    }

    .chat-typing-indicator.active {
        display: block;
    }

    .chat-typing-indicator span {
        animation: blink 1.4s infinite;
    }

    .chat-typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .chat-typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes blink {
        0%, 60%, 100% { opacity: 1; }
        30% { opacity: 0.3; }
    }

    /* Input Container */
    .chat-popup-input-container {
        padding: 12px 15px;
        background: white;
        border-top: 1px solid #e4e6eb;
        border-radius: 0 0 12px 12px;
    }

    .chat-popup-form {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .chat-popup-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #e4e6eb;
        border-radius: 20px;
        font-size: 0.9rem;
        outline: none;
        background: #f0f2f5;
        transition: background 0.2s;
    }

    .chat-popup-input:focus {
        background: white;
        border-color: #667eea;
    }

    /* Send Button */
    .chat-send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
    }

    .chat-send-btn:hover:not(:disabled) {
        transform: scale(1.1);
    }

    .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Connection Status */
    .chat-connection-status {
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .chat-connection-status::before {
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #31a24c;
    }

    .chat-connection-status.disconnected::before {
        background: #f02849;
    }

    /* Notification Badge on Message Button */
    .chat-notification-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #f02849;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
    }

    .chat-notification-badge.active {
        display: flex;
    }

    /* ========================================
       CONTEXT MENU STYLES
       ======================================== */

    .message-context-menu {
        position: fixed;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.25);
        padding: 8px 0;
        min-width: 180px;
        z-index: 10000;
        display: none;
        animation: menuSlideIn 0.15s ease-out;
    }

    .message-context-menu.active {
        display: block;
    }

    @keyframes menuSlideIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .context-menu-item {
        padding: 12px 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 0.9rem;
        color: #333;
        transition: background 0.2s;
    }

    .context-menu-item:hover {
        background: #f5f5f5;
    }

    .context-menu-item i {
        width: 18px;
        font-size: 1rem;
    }

    .context-menu-item.danger {
        color: #f02849;
    }

    .context-menu-item.danger:hover {
        background: #ffebee;
    }

    /* ========================================
       UNSEND MODAL STYLES
       ======================================== */

    .unsend-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        animation: fadeIn 0.2s ease;
    }

    .unsend-modal.active {
        display: flex;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .unsend-modal-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        animation: modalSlideUp 0.3s ease-out;
    }

    @keyframes modalSlideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .unsend-modal h3 {
        margin: 0 0 16px 0;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .unsend-option {
        padding: 16px;
        border: 2px solid #e4e6eb;
        border-radius: 12px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .unsend-option:hover {
        border-color: #667eea;
        background: #f8f9ff;
    }

    .unsend-option.selected {
        border-color: #667eea;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .unsend-option-title {
        font-weight: 600;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .unsend-option-desc {
        font-size: 0.85rem;
        color: #65676b;
    }

    .unsend-modal-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .unsend-modal-buttons button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-cancel {
        background: #e4e6eb;
        color: #333;
    }

    .btn-cancel:hover {
        background: #d0d2d7;
    }

    .btn-remove {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-remove:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-remove:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* ========================================
       MESSAGE STATES
       ======================================== */

    /* Message Deleted State */
    .chat-message.deleted .chat-bubble {
        background: #f5f5f5 !important;
        color: #999 !important;
        font-style: italic;
        opacity: 0.7;
    }

    .chat-message.deleted .chat-bubble::before {
        content: 'üö´ ';
    }

    /* ‚úÖ PINNED MESSAGES LIST MODAL */
    .pinned-messages-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 10002;
        animation: fadeIn 0.2s ease;
    }

    .pinned-messages-modal.active {
        display: flex;
    }

    .pinned-messages-modal-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        max-height: 70vh;
        overflow-y: auto;
        animation: modalSlideUp 0.3s ease-out;
    }

    .pinned-messages-modal h3 {
        margin: 0 0 16px 0;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .pinned-messages-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .pinned-messages-list .pinned-message-item {
        padding: 12px;
        border: 1px solid #e4e6eb;
    }

    .pinned-messages-empty {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .pinned-messages-empty i {
        font-size: 48px;
        opacity: 0.3;
        display: block;
        margin-bottom: 12px;
    }

    /* ========================================
       MOBILE RESPONSIVE
       ======================================== */

    @media (max-width: 768px) {
        .chat-popup-container {
            width: calc(100% - 40px);
            height: calc(100vh - 100px);
            max-height: 600px;
        }

        .message-options-btn {
            width: 36px;
            height: 36px;
            font-size: 16px;
            /* ‚úÖ Make button easier to tap on mobile */
            opacity: 0.7;
        }

        .chat-message.sent .message-options-btn {
            margin-right: 12px;
        }

        .chat-message.received .message-options-btn {
            margin-left: 12px;
        }

        /* ‚úÖ Ensure menu items are tappable */
        .context-menu-item {
            padding: 16px 20px;
            font-size: 1rem;
        }

        .unsend-option {
            padding: 18px;
        }
    }

    /* ‚úÖ QUANTITY WARNING MESSAGE STYLES */
    .quantity-warning {
        display: none;
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        font-weight: 500;
        animation: fadeIn 0.3s ease;
    }

    .quantity-warning.show {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

{# Override notification to appear top-center #}
<style>
    /* ‚îÄ‚îÄ Center-top toast notification ‚îÄ‚îÄ */
    .custom-cart-notification {
        position: fixed !important;
        top: 20px !important;
        left: 50% !important;
        right: auto !important;
        transform: translateX(-50%) !important;
        min-width: 320px !important;
        max-width: 480px !important;
        width: auto !important;
        border-radius: 14px !important;
        padding: 14px 20px !important;
        background: #fff !important;
        box-shadow: 0 6px 28px rgba(0,0,0,0.16) !important;
        border-left: none !important;
        border-top: 4px solid #28a745 !important;
        z-index: 99999 !important;
        animation: toastDropIn 0.3s cubic-bezier(0.34,1.56,0.64,1) !important;
    }
    .custom-cart-notification.notification-error { border-top-color: #dc3545 !important; }
    .custom-cart-notification.notification-warning { border-top-color: #ffc107 !important; }
    .custom-cart-notification.notification-info { border-top-color: #0d6efd !important; }

    @keyframes toastDropIn {
        from { opacity: 0; transform: translateX(-50%) translateY(-20px) scale(0.95); }
        to   { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
    }

    /* ‚îÄ‚îÄ Cart badge pulse animation ‚îÄ‚îÄ */
    #cart-count-badge.badge-pulse {
        animation: cartPulse 0.5s ease-in-out;
    }
    @keyframes cartPulse {
        0%,100% { transform: scale(1); }
        50% { transform: scale(1.25); background: #8b0000; }
    }
</style>
{% endblock %}

{% block extra_nav_buttons %}
{% if user.is_authenticated %}
<a onclick="toggleChatPopup(); return false;" href="#" class="nib nav-message-btn" style="position: relative; cursor: pointer;">
    <i class="fas fa-comments"></i>
    <span>Message</span>
    <span class="chat-notification-badge" id="chatNotificationBadge" style="position:absolute;top:-7px;right:-9px;background:#B71C1C;color:#fff;border-radius:50%;min-width:18px;height:18px;font-size:10px;font-weight:700;display:none;align-items:center;justify-content:center;padding:0 3px;border:2px solid #fff;line-height:1;"></span>
</a>
{# Hidden span ‚Äî JS uses this to get initial cart count and inject into base template's cart badge #}
<span id="cart-count-init" data-count="{{ cart_count|default:0 }}" style="display:none;"></span>
{% endif %}
{% endblock extra_nav_buttons %}

{% block content %}
<div id="food-details-page">

    {# MESSAGES - NEW DESIGN #}
    {% if messages %}
    <div class="messages-container" id="messagesContainer">
        {% for message in messages %}
        <div class="message-alert {{ message.tags|default:'info' }}">
            <span class="message-icon">
                {% if 'success' in message.tags %}
                    <i class="fas fa-check-circle"></i>
                {% elif 'error' in message.tags %}
                    <i class="fas fa-exclamation-circle"></i>
                {% elif 'warning' in message.tags %}
                    <i class="fas fa-exclamation-triangle"></i>
                {% else %}
                    <i class="fas fa-info-circle"></i>
                {% endif %}
            </span>
            <span class="message-text">{{ message }}</span>
            <button class="message-close" onclick="dismissMessage(this)" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# HERO HEADER #}
    <header class="establishment-hero"
            style="background-image: url('{% if establishment.image %}{{ establishment.image.url }}{% else %}{% static 'images/default-bg.jpg' %}{% endif %}');">
        <div class="hero-overlay">
            <div class="hero-content">
                <h1>{{ establishment.name }}</h1>
                <div class="average-rating-display" id="averageRatingDisplay">
                    <span class="rating-number">{{ establishment.average_rating|floatformat:1|default:"0.0" }}</span>
                    <div class="star-rating-main">
                        {% for i in "12345" %}
                        {% if forloop.counter <= establishment.average_rating|default:0 %}
                        <i class="fas fa-star filled"></i>
                        {% else %}
                        <i class="far fa-star"></i>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <span class="review-count-text">({{ establishment.review_count|default:0 }} Reviews)</span>
                </div>
            </div>
        </div>
    </header>

    <div class="details-container">

        {# TOP THREE COLUMN LAYOUT #}
        <div class="top-info-grid">
            {# COLUMN 1: Location & Contact #}
            <section class="section-card contact-location">
                <h2>Location & Contact</h2>
                <div class="contact-grid">

                    <div class="contact-info-card">
                        <div class="contact-icon-wrap contact-icon--address">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="contact-info-body">
                            <span class="contact-label">Address</span>
                            <span class="contact-value">{{ establishment.address|default:"Not Available" }}</span>
                        </div>
                    </div>

                    <div class="contact-info-card">
                        <div class="contact-icon-wrap contact-icon--category">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="contact-info-body">
                            <span class="contact-label">Categories</span>
                            <span class="contact-value">
                                {% with cats=establishment.categories.all %}
                                {% if cats %}
                                    {% for cat in cats %}{{ cat.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                {% elif establishment.other_category %}
                                    {{ establishment.other_category }}
                                {% else %}
                                    N/A
                                {% endif %}
                                {% endwith %}
                            </span>
                        </div>
                    </div>

                    <div class="contact-info-card">
                        <div class="contact-icon-wrap contact-icon--hours">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="contact-info-body">
                            <span class="contact-label">Hours</span>
                            <div class="hours-row">
                                <span class="hours-text">
                                    {% if establishment.opening_time and establishment.closing_time %}
                                        {{ establishment.opening_time|time:"g:i A" }} ‚Äì {{ establishment.closing_time|time:"g:i A" }}
                                    {% else %}
                                        Hours not set
                                    {% endif %}
                                </span>
                                <span class="status-badge-small status-{{ establishment.calculated_status|lower }}"
                                      id="detailStatusBadge"
                                      data-opening-time="{{ establishment.opening_time|time:'H:i' }}"
                                      data-closing-time="{{ establishment.closing_time|time:'H:i' }}">
                                    {% if establishment.calculated_status == 'Open' %}
                                        <i class="fas fa-circle status-dot"></i> Open Now
                                    {% else %}
                                        <i class="fas fa-circle status-dot"></i> Closed
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="contact-info-card">
                        <div class="contact-icon-wrap contact-icon--payment">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="contact-info-body">
                            <span class="contact-label">Payment</span>
                            <span class="contact-value">
                                {% if establishment.payment_methods %}{{ establishment.payment_methods }}{% else %}N/A{% endif %}
                            </span>
                        </div>
                    </div>

                </div>
            </section>

            {# COLUMN 2: Amenities & Features #}
            <section class="section-card amenities-section">
                <h2>Amenities & Features</h2>
                <ul class="amenities-list">
                    {% for amenity in establishment.amenities.all %}
                    <li><i class="fas fa-check-circle"></i> {{ amenity.name }}</li>
                    {% empty %}
                    <li>No amenities listed.</li>
                    {% endfor %}
                </ul>
            </section>

            {# COLUMN 3: Customer Reviews #}
            <section class="section-card reviews-section">
                <h2>Customer Reviews</h2>

                <div class="reviews-header-bar">
                    <div class="review-filters">
                        <select class="review-filter-dropdown" id="reviewFilterDropdown">
                            <option value="all">All Reviews</option>
                            <option value="good">Good (4-5 ‚≠ê)</option>
                            <option value="bad">Bad (1-3 ‚≠ê)</option>
                        </select>
                    </div>

                    {% if user.is_authenticated %}
                    {% if not user_review %}
                    <button class="btn-review" id="addReviewBtn" onclick="openReviewModal()"><i class="fas fa-pen"></i> Write a Review</button>
                    {% else %}
                    <p class="user-review-hint" id="userReviewHint">‚úèÔ∏è Click the pencil icon to edit your review.</p>
                    {% endif %}
                    {% else %}
                    <p class="review-login-prompt">
                        <a href="{% url 'user_login_register' %}"><i class="fas fa-sign-in-alt"></i> Log in to review</a>
                    </p>
                    {% endif %}
                </div>

                <div class="all-reviews-list-wrapper">
                    <div class="all-reviews-list" id="allReviewsList">

                        {# User's own review rendered first #}
                        {% if user_review %}
                        {% with review=user_review %}
                        <div class="review-card review-card--mine" data-review-id="{{ review.id }}"
                             data-is-user-review="true" data-rating="{{ review.rating }}">
                            <div class="review-card__avatar">
                                <img src="{% if review.user.profile.profile_image %}{{ review.user.profile.profile_image.url }}{% else %}{% static 'images/placeholder_profile.png' %}{% endif %}"
                                     alt="{{ review.user.username }}">
                            </div>
                            <div class="review-card__body">
                                <div class="review-card__top">
                                    <span class="review-card__name">{{ review.user.username }}</span>
                                    <span class="review-card__badge">You</span>
                                    <div class="review-card__stars">
                                        {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                        <i class="fas fa-star"></i>
                                        {% else %}
                                        <i class="far fa-star empty"></i>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    <span class="review-card__date">{{ review.created_at|date:"M d, Y" }}</span>
                                </div>
                                <p class="review-card__comment">{{ review.comment|default:'' }}</p>
                            </div>
                            <div class="review-card__actions">
                                <button class="review-action-btn edit-review"
                                        data-review-id="{{ review.id }}"
                                        data-rating="{{ review.rating }}"
                                        data-comment="{{ review.comment|default:''|escapejs }}"
                                        title="Edit">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button class="review-action-btn review-action-btn--delete delete-review"
                                        data-review-id="{{ review.id }}"
                                        title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        {% endwith %}
                        {% endif %}

                        {# Other reviews #}
                        {% for review in reviews %}
                        <div class="review-card" data-review-id="{{ review.id }}" data-rating="{{ review.rating }}">
                            <div class="review-card__avatar">
                                <img src="{% if review.user.profile.profile_image %}{{ review.user.profile.profile_image.url }}{% else %}{% static 'images/placeholder_profile.png' %}{% endif %}"
                                     alt="{{ review.user.username }}">
                            </div>
                            <div class="review-card__body">
                                <div class="review-card__top">
                                    <span class="review-card__name">{{ review.user.username }}</span>
                                    <div class="review-card__stars">
                                        {% for i in "12345" %}
                                        {% if forloop.counter <= review.rating %}
                                        <i class="fas fa-star"></i>
                                        {% else %}
                                        <i class="far fa-star empty"></i>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    <span class="review-card__date">{{ review.created_at|date:"M d, Y" }}</span>
                                </div>
                                <p class="review-card__comment">{{ review.comment|default:'' }}</p>
                            </div>
                        </div>
                        {% empty %}
                        {% if not user_review %}
                        <div class="reviews-empty" id="noReviewsMessage">
                            <i class="fas fa-comment-slash"></i>
                            <p>Be the first to leave a review!</p>
                        </div>
                        {% endif %}
                        {% endfor %}
                        <p class="text-muted hidden-message" id="noFilteredReviews" style="display:none;">No reviews found for this filter.</p>
                    </div>
                </div>
            </section>
        </div>

        {# FULL WIDTH MENU SECTION #}
        <div class="quantity-control">
            <section class="section-card" id="menu-section">

                {# Menu Title ‚Äî centered #}
                <h2 class="menu-title-centered"><i class="fas fa-utensils menu-title-icon"></i> Menu</h2>

                {# Controls row: [Price pills] [Search bar] #}
                <div class="menu-controls">
                    <div class="filter-pill-group">
                        <button class="filter-pill" id="filterPriceAsc" onclick="setPriceFilter('lowest', this)">
                            <i class="fas fa-sort-amount-up-alt"></i> Price ‚Üë
                        </button>
                        <button class="filter-pill" id="filterPriceDesc" onclick="setPriceFilter('highest', this)">
                            <i class="fas fa-sort-amount-down"></i> Price ‚Üì
                        </button>
                    </div>

                    <div class="menu-search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="menuSearchInput" placeholder="Search menu items..."
                               oninput="filterMenuItems()">
                    </div>

                    {# Hidden selects kept for JS compatibility #}
                    <select id="priceFilter" onchange="filterMenuItems()" style="display:none;">
                        <option value="default">Sort by Price</option>
                        <option value="highest">Highest to Lowest</option>
                        <option value="lowest">Lowest to Highest</option>
                    </select>
                    <select id="stockFilter" onchange="filterMenuItems()" style="display:none;">
                        <option value="all">Stock Status</option>
                        <option value="available">Available</option>
                        <option value="outofstock">Out of Stock</option>
                    </select>
                </div>

                <div class="menu-list-wrapper">
                    <div class="menu-list" id="menuList">
    {% for item in menu_items %}
    <div class="menu-item"
         data-price="{{ item.price|floatformat:2 }}"
         data-is-top-seller="{% if item.is_top_seller %}true{% else %}false{% endif %}"
         data-item-id="{{ item.id }}"
         data-item-name="{{ item.name }}"
         data-item-description="{{ item.description|default:'No description provided.'|escapejs }}"
         data-item-image-url="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/menu_default.png' %}{% endif %}"
         data-item-quantity="{{ item.quantity|default:0 }}"
         onclick="openItemDetailModal(this)">

        <!-- Image Container with Badges -->
        <div class="menu-item-image-wrapper">
            <img src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/menu_default.png' %}{% endif %}"
                 alt="{{ item.name }}" class="menu-item-image">

            <!-- Top Left: Best Seller Badge -->
            {% if item.is_top_seller %}
            <span class="badge-top-seller">
                <i class="fas fa-medal"></i> Best Seller
            </span>
            {% endif %}

            <!-- Top Right: Stock Badge -->
            {% if item.quantity > 0 %}
            <span class="badge-stock available">
                <i class="fas fa-check-circle"></i> Available: {{ item.quantity }}
            </span>
            {% else %}
            <span class="badge-stock out-of-stock">
                <i class="fas fa-times-circle"></i> Out of Stock
            </span>
            {% endif %}
        </div>

        <!-- Menu Info Section -->
        <div class="menu-info">
            <div class="menu-header-info">
                <h3 class="menu-name">{{ item.name }}</h3>
            </div>

            <p class="menu-description">
                {% if item.description %}
                {{ item.description }}
                {% else %}
                No description provided.
                {% endif %}
                <p class="menu-price">‚Ç±{{ item.price|floatformat:2 }}</p>
            </p>

            <!-- Action Buttons -->
            <div class="item-actions">
                {% if user.is_authenticated %}
                {% if item.quantity > 0 %}
                <div class="item-action-buttons">
                    <button class="btn-add-to-cart quick-add-btn"
                            data-item-id="{{ item.id }}"
                            data-item-name="{{ item.name }}"
                            data-item-price="{{ item.price|floatformat:2 }}"
                            onclick="handleQuickAddToCart(this, event)">
                        <i class="fas fa-cart-plus"></i> Add to Cart
                    </button>
                    <button class="btn-buy-now quick-buy-btn"
                            onclick="openItemDetailModal(this.closest('.menu-item'))">
                        <i class="fas fa-money-bill"></i> Buy Now
                    </button>
                </div>
                {% else %}
                <button class="btn-add-to-cart disabled" disabled>
                    <i class="fas fa-times-circle"></i> Out of Stock
                </button>
                {% endif %}
                {% else %}
                <a href="{% url 'user_login_register' %}" class="btn-add-to-cart login-prompt-btn">
                    <i class="fas fa-sign-in-alt"></i> Log in to Order
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <p class="text-muted">No menu items available yet.</p>
    {% endfor %}
    <p id="noMenuItemsFound" class="hidden-message">No menu items found.</p>
</div>
                </div>
            </section>
        </div>
    </div>

    {# DELETE REVIEW FORM #}
    <form id="delete-review-form" method="post" style="display:none;">{% csrf_token %}</form>

    {# REVIEW MODAL #}
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeReviewModal()">&times;</span>
            <h2 id="modalTitle">Write a Review</h2>
            <form id="reviewForm" method="post" action="">
                {% csrf_token %}
                <div class="form-group text-center">
                    <label>Your Rating:</label>
                    <div class="modal-stars-container" id="modalStars">
                        {% for i in "12345" %}
                        <i class="far fa-star" data-rating="{{ forloop.counter }}"></i>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="rating" id="ratingInput" value="0">
                </div>
                <div class="form-group">
                    <label for="comment">Comment:</label>
                    <textarea name="comment" id="comment" rows="4" required></textarea>
                </div>
                <button type="submit" class="btn-submit-review">Submit Review</button>
            </form>
        </div>
    </div>

    {# ITEM DETAIL MODAL #}
    <div id="itemDetailModal" class="modal">
        <div class="modal-content item-detail-modal-content">
            <span class="close-btn" onclick="closeItemDetailModal()">&times;</span>
            <h2 id="itemDetailModalTitle" class="item-name-header">Menu Item Name</h2>
            <div class="item-details-body">
                <img id="modalItemImage" src="" alt="Menu Item Image" class="modal-item-image">
                <p id="modalItemDescription" class="modal-item-description"></p>

                {% if user.is_authenticated %}
                <p id="modalItemPrice" class="modal-item-price">‚Ç± 0.00</p>
                <p id="modalItemStock" class="modal-item-stock"></p>

                <div class="quantity-control">
                    <label for="itemQuantity">Quantity:</label>
                    <div class="quantity-input-group">
                        <button type="button" class="btn-quantity-minus" onclick="updateModalQuantity(-1)">-</button>
                        <input type="number" id="itemQuantity" value="1" min="1" readonly>
                        <button type="button" class="btn-quantity-plus" onclick="updateModalQuantity(1)">+</button>
                    </div>
                    </div>
                    <!-- ‚úÖ QUANTITY WARNING MESSAGE -->
                    <div id="quantityWarning" class="quantity-warning">
                        Maximum quantity reached
                    </div>
                </div>

                <div class="modal-actions">
                    <button id="modalAddToCartBtn" class="btn-add-to-cart-modal" onclick="handleModalAddToCart(this)"
                            data-action="add">
                        <i class="fas fa-cart-plus"></i> Add to Cart
                    </button>
                    <!-- ‚úÖ FIXED BUY NOW BUTTON - REDIRECTS TO PAYMONGO -->
                    <button id="modalBuyNowBtn" class="btn-buy-now-modal" onclick="handleModalBuyNow(this)">
                        <i class="fas fa-bolt"></i> Buy Now
                    </button>
                </div>
                {% else %}
                <p class="text-muted text-center">Log in or Sign Up to order.</p>
                <div class="modal-actions">
                    <a href="{% url 'user_login_register' %}" class="btn-add-to-cart-modal btn-full-width">
                        <i class="fas fa-sign-in-alt"></i> Log In / Sign Up
                    </a>
                </div>
                {% endif %}
            </div>
            <!-- ‚úÖ HIDDEN FIELDS FOR VALIDATION -->
            <input type="hidden" id="modalItemId" value="">
            <input type="hidden" id="modalMaxQuantity" value="0">
        </div>
    </div>

    {% if user.is_authenticated %}
    <button onclick="toggleChatPopup()" class="floating-chat-button" id="floatingChatButton">
        <i class="fas fa-comments"></i>
        <span class="chat-notification-badge" id="floatingChatBadge">1</span>
    </button>
    {% endif %}

    {% if user.is_authenticated %}
    <div class="chat-popup-container" id="chatPopupContainer">
        <div class="chat-popup-header" id="chatPopupHeader">
            <img src="{% if establishment.image %}{{ establishment.image.url }}{% else %}{% static 'images/default_profile.png' %}{% endif %}"
                 alt="{{ establishment.name }}">
            <div class="chat-popup-header-info">
                <h4>{{ establishment.name }}</h4>
                <p class="chat-connection-status" id="chatConnectionStatus">Connecting...</p>
            </div>
            <button class="chat-popup-close" onclick="closeChatPopup()">&times;</button>
        </div>

        <!-- ‚úÖ PINNED MESSAGES SECTION - Top of chat -->
        <div class="chat-pinned-section" id="chatPinnedSection">
            <div class="chat-pinned-section-header">
                <span class="chat-pinned-section-title">üìå Pinned Messages</span>
                <button class="chat-pinned-collapse" onclick="togglePinnedSection()">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
            <div id="pinnedMessagesList">
                <!-- Pinned messages will appear here -->
            </div>
        </div>

        <div class="chat-popup-messages" id="chatPopupMessages">
            <!-- Messages will be loaded dynamically via JavaScript -->
        </div>

        <div class="chat-typing-indicator" id="chatTypingIndicator">
            {{ establishment.name }} is typing<span>.</span><span>.</span><span>.</span>
        </div>

        <!-- ‚úÖ SEE ALL PINS LINK - Bottom above input -->
        <div class="chat-see-pins-link" id="chatSeePinsLink" onclick="openPinnedMessagesModal()">
            <i class="fas fa-thumbtack"></i> See All Pins
        </div>

        <div class="chat-popup-input-container">
            <form class="chat-popup-form" id="chatPopupForm">
                <input type="text"
                       class="chat-popup-input"
                       id="chatPopupInput"
                       placeholder="Aa"
                       autocomplete="off">
                <button type="submit" class="chat-send-btn" id="chatSendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="message-context-menu" id="messageContextMenu">
        <div class="context-menu-item" onclick="pinMessage()">
            <i class="fas fa-thumbtack"></i>
            <span id="pinMenuText">Pin</span>
        </div>
        <div class="context-menu-item danger" onclick="openUnsendModal()">
            <i class="fas fa-undo"></i>
            <span>Unsend</span>
        </div>
    </div>

    <!-- Unsend Modal -->
    <div class="unsend-modal" id="unsendModal">
        <div class="unsend-modal-content">
            <h3>Who do you want to unsend this message for?</h3>

            <div class="unsend-option selected" data-type="everyone" onclick="selectUnsendOption('everyone')">
                <div class="unsend-option-title">
                    <i class="fas fa-users"></i>
                    Unsend for everyone
                </div>
                <div class="unsend-option-desc">
                    This message will be unsent for everyone in the chat. Others may have already seen or forwarded it.
                </div>
            </div>

            <div class="unsend-option" data-type="you" onclick="selectUnsendOption('you')">
                <div class="unsend-option-title">
                    <i class="fas fa-user"></i>
                    Unsend for you
                </div>
                <div class="unsend-option-desc">
                    This will remove the message from your devices. Other chat members will still be able to see it.
                </div>
            </div>

            <div class="unsend-modal-buttons">
                <button class="btn-cancel" onclick="closeUnsendModal()">Cancel</button>
                <button class="btn-remove" onclick="confirmUnsend()">Remove</button>
            </div>
        </div>
    </div>

    <!-- ‚úÖ PINNED MESSAGES LIST MODAL -->
    <div class="pinned-messages-modal" id="pinnedMessagesModal">
        <div class="pinned-messages-modal-content">
            <h3><i class="fas fa-thumbtack"></i> Pinned Messages</h3>
            <div class="pinned-messages-list" id="pinnedMessagesListModal">
                <!-- Pinned messages will appear here -->
            </div>
            <div class="pinned-messages-empty" id="pinnedMessagesEmpty" style="display: none;">
                <i class="fas fa-inbox"></i>
                <p>No pinned messages</p>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn-cancel" onclick="closePinnedMessagesModal()">Close</button>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    const UPDATE_PROFILE_URL = "{% url 'update_profile' %}";
    const ADD_TO_CART_URL = "{% url 'add_to_cart' %}";
    const VIEW_CART_URL = "{% url 'view_cart' %}";
    const CLEAR_CART_URL = "{% url 'clear_cart' %}";
    const IS_USER_AUTHENTICATED = "{% if user.is_authenticated %}true{% else %}false{% endif %}" === 'true';
    const LOGIN_REGISTER_URL = "{% url 'user_login_register' %}";
    const ESTABLISHMENT_ID = {{ establishment.id|default:'null' }};
    const BASE_URL_ROOT = "{% url 'food_establishment_details' establishment.id %}";
    const SUBMIT_REVIEW_URL = "{% url 'submit_review' establishment.id %}";
    const CUSTOMER_ID = {{ request.user.id|default:'null' }};
</script>
<script src="{% static 'js/establishment_details.js' %}"></script>
<script src="{% static 'js/status_updater.js' %}"></script>

<script>
    let chatSocket = null;
    let chatPopupOpen = false;
    let chatMessagesCache = [];
    let contextMenuMessageId = null;
    let selectedUnsendType = 'everyone';
    let pinnedMessages = new Set();

    // Long press detection variables
    let longPressTimer = null;
    let longPressTriggered = false;
    const LONG_PRESS_DURATION = 500;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function toggleChatPopup() {
        const chatPopup = document.getElementById('chatPopupContainer');
        chatPopupOpen = !chatPopupOpen;

        if (chatPopupOpen) {
            chatPopup.classList.add('active');
            initializeChatWebSocket();
            loadChatMessages();
            clearChatNotificationBadge();
        } else {
            chatPopup.classList.remove('active');
        }
    }

    function closeChatPopup() {
        chatPopupOpen = false;
        const chatPopup = document.getElementById('chatPopupContainer');
        chatPopup.classList.remove('active');
    }

    function loadChatMessages() {
        const messagesContainer = document.getElementById('chatPopupMessages');
        if (!messagesContainer) return;

        chatMessagesCache = [];
        messagesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Loading messages...</div>';

        fetch(`/chat/messages/${CUSTOMER_ID}/${ESTABLISHMENT_ID}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.messages) {
                messagesContainer.innerHTML = '';
                chatMessagesCache = [];

                data.messages.forEach((msg) => {
                    const msgData = {
                        type: 'chat_message',
                        sender_id: msg.sender_id,
                        message: msg.content,
                        timestamp: msg.timestamp,
                        message_id: msg.id
                    };
                    chatMessagesCache.push(msgData);
                    addMessageToChatPopup(msgData, false);
                });

                scrollChatToBottom();
                updatePinnedSection();
            } else {
                messagesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No messages yet. Say hi! üëã</div>';
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading chat messages:', error);
            messagesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #f00;">Failed to load messages</div>';
        });
    }

    function initializeChatWebSocket() {
        if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            return;
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${CUSTOMER_ID}/${ESTABLISHMENT_ID}/`;

        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function(e) {
            console.log('‚úÖ Chat WebSocket connected');
            updateConnectionStatus('online');
        };

        chatSocket.onclose = function(e) {
            console.log('‚ùå Chat WebSocket disconnected');
            updateConnectionStatus('disconnected');
        };

        chatSocket.onerror = function(e) {
            console.error('‚ö†Ô∏è WebSocket error:', e);
            updateConnectionStatus('error');
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if (data.type === 'connection_established') {
                console.log('‚úÖ Connection confirmed');
            }
            else if (data.type === 'chat_message') {
                if (parseInt(data.sender_id) === parseInt(CUSTOMER_ID)) {
                    return;
                }
                addMessageToChatPopup(data, true);
                if (!chatPopupOpen) {
                    showChatNotificationBadge();
                }
            }
            else if (data.type === 'typing_indicator') {
                if (parseInt(data.sender_id) !== parseInt(CUSTOMER_ID)) {
                    showTypingIndicator(data.is_typing);
                }
            }
            else if (data.type === 'message_unsent') {
                handleMessageUnsent(data);
            }
        };
    }

    function updateConnectionStatus(status) {
        const statusElement = document.getElementById('chatConnectionStatus');
        if (!statusElement) return;

        if (status === 'online') {
            statusElement.textContent = 'Active now';
            statusElement.classList.remove('disconnected');
        } else if (status === 'disconnected') {
            statusElement.textContent = 'Offline';
            statusElement.classList.add('disconnected');
        } else if (status === 'error') {
            statusElement.textContent = 'Connection Error';
            statusElement.classList.add('disconnected');
        }
    }

    function addMessageToChatPopup(data, addToCache = true) {
        const messagesContainer = document.getElementById('chatPopupMessages');
        if (!messagesContainer) return;

        if (addToCache) {
            chatMessagesCache.push(data);
        }

        const messageDiv = document.createElement('div');
        const senderId = parseInt(data.sender_id);
        const customerId = parseInt(CUSTOMER_ID);
        const isMyMessage = senderId === customerId;

        messageDiv.className = `chat-message ${isMyMessage ? 'sent' : 'received'}`;
        messageDiv.dataset.messageId = data.message_id;

        // Check if message is pinned
        if (pinnedMessages.has(data.message_id)) {
            messageDiv.classList.add('pinned');
        }

        const optionsButton = isMyMessage ? `
            <button class="message-options-btn" onclick="showContextMenu(event, ${data.message_id})">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        ` : '';

        messageDiv.innerHTML = `
            ${optionsButton}
            <div class="chat-bubble">
                <div>${escapeHtml(data.message)}</div>
                <span class="chat-timestamp">${data.timestamp}</span>
            </div>
        `;

        if (isMyMessage) {
            attachLongPressHandlers(messageDiv, data.message_id);
        }

        messagesContainer.appendChild(messageDiv);
        scrollChatToBottom();
    }

    // ==========================================
    // ‚úÖ LONG PRESS DETECTION (MOBILE)
    // ==========================================

    function attachLongPressHandlers(messageElement, messageId) {
        // Touch events
        messageElement.addEventListener('touchstart', function(e) {
            longPressTriggered = false;
            messageElement.classList.add('long-pressing');

            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                messageElement.classList.remove('long-pressing');

                const touch = e.touches[0];
                showContextMenuAtPosition(touch.clientX, touch.clientY, messageId);

                e.preventDefault();
            }, LONG_PRESS_DURATION);
        }, { passive: false });

        messageElement.addEventListener('touchend', function(e) {
            clearTimeout(longPressTimer);
            messageElement.classList.remove('long-pressing');

            if (longPressTriggered) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        messageElement.addEventListener('touchmove', function(e) {
            clearTimeout(longPressTimer);
            messageElement.classList.remove('long-pressing');
        });

        // Mouse events (for desktop)
        messageElement.addEventListener('mousedown', function(e) {
            if (e.button !== 0) return;

            longPressTriggered = false;

            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                showContextMenuAtPosition(e.clientX, e.clientY, messageId);
            }, LONG_PRESS_DURATION);
        });

        messageElement.addEventListener('mouseup', function(e) {
            clearTimeout(longPressTimer);
        });

        messageElement.addEventListener('mouseleave', function(e) {
            clearTimeout(longPressTimer);
        });
    }

    // ==========================================
    // ‚úÖ CONTEXT MENU (DESKTOP & MOBILE)
    // ==========================================

    function showContextMenu(event, messageId) {
        event.preventDefault();
        event.stopPropagation();

        const rect = event.target.closest('button').getBoundingClientRect();
        showContextMenuAtPosition(rect.left, rect.bottom + 5, messageId);
    }

    function showContextMenuAtPosition(x, y, messageId) {
        const contextMenu = document.getElementById('messageContextMenu');
        contextMenuMessageId = messageId;

        // Update pin/unpin text
        const isPinned = pinnedMessages.has(messageId);
        document.getElementById('pinMenuText').textContent = isPinned ? 'Unpin' : 'Pin';

        // Position the menu
        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';

        // Adjust if menu goes off-screen
        setTimeout(() => {
            const menuRect = contextMenu.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (menuRect.right > windowWidth) {
                contextMenu.style.left = (x - menuRect.width) + 'px';
            }

            if (menuRect.bottom > windowHeight) {
                contextMenu.style.top = (y - menuRect.height - 10) + 'px';
            }
        }, 10);

        contextMenu.classList.add('active');

        setTimeout(() => {
            document.addEventListener('click', hideContextMenu);
            document.addEventListener('touchstart', hideContextMenu);
        }, 100);
    }

    function hideContextMenu() {
        const contextMenu = document.getElementById('messageContextMenu');
        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideContextMenu);
        document.removeEventListener('touchstart', hideContextMenu);
    }

    function scrollChatToBottom() {
        const messagesContainer = document.getElementById('chatPopupMessages');
        if (messagesContainer) {
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showTypingIndicator(isTyping) {
        const typingIndicator = document.getElementById('chatTypingIndicator');
        if (typingIndicator) {
            if (isTyping) {
                typingIndicator.classList.add('active');
                scrollChatToBottom();
            } else {
                typingIndicator.classList.remove('active');
            }
        }
    }

    function showChatNotificationBadge() {
        const headerBadge = document.getElementById('chatNotificationBadge');
        const floatingBadge = document.getElementById('floatingChatBadge');

        if (headerBadge) {
            headerBadge.classList.add('active');
        }
        if (floatingBadge) {
            floatingBadge.classList.add('active');
        }
    }

    function clearChatNotificationBadge() {
        const headerBadge = document.getElementById('chatNotificationBadge');
        const floatingBadge = document.getElementById('floatingChatBadge');

        if (headerBadge) {
            headerBadge.classList.remove('active');
        }
        if (floatingBadge) {
            floatingBadge.classList.remove('active');
        }
    }

    // ==========================================
    // ‚úÖ PIN FUNCTIONALITY (PERSISTENT)
    // ==========================================

    function loadPinnedMessages() {
        const stored = localStorage.getItem(`pinned_${CUSTOMER_ID}_${ESTABLISHMENT_ID}`);
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                pinnedMessages = new Set(parsed);
            } catch (e) {
                pinnedMessages = new Set();
            }
        }
    }

    function savePinnedMessages() {
        const arr = Array.from(pinnedMessages);
        localStorage.setItem(`pinned_${CUSTOMER_ID}_${ESTABLISHMENT_ID}`, JSON.stringify(arr));
    }

    function pinMessage() {
        hideContextMenu();

        if (!contextMenuMessageId) return;

        const messageEl = document.querySelector(`.chat-message[data-message-id="${contextMenuMessageId}"]`);
        if (!messageEl) return;

        const isPinned = pinnedMessages.has(contextMenuMessageId);

        if (isPinned) {
            // Unpin
            pinnedMessages.delete(contextMenuMessageId);
            messageEl.classList.remove('pinned');
        } else {
            // Pin
            pinnedMessages.add(contextMenuMessageId);
            messageEl.classList.add('pinned');
        }

        savePinnedMessages();
        updatePinnedSection();
    }

    function updatePinnedSection() {
        const pinnedSection = document.getElementById('chatPinnedSection');
        const pinnedList = document.getElementById('pinnedMessagesList');
        const seePinsLink = document.getElementById('chatSeePinsLink');

        if (pinnedMessages.size === 0) {
            pinnedSection.classList.remove('active');
            seePinsLink.classList.remove('active');
            return;
        }

        pinnedSection.classList.add('active');
        seePinsLink.classList.add('active');

        // Show max 3 pinned messages in section
        pinnedList.innerHTML = '';
        const pinnedArray = Array.from(pinnedMessages).slice(-3);

        pinnedArray.forEach(msgId => {
            const msg = chatMessagesCache.find(m => m.message_id === msgId);
            if (msg) {
                const item = document.createElement('div');
                item.className = 'pinned-message-item';
                item.innerHTML = `
                    <i class="fas fa-thumbtack"></i>
                    <span class="pinned-message-text">${escapeHtml(msg.message)}</span>
                    <button class="unpin-btn" onclick="unpinMessage(${msgId}, event)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                pinnedList.appendChild(item);
            }
        });
    }

    function unpinMessage(messageId, event) {
        if (event) {
            event.stopPropagation();
        }

        pinnedMessages.delete(messageId);
        savePinnedMessages();

        const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
        if (messageEl) {
            messageEl.classList.remove('pinned');
        }

        updatePinnedSection();
    }

    function togglePinnedSection() {
        const section = document.getElementById('chatPinnedSection');
        section.classList.toggle('active');
    }

    // ==========================================
    // ‚úÖ PINNED MESSAGES MODAL
    // ==========================================

    function openPinnedMessagesModal() {
        const modal = document.getElementById('pinnedMessagesModal');
        const modalList = document.getElementById('pinnedMessagesListModal');
        const emptyState = document.getElementById('pinnedMessagesEmpty');

        if (pinnedMessages.size === 0) {
            modalList.innerHTML = '';
            emptyState.style.display = 'block';
        } else {
            emptyState.style.display = 'none';
            modalList.innerHTML = '';

            Array.from(pinnedMessages).forEach(msgId => {
                const msg = chatMessagesCache.find(m => m.message_id === msgId);
                if (msg) {
                    const item = document.createElement('div');
                    item.className = 'pinned-message-item';
                    item.innerHTML = `
                        <i class="fas fa-thumbtack"></i>
                        <span class="pinned-message-text">${escapeHtml(msg.message)}</span>
                        <button class="unpin-btn" onclick="unpinMessage(${msgId}, event)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    modalList.appendChild(item);
                }
            });
        }

        modal.classList.add('active');
    }

    function closePinnedMessagesModal() {
        const modal = document.getElementById('pinnedMessagesModal');
        modal.classList.remove('active');
    }

    // ==========================================
    // ‚úÖ UNSEND FUNCTIONALITY (PERSISTENT)
    // ==========================================

    function openUnsendModal() {
        hideContextMenu();
        const modal = document.getElementById('unsendModal');
        modal.classList.add('active');
        selectedUnsendType = 'everyone';
    }

    function closeUnsendModal() {
        const modal = document.getElementById('unsendModal');
        modal.classList.remove('active');
        contextMenuMessageId = null;
    }

    function selectUnsendOption(type) {
        selectedUnsendType = type;

        document.querySelectorAll('.unsend-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`.unsend-option[data-type="${type}"]`).classList.add('selected');
    }

    function confirmUnsend() {
        if (!contextMenuMessageId || !chatSocket) {
            console.error('Cannot unsend: missing message ID or socket');
            return;
        }

        const removeBtn = document.querySelector('.btn-remove');
        removeBtn.disabled = true;
        removeBtn.textContent = 'Removing...';

        chatSocket.send(JSON.stringify({
            'type': 'unsend_message',
            'message_id': contextMenuMessageId,
            'unsend_type': selectedUnsendType,
            'sender_id': CUSTOMER_ID
        }));

        setTimeout(() => {
            closeUnsendModal();
            removeBtn.disabled = false;
            removeBtn.textContent = 'Remove';
        }, 500);
    }

    function handleMessageUnsent(data) {
        const messageId = data.message_id;
        const unsendType = data.unsend_type;
        const unsent_by = parseInt(data.unsent_by);
        const currentUserId = parseInt(CUSTOMER_ID);

        const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);

        if (!messageEl) {
            console.warn('Message element not found:', messageId);
            return;
        }

        if (unsendType === 'everyone') {
            const bubble = messageEl.querySelector('.chat-bubble');
            messageEl.classList.add('deleted');

            const optionsBtn = messageEl.querySelector('.message-options-btn');
            if (optionsBtn) {
                optionsBtn.remove();
            }

            bubble.innerHTML = `
                <div>Message was unsent</div>
                <span class="chat-timestamp">${new Date().toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}</span>
            `;

            chatMessagesCache = chatMessagesCache.filter(msg => msg.message_id !== messageId);
        }
        else if (unsendType === 'you' && unsent_by === currentUserId) {
            messageEl.remove();
            chatMessagesCache = chatMessagesCache.filter(msg => msg.message_id !== messageId);
        }

        // Remove from pinned if it was pinned
        if (pinnedMessages.has(messageId)) {
            pinnedMessages.delete(messageId);
            savePinnedMessages();
            updatePinnedSection();
        }
    }

    // Chat Form Submit
    document.addEventListener('DOMContentLoaded', function() {
        loadPinnedMessages();

        const chatForm = document.getElementById('chatPopupForm');
        const chatInput = document.getElementById('chatPopupInput');
        const sendButton = document.getElementById('chatSendBtn');
        let typingTimeout;

        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const message = chatInput.value.trim();
                if (!message || !chatSocket) {
                    return;
                }

                sendButton.disabled = true;
                chatInput.disabled = true;

                const now = new Date();
                const timestamp = now.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });

                const tempMessageId = 'temp_' + Date.now();

                chatSocket.send(JSON.stringify({
                    'type': 'chat_message',
                    'message': message,
                    'sender_id': CUSTOMER_ID
                }));

                const messageData = {
                    type: 'chat_message',
                    sender_id: CUSTOMER_ID,
                    message: message,
                    timestamp: timestamp,
                    message_id: tempMessageId
                };
                addMessageToChatPopup(messageData, true);

                chatInput.value = '';
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
            });

            chatInput.addEventListener('input', function() {
                if (!chatSocket) return;

                chatSocket.send(JSON.stringify({
                    'type': 'typing',
                    'sender_id': CUSTOMER_ID,
                    'is_typing': true
                }));

                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    chatSocket.send(JSON.stringify({
                        'type': 'typing',
                        'sender_id': CUSTOMER_ID,
                        'is_typing': false
                    }));
                }, 1000);
            });
        }

        // Close context menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.message-context-menu') &&
                !e.target.closest('.message-options-btn') &&
                !e.target.closest('.chat-message')) {
                hideContextMenu();
            }
        });

        // Close modals on outside click
        document.getElementById('pinnedMessagesModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePinnedMessagesModal();
            }
        });

        document.getElementById('unsendModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUnsendModal();
            }
        });
    });

    // Auto-initialize WebSocket
    if (IS_USER_AUTHENTICATED && CUSTOMER_ID && ESTABLISHMENT_ID) {
        setTimeout(() => {
            initializeChatWebSocket();
        }, 2000);
    }

    // Expose functions globally
    window.toggleChatPopup = toggleChatPopup;
    window.closeChatPopup = closeChatPopup;
    window.showContextMenu = showContextMenu;
    window.selectUnsendOption = selectUnsendOption;
    window.openUnsendModal = openUnsendModal;
    window.closeUnsendModal = closeUnsendModal;
    window.confirmUnsend = confirmUnsend;
    window.pinMessage = pinMessage;
    window.unpinMessage = unpinMessage;
    window.togglePinnedSection = togglePinnedSection;
    window.openPinnedMessagesModal = openPinnedMessagesModal;
    window.closePinnedMessagesModal = closePinnedMessagesModal;
</script>

<script>
// =============================================
// REVIEW MODAL - Open / Close / Star Rating / AJAX Submit (Realtime)
// =============================================
(function() {
    let currentEditReviewId = null;

    // ---- CSRF helper ----
    function getCSRFToken() {
        const cookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
        return cookie ? decodeURIComponent(cookie.trim().split('=')[1]) : '';
    }

    // ---- Star visual sync ----
    function syncStarVisuals(rating) {
        document.querySelectorAll('#modalStars i').forEach(function(star, idx) {
            if (idx < rating) {
                star.classList.remove('far');
                star.classList.add('fas', 'filled');
            } else {
                star.classList.remove('fas', 'filled');
                star.classList.add('far');
            }
        });
    }

    // ---- Build star HTML for a given rating ----
    function buildStarsHTML(rating) {
        let html = '<div class="review-card__stars">';
        for (let i = 1; i <= 5; i++) {
            html += (i <= rating)
                ? '<i class="fas fa-star"></i>'
                : '<i class="far fa-star empty"></i>';
        }
        html += '</div>';
        return html;
    }

    // ---- Format today's date as "Mon DD, YYYY" ----
    function formatToday() {
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const now = new Date();
        return months[now.getMonth()] + ' ' + String(now.getDate()).padStart(2,'0') + ', ' + now.getFullYear();
    }

    // ---- Open modal ----
    window.openReviewModal = function(reviewId, existingRating, existingComment) {
        const modal        = document.getElementById('reviewModal');
        const modalTitle   = document.getElementById('modalTitle');
        const ratingInput  = document.getElementById('ratingInput');
        const commentField = document.getElementById('comment');
        const submitBtn    = document.querySelector('#reviewForm .btn-submit-review');

        if (reviewId) {
            currentEditReviewId = reviewId;
            modalTitle.textContent  = 'Edit Your Review';
            ratingInput.value       = existingRating || 0;
            commentField.value      = existingComment || '';
            submitBtn.textContent   = 'Save Changes';
        } else {
            currentEditReviewId     = null;
            modalTitle.textContent  = 'Write a Review';
            ratingInput.value       = 0;
            commentField.value      = '';
            submitBtn.textContent   = 'Submit Review';
        }

        syncStarVisuals(parseInt(ratingInput.value));
        modal.style.display = 'block';
    };

    // ---- Close modal ----
    window.closeReviewModal = function() {
        document.getElementById('reviewModal').style.display = 'none';
        currentEditReviewId = null;
    };

    // ---- Close on backdrop click ----
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('reviewModal');
        if (modal && e.target === modal) closeReviewModal();
    });

    // ---- Insert a NEW review card at the TOP of the list (realtime) ----
    function insertNewReviewCard(rating, comment, profilePicUrl, username) {
        const list = document.getElementById('allReviewsList');

        // Hide "Be the first to leave a review!" if visible
        const noMsg = document.getElementById('noReviewsMessage');
        if (noMsg) noMsg.style.display = 'none';

        const starsHtml = buildStarsHTML(rating);

        // Build card using new review-card structure
        const card = document.createElement('div');
        card.className = 'review-card review-card--mine';
        card.setAttribute('data-is-user-review', 'true');
        card.setAttribute('data-rating', rating);

        card.innerHTML =
            '<div class="review-card__avatar">' +
                '<img src="' + profilePicUrl + '" alt="' + username + '">' +
            '</div>' +
            '<div class="review-card__body">' +
                '<div class="review-card__top">' +
                    '<span class="review-card__name">' + username + '</span>' +
                    '<span class="review-card__badge">You</span>' +
                    starsHtml +
                    '<span class="review-card__date">' + formatToday() + '</span>' +
                '</div>' +
                '<p class="review-card__comment">' + comment.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p>' +
            '</div>' +
            '<div class="review-card__actions">' +
                '<button class="review-action-btn edit-review" data-review-id="" data-rating="' + rating + '" data-comment="' + comment.replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '" title="Edit"><i class="fas fa-pen"></i></button>' +
                '<button class="review-action-btn review-action-btn--delete delete-review" data-review-id="" title="Delete"><i class="fas fa-trash-alt"></i></button>' +
            '</div>';

        list.insertBefore(card, list.firstChild);
        return card;
    }

    // ---- Update an EXISTING user review card in place (realtime) ----
    function updateExistingReviewCard(reviewId, rating, comment) {
        const card = document.querySelector('.review-card[data-review-id="' + reviewId + '"]');
        if (!card) return;

        card.setAttribute('data-rating', rating);

        // Update stars
        const starsContainer = card.querySelector('.review-card__stars');
        if (starsContainer) starsContainer.outerHTML = buildStarsHTML(rating);

        // Update comment
        const commentEl = card.querySelector('.review-card__comment');
        if (commentEl) commentEl.textContent = comment;

        // Update edit button data attributes
        const editBtn = card.querySelector('.edit-review');
        if (editBtn) {
            editBtn.setAttribute('data-rating', rating);
            editBtn.setAttribute('data-comment', comment);
        }
    }

    // ---- DOMContentLoaded: wire up stars + form ----
    document.addEventListener('DOMContentLoaded', function() {
        const starsContainer = document.getElementById('modalStars');
        if (!starsContainer) return;

        const stars       = starsContainer.querySelectorAll('i');
        const ratingInput = document.getElementById('ratingInput');

        // Star click & hover
        stars.forEach(function(star) {
            star.addEventListener('click', function() {
                ratingInput.value = this.getAttribute('data-rating');
                syncStarVisuals(parseInt(ratingInput.value));
            });
            star.addEventListener('mouseenter', function() {
                syncStarVisuals(parseInt(this.getAttribute('data-rating')));
            });
        });
        starsContainer.addEventListener('mouseleave', function() {
            syncStarVisuals(parseInt(ratingInput.value));
        });

        // ---- AJAX form submit ----
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', function(e) {
                e.preventDefault(); // PREVENT normal page reload

                const rating  = parseInt(ratingInput.value);
                const comment = document.getElementById('comment').value.trim();
                const submitBtn = reviewForm.querySelector('.btn-submit-review');

                if (rating === 0) {
                    alert('Please select a star rating before submitting.');
                    return;
                }

                // Disable button to prevent double-submit
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                // Determine URL: edit or create
                let url;
                if (currentEditReviewId) {
                    url = BASE_URL_ROOT + 'edit_review/' + currentEditReviewId + '/';
                } else {
                    url = SUBMIT_REVIEW_URL;
                }

                // Build form data
                const formData = new FormData();
                formData.append('rating', rating);
                formData.append('comment', comment);
                formData.append('csrfmiddlewaretoken', getCSRFToken());

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData,
                    credentials: 'same-origin'
                })
                .then(function(response) {
                    return response.json().catch(function() {
                        // Fallback: not JSON (redirect/HTML)
                        return { success: response.ok || response.redirected, _nonJson: true };
                    });
                })
                .then(function(data) {
                    if (!data.success) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = currentEditReviewId ? 'Save Changes' : 'Submit Review';
                        alert(data.error || 'Something went wrong. Please try again.');
                        return;
                    }

                    // --- SUCCESS: update DOM realtime ---

                    if (currentEditReviewId) {
                        // EDIT: update existing card in place
                        updateExistingReviewCard(currentEditReviewId, rating, comment);
                    } else {
                        // NEW: insert card at top
                        const newReviewId = data.review_id || null;

                        // Get current user's profile picture URL
                        // We embed it server-side so it's always correct
                        let profilePicUrl = '{% if request.user.profile.profile_image %}{{ request.user.profile.profile_image.url }}{% else %}{% static "images/placeholder_profile.png" %}{% endif %}';
                        const existingUserCard = document.querySelector('.review-card.review-card--mine .review-card__avatar img');
                        if (existingUserCard) profilePicUrl = existingUserCard.getAttribute('src');

                        // Get username from the page (from the existing user card or a known element)
                        let username = '{{ request.user.username|escapejs }}';

                        const card = insertNewReviewCard(rating, comment, profilePicUrl, username);

                        // Patch in the review ID if we got one
                        if (newReviewId) {
                            card.setAttribute('data-review-id', newReviewId);
                            card.querySelector('.edit-review').setAttribute('data-review-id', newReviewId);
                            card.querySelector('.delete-review').setAttribute('data-review-id', newReviewId);
                        }

                        // Hide the "Write a Review" button (user now has a review)
                        const addBtn = document.getElementById('addReviewBtn');
                        if (addBtn) addBtn.style.display = 'none';

                        // Show the "your review is highlighted" hint
                        // (create it dynamically if not present)
                        let hint = document.getElementById('userReviewHint');
                        if (!hint) {
                            hint = document.createElement('p');
                            hint.id = 'userReviewHint';
                            hint.className = 'text-muted';
                            hint.style.margin = '0';
                            hint.style.fontSize = '0.82em';
                            hint.textContent = 'Your review is highlighted below. Click the pencil icon to edit it.';
                            // Insert where the button was
                            const btnParent = addBtn ? addBtn.parentNode : null;
                            if (btnParent) btnParent.appendChild(hint);
                        }
                        hint.style.display = 'block';
                    }

                    // Close modal
                    closeReviewModal();
                })
                .catch(function(err) {
                    console.error('Review submit error:', err);
                    submitBtn.disabled = false;
                    submitBtn.textContent = currentEditReviewId ? 'Save Changes' : 'Submit Review';
                    alert('Something went wrong. Please try again.');
                });
            });
        }

        // ---- Edit review button (delegated) ----
        document.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-review');
            if (editBtn) {
                openReviewModal(
                    editBtn.getAttribute('data-review-id'),
                    parseInt(editBtn.getAttribute('data-rating')) || 0,
                    editBtn.getAttribute('data-comment') || ''
                );
            }
        });

        // ---- Delete review button (delegated) ----
        document.addEventListener('click', function(e) {
            const deleteBtn = e.target.closest('.delete-review');
            if (deleteBtn) {
                const reviewId = deleteBtn.getAttribute('data-review-id');
                if (!reviewId) return;
                if (!confirm('Are you sure you want to delete your review?')) return;

                fetch(BASE_URL_ROOT + 'delete_review/' + reviewId + '/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                .then(function(response) {
                    return response.json().catch(function() {
                        return { success: response.ok || response.redirected };
                    });
                })
                .then(function(data) {
                    if (!data.success) return;
                    // Remove the card from DOM realtime
                    const card = document.querySelector('.review-card[data-review-id="' + reviewId + '"]');
                    if (card) card.remove();

                    // Show "Write a Review" button again
                    const addBtn = document.getElementById('addReviewBtn');
                    if (addBtn) addBtn.style.display = 'inline-flex';

                    // Hide hint
                    const hint = document.getElementById('userReviewHint');
                    if (hint) hint.style.display = 'none';

                    // If no reviews left, show "Be the first..." message
                    const remaining = document.querySelectorAll(".review-card");
                    if (remaining.length === 0) {
                        let noMsg = document.getElementById('noReviewsMessage');
                        if (!noMsg) {
                            noMsg = document.createElement('p');
                            noMsg.id = 'noReviewsMessage';
                            noMsg.className = 'text-muted';
                            noMsg.textContent = 'Be the first to leave a review!';
                            document.getElementById('allReviewsList').appendChild(noMsg);
                        }
                        noMsg.style.display = 'block';
                    }
                })
                .catch(function(err) {
                    console.error('Delete review error:', err);
                    alert('Something went wrong. Please try again.');
                });
            }
        });
    });
})();
</script>

<script>
// Review Filter Dropdown Functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterDropdown = document.getElementById('reviewFilterDropdown');

    if (filterDropdown) {
        filterDropdown.addEventListener('change', function() {
            const filterValue = this.value;
            const allReviews = document.querySelectorAll(".review-card");
            const noFilteredMsg = document.getElementById('noFilteredReviews');
            let visibleCount = 0;

            allReviews.forEach(review => {
                const rating = parseInt(review.dataset.rating || 0);
                let shouldShow = false;

                switch(filterValue) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'good':
                        shouldShow = rating >= 4 && rating <= 5;
                        break;
                    case 'bad':
                        shouldShow = rating >= 1 && rating <= 3;
                        break;
                }

                if (shouldShow) {
                    review.style.display = 'flex';
                    visibleCount++;
                } else {
                    review.style.display = 'none';
                }
            });

            // Show/hide "no reviews" message
            if (noFilteredMsg) {
                if (visibleCount === 0) {
                    noFilteredMsg.style.display = 'block';
                } else {
                    noFilteredMsg.style.display = 'none';
                }
            }
        });
    }
});
</script>

<script>
// =============================================
// MENU FILTERS ‚Äî search, price sort, stock status, best sellers
// =============================================
(function() {
    let bestSellerActive = false;

    // ---- Main filter/sort runner ‚Äî called by every control ----
    window.filterMenuItems = function() {
        const searchVal  = document.getElementById('menuSearchInput').value.trim().toLowerCase();
        const priceVal   = document.getElementById('priceFilter').value;
        const stockVal   = document.getElementById('stockFilter').value;

        const menuList   = document.getElementById('menuList');
        const items      = Array.from(menuList.querySelectorAll('.menu-item'));
        const noMsg      = document.getElementById('noMenuItemsFound');

        // ---- 1. FILTER: hide items that don't match ----
        let visibleItems = [];

        items.forEach(function(item) {
            const name        = (item.getAttribute('data-item-name') || '').toLowerCase();
            const description = (item.getAttribute('data-item-description') || '').toLowerCase();
            const quantity    = parseInt(item.getAttribute('data-item-quantity') || 0);
            const isTopSeller = item.getAttribute('data-is-top-seller') === 'true';

            let show = true;

            // Search: match name OR description
            if (searchVal && !name.includes(searchVal) && !description.includes(searchVal)) {
                show = false;
            }

            // Stock filter
            if (show && stockVal === 'available' && quantity <= 0)   show = false;
            if (show && stockVal === 'outofstock' && quantity > 0)   show = false;

            // Best seller toggle
            if (show && bestSellerActive && !isTopSeller)            show = false;

            item.style.display = show ? '' : 'none';
            if (show) visibleItems.push(item);
        });

        // ---- 2. SORT: reorder visible items inside the grid ----
        if (priceVal === 'highest' || priceVal === 'lowest') {
            visibleItems.sort(function(a, b) {
                const priceA = parseFloat(a.getAttribute('data-price') || 0);
                const priceB = parseFloat(b.getAttribute('data-price') || 0);
                return (priceVal === 'highest') ? (priceB - priceA) : (priceA - priceB);
            });
        }

        // Re-append in sorted order (hidden items stay where they are, won't show)
        visibleItems.forEach(function(item) {
            menuList.appendChild(item);
        });

        // ---- 3. Show/hide "no items found" message ----
        noMsg.style.display = (visibleItems.length === 0) ? 'block' : 'none';
    };

    // ---- Best Seller toggle button ----
    window.toggleBestSellerFilter = function() {
        const btn = document.getElementById('bestSellerFilter');
        bestSellerActive = !bestSellerActive;
        btn.classList.toggle('active', bestSellerActive);
        btn.setAttribute('aria-pressed', bestSellerActive ? 'true' : 'false');
        filterMenuItems(); // re-run combined filter
    };
})();
</script>

<script>
// =============================================
// PILL FILTER HELPERS ‚Äî stock & price pills
// =============================================
window.setStockFilter = function(val, btn) {
    document.getElementById('stockFilter').value = val;
    // deactivate all stock pills
    ['filterAll','filterAvailable','filterOutOfStock'].forEach(function(id) {
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
    });
    if (btn) btn.classList.add('active');
    filterMenuItems();
};

window.setPriceFilter = function(val, btn) {
    const priceEl = document.getElementById('priceFilter');
    // toggle: clicking same button resets to default
    if (priceEl.value === val) {
        priceEl.value = 'default';
        if (btn) btn.classList.remove('active');
    } else {
        priceEl.value = val;
        // deactivate other price pills
        ['filterPriceAsc','filterPriceDesc'].forEach(function(id) {
            const el = document.getElementById(id);
            if (el) el.classList.remove('active');
        });
        if (btn) btn.classList.add('active');
    }
    filterMenuItems();
};
</script>

<script>
// ‚îÄ‚îÄ Cart badge ‚Äî use base template's existing cart badge ‚îÄ‚îÄ
(function() {
    // Find the base template's cart badge (id set by base template)
    function getCartBadge() {
        return document.getElementById('cart-count-badge');
    }

    function initCartBadge() {
        // Get initial count from the hidden init span
        const initEl = document.getElementById('cart-count-init');
        if (!initEl) return;
        const count = parseInt(initEl.dataset.count) || 0;
        const badge = getCartBadge();
        if (!badge) return;
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'flex';
        }
    }

    // Override updateCartBadge to update base template's badge
    window.updateCartBadge = function(count) {
        const badge = getCartBadge();
        if (badge) {
            badge.textContent = count;
            if (count > 0) {
                badge.style.display = 'flex';
                badge.classList.add('badge-pulse');
                setTimeout(() => badge.classList.remove('badge-pulse'), 500);
            } else {
                badge.style.display = 'none';
            }
        }
    };

    document.addEventListener('DOMContentLoaded', initCartBadge);
})();
</script>

{% endblock %}