{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Register (3/3): Account - KabsuEats</title>
    <link rel="stylesheet" href="{% static 'css/business_owner_registration.css' %}">
    <style>
        /* ===== FLOATING OTP MODAL ===== */
        .otp-backdrop {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.55); z-index: 9000;
            align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .otp-backdrop.show { display: flex; animation: bIn .2s ease; }
        @keyframes bIn { from{opacity:0} to{opacity:1} }

        .otp-card {
            background: #fff; border-radius: 18px; padding: 36px 30px 28px;
            max-width: 430px; width: 92%;
            box-shadow: 0 24px 64px rgba(0,0,0,.22);
            position: relative;
            animation: cIn .28s cubic-bezier(.34,1.56,.64,1);
        }
        @keyframes cIn {
            from { opacity:0; transform:scale(.88) translateY(18px); }
            to   { opacity:1; transform:scale(1)   translateY(0); }
        }

        .otp-close {
            position:absolute; top:14px; right:16px;
            background:none; border:none; cursor:pointer;
            color:#bbb; font-size:22px; line-height:1;
            padding:4px 8px; border-radius:6px;
            transition:color .15s,background .15s;
        }
        .otp-close:hover { color:#333; background:#f0f0f0; }

        .otp-card h3 { margin:0 0 5px; font-size:21px; color:#1a1a1a; }
        .otp-sub { font-size:13.5px; color:#666; margin:0 0 20px; line-height:1.5; }
        .otp-sub strong { color:#1a1a1a; word-break:break-all; }

        /* 6 digit boxes */
        .digits { display:flex; gap:9px; justify-content:center; margin-bottom:20px; }
        .digit {
            width:50px; height:58px; border:2px solid #ddd; border-radius:10px;
            font-size:26px; font-weight:700; text-align:center; outline:none;
            color:#1a1a1a; transition:border-color .15s,box-shadow .15s;
            background:#fff;
        }
        .digit:focus { border-color:#e59b20; box-shadow:0 0 0 3px rgba(229,155,32,.18); }
        .digit.filled { border-color:#e59b20; background:#fffbf2; }
        .digit.err { border-color:#e74c3c; background:#fff5f5; animation:shake .38s ease; }
        @keyframes shake {
            0%,100%{transform:translateX(0)}
            20%,60%{transform:translateX(-5px)}
            40%,80%{transform:translateX(5px)}
        }

        /* Verify button */
        .verify-btn {
            width:100%; padding:14px;
            background:linear-gradient(135deg,#e59b20,#c8860f);
            color:#fff; border:none; border-radius:10px;
            font-size:16px; font-weight:700; cursor:pointer;
            transition:opacity .2s,transform .1s;
        }
        .verify-btn:hover:not(:disabled) { opacity:.9; transform:translateY(-1px); }
        .verify-btn:disabled { background:#ccc; cursor:not-allowed; transform:none; }

        .btn-spin {
            display:inline-block; width:15px; height:15px;
            border:2px solid rgba(255,255,255,.4); border-top-color:#fff;
            border-radius:50%; animation:spin .7s linear infinite;
            vertical-align:middle; margin-right:7px;
        }
        @keyframes spin { to{transform:rotate(360deg)} }

        /* Footer row */
        .otp-foot {
            display:flex; align-items:center; justify-content:space-between;
            margin-top:12px; flex-wrap:wrap; gap:6px;
        }
        .timer-txt { font-size:13px; color:#666; }
        .timer-txt .t { font-weight:700; color:#e59b20; }
        .timer-txt.exp .t { color:#e74c3c; }
        .resend-btn {
            background:none; border:none; color:#e59b20;
            font-size:13px; font-weight:600; cursor:pointer;
            padding:0; text-decoration:underline; display:none;
        }
        .resend-btn.show { display:inline; }
        .resend-btn:disabled { color:#bbb; cursor:not-allowed; }

        .otp-msg { margin-top:10px; font-size:13px; min-height:16px; text-align:center; font-weight:500; }
        .otp-msg.ok  { color:#27ae60; }
        .otp-msg.err { color:#e74c3c; }

        /* Send button inline error */
        #send-err {
            display:none; color:#c0392b; font-size:13px; font-weight:600;
            margin-top:10px; padding:9px 14px;
            background:#fff5f5; border:1px solid #f5c6c6; border-radius:8px;
            text-align:center;
        }

        /* Success overlay */
        .success-ov {
            display:none; position:fixed; inset:0;
            background:rgba(0,0,0,.6); z-index:9999;
            align-items:center; justify-content:center;
        }
        .success-ov.show { display:flex; }
        .scard {
            background:#fff; border-radius:20px; padding:44px 32px;
            text-align:center; max-width:340px; width:90%;
            box-shadow:0 16px 48px rgba(0,0,0,.22);
            animation:cIn .3s cubic-bezier(.34,1.56,.64,1);
        }
        .sicon {
            width:68px; height:68px;
            background:linear-gradient(135deg,#27ae60,#1e8449);
            border-radius:50%; display:flex;
            align-items:center; justify-content:center; margin:0 auto 18px;
        }
        .sicon svg { width:34px; height:34px; color:#fff; }
        .scard h3 { margin:0 0 8px; font-size:21px; color:#1a1a1a; }
        .scard p  { color:#666; font-size:14px; margin:0 0 18px; line-height:1.5; }
        .prog-bar { height:5px; background:#eee; border-radius:3px; overflow:hidden; }
        .prog-fill {
            height:100%; background:linear-gradient(90deg,#27ae60,#2ecc71);
            border-radius:3px; transition:width .05s linear;
        }
    </style>
</head>
<body>
<div class="registration-container">
    <div class="registration-header">
        <h1>Business Registration</h1>
        <div class="progress-bar">
            <div class="progress-step active">1</div>
            <div class="progress-step active">2</div>
            <div class="progress-step active">3</div>
        </div>
    </div>

    <div class="registration-content">
        <h2>Step 3: Create Your Account</h2>
        <p>Set up your login credentials. Your password must be at least 8 characters long. An OTP will be sent to your email for verification.</p>

        <form id="creds-form" onsubmit="return false;">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="email">Gmail Address</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group password-field">
                    <label for="password">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" name="password" required minlength="8">
                        <button type="button" class="toggle-password" data-target="password">
                            <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                            </svg>
                            <svg class="eye-slash-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                <line x1="1" y1="1" x2="23" y2="23"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="form-group password-field">
                    <label for="retype-password">Retype Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="retype-password" name="retype_password" required minlength="8">
                        <button type="button" class="toggle-password" data-target="retype-password">
                            <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                            </svg>
                            <svg class="eye-slash-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                <line x1="1" y1="1" x2="23" y2="23"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <div id="send-err"></div>

        <div class="navigation-buttons">
            <button id="back-btn" class="btn-secondary">Back: Details</button>
            <button id="send-btn" class="btn-primary" disabled>Send OTP to register establishment</button>
        </div>
        <p class="login-link">Already have an account? <a href="{% url 'owner_login' %}">Login here</a>.</p>
    </div>
</div>

<!-- ===== FLOATING OTP MODAL ===== -->
<div id="otp-backdrop" class="otp-backdrop">
    <div class="otp-card">
        <button class="otp-close" id="otp-close">&#x2715;</button>
        <h3>Verify Your Email</h3>
        <p class="otp-sub">A 6-digit code was sent to <strong id="otp-email-lbl"></strong>.<br>Check your inbox and spam folder.</p>

        <div class="digits">
            <input class="digit" type="text" maxlength="1" inputmode="numeric" autocomplete="one-time-code" data-i="0">
            <input class="digit" type="text" maxlength="1" inputmode="numeric" data-i="1">
            <input class="digit" type="text" maxlength="1" inputmode="numeric" data-i="2">
            <input class="digit" type="text" maxlength="1" inputmode="numeric" data-i="3">
            <input class="digit" type="text" maxlength="1" inputmode="numeric" data-i="4">
            <input class="digit" type="text" maxlength="1" inputmode="numeric" data-i="5">
        </div>

        <button id="verify-btn" class="verify-btn" disabled>Verify &amp; Register</button>

        <div class="otp-foot">
            <div id="timer-wrap" class="timer-txt">Expires in: <span class="t" id="timer">10:00</span></div>
            <button id="resend-btn" class="resend-btn">Resend OTP</button>
        </div>
        <p id="otp-msg" class="otp-msg"></p>
    </div>
</div>

<!-- ===== SUCCESS OVERLAY ===== -->
<div id="success-ov" class="success-ov">
    <div class="scard">
        <div class="sicon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
        </div>
        <h3>Registration Successful!</h3>
        <p>Your establishment has been created.<br>Taking you to your dashboard…</p>
        <div class="prog-bar"><div id="prog" class="prog-fill" style="width:0%"></div></div>
    </div>
</div>

<script src="{% static 'js/business_owner_registration.js' %}"></script>
<script>
/* ===== PASSWORD TOGGLE ===== */
document.querySelectorAll('.toggle-password').forEach(btn => {
    btn.addEventListener('click', function() {
        const inp = document.getElementById(this.dataset.target);
        const eye = this.querySelector('.eye-icon');
        const eyeX= this.querySelector('.eye-slash-icon');
        if (inp.type === 'password') {
            inp.type='text'; eye.style.display='none'; eyeX.style.display='block';
        } else {
            inp.type='password'; eye.style.display='block'; eyeX.style.display='none';
        }
    });
});

/* ===== FORM VALIDATION — enable Send OTP only when all fields valid ===== */
const eEmail = document.getElementById('email');
const ePass  = document.getElementById('password');
const eRe    = document.getElementById('retype-password');
const sendBtn= document.getElementById('send-btn');

function checkForm() {
    sendBtn.disabled = !(
        /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(eEmail.value.trim()) &&
        ePass.value.length >= 8 &&
        ePass.value === eRe.value
    );
}
[eEmail, ePass, eRe].forEach(el => el.addEventListener('input', checkForm));

/* ===== HELPERS ===== */
function csrf() { return document.querySelector('[name=csrfmiddlewaretoken]').value; }
function otpMsg(txt, cls='') {
    const el = document.getElementById('otp-msg');
    el.textContent = txt; el.className = 'otp-msg ' + cls;
}
function sendErr(txt) {
    const el = document.getElementById('send-err');
    el.textContent = txt; el.style.display = txt ? 'block' : 'none';
}

/* ===== COUNTDOWN ===== */
let secsLeft=600, tmr=null;
function startCountdown() {
    secsLeft=600; clearInterval(tmr);
    const tEl=document.getElementById('timer');
    const tWr=document.getElementById('timer-wrap');
    const rBtn=document.getElementById('resend-btn');
    tWr.classList.remove('exp');
    rBtn.classList.remove('show'); rBtn.disabled=false;

    function tick() {
        const m=String(Math.floor(secsLeft/60)).padStart(2,'0');
        const s=String(secsLeft%60).padStart(2,'0');
        tEl.textContent=`${m}:${s}`;
        tEl.style.color = secsLeft<=60 ? '#e74c3c':'#e59b20';
        if (secsLeft<=0) {
            clearInterval(tmr); tEl.textContent='00:00'; tWr.classList.add('exp');
            rBtn.classList.add('show');
            document.getElementById('verify-btn').disabled=true;
            otpMsg('OTP expired. Please request a new one.','err');
        }
        secsLeft--;
    }
    tick(); tmr=setInterval(tick,1000);
}

/* ===== 6 DIGIT INPUTS ===== */
const digits = Array.from(document.querySelectorAll('.digit'));
digits.forEach((inp,i) => {
    inp.addEventListener('input', function() {
        this.value=this.value.replace(/\D/g,'').slice(-1);
        this.classList.toggle('filled',!!this.value);
        this.classList.remove('err');
        if (this.value && i<5) digits[i+1].focus();
        checkVerify();
    });
    inp.addEventListener('keydown', function(e) {
        if (e.key==='Backspace' && !this.value && i>0) {
            digits[i-1].focus(); digits[i-1].value='';
            digits[i-1].classList.remove('filled','err');
            checkVerify();
        }
    });
    inp.addEventListener('paste', function(e) {
        e.preventDefault();
        const s=(e.clipboardData||window.clipboardData).getData('text').replace(/\D/g,'').slice(0,6);
        s.split('').forEach((ch,j)=>{
            if(digits[j]){ digits[j].value=ch; digits[j].classList.add('filled'); }
        });
        const nx=digits[Math.min(s.length,5)];
        if(nx) nx.focus();
        checkVerify();
    });
});
function otpVal() { return digits.map(d=>d.value).join(''); }
function checkVerify() {
    document.getElementById('verify-btn').disabled = otpVal().length!==6 || secsLeft<=0;
}
function clearDigits() {
    digits.forEach(d=>{ d.value=''; d.classList.remove('filled','err'); });
    checkVerify();
}
function shakeDigits() {
    digits.forEach(d=>{ d.classList.add('err'); d.value=''; d.classList.remove('filled'); });
    digits[0].focus(); checkVerify();
}

/* ===== OPEN / CLOSE MODAL ===== */
function openModal(email) {
    document.getElementById('otp-email-lbl').textContent=email;
    document.getElementById('otp-backdrop').classList.add('show');
    otpMsg('',''); clearDigits();
    document.getElementById('verify-btn').disabled=true;
    document.getElementById('resend-btn').classList.remove('show');
    setTimeout(()=>digits[0].focus(), 80);
}
function closeModal() {
    document.getElementById('otp-backdrop').classList.remove('show');
    clearInterval(tmr);
}
document.getElementById('otp-close').addEventListener('click', closeModal);
document.getElementById('otp-backdrop').addEventListener('click', e=>{
    if(e.target.id==='otp-backdrop') closeModal();
});
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

/* ===== SEND OTP ===== */
async function doSend() {
    const email=eEmail.value.trim();
    sendErr('');
    sendBtn.disabled=true;
    sendBtn.innerHTML='<span class="btn-spin"></span>Sending…';

    try {
        const resp=await fetch('/api/send-otp/',{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrf()},
            body:JSON.stringify({email})
        });
        const data=await resp.json();

        if(resp.ok && data.success) {
            openModal(email);
            startCountdown();
            otpMsg('✅ OTP sent! Check your inbox.','ok');
            sendBtn.textContent='Resend OTP via email';
            sendBtn.disabled=false;
        } else {
            // Real error from backend — show it, do NOT open modal
            sendErr('⚠️ ' + (data.error || 'Failed to send OTP. Please try again.'));
            sendBtn.textContent='Send OTP to register establishment';
            checkForm();
        }
    } catch(err) {
        sendErr('⚠️ Network error. Check your connection and try again.');
        sendBtn.textContent='Send OTP to register establishment';
        checkForm();
    }
}
sendBtn.addEventListener('click', doSend);

/* ===== RESEND OTP ===== */
document.getElementById('resend-btn').addEventListener('click', async function() {
    this.disabled=true; this.textContent='Sending…';
    otpMsg('',''); clearDigits();
    try {
        const resp=await fetch('/api/send-otp/',{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrf()},
            body:JSON.stringify({email:eEmail.value.trim()})
        });
        const data=await resp.json();
        if(resp.ok && data.success) {
            startCountdown();
            otpMsg('✅ New OTP sent! Check your inbox.','ok');
            this.classList.remove('show'); this.textContent='Resend OTP';
        } else {
            otpMsg(data.error||'Failed to resend. Try again.','err');
            this.classList.add('show'); this.disabled=false; this.textContent='Resend OTP';
        }
    } catch(err) {
        otpMsg('Network error. Try again.','err');
        this.classList.add('show'); this.disabled=false; this.textContent='Resend OTP';
    }
});

/* ===== VERIFY OTP & REGISTER ===== */
document.getElementById('verify-btn').addEventListener('click', async function() {
    const otp=otpVal();
    if(otp.length!==6) return;
    this.disabled=true;
    this.innerHTML='<span class="btn-spin"></span>Verifying…';

    let regData={};
    try{ regData=JSON.parse(sessionStorage.getItem('registrationData')||'{}'); }catch(e){}
    regData.email=eEmail.value.trim();
    regData.password=ePass.value;

    const fd=new FormData();
    fd.append('otp',otp);
    fd.append('registrationData',JSON.stringify(regData));
    fd.append('csrfmiddlewaretoken',csrf());
    if(window._establishmentImageFile) fd.append('profile_image',window._establishmentImageFile);

    try {
        const resp=await fetch('/api/verify-and-register/',{
            method:'POST', headers:{'X-CSRFToken':csrf()}, body:fd
        });
        const data=await resp.json();

        if(data.success) {
            clearInterval(tmr); closeModal();

            // Show success overlay, fast progress bar (~1.2s), then redirect
            const ov=document.getElementById('success-ov');
            const fill=document.getElementById('prog');
            ov.classList.add('show');

            let pct=0;
            const p=setInterval(()=>{
                pct+=5;
                fill.style.width=pct+'%';
                if(pct>=100){
                    clearInterval(p);
                    window.location.href=data.redirect_url||'/food_establishment/dashboard/';
                }
            }, 60);  // 100/5 = 20 steps × 60ms = ~1.2s
        } else {
            shakeDigits();
            otpMsg(data.error||'Invalid OTP. Please try again.','err');
            this.disabled=false; this.textContent='Verify & Register';
        }
    } catch(err) {
        otpMsg('Network error. Please try again.','err');
        this.disabled=false; this.textContent='Verify & Register';
    }
});

/* ===== BACK ===== */
document.getElementById('back-btn').addEventListener('click', ()=>{
    window.location.href='/owner/register/details/';
});
</script>
</body>
</html>