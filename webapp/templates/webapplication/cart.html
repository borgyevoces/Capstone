{% extends "webapplication/kabsueats.html" %}
{% load static %}
{% load custom_filters %}
{% load static custom_filters webapp_filters %}

{% block search_visibility_control %}
{% with show_search=False %}{% endwith %}
{% endblock search_visibility_control %}

{% block title %}Shopping Cart - KabsuEats{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/cart_page.css' %}" />
{% endblock %}

{% block content %}

<div id="cart-page-container">

    {% if carts_data %}
        <!-- Cart Header -->
        <div class="cart-header">
            <h1>Shopping Cart</h1>
            <span class="cart-item-count">{{ total_cart_count }} item{{ total_cart_count|pluralize }}</span>
        </div>

        <!-- Main Cart Layout -->
        <div class="cart-main-wrapper">

            <!-- Left Column: All Establishment Carts -->
            <div class="all-carts-container">

                {% for cart in carts_data %}
                <div class="establishment-cart-box"
                     data-establishment-id="{{ cart.establishment.id }}"
                     data-establishment-name="{{ cart.establishment.name }}">

                    <!-- Establishment Header -->
                    <div class="cart-establishment-info">
                        <div class="est-header-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="est-header-text">
                            <h2>{{ cart.establishment.name }}</h2>
                            <div class="est-header-meta">
                                <i class="fas fa-map-marker-alt"></i>
                                {{ cart.establishment.address|truncatechars:55 }}
                            </div>
                        </div>
                        <button type="button"
                                class="clear-establishment-btn"
                                onclick="clearEstablishmentCart({{ cart.establishment.id }})"
                                title="Clear this cart">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>

                    <!-- Cart Items List -->
                    <div class="cart-items-list">
                        {% for item in cart.items %}
                            <div class="cart-item"
                                 id="cart-item-{{ item.id }}"
                                 data-order-id="{{ cart.order.id }}"
                                 data-item-id="{{ item.id }}"
                                 data-max-stock="{{ item.menu_item.quantity }}">

                                <!-- Item Image -->
                                {% if item.menu_item.image %}
                                    <img src="{{ item.menu_item.image.url }}"
                                         alt="{{ item.menu_item.name }}"
                                         class="item-image">
                                {% else %}
                                    <div class="item-image-placeholder">
                                        <i class="fas fa-utensils"></i>
                                    </div>
                                {% endif %}

                                <!-- Item Details -->
                                <div class="item-details">
                                    <h3 class="item-name">{{ item.menu_item.name }}</h3>
                                    {% if item.menu_item.description %}
                                        <p class="item-desc">{{ item.menu_item.description|truncatechars:60 }}</p>
                                    {% endif %}
                                    <p class="item-price" data-unit-price="{{ item.menu_item.price }}">
                                        â‚±{{ item.menu_item.price|floatformat:2 }} / item
                                    </p>
                                    <p class="item-stock">
                                        <i class="fas fa-box-open"></i>
                                        <span class="stock-count">{{ item.menu_item.quantity }}</span> left in stock
                                    </p>
                                    <span class="order-number-badge">
                                        <i class="fas fa-receipt"></i>
                                        Order #{{ cart.order.id }}
                                    </span>
                                </div>

                                <!-- Quantity Controls -->
                                <div class="item-quantity-controls">
                                    <button type="button"
                                            class="quantity-btn btn-decrease"
                                            data-item-id="{{ item.id }}"
                                            {% if item.quantity <= 1 %}disabled{% endif %}>
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="quantity-value" data-item-id="{{ item.id }}">{{ item.quantity }}</span>
                                    <button type="button"
                                            class="quantity-btn btn-increase"
                                            data-item-id="{{ item.id }}"
                                            {% if item.quantity >= item.menu_item.quantity %}disabled{% endif %}>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>

                                <!-- Item Subtotal & Remove -->
                                <div class="item-subtotal-section">
                                    <span class="item-subtotal" id="item-total-{{ item.id }}">
                                        â‚±{{ item.total_price|floatformat:2 }}
                                    </span>
                                    <button type="button"
                                            class="remove-item-btn"
                                            onclick="removeItemFromCart({{ item.id }})">
                                        <i class="fas fa-trash-alt"></i>
                                        Remove
                                    </button>
                                </div>

                            </div>
                        {% endfor %}
                    </div>

                    <!-- Cart Box Footer: item count + subtotal -->
                    <div class="cart-box-footer">
                        <span>{{ cart.item_count }} item{{ cart.item_count|pluralize }}</span>
                        <span class="cart-box-footer-total">
                            â‚±{% with total=0 %}
                                {% for item in cart.items %}
                                    {% with subtotal=item.total_price %}
                                    {% endwith %}
                                {% endfor %}
                                {{ cart.order.total_amount|floatformat:2 }}
                            {% endwith %}
                        </span>
                    </div>

                </div>
                {% endfor %}

            </div>

            <!-- Right Column: Active Order Summary (Sticky) -->
            <div class="cart-summary-sticky">
                <div class="cart-summary" id="active-order-summary">
                    <h2 class="summary-title">Order Summary</h2>
                    <p class="summary-subtitle">Select an establishment below</p>
                    <p class="summary-instruction">
                        <i class="fas fa-hand-pointer" style="margin-right:6px;color:#B71C1C;"></i>
                        Click on an establishment card to see order details and checkout
                    </p>

                    <div class="summary-content" style="display: none;">
                        <div class="summary-establishment-name"></div>

                        <div class="summary-line">
                            <span>Subtotal <span class="summary-item-count"></span></span>
                            <strong class="summary-subtotal">â‚±0.00</strong>
                        </div>
                        <div class="summary-line">
                            <span>Delivery</span>
                            <strong style="color:#2E7D32;">Free</strong>
                        </div>

                        <div class="summary-divider"></div>

                        <div class="grand-total-line">
                            <strong>Total</strong>
                            <span class="grand-total-amount">â‚±0.00</span>
                        </div>

                        <!-- Payment Method Selection (Hidden Initially) -->
                        <div class="payment-method-section" id="payment-method-section">
                            <p class="payment-method-title">Choose Payment Method</p>

                            <button type="button"
                                    class="btn-payment-method btn-paymongo"
                                    onclick="proceedToPayMongoCheckout(this)">
                                <i class="fas fa-credit-card icon-main"></i>
                                <div class="payment-method-info">
                                    <span class="payment-method-name">Online Payment</span>
                                    <span class="payment-method-desc">GCash, Credit/Debit Card</span>
                                </div>
                                <i class="fas fa-chevron-right" style="color:#9ca3af;font-size:11px;"></i>
                            </button>

                            <button type="button"
                                    class="btn-payment-method btn-cash"
                                    onclick="proceedToCashPayment(this)">
                                <i class="fas fa-money-bill-wave icon-main"></i>
                                <div class="payment-method-info">
                                    <span class="payment-method-name">Cash on Claim</span>
                                    <span class="payment-method-desc">Pay when you pick up</span>
                                </div>
                                <i class="fas fa-chevron-right" style="color:#9ca3af;font-size:11px;"></i>
                            </button>
                        </div>

                        <!-- Initial Checkout Button -->
                        <button type="button"
                                class="btn-checkout-gcash"
                                id="initial-checkout-btn"
                                onclick="showPaymentMethodSelection()">
                            <i class="fas fa-lock"></i>
                            Proceed to Checkout
                        </button>

                        <div class="security-badge">
                            <i class="fas fa-shield-alt"></i>
                            <span>Secured by PayMongo</span>
                        </div>
                    </div>
                </div>

                <a href="{% url 'kabsueats_home' %}" class="continue-shopping">
                    <i class="fas fa-arrow-left"></i> Continue Shopping
                </a>
            </div>

        </div>

    {% else %}
        <!-- Empty Cart State -->
        <div class="empty-cart-message">
            <div class="empty-cart-icon">ðŸ›’</div>
            <h2>Your cart is empty</h2>
            <p>Add delicious items from our food establishments!</p>
            <a href="{% url 'kabsueats_home' %}" class="btn-back-to-home">
                <i class="fas fa-store"></i> Browse Establishments
            </a>
        </div>
    {% endif %}

</div>

{% endblock %}

{% block extra_js %}
<script>
    // âœ… Auto-show payment method section when redirected from "Buy Now"
    // Accepts ?pay=1 and optionally ?est=<establishment_id> to auto-select the right store
    document.addEventListener('DOMContentLoaded', function () {
        const params = new URLSearchParams(window.location.search);
        if (params.get('pay') === '1') {
            const targetEstId = params.get('est'); // optional: specific establishment

            setTimeout(function () {
                let targetBox = null;

                if (targetEstId) {
                    // Select the specific establishment that was just added
                    targetBox = document.querySelector(
                        `.establishment-cart-box[data-establishment-id="${targetEstId}"]`
                    );
                }

                // Fall back to first establishment if none found
                if (!targetBox) {
                    targetBox = document.querySelector('.establishment-cart-box');
                }

                if (targetBox) {
                    targetBox.click();
                }

                // Show payment section after establishment is selected
                setTimeout(function () {
                    const summaryContent = document.querySelector('.summary-content');
                    const paymentSection = document.getElementById('payment-method-section');
                    const checkoutBtn = document.getElementById('initial-checkout-btn');

                    if (summaryContent) summaryContent.style.display = 'block';
                    if (paymentSection) paymentSection.style.display = 'flex';
                    if (checkoutBtn) checkoutBtn.style.display = 'none';

                    if (paymentSection) {
                        paymentSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 600);
            }, 300);
        }
    });
</script>
<script src="{% static 'js/cart.js' %}"></script>
{% endblock %}