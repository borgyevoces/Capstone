{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}KabsuEats{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="{% static 'css/kabsueats_desktopview.css' %}">
    <link rel="stylesheet" href="{% static 'css/kabsueats_phoneview.css' %}">
    {% block extra_css %}{% endblock %}

    <style>
    /* ── Smart Search: Menu Search Badge in BS carousel ── */
    .bsc-badge-search {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
    }
    .bsc-badge-est {
        background: linear-gradient(135deg, #8b5cf6, #6d28d9) !important;
    }

    /* ── Establishment match badge ── */
    .est-match-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        border: 1px solid #f59e0b;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 700;
        padding: 4px 9px;
        margin-bottom: 6px;
        font-family: 'Poppins', sans-serif;
        animation: matchPulse 0.4s ease;
    }
    .est-match-badge i {
        font-size: 10px;
        color: #d97706;
    }
    @keyframes matchPulse {
        0%   { transform: scale(0.8); opacity: 0; }
        60%  { transform: scale(1.05); }
        100% { transform: scale(1); opacity: 1; }
    }

    /* ── Highlight matched text in dropdown ── */
    .search-match {
        background: #fef08a;
        color: #854d0e;
        border-radius: 3px;
        padding: 0 2px;
        font-weight: 700;
    }

    /* ── BS title transition ── */
    .bs-title {
        transition: all 0.25s ease;
    }

    /* ── Est cards with matches get a subtle highlight ring ── */
    .food-est-item[data-match-count]:not([data-match-count="0"]) {
        outline: 2px solid #f59e0b;
        outline-offset: -2px;
    }
    </style>
</head>
<body>

{% block search_visibility_control %}{% endblock %}

<!-- Django Messages — customer-facing only (owner_only messages excluded) -->
{% if messages %}
<div class="messages-container" id="messagesContainer">
    {% for message in messages %}
    {% if 'owner_only' not in message.extra_tags %}
    <div class="message-alert {{ message.tags }}" id="msg-{{ forloop.counter }}">
        <span class="message-icon">
            {% if message.tags == 'success' %}<i class="fas fa-check-circle"></i>
            {% elif message.tags == 'error' %}<i class="fas fa-times-circle"></i>
            {% elif message.tags == 'warning' %}<i class="fas fa-exclamation-triangle"></i>
            {% else %}<i class="fas fa-info-circle"></i>{% endif %}
        </span>
        <span class="message-text">{{ message }}</span>
        <button class="message-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% endif %}

<!-- NAVBAR -->
<header class="navbar">
    <a href="{% url 'kabsueats_home' %}" class="brand">KabsuEats</a>

    <div class="nav-right">
        {% if user.is_authenticated %}
            {% block extra_nav_buttons %}{% endblock %}
            <a href="{% url 'order_history' %}" class="nib"><i class="fas fa-receipt"></i> My Orders</a>
            <a href="{% url 'view_cart' %}" class="nib cart-link">
                <i class="fas fa-shopping-cart"></i> Cart
                <span class="cart-badge" id="cartBadge">{{ cart_count|default:"0" }}</span>
            </a>
            <div class="pcont" id="pcont">
                <div class="pav" id="pavBtn" title="Profile">
                    {% if user.profile.profile_image %}
                        <img src="{{ user.profile.profile_image.url }}" alt="Profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
                    {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd"/></svg>
                    {% endif %}
                </div>
                <div id="pdrop" class="pdrop">
                    <div class="pd-hdr">
                        <div class="pd-av">
                            {% if user.profile.profile_image %}
                                <img src="{{ user.profile.profile_image.url }}" alt="Profile" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
                            {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd"/></svg>
                            {% endif %}
                        </div>
                        <div>
                            <span class="pd-name">{{ user.get_full_name|default:user.username }}</span>
                            <span class="pd-email">{{ user.email }}</span>
                        </div>
                    </div>
                    <div class="pd-div"></div>
                    <a href="#" class="pd-item" id="editProf">
                        <span class="pd-ico edit"><i class="fas fa-user-edit"></i></span> Edit Profile
                    </a>
                    <div class="pd-div"></div>
                    <a href="{% url 'user_logout' %}" class="pd-item logout">
                        <span class="pd-ico so"><i class="fas fa-sign-out-alt"></i></span> Log Out
                    </a>
                </div>
            </div>
        {% else %}
            <a href="{% url 'user_login_register' %}" class="nib"><i class="fas fa-sign-in-alt"></i> Login</a>
            <a href="{% url 'user_login_register' %}" class="nib login-btn">Register</a>
        {% endif %}
    </div>
</header>

<main class="main">
{% block content %}

    <!-- Hero Search -->
    <div class="hero">
        <div class="hsw">
                <div class="hs-cont">
                <i class="fas fa-search hs-ico"></i>
                <input type="text" class="hs-inp" id="hSearch"
                    placeholder="What are you craving today? Search restaurants, dishes, or cuisines..."
                    value="{{ q|default:'' }}" autocomplete="off"/>
                <i class="fas fa-times hs-clr" id="hClr"></i>
            </div>
            <!-- Live search dropdown removed -->
            <div class="hs-hints">
                <span class="hs-hint-label"><i class="fas fa-trophy"></i> Top Rated:</span>
                {% for est in food_establishments|slice:":5" %}
                <a href="{% url 'food_establishment_details' est.id %}" class="hs-hint-pill">
                    <i class="fas fa-store"></i> {{ est.name }}
                </a>
                {% empty %}
                <span class="hs-hint-pill"><i class="fas fa-store"></i> No establishments yet</span>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- BESTSELLERS SECTION -->
    <section class="bs-section" id="bsSec">
        <div class="bs-title-row">
            <h2 class="bs-title" id="bsTitle">
                <i class="fas fa-fire"></i>
                Top-rated items from all our partner establishments
            </h2>
        </div>

        <div class="bs-controls">
            <!-- LEFT: dropdown -->
            <div class="ddw" id="ddw">
                <button class="dd-btn" id="ddBtn" onclick="toggleDD()">
                    <i class="fas fa-trophy"></i>
                    <span id="ddLabel">Best Sellers</span>
                    <i class="fas fa-chevron-down chev"></i>
                </button>
                <div class="dd-panel" id="ddPanel">
                    <div class="ddo sel" id="ddBS" onclick="setView('bs')">
                        <i class="fas fa-fire ddo-ico"></i>
                        <div><div class="ddo-title">Best Sellers</div><div class="ddo-desc">Top-rated items across KabsuEats</div></div>
                    </div>
                    <div class="ddo" id="ddMap" onclick="setView('map')">
                        <i class="fas fa-map ddo-ico"></i>
                        <div><div class="ddo-title">View Map</div><div class="ddo-desc">See all establishments — 500m radius from CvSU-Bacoor</div></div>
                    </div>
                </div>
            </div>
            <!-- RIGHT: grid view -->
            <button class="gv-btn" id="gvBtn" onclick="toggleGrid()">
                <i class="fas fa-th" id="gvIco"></i>
                <span id="gvLbl">Grid View</span>
            </button>
        </div>

        <!-- CAROUSEL (default) -->
        <div id="carouselWrap">
            <button class="cnav prev" id="cPrev" onclick="cScroll(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="car-cont">
                <div class="car-track" id="cTrack">
                    <!-- Skeleton loaders while fetching -->
                    <div class="sk-card"><div class="sk sk-img"></div><div class="sk sk-ln" style="margin-top:13px"></div><div class="sk sk-ln s"></div><div class="sk sk-bt"></div></div>
                    <div class="sk-card"><div class="sk sk-img"></div><div class="sk sk-ln" style="margin-top:13px"></div><div class="sk sk-ln s"></div><div class="sk sk-bt"></div></div>
                    <div class="sk-card"><div class="sk sk-img"></div><div class="sk sk-ln" style="margin-top:13px"></div><div class="sk sk-ln s"></div><div class="sk sk-bt"></div></div>
                    <div class="sk-card"><div class="sk sk-img"></div><div class="sk sk-ln" style="margin-top:13px"></div><div class="sk sk-ln s"></div><div class="sk sk-bt"></div></div>
                    <div class="sk-card"><div class="sk sk-img"></div><div class="sk sk-ln" style="margin-top:13px"></div><div class="sk sk-ln s"></div><div class="sk sk-bt"></div></div>
                </div>
            </div>
            <button class="cnav next" id="cNext" onclick="cScroll(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- MAP (hidden by default) -->
        <div id="mapSection">
            <!-- Map container -->
            <div class="map-wrap">
                <div id="esMap"></div>

                <!-- Search inside map (top center) -->
                <div class="map-search-bar">
                    <i class="fas fa-search map-search-ico"></i>
                    <input type="text" id="mapSearch" placeholder="Search establishments..."
                           oninput="filterMapMarkers(this.value)" autocomplete="off">
                </div>

                <!-- Layer switcher (top right) -->
                <div class="map-layer-btn" id="mapLayerBtn" onclick="toggleLayerPanel()">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div class="map-layer-panel" id="mapLayerPanel">
                    <div class="mlp-title">Map Type</div>
                    <button class="mlp-opt" id="mts-street" onclick="switchTile('street')"><i class="fas fa-road"></i> Street</button>
                    <button class="mlp-opt on" id="mts-satellite" onclick="switchTile('satellite')"><i class="fas fa-satellite"></i> Satellite</button>
                    <button class="mlp-opt" id="mts-topo" onclick="switchTile('topo')"><i class="fas fa-mountain"></i> Topo</button>
                    <button class="mlp-opt" id="mts-dark" onclick="switchTile('dark')"><i class="fas fa-moon"></i> Dark</button>
                </div>

                <!-- Show My Location button -->
                <button class="map-loc-btn" id="mapLocBtn" onclick="showMyLocation()">
                    <i class="fas fa-location-arrow"></i> Show My Location
                </button>

                <!-- 500m legend -->
                <div class="mleg"><div class="mleg-dot"></div> 500m radius from CvSU-Bacoor</div>
            </div>
        </div>
    </section>

    <!-- Food Establishments -->
    <h2 class="sec-title"><i class="fas fa-store"></i> Food Establishments</h2>

    <div class="filt-bar">
        <div class="filt-inner">
            <span class="filt-lbl"><i class="fas fa-filter"></i> Filter by:</span>
            <div class="selw">
                <select id="catFilt" onchange="applyFilter()">
                    <option value="">All Categories</option>
                    {% for cat in all_categories %}
                    <option value="{{ cat.name|lower }}" {% if request.GET.category == cat.name %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="est-wrap">
        <div class="est-grid" id="estGrid">
            {% for est in food_establishments %}
            <a href="{% url 'food_establishment_details' est.id %}"
               class="estc food-est-item"
               data-id="{{ est.id }}"
               data-name="{{ est.name|lower }}"
               data-category="{% for c in est.categories.all %}{{ c.name|lower }}{% if not forloop.last %},{% endif %}{% endfor %}{% if est.other_category %}{% if est.categories.all %},{% endif %}{{ est.other_category|lower }}{% endif %}"
               data-status="{{ est.calculated_status|lower }}"
               data-rating="{{ est.average_rating|floatformat:1 }}"
               onclick="window.location.href='{% url 'food_establishment_details' est.id %}'; return true;"
               style="text-decoration:none;cursor:pointer;pointer-events:auto;">

                {% if est.image %}
                    <img class="estc-img" src="{{ est.image.url }}" alt="{{ est.name }}" loading="lazy">
                {% else %}
                    <img class="estc-img" src="https://via.placeholder.com/400x180?text={{ est.name }}" alt="{{ est.name }}" loading="lazy">
                {% endif %}

                <span class="estb {% if est.calculated_status == 'Open' %}open{% else %}closed{% endif %}">
                    <span class="estb-dot"></span>{{ est.calculated_status }}
                </span>

                <div class="estc-body">
                    <div class="star-r">
                        {% with rating=est.average_rating|floatformat:0 %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= est.average_rating %}
                                    <i class="fas fa-star" style="color:#fbbf24;font-size:12px"></i>
                                {% else %}
                                    <i class="far fa-star" style="color:#fbbf24;font-size:12px"></i>
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                        <span class="sv">{{ est.average_rating|floatformat:1 }}</span>
                    </div>
                    <div class="rcnt">({{ est.review_count }} Reviews)</div>
                    <div class="estc-name">{{ est.name }}</div>
                    <span class="ecat">
                        {% for cat in est.categories.all %}{{ cat.name }}{% if not forloop.last %}, {% endif %}{% endfor %}{% if est.other_category %}{% if est.categories.all %}, {% endif %}{{ est.other_category }}{% endif %}
                        {% if not est.categories.all and not est.other_category %}Uncategorized{% endif %}
                    </span>
                </div>
                <div class="emr"><i class="fas fa-route" style="color:#B71C1C"></i>
                    {% if est.distance_meters %}
                        {% if est.distance_meters < 1000 %}
                            {{ est.distance_meters|floatformat:0 }} meters
                        {% else %}
                            {{ est.distance|floatformat:2 }} km
                        {% endif %}
                    {% else %}
                        Distance unknown
                    {% endif %}
                </div>
                <div class="emr" style="padding-bottom:4px">
                    <i class="fas fa-credit-card" style="color:#B71C1C"></i>
                    {{ est.payment_methods|default:"Cash" }}
                </div>
                {% if est.amenities.all or est.other_amenity %}
                <div class="emr" style="padding-bottom:10px">
                    <i class="fas fa-concierge-bell" style="color:#B71C1C"></i>
                    {% for amenity in est.amenities.all %}{{ amenity.name }}{% if not forloop.last %}, {% endif %}{% endfor %}{% if est.other_amenity %}{% if est.amenities.all %}, {% endif %}{{ est.other_amenity }}{% endif %}
                </div>
                {% endif %}
            </a>
            {% empty %}
            <p class="no-est-msg">No food establishments found.</p>
            {% endfor %}
        </div>
    </div>
{% endblock content %}
</main>

<!-- FOOTER -->
<footer class="footer">
    <div class="f-inner">
        <div class="fc">
            <h3><i class="fas fa-utensils"></i> KabsuEats</h3>
            <p>Your trusted food shops platform connecting you with the best local restaurants and food establishments near CvSU-Bacoor.</p>
            <div class="soc-r">
                <a href="#" class="sob"><i class="fab fa-facebook-f"></i></a>
                <a href="#" class="sob"><i class="fab fa-instagram"></i></a>
                <a href="#" class="sob"><i class="fab fa-twitter"></i></a>
                <a href="#" class="sob"><i class="fab fa-tiktok"></i></a>
            </div>
        </div>
        <div class="fc">
            <h3><i class="fas fa-link"></i> Quick Links</h3>
            <ul class="fl">
                <li><a href="{% url 'kabsueats_home' %}"><i class="fas fa-chevron-right"></i> Home</a></li>
                <li><a href="{% url 'kabsueats_about' %}"><i class="fas fa-chevron-right"></i> About Us</a></li>
                {% if user.is_authenticated %}
                <li><a href="{% url 'order_history' %}"><i class="fas fa-chevron-right"></i> My Orders</a></li>
                <li><a href="{% url 'view_cart' %}"><i class="fas fa-chevron-right"></i> My Cart</a></li>
                {% endif %}
            </ul>
        </div>
        <div class="fc">
            <h3><i class="fas fa-file-alt"></i> Legal</h3>
            <ul class="fl">
                <li><a href="#"><i class="fas fa-chevron-right"></i> Terms & Conditions</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Privacy Policy</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Cookie Policy</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Refund Policy</a></li>
            </ul>
        </div>
        <div class="fc">
            <h3><i class="fas fa-headset"></i> Contact Us</h3>
            <ul class="fl">
                <li><a href="#"><i class="fas fa-envelope"></i> support@kabsueats.com</a></li>
                <li><a href="#"><i class="fas fa-phone"></i> +63 912 345 6789</a></li>
                <li><a href="#"><i class="fas fa-map-marker-alt"></i> CvSU-Bacoor, Cavite</a></li>
                <li><a href="#"><i class="fas fa-clock"></i> 24/7 Support</a></li>
            </ul>
        </div>
    </div>
    <div class="fbot"><p>&copy; 2025 <a href="{% url 'kabsueats_home' %}">KabsuEats</a>. All rights reserved. Made with <i class="fas fa-heart" style="color:#B71C1C;"></i> by CvSU-Bacoor Students</p></div>
</footer>

<button class="stb" id="stb"><i class="fas fa-arrow-up"></i></button>

<!-- ============================================ -->
<!-- BESTSELLER DETAIL MODAL                      -->
<!-- ============================================ -->
<div class="mover" id="bsMod">
    <div class="mbox">
        <button class="mcb" onclick="closeMod()"><i class="fas fa-times"></i></button>
        <div class="mbody">
            <div class="mimg">
                <img id="mImg" src="" alt="">
                <span class="m-bsbadge"><i class="fas fa-fire"></i> Best Seller</span>
            </div>
            <div class="mdet">
                <h2 class="miname" id="mName"></h2>
                <p class="midesc" id="mDesc"></p>
                <div class="mpr">
                    <span class="mprice" id="mPrice">₱0.00</span>
                    <span class="mstock" id="mStock"><i class="fas fa-box"></i> 0 Items</span>
                </div>
                <div class="mestb">
                    <div class="mestn"><i class="fas fa-store"></i> <span id="mEstN"></span></div>
                    <div class="mesta"><i class="fas fa-map-marker-alt"></i> <span id="mEstA"></span></div>
                    <div class="mests closed" id="mEstS"><i class="fas fa-circle" style="font-size:8px"></i> Closed</div>
                </div>
                <div class="qrow">
                    <span class="qlbl">Quantity:</span>
                    <div class="qctrl">
                        <button class="qb" onclick="chgQ(-1)"><i class="fas fa-minus"></i></button>
                        <input type="number" id="mqty" value="1" min="1" readonly>
                        <button class="qb" onclick="chgQ(1)"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="mar" id="modalActions">
                    {% if user.is_authenticated %}
                    <button class="macb" id="addToCartBtn" onclick="addToCartFromModal()">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                    <button class="mbnb mbnb-green" id="buyNowBtn" onclick="buyNowFromModal()">
                        <i class="fas fa-bolt"></i> Buy Now
                    </button>
                    {% else %}
                    <a href="{% url 'user_login_register' %}" class="macb" style="justify-content:center;text-decoration:none;">
                        <i class="fas fa-sign-in-alt"></i> Login to Order
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="sover" id="setMod">
    <div class="sbox">
        <span class="scls" onclick="closeSet()">&times;</span>
        <div class="stitle">Update Profile</div>
        <form id="profileUpdateForm" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="fg" style="text-align:center">
                <div style="width:84px;height:84px;border-radius:50%;background:linear-gradient(135deg,#1f2937,#374151);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;color:#fff;overflow:hidden;border:3px solid var(--g200);" id="profilePreview">
                    {% if user.profile.profile_image %}
                        <img src="{{ user.profile.profile_image.url }}" style="width:100%;height:100%;object-fit:cover;">
                    {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="44" height="44"><path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd"/></svg>
                    {% endif %}
                </div>
            </div>
            <div class="fg">
                <label>Change Profile Picture:</label>
                <input type="file" name="profile_picture" accept="image/*" id="profileImgInput" onchange="previewProfileImg(this)">
            </div>
            <div class="fg">
                <label>Email Address:</label>
                <input type="email" value="{{ user.email }}" readonly style="background:#f3f4f6;cursor:not-allowed">
            </div>
            <div style="margin-top:20px;text-align:center">
                <button type="button" class="svbtn" id="saveProfileBtn" onclick="saveProfile()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- CSRF Token for AJAX -->
<input type="hidden" id="csrfToken" value="{{ csrf_token }}">

<!-- Django data for JS -->
<script>
    const URLS = {
        bestsellers:    "{% url 'get_bestsellers' %}",
        addToCart:      "{% url 'add_to_cart' %}",
        cartCount:      "{% url 'get_cart_count' %}",
        nearbyEst:      "{% url 'get_nearby_establishments' %}",
        estDetail:      "/food_establishment/",  // append {id}/
        createCash:     "{% url 'create_cash_order' %}",
        cart:           "{% url 'view_cart' %}",
        login:          "{% url 'user_login_register' %}",
        updateProfile:  "{% url 'update_profile' %}",
    };
    const IS_AUTHENTICATED = {% if user.is_authenticated %}true{% else %}false{% endif %};
    const CVSU = {
        lat: {{ CVSU_LATITUDE|default:"14.412768" }},
        lng: {{ CVSU_LONGITUDE|default:"120.981348" }}
    };
    const RADIUS = 500;
    // Map of establishment id → image URL (for bestseller cards)
    const EST_IMG_MAP = {
        {% for est in food_establishments %}
        {{ est.id }}: "{% if est.image %}{{ est.image.url }}{% endif %}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    };
    // Full establishment data for map markers (status + image, rendered server-side)
    const EST_ALL_DATA = {
        {% for est in food_establishments %}
        {{ est.id }}: {
            name: "{{ est.name|escapejs }}",
            address: "{{ est.address|default:''|escapejs }}",
            image: "{% if est.image %}{{ est.image.url }}{% endif %}",
            status: "{{ est.calculated_status|lower }}",
            lat: {{ est.latitude|default:"null" }},
            lng: {{ est.longitude|default:"null" }},
            categories: "{% for c in est.categories.all %}{{ c.name|lower }}{% if not forloop.last %},{% endif %}{% endfor %}{% if est.other_category %}{% if est.categories.all %},{% endif %}{{ est.other_category|lower|escapejs }}{% endif %}",
            other_category: "{{ est.other_category|default:''|lower|escapejs }}",
            other_amenity: "{{ est.other_amenity|default:''|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="{% static 'js/kabsueats.js' %}"></script>
{% block extra_js %}{% endblock %}

</body>
</html>