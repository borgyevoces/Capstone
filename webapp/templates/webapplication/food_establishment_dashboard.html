{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}"/>
    <title>{% block page_title %}{{ establishment.name }} - Dashboard{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    {% block extra_head_links %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    {% endblock %}
    <link rel="stylesheet" href="{% static 'css/owner_dashboard_styless.css' %}">
    <style>
        /* ==========================================
           NAVIGATION BUTTON FIXES
           ========================================== */
        .nav-icon-btn {
            display: inline-flex !important;
            align-items: center !important;
            text-decoration: none !important;
            color: inherit !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            position: relative !important;
            z-index: 100 !important;
            transition: all 0.2s ease !important;
        }

        .nav-icon-btn:hover {
            opacity: 0.85 !important;
            transform: translateY(-1px) !important;
        }

        .nav-icon-btn:active {
            transform: translateY(0) !important;
        }

        /* Ensure links are clickable */
        a.nav-icon-btn {
            -webkit-tap-highlight-color: transparent;
        }

        .notification-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .notification-item.unread {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
        }

        .notification-header {
            display: flex;
            align-items: start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f02849 0%, #c62828 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-weight: 700;
            font-size: 16px;
        }

        .notification-type-badge {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .notification-message {
            color: #6b7280;
            font-size: 14px;
        }

        /* Customer Info */
        .customer-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            margin: 12px 0;
        }

        .customer-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        .customer-details {
            flex: 1;
        }

        .customer-name {
            font-weight: 700;
            font-size: 15px;
            color: #1a1a1a;
        }

        .customer-email {
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }

        /* Order Summary */
        .order-summary {
            border-top: 1px solid #e5e7eb;
            padding-top: 12px;
            margin-top: 12px;
        }

        .order-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .order-id {
            font-weight: 700;
            font-size: 14px;
            color: #1a1a1a;
        }

        .order-total {
            font-weight: 800;
            font-size: 18px;
            color: #B71C1C;
        }

        .order-reference {
            background: #f0f7ff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #1877F2;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .order-items-list {
            margin: 12px 0;
        }

        .order-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .item-name-qty {
            font-size: 14px;
            color: #1a1a1a;
        }

        .item-price {
            font-weight: 700;
            color: #B71C1C;
            font-size: 14px;
        }

        .order-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
        }

        .order-status-badge.paid {
            background: #d1fae5;
            color: #10b981;
        }

        .order-status-badge.pending {
            background: #fef3c7;
            color: #f59e0b;
        }

        .notification-time {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #9ca3af;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f3f4f6;
        }

        .time-ago {
            font-weight: 600;
            color: #6b7280;
        }

        .notification-toggle-btn {
            position: relative;
            background: transparent;
            border: none;
            color: var(--text-dark, #333);
            font-size: 20px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .notification-toggle-btn:hover {
            background: var(--bg-light, #f5f7fa);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #f02849;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }

        .notification-panel {
            position: fixed;
            right: 0;
            top: 70px;
            width: 400px;
            height: calc(100vh - 70px);
            background: white;
            border-left: 1px solid var(--border, #e4e6eb);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 998;
            display: flex;
            flex-direction: column;
        }

        .notification-panel.open {
            transform: translateX(0);
        }

        .notification-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border, #e4e6eb);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f02849 0%, #c62828 100%);
            color: white;
        }

        .notification-panel-header h3 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }

        .mark-all-read-btn,
        .notification-close-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
            transition: opacity 0.2s;
        }

        .mark-all-read-btn:hover,
        .notification-close-btn:hover {
            opacity: 0.8;
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .notification-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted, #65676b);
        }

        .notification-empty-state i {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 16px;
            display: block;
        }

        @media (max-width: 768px) {
            .notification-panel {
                width: 100vw !important;
                max-width: 100vw !important;
                top: 60px;
                height: calc(100vh - 60px);
            }
        }

        /* ==========================================
           CHAT PANEL STYLES
           ========================================== */

        .chat-panel {
            position: fixed;
            right: 0;
            top: 70px;
            width: 360px;
            max-width: 100vw !important;
            height: calc(100vh - 70px);
            background: white;
            border-left: 1px solid var(--border, #e4e6eb);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 999;
            display: flex;
            flex-direction: column;
            overflow-x: hidden !important;
            box-sizing: border-box !important;
        }

        .chat-panel *,
        .chat-panel *::before,
        .chat-panel *::after {
            box-sizing: border-box !important;
        }

        .chat-panel.open {
            transform: translateX(0);
        }

        .chat-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border, #e4e6eb);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
        }

        .chat-panel-header h3 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }

        .chat-close-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .chat-close-btn:hover {
            transform: scale(1.1);
        }

        .chat-conversations-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px;
        }

        .chat-conversation-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 8px;
            position: relative;
        }

        .chat-conversation-item:hover {
            background: var(--bg-light, #f5f7fa);
        }

        .chat-conversation-item.active {
            background: rgba(102, 126, 234, 0.1);
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .chat-conversation-info {
            flex: 1;
            min-width: 0;
        }

        .chat-conversation-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--text-dark, #333);
        }

        .chat-conversation-preview {
            font-size: 13px;
            color: var(--text-muted, #65676b);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-conversation-time {
            font-size: 11px;
            color: var(--text-muted, #65676b);
            position: absolute;
            top: 12px;
            right: 12px;
        }

        .chat-unread-badge {
            background: var(--primary, #667eea);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 700;
            position: absolute;
            bottom: 12px;
            right: 12px;
        }

        .chat-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted, #65676b);
        }

        .chat-empty-state i {
            font-size: 64px;
            opacity: 0.2;
            margin-bottom: 16px;
            display: block;
        }

        /* ========================================
           CHAT WINDOW - FIXED DISPLAY & HEADER
           ======================================== */

        .chat-window {
            position: fixed;
            right: 0;
            top: 70px;
            width: 360px;
            max-width: 100vw !important;
            height: calc(100vh - 70px);
            background: white;
            border-left: 1px solid var(--border, #e4e6eb);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-x: hidden !important;
            box-sizing: border-box !important;
            visibility: hidden;
        }

        .chat-window *,
        .chat-window *::before,
        .chat-window *::after {
            box-sizing: border-box !important;
        }

        .chat-window.open {
            transform: translateX(0);
            visibility: visible;
        }

        .chat-window-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border, #e4e6eb);
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
        }

        .back-to-conversations {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            margin-right: 12px;
            transition: transform 0.2s;
        }

        .back-to-conversations:hover {
            transform: translateX(-3px);
        }

        .chat-header-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-name {
            font-weight: 700;
            font-size: 16px;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ========================================
           âœ… PINNED SECTION STYLES - REDESIGNED
           ======================================== */

        .owner-pinned-section {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            display: none; /* Hidden by default */
            flex-direction: column;
            width: 100%;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 90;
        }

        .owner-pinned-section.active {
            display: flex;
        }

        .owner-pinned-section-header {
            padding: 10px 16px;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
        }

        .owner-pinned-section-title {
            font-size: 13px;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .owner-pinned-collapse {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .owner-pinned-collapse:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
        }

        #ownerPinnedMessagesList {
            max-height: 120px;
            overflow-y: auto;
            background: #fff;
            display: block; /* Visible by default when section is active */
        }

        .pinned-message-item {
            padding: 10px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #475569;
            transition: background 0.2s;
            cursor: pointer;
        }

        .pinned-message-item:hover {
            background: #f8fafc;
        }

        .pinned-message-item:last-child {
            border-bottom: none;
        }

        .pinned-message-item i.fa-thumbtack {
            color: #667eea;
            font-size: 11px;
            transform: rotate(45deg);
        }

        .pinned-message-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        .unpin-btn {
            background: none;
            border: none;
            color: #cbd5e0;
            cursor: pointer;
            padding: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .unpin-btn:hover {
            color: #ef4444;
            background: #fee2e2;
        }

        /* Chat messages area */
        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden !important;
            padding: 16px;
            background: #f0f2f5;
            width: 100%;
        }

        /* ========================================
           CHAT MESSAGES
           ======================================== */

        .chat-message {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            position: relative;
            max-width: 100%;
        }

        .chat-message.sent {
            justify-content: flex-end;
        }

        .chat-message.received {
            justify-content: flex-start;
        }

        .chat-message-bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 16px;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
            font-size: 14px;
            position: relative;
        }

        .chat-message.sent .chat-message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.received .chat-message-bubble {
            background: white;
            color: var(--text-dark, #333);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .chat-message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
            display: block;
        }

        .message-options-btn {
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chat-message.sent .message-options-btn {
            order: -1;
            margin-right: 10px;
        }

        .chat-message.received .message-options-btn {
            order: 1;
            margin-left: 10px;
        }

        @media (hover: hover) {
            .chat-message:hover .message-options-btn {
                opacity: 1;
            }

            .message-options-btn:hover {
                background: rgba(0, 0, 0, 0.7);
                transform: scale(1.1);
            }
        }

        .chat-message.active .message-options-btn {
            opacity: 1;
        }

        .chat-message.long-pressing .chat-message-bubble {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .chat-message.pinned .chat-message-bubble::before {
            content: 'ðŸ“Œ ';
            margin-right: 4px;
        }

        .owner-see-pins-link {
            background: #f0f2f5;
            padding: 10px 15px;
            border-top: 1px solid #e4e6eb;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            font-weight: 600;
            color: #667eea;
            display: none;
            flex-shrink: 0;
        }

        .owner-see-pins-link.active {
            display: block;
        }

        .owner-see-pins-link:hover {
            background: #e4e6eb;
        }

        .chat-input-container {
            padding: 10px !important;
            border-top: 1px solid var(--border, #e4e6eb);
            background: white;
            position: relative;
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow: hidden !important;
            flex-shrink: 0 !important;
        }

        .chat-input-form {
            display: flex !important;
            gap: 8px !important;
            align-items: center;
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .chat-input {
            flex: 1 1 auto !important;
            min-width: 0 !important;
            width: 100% !important;
            padding: 10px 14px !important;
            border: 1px solid var(--border, #e4e6eb);
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box !important;
            margin: 0 !important;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .chat-send-btn {
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            max-width: 40px !important;
            flex: 0 0 40px !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex !important;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            padding: 0 !important;
            margin: 0 !important;
            box-sizing: border-box !important;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
        }

        .chat-send-btn:active {
            transform: scale(0.95);
        }

        .chat-toggle-btn {
            position: relative;
            background: transparent;
            border: none;
            color: var(--text-dark, #333);
            font-size: 20px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .chat-toggle-btn:hover {
            background: var(--bg-light, #f5f7fa);
        }

        .chat-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--primary, #667eea);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }

        /* ========================================
           CONTEXT MENU STYLES
           ======================================== */

        .message-context-menu {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.25);
            padding: 8px 0;
            min-width: 180px;
            z-index: 10002;
            display: none;
            animation: menuSlideIn 0.15s ease-out;
        }

        .message-context-menu.active {
            display: block;
        }

        @keyframes menuSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center; /* Ensures vertical center */
            gap: 12px;
            font-size: 0.9rem;
            color: #333;
            transition: background 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        .context-menu-item:hover {
            background: #f5f5f5;
        }

        .context-menu-item i {
            width: 18px;
            font-size: 1rem;
            text-align: center; /* Center icon in its width */
        }

        .context-menu-item.danger {
            color: #f02849;
        }

        .context-menu-item.danger:hover {
            background: #ffebee;
        }

        /* ========================================
           UNSEND MODAL STYLES
           ======================================== */

        .unsend-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10003;
            animation: fadeIn 0.2s ease;
        }

        .unsend-modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .unsend-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            animation: modalSlideUp 0.3s ease-out;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .unsend-modal h3 {
            margin: 0 0 16px 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .unsend-option {
            padding: 16px;
            border: 2px solid #e4e6eb;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .unsend-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .unsend-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .unsend-option-title {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unsend-option-desc {
            font-size: 0.85rem;
            color: #65676b;
        }

        .unsend-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .unsend-modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            /* FIX: Ensure text is centered */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-cancel {
            background: #e4e6eb;
            color: #333;
        }

        .btn-cancel:hover {
            background: #d0d2d7;
        }

        .btn-remove {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-remove:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-remove:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .chat-message.deleted .chat-message-bubble {
            background: #f5f5f5 !important;
            color: #999 !important;
            font-style: italic;
            opacity: 0.7;
        }

        .chat-message.deleted .chat-message-bubble::before {
            content: 'ðŸš« ';
        }

        .pinned-messages-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10004;
            animation: fadeIn 0.2s ease;
        }

        .pinned-messages-modal.active {
            display: flex;
        }

        .pinned-messages-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease-out;
        }

        .pinned-messages-modal h3 {
            margin: 0 0 16px 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .pinned-messages-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pinned-messages-list .pinned-message-item {
            padding: 12px;
            border: 1px solid #e4e6eb;
        }

        .pinned-messages-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .pinned-messages-empty i {
            font-size: 48px;
            opacity: 0.3;
            display: block;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            .chat-panel,
            .chat-window {
                width: 100vw !important;
                max-width: 100vw !important;
                top: 60px;
                height: calc(100vh - 60px);
            }

            .message-options-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
                opacity: 0.7;
            }

            .chat-message.sent .message-options-btn {
                margin-right: 12px;
            }

            .chat-message.received .message-options-btn {
                margin-left: 12px;
            }

            .context-menu-item {
                padding: 16px 20px;
                font-size: 1rem;
            }

            .unsend-option {
                padding: 18px;
            }

            .chat-input-container {
                padding: 8px !important;
            }

            .chat-input-form {
                gap: 6px !important;
            }

            .chat-input {
                padding: 9px 12px !important;
                font-size: 14px;
            }

            .chat-send-btn {
                width: 38px !important;
                height: 38px !important;
                min-width: 38px !important;
                max-width: 38px !important;
                flex: 0 0 38px !important;
            }

            .chat-send-btn i {
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            .chat-panel,
            .chat-window {
                width: 100vw !important;
                max-width: 100vw !important;
                top: 56px;
                height: calc(100vh - 56px);
            }

            .chat-input-container {
                padding: 8px !important;
            }

            .chat-input-form {
                gap: 6px !important;
            }

            .chat-input {
                padding: 8px 10px !important;
                font-size: 13px;
            }

            .chat-send-btn {
                width: 36px !important;
                height: 36px !important;
                min-width: 36px !important;
                max-width: 36px !important;
                flex: 0 0 36px !important;
            }

            .chat-send-btn i {
                font-size: 14px;
            }
        }

        @media (max-width: 360px) {
            .chat-panel,
            .chat-window {
                width: 100vw !important;
                max-width: 100vw !important;
            }

            .chat-input-container {
                padding: 6px !important;
            }

            .chat-input-form {
                gap: 5px !important;
            }

            .chat-input {
                padding: 7px 9px !important;
                font-size: 13px;
            }

            .chat-send-btn {
                width: 34px !important;
                height: 34px !important;
                min-width: 34px !important;
                max-width: 34px !important;
                flex: 0 0 34px !important;
            }

            .chat-send-btn i {
                font-size: 13px;
            }
        }

        /* Delete Establishment Link */
        .delete-establishment-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #dc2626;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .delete-establishment-link:hover {
            background: #fee2e2;
            transform: translateX(4px);
        }

        .delete-establishment-link i {
            font-size: 18px;
        }

        /* Delete Confirmation Modal */
        .delete-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .delete-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .delete-modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .delete-modal-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
        }

        .delete-modal-title {
            flex: 1;
        }

        .delete-modal-title h3 {
            margin: 0;
            font-size: 24px;
            color: #111827;
            font-weight: 700;
        }

        .delete-modal-title p {
            margin: 4px 0 0 0;
            color: #6b7280;
            font-size: 14px;
        }

        .delete-modal-body {
            margin-bottom: 24px;
        }

        .delete-warning {
            background: #fef2f2;
            border-left: 4px solid #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .delete-warning p {
            margin: 0;
            color: #991b1b;
            font-weight: 600;
        }

        .delete-consequences {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
        }

        .delete-consequences h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #111827;
            font-weight: 600;
        }

        .delete-consequences ul {
            margin: 0;
            padding-left: 20px;
        }

        .delete-consequences li {
            color: #6b7280;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .delete-modal-actions {
            display: flex;
            gap: 12px;
        }

        .btn-cancel,
        .btn-delete {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-cancel:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .btn-delete:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        /* ========================================== */
        /* NEW FEATURES STYLES - ORDERS & SALES REPORT */
        /* ========================================== */

        .orders-table-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .orders-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .orders-table-title {
            font-size: 24px;
            font-weight: 800;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .orders-table-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-btn, .export-btn, .sales-report-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .filter-btn {
            background: #f3f4f6;
            color: #374151;
        }

        .filter-btn:hover {
            background: #e5e7eb;
        }

        .export-btn {
            background: #10b981;
            color: white;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .sales-report-btn {
            background: linear-gradient(135deg, #f02849 0%, #c62828 100%);
            color: white;
        }

        .sales-report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 40, 73, 0.4);
        }

        .orders-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .orders-table thead {
            background: linear-gradient(135deg, #f02849 0%, #c62828 100%);
            color: white;
        }

        .orders-table th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .orders-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s;
        }

        .orders-table tbody tr:hover {
            background: #f9fafb;
        }

        .orders-table td {
            padding: 16px;
            color: #374151;
            font-size: 14px;
        }

        .order-id-cell {
            font-weight: 700;
            color: #1877F2;
        }

        .order-customer-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .customer-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .order-amount-cell {
            font-weight: 800;
            font-size: 16px;
            color: #B71C1C;
        }

        .status-preparing {
            background: #dbeafe;
            color: #3b82f6;
        }

        .status-ready {
            background: #e0e7ff;
            color: #6366f1;
        }

        .status-completed {
            background: #d1fae5;
            color: #059669;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #ef4444;
        }

        .order-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .view-btn {
            background: #3b82f6;
            color: white;
        }

        .view-btn:hover {
            background: #2563eb;
        }

        .pagination-container {
            margin-top: 24px;
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #f02849;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Back to Dashboard Button */
        .back-to-dashboard-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #f02849 0%, #c62828 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            margin-top: 24px;
        }

        .back-to-dashboard-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(240, 40, 73, 0.4);
            color: white;
        }

        .payment-success-container {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 20px;
            max-width: 600px;
            margin: 40px auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        /* Transaction History Section */
        .transaction-history-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s;
        }

        .transaction-item:hover {
            background: #f9fafb;
        }

        .transaction-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .transaction-icon.payment {
            background: #d1fae5;
            color: #10b981;
        }

        .transaction-icon.refund {
            background: #fee2e2;
            color: #ef4444;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-title {
            font-weight: 700;
            font-size: 15px;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .transaction-date {
            font-size: 13px;
            color: #6b7280;
        }

        .transaction-amount {
            font-weight: 800;
            font-size: 18px;
        }

        .transaction-amount.positive {
            color: #10b981;
        }

        .transaction-amount.negative {
            color: #ef4444;
        }

        /* Sales Report Modal */
        .sales-report-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .sales-report-modal.active {
            display: flex;
        }

        .sales-report-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .sales-report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f3f4f6;
        }

        .sales-report-title {
            font-size: 28px;
            font-weight: 800;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-report-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #9ca3af;
            cursor: pointer;
            transition: all 0.2s;
        }

        .close-report-btn:hover {
            color: #ef4444;
            transform: rotate(90deg);
        }

        .report-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 13px;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #f02849;
            box-shadow: 0 0 0 3px rgba(240, 40, 73, 0.1);
        }

        .apply-filters-btn {
            background: linear-gradient(135deg, #f02849 0%, #c62828 100%);
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .apply-filters-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 40, 73, 0.4);
        }

        .sales-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .summary-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .summary-card-icon.revenue {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .summary-card-icon.orders {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .summary-card-icon.average {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .summary-card-icon.items {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .summary-card-label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card-value {
            font-size: 28px;
            font-weight: 800;
            color: #1a1a1a;
            margin-top: 4px;
        }

        .chart-container {
            background: #f9fafb;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 16px;
        }

        /* Mobile responsiveness for new features */
        @media (max-width: 768px) {
            .orders-table-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .orders-table-actions {
                width: 100%;
                flex-direction: column;
            }

            .orders-table-actions button {
                width: 100%;
                justify-content: center;
            }

            .sales-report-content {
                padding: 20px;
            }

            .sales-report-title {
                font-size: 22px;
            }

            .sales-summary-cards {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .sales-summary-cards {
                grid-template-columns: 1fr;
            }
        }

    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
<nav class="navbar">
    <div class="navbar-container">
        <a href="{% url 'food_establishment_dashboard' %}" class="navbar-logo">
            KabsuEats
        </a>
        <div class="navbar-actions">
            <!-- Dashboard Button (Active) -->
            <a href="{% url 'food_establishment_dashboard' %}"
               class="nav-icon-btn {% if request.resolver_match.url_name == 'food_establishment_dashboard' %}active{% endif %}"
               title="Dashboard">
                <i class="fas fa-chart-line"></i>
                <span class="nav-btn-label">Dashboard</span>
            </a>

            <!-- Orders Button -->
            <a href="{% url 'orders_list' %}"
               class="nav-icon-btn {% if request.resolver_match.url_name == 'orders_list' %}active{% endif %}"
               title="Orders">
                <i class="fas fa-shopping-bag"></i>
                <span class="nav-btn-label">Orders</span>
            </a>

            <!-- Transaction History Button -->
            <a href="{% url 'user_transactions' %}"
               class="nav-icon-btn {% if request.resolver_match.url_name == 'transaction_history' %}active{% endif %}"
               title="Transaction History">
                <i class="fas fa-history"></i>
                <span class="nav-btn-label">Transactions</span>
            </a>

            <button class="notification-toggle-btn" onclick="toggleNotificationPanel()" id="notificationToggleBtn"
                    title="Notifications">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>

            <button class="chat-toggle-btn" onclick="toggleChatPanel()" id="chatToggleBtn" title="Messages">
                <i class="fas fa-envelope"></i>
                <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
            </button>

            <div class="navbar-dropdown">
                <button class="navbar-btn" onclick="toggleDropdown()" title="Menu">
                    <i class="fas fa-user-circle"></i>
                    <span>{{ establishment.name }}</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="navbar-menu" id="navMenu">
                    <a href="#" onclick="showDeleteConfirmation(event)" class="delete-establishment-link">
                        <i class="fas fa-trash-alt"></i>
                        <span>Delete Establishment</span>
                    </a>
                    <a href="{% url 'logout_owner' %}" class="logout-link">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Delete Establishment Confirmation Modal -->
<div class="delete-modal-overlay" id="deleteModal">
    <div class="delete-modal">
        <div class="delete-modal-header">
            <div class="delete-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="delete-modal-title">
                <h3>Delete Establishment?</h3>
                <p>This action cannot be undone</p>
            </div>
        </div>
        <div class="delete-modal-body">
            <div class="delete-warning">
                <p><i class="fas fa-info-circle"></i> You are about to permanently delete your establishment</p>
            </div>
            <div class="delete-consequences">
                <h4>This will permanently remove:</h4>
                <ul>
                    <li><i class="fas fa-check"></i> Your establishment profile</li>
                    <li><i class="fas fa-check"></i> All menu items and categories</li>
                    <li><i class="fas fa-check"></i> Order history and customer data</li>
                    <li><i class="fas fa-check"></i> Reviews and ratings</li>
                    <li><i class="fas fa-check"></i> Chat conversations</li>
                </ul>
            </div>
        </div>
        <div class="delete-modal-actions">
            <button class="btn-cancel" onclick="hideDeleteConfirmation()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn-delete" onclick="confirmDeleteEstablishment()" id="confirmDeleteBtn">
                <i class="fas fa-trash-alt"></i> Yes, Delete
            </button>
        </div>
    </div>
</div>

<div class="notification-panel" id="notificationPanel">
    <div class="notification-panel-header">
        <h3><i class="fas fa-bell"></i> Notifications</h3>
        <div style="display: flex; gap: 8px; align-items: center;">
            <button class="mark-all-read-btn" onclick="markAllNotificationsRead()" id="markAllReadBtn"
                    title="Mark all as read">
                <i class="fas fa-check-double"></i>
            </button>
            <button class="notification-close-btn" onclick="toggleNotificationPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="notification-list" id="notificationList">
        <div class="notification-empty-state">
            <i class="fas fa-bell-slash"></i>
            <p>No new notifications</p>
        </div>
    </div>
</div>


<div class="chat-panel" id="chatPanel">
    <div class="chat-panel-header">
        <h3><i class="fas fa-comments"></i> Messages</h3>
        <button class="chat-close-btn" onclick="toggleChatPanel()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="chat-conversations-list" id="conversationsList">
        <div class="chat-empty-state">
            <i class="fas fa-inbox"></i>
            <p>No conversations yet</p>
        </div>
    </div>
</div>

<div class="chat-window" id="chatWindow">
    <div class="chat-window-header">
        <button class="back-to-conversations" onclick="backToConversations()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="chat-avatar" id="chatWindowAvatar">U</div>
        <div class="chat-header-info">
            <h4 class="chat-header-name" id="chatWindowName">Customer</h4>
        </div>
    </div>

    <!-- âœ… REDESIGNED: PINNED MESSAGE SECTION -->
    <div class="owner-pinned-section" id="ownerPinnedSection">
        <div class="owner-pinned-section-header">
            <span class="owner-pinned-section-title">
                <i class="fas fa-thumbtack"></i> Pinned Messages
            </span>
            <button class="owner-pinned-collapse" onclick="toggleOwnerPinnedSection()">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div id="ownerPinnedMessagesList">
            <!-- Messages injected here -->
        </div>
    </div>

    <div class="chat-messages-container" id="chatMessagesContainer">
    </div>

    <div class="owner-see-pins-link" id="ownerSeePinsLink" onclick="openOwnerPinnedMessagesModal()">
        <i class="fas fa-thumbtack"></i> See All Pins
    </div>

    <div class="chat-input-container">
        <form class="chat-input-form" id="chatInputForm" onsubmit="sendMessage(event)">
            <input
                    type="text"
                    class="chat-input"
                    id="chatInput"
                    placeholder="Type a message..."
                    autocomplete="off"
            >
            <button type="submit" class="chat-send-btn" id="chatSendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>


{% block main_content %}
<main class="main-content">
    {% if is_suspended %}
    <div class="suspension-warning">
        <i class="fas fa-exclamation-circle"></i> Your store is currently suspended. Please contact an administrator.
    </div>
    {% endif %}

    <div class="dashboard-layout">

        <aside class="dashboard-sidebar">

            <header class="store-header">
                <div class="cover-photo" onclick="openProfileImageModal()">
                    <img id="storeCoverPhoto"
                         src="{% if establishment.image %}{{ establishment.image.url }}{% else %}{% static 'images/cover_photo_default.jpg' %}{% endif %}"
                         alt="Cover">
                </div>
                <div class="header-info">
                    <div class="profile-pic" onclick="openProfileImageModal()">
                        <img id="profileImageView"
                             src="{% if establishment.image %}{{ establishment.image.url }}{% else %}{% static 'images/default_profile.png' %}{% endif %}"
                             alt="Profile">
                    </div>
                    <div class="store-info">
                        <h1 id="establishmentName">{{ establishment.name }}</h1>
                        <p id="establishmentAddress">{{ establishment.address }}</p>
                        <span class="status-badge status-{{ establishment.calculated_status|lower }}"
                              id="establishmentStatus"
                              data-opening-time="{{ establishment.opening_time|time:'H:i' }}"
                              data-closing-time="{{ establishment.closing_time|time:'H:i' }}">
    {% if establishment.calculated_status == 'Open' %}
          Open Now
    {% else %}
         Closed Now
    {% endif %}
</span>
                    </div>
                </div>
            </header>
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-transparent" onclick="openModal('addMenuItemModal')">
                            <i class="fas fa-plus"></i> Add Menu Item
                        </button>
                        <button class="btn btn-transparent" onclick="openModal('updateStoreDetailsModal')">
                            <i class="fas fa-edit"></i> Update Details
                        </button>
                        <button class="btn btn-transparent" onclick="openModal('storeReviewsModal')">
                            <i class="fas fa-star"></i> View Reviews
                        </button>
                        <button class="btn btn-transparent" onclick="openModal('viewStoreDetailsModal')">
                            <i class="fas fa-info-circle"></i> View Details
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-chart-bar"></i> Statistics
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div>
                                <div class="stat-number">{{ total_reviews }}</div>
                                <div class="stat-label">Total Reviews</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div>
                                <div class="stat-number">{{ average_rating }}/5.0</div>
                                <div class="stat-label">Average Rating</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <section class="dashboard-content">
<div style="background: white; border-radius: 12px; padding: 14px 18px; margin-bottom: 24px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; gap: 20px;">
    <!-- LEFT SIDE: Welcome Text -->
    <div style="flex: 1;">
        <h2 style="font-size: 18px; font-weight: 700; color: var(--text-dark); margin-bottom: 3px;">
            Owner Dashboard
        </h2>
        <p style="color: var(--text-muted); font-size: 13px;">
            Welcome back! Manage your establishment <span style="color: var(--primary); font-weight: 600;">{{ establishment.name }}</span> here.
        </p>
    </div>

    <!-- RIGHT SIDE: Stats Display -->
    <div class="store-stats-display" style="margin: 0; flex-shrink: 0;">
        <div class="stat-card">
            <div class="stat-icon bestseller">
                <i class="fas fa-award"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="bestSellerCount">0</div>
                <div class="stat-label">Best Sellers</div>
            </div>
        </div>

        <div class="stat-divider"></div>

        <div class="stat-card">
            <div class="stat-icon available">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="availableCount">0</div>
                <div class="stat-label">Available Items</div>
            </div>
        </div>
    </div>
</div>

            <div class="card menu-section">
                <div class="card-title-center">
                    <i class="fas fa-hamburger"></i> Your Menu
                </div>
                {% if menu_items %}
                <div class="menu-grid">
                    {% for item in menu_items %}
                    <div class="menu-card" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}"
                         data-item-description="{{ item.description }}" data-item-price="{{ item.price|floatformat:2 }}"
                         data-item-quantity="{{ item.quantity|default:0 }}"
                         data-item-image-url="{% if item.image %}{{ item.image.url }}{% endif %}">
                        <div class="menu-image">
                            <img src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/default_menu_item.png' %}{% endif %}"
                                 alt="{{ item.name }}">
                            <div class="badges-container">
                                {% if item.is_top_seller %}
                                <span class="badge bestseller">
                                        <i class="fas fa-award"></i> Best Seller
                                    </span>
                                {% endif %}
                                {% if item.quantity > 0 %}
                                <span class="badge available">Available: {{ item.quantity }}</span>
                                {% else %}
                                <span class="badge soldout">Out of Stock</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="menu-info">
                            <div class="menu-name">{{ item.name }}</div>
                            <div class="menu-desc">{{ item.description }}</div>
                            <div class="menu-price">â‚±{{ item.price|floatformat:2 }}</div>
                            <div class="menu-actions">
                                <button class="action-btn edit" onclick="openEditModal('{{ item.id }}')">
                                    <i class="fas fa-pen"></i> Edit
                                </button>
                                <form action="{% url 'toggle_top_seller' item.id %}" method="post"
                                      style="display: contents;">
                                    {% csrf_token %}
                                    <button type="submit" class="action-btn seller">
                                        <i class="fas fa-award"></i> {% if item.is_top_seller %}Unmark{% else %}Mark
                                        {% endif %}
                                    </button>
                                </form>
                                <button type="button" class="action-btn delete"
                                        onclick="deleteMenuItem('{{ item.id }}', this)">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-items">
                    <i class="fas fa-inbox"></i>
                    <p>No menu items yet. Add your first item to get started!</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>
</main>
{% endblock %}


<div class="modal" id="viewStoreDetailsModal">
    <div class="modal-content" style="max-width: 450px;">
        <button class="modal-close" onclick="closeModal('viewStoreDetailsModal')">Ã—</button>
        <h2><i class="fas fa-info-circle"></i> Store Details</h2>
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <!-- Category -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">Category</label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentCategory">
                    {{ establishment.category.name|default:"N/A" }}
                </p>
            </div>

            <!-- Operating Hours -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">
                    <i class="fas fa-clock"></i> Operating Hours
                </label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentHours">
                    {% if establishment.opening_time and establishment.closing_time %}
                    {{ establishment.opening_time|time:"g:i A" }} - {{ establishment.closing_time|time:"g:i A" }}
                    {% else %}
                    Not Set
                    {% endif %}
                </p>
            </div>

            <!-- Amenities -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">Amenities</label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentAmenities">
                    {% for amenity in establishment.amenities.all %}
                    {{ amenity.name }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                    N/A
                    {% endfor %}
                </p>
            </div>

            <!-- Payment Methods -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">Payment
                    Methods</label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentPaymentMethods">
                    {{ establishment.payment_methods|default:"N/A" }}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="updateStoreDetailsModal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeModal('updateStoreDetailsModal')">Ã—</button>
        <h2><i class="fas fa-edit"></i> Update Store Details</h2>
        <form method="POST" enctype="multipart/form-data" class="modal-form" id="updateStoreDetailsForm"
              action="{% url 'update_establishment_details_ajax' pk=pk %}">
            {% csrf_token %}
            <input type="hidden" name="update_status" value="1">
            <input type="hidden" name="update_token" id="update_token" value="{{ update_token }}">

            <!-- Establishment Name -->
            <div class="form-group">
                {{ status_form.name.label_tag }}
                {{ status_form.name }}
            </div>

            <!-- Address (Auto-filled, Read-only) -->
            <div class="form-group">
                <label for="id_address">
                    Address
                    <span style="color: #999; font-size: 11px; font-weight: normal;">
            (Auto-filled from pin location)
        </span>
                </label>
                <textarea
                        name="address"
                        id="id_address"
                        rows="3"
                        readonly
                        placeholder="Pin your location on the map to auto-fill address">{{ establishment.address }}</textarea>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 4px;">
                    <i class="fas fa-info-circle"></i> Address is automatically set when you pin your location on the
                    map
                </small>
            </div>

            <!-- Pin Location Button -->
            <div class="form-group">
                <label>Pin Location <span style="color: red;">*</span></label>
                <button type="button" class="btn btn-secondary" onclick="openLocationModal()"
                        style="width: 100%; justify-content: center;">
                    <i class="fas fa-map-marker-alt"></i> Set Location on Map
                </button>
                <small id="locationStatus">
                    {% if establishment.latitude and establishment.longitude %}
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Location set: {{ establishment.latitude|floatformat:6 }}, {{ establishment.longitude|floatformat:6
                    }}
                    {% else %}
                    <i class="fas fa-exclamation-circle" style="color: var(--error);"></i>
                    No location set yet
                    {% endif %}
                </small>
            </div>

            <!-- Hidden fields for coordinates -->
            <input type="hidden" name="latitude" id="id_latitude" value="{{ establishment.latitude|default:'' }}">
            <input type="hidden" name="longitude" id="id_longitude" value="{{ establishment.longitude|default:'' }}">
            <input type="hidden" id="previous_lat" value="{{ establishment.latitude|default:'' }}">
            <input type="hidden" id="previous_lng" value="{{ establishment.longitude|default:'' }}">

            <!-- Status -->
            <div class="form-group">
                <label for="id_opening_time">
                    <i class="fas fa-clock"></i> Opening Time
                </label>
                <input type="time"
                       id="id_opening_time"
                       name="opening_time"
                       value="{{ establishment.opening_time|time:'H:i'|default:'' }}"
                       class="form-control">
                <small class="form-text text-muted">Example: 08:00 for 8:00 AM</small>
            </div>

            <div class="form-group">
                <label for="id_closing_time">
                    <i class="fas fa-moon"></i> Closing Time
                </label>
                <input type="time"
                       id="id_closing_time"
                       name="closing_time"
                       value="{{ establishment.closing_time|time:'H:i'|default:'' }}"
                       class="form-control">
                <small class="form-text text-muted">Example: 22:00 for 10:00 PM</small>
            </div>

            <!-- Category -->
            <div class="form-group">
                {{ status_form.category.label_tag }}
                {{ status_form.category }}
            </div>

            <!-- Amenities -->
            <div class="form-group">
                {{ status_form.amenities.label_tag }}
                {{ status_form.amenities }}
            </div>

            <!-- Payment Methods -->
            <div class="form-group">
                <label>Payment Methods</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="payment_cash" name="payment_methods" value="Cash"
                               {% if 'Cash' in establishment.payment_methods %}checked{% endif %}>
                        <label for="payment_cash">Cash</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="payment_gcash" name="payment_methods" value="GCash"
                               {% if 'GCash' in establishment.payment_methods %}checked{% endif %}>
                        <label for="payment_gcash">GCash</label>
                    </div>
                </div>
            </div>

            <!-- Store Image -->
            <div class="form-group">
                {{ status_form.image.label_tag }}
                {% if establishment.image %}
                <img src="{{ establishment.image.url }}" alt="Current"
                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; display: block;">
                {% endif %}
                {{ status_form.image }}
            </div>

            <!-- Submit Button -->
            <button type="submit" name="update_status" class="btn btn-primary"
                    style="width: 100%; justify-content: center; margin-top: 16px;">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </form>
    </div>
</div>

<div class="modal" id="addMenuItemModal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeModal('addMenuItemModal')">Ã—</button>
        <h2><i class="fas fa-plus"></i> Add New Menu Item</h2>

        <div id="debugInfo"
             style="display:none; background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 12px;">
            <strong>Debug:</strong> <span id="debugMessage"></span>
        </div>

        <form method="POST" enctype="multipart/form-data" class="modal-form" id="addMenuItemForm">
            {% csrf_token %}
            <input type="hidden" name="add_menu_item" value="1">
            <input type="hidden" name="menu_add_token" value="{{ menu_add_token }}">

            <div class="form-group">
                <label for="id_name">Menu Name *</label>
                <input type="text" name="name" id="id_name" required maxlength="100">
            </div>

            <div class="form-group">
                <label for="id_description">Description *</label>
                <textarea name="description" id="id_description" required rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="id_price">Price (â‚±) *</label>
                <input type="number" name="price" id="id_price" step="0.01" min="0" required>
            </div>

            <div class="form-group">
                <label for="id_quantity">Quantity</label>
                <input type="number" name="quantity" id="id_quantity" min="0" value="0">
            </div>

            <div class="form-group">
                <label for="id_image">Image (Optional)</label>
                <input type="file" name="image" id="id_image" accept="image/*">
                <small style="color: #666; font-size: 12px;">Recommended: JPG or PNG, max 5MB</small>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                <i class="fas fa-plus"></i> Add Item
            </button>
        </form>
    </div>
</div>

<div class="modal" id="editMenuItemModal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeModal('editMenuItemModal')">Ã—</button>
        <h2><i class="fas fa-edit"></i> Edit Menu Item</h2>
        <form id="editMenuItemForm" method="post" action="" enctype="multipart/form-data" class="modal-form">
            {% csrf_token %}
            <input type="hidden" name="item_id" id="edit_item_id">
            <div class="form-group">
                <label for="edit_item_name">Menu Name</label>
                <input type="text" name="name" id="edit_item_name" required>
            </div>
            <div class="form-group">
                <label for="edit_item_description">Description</label>
                <textarea name="description" id="edit_item_description" required></textarea>
            </div>
            <div class="form-group">
                <label for="edit_item_price">Price</label>
                <input type="text" name="price" id="edit_item_price" required>
            </div>
            <div class="form-group">
                <label for="id_quantity_edit">Quantity</label>
                <input type="number" name="quantity" id="id_quantity_edit" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="edit_item_image">New Image</label>
                <input type="file" name="image" id="edit_item_image" accept="image/*">
                <img id="edit_current_item_image" src="" alt="Current"
                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-top: 8px; display: none;">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </form>
    </div>
</div>

<div class="modal" id="storeReviewsModal">
    <div class="modal-content" style="max-width: 600px; max-height: 70vh;">
        <button class="modal-close" onclick="closeModal('storeReviewsModal')">Ã—</button>
        <h2><i class="fas fa-star"></i> Customer Reviews</h2>
        <div style="display: flex; gap: 16px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
            <div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">{{ total_reviews }}</div>
                <div style="font-size: 13px; color: var(--text-muted);">Total Reviews</div>
            </div>
            {% if average_rating > 0 %}
            <div>
                <div style="font-size: 24px; font-weight: 700; color: var(--primary);">{{ average_rating }}/5.0</div>
                <div style="font-size: 13px; color: var(--text-muted);">
                    {% for i in "12345" %}
                    <i class="fas fa-star{% if forloop.counter > average_rating|floatformat:0 %}-o{% endif %}"
                       style="color: #ffb400;"></i>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            {% for review in dashboard_reviews %}
            <div style="padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div style="font-weight: 700;">{{ review.user.username }}</div>
                    <div style="color: #ffb400;">
                        {% for i in "12345" %}
                        <i class="fas fa-star{% if forloop.counter > review.rating %}-o{% endif %}"></i>
                        {% endfor %}
                    </div>
                </div>
                <p style="margin-bottom: 8px; color: var(--text-muted); font-size: 14px;">{{ review.comment }}</p>
                {% if review.image %}
                <img src="{{ review.image.url }}" alt="Review"
                     style="max-width: 100%; max-height: 150px; border-radius: 6px; margin-bottom: 8px;">
                {% endif %}
                <div style="font-size: 12px; color: #9aa0a6;">{{ review.created_at|date:"M d, Y" }}</div>
            </div>
            {% empty %}
            <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                <i class="fas fa-inbox" style="font-size: 32px; opacity: 0.3; display: block; margin-bottom: 12px;"></i>
                No reviews yet
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal" id="ownerProfileImageModal" style="background: rgba(0, 0, 0, 0.9);">
    <button class="modal-close" onclick="closeModal('ownerProfileImageModal')" style="color: white;">Ã—</button>
    <img id="ownerModalImageView" src="" alt="Profile"
         style="max-width: 90%; max-height: 90vh; border-radius: var(--radius);">
</div>

<div class="modal" id="mapModal">
    <div class="modal-content" style="max-width: 900px; padding: 16px;">
        <button class="modal-close" onclick="closeModal('mapModal')">Ã—</button>

        <h2 style="margin-bottom: 8px;">
            <i class="fas fa-map-marker-alt"></i> Set Establishment Location
        </h2>

        <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
            ðŸ“ Click or drag the pin inside the red circle (500m from CvSU-Bacoor)
        </p>

        <!-- Current Location Display - Simplified & Responsive -->
        <div class="location-display-card">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="location-icon"
                     style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                    ðŸ“
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="location-label"
                         style="font-size: 11px; opacity: 0.9; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        Current Location
                    </div>
                    <div class="location-coords" id="currentLocationDisplay"
                         style="font-size: 16px; font-weight: 700; margin-top: 2px; word-break: break-all;">
                        {{ location_display }}
                    </div>
                    <div class="location-status" style="font-size: 11px; opacity: 0.8; margin-top: 2px;">
                        {% if has_location %}
                        âœ“ Location is set
                        {% else %}
                        âš  Please pin location
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Address Display - Simplified & Responsive -->
        <div class="address-display-card" id="geocodedAddressDisplay" style="display: none;">
            <div style="display: flex; align-items: start; gap: 10px;">
                <div class="address-icon" style="font-size: 22px; flex-shrink: 0;">ðŸ </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="address-title"
                         style="font-weight: 700; color: #2e7d32; margin-bottom: 4px; font-size: 12px;">
                        NEW ADDRESS FOR THIS LOCATION
                    </div>
                    <div class="address-text" id="geocodedAddressText"
                         style="color: #1b5e20; font-size: 13px; line-height: 1.5; word-break: break-word;">
                        <i class="fas fa-spinner fa-spin"></i> Getting address...
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Container - Responsive -->
        <div id="map"></div>

        <!-- Action Buttons - Responsive -->
        <div class="map-actions">
            <button type="button" class="btn btn-secondary" onclick="resetToCvSU()">
                <i class="fas fa-crosshairs"></i> Reset to CvSU
            </button>

            <div class="map-info-text" style="text-align: center; font-size: 12px; color: #666;">
                <i class="fas fa-info-circle"></i> Drag pin or click to set location
            </div>

            <button type="button" class="btn btn-primary" onclick="confirmMapLocation()">
                <i class="fas fa-check-circle"></i> Confirm Location
            </button>
        </div>
    </div>
</div>

<input type="hidden" name="latitude" id="id_latitude" value="{{ current_lat }}">
<input type="hidden" name="longitude" id="id_longitude" value="{{ current_lng }}">
<input type="hidden" id="previous_lat" value="{{ current_lat }}">
<input type="hidden" id="previous_lng" value="{{ current_lng }}">

<div class="message-context-menu" id="ownerMessageContextMenu">
    <div class="context-menu-item" onclick="pinOwnerMessage()">
        <i class="fas fa-thumbtack"></i>
        <span id="ownerPinMenuText">Pin</span>
    </div>
    <div class="context-menu-item danger" onclick="openOwnerUnsendModal()">
        <i class="fas fa-undo"></i>
        <span>Unsend</span>
    </div>
</div>

<div class="unsend-modal" id="ownerUnsendModal">
    <div class="unsend-modal-content">
        <h3>Who do you want to unsend this message for?</h3>

        <div class="unsend-option selected" data-type="everyone" onclick="selectOwnerUnsendOption('everyone')">
            <div class="unsend-option-title">
                <i class="fas fa-users"></i>
                Unsend for everyone
            </div>
            <div class="unsend-option-desc">
                This message will be unsent for everyone in the chat. Others may have already seen or forwarded it.
            </div>
        </div>

        <div class="unsend-option" data-type="you" onclick="selectOwnerUnsendOption('you')">
            <div class="unsend-option-title">
                <i class="fas fa-user"></i>
                Unsend for you
            </div>
            <div class="unsend-option-desc">
                This will remove the message from your devices. Other chat members will still be able to see it.
            </div>
        </div>

        <div class="unsend-modal-buttons">
            <button class="btn-cancel" onclick="closeOwnerUnsendModal()">Cancel</button>
            <button class="btn-remove" onclick="confirmOwnerUnsend()">Remove</button>
        </div>
    </div>
</div>

<div class="pinned-messages-modal" id="ownerPinnedMessagesModal">
    <div class="pinned-messages-modal-content">
        <h3><i class="fas fa-thumbtack"></i> Pinned Messages</h3>
        <div class="pinned-messages-list" id="ownerPinnedMessagesListModal">
        </div>
        <div class="pinned-messages-empty" id="ownerPinnedMessagesEmpty" style="display: none;">
            <i class="fas fa-inbox"></i>
            <p>No pinned messages</p>
        </div>
        <div style="margin-top: 20px; text-align: center;">
            <button class="btn-cancel" onclick="closeOwnerPinnedMessagesModal()">Close</button>
        </div>
    </div>
</div>


{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/food_establishment_dashboard.js' %}"></script>
{% endblock %}

<script src="{% static 'js/status_updater.js' %}"></script>

<script>
    const establishmentId = {{ establishment.id }};
    const currentUserId = {{ request.user.id }};
    let activeCustomerId = null;
    let chatSocket = null;
    let ownerContextMenuMessageId = null;
    let ownerSelectedUnsendType = 'everyone';
    let ownerPinnedMessages = new Set();
    let ownerMessagesCache = [];

    // Long press detection variables
    let longPressTimer = null;
    let longPressTriggered = false;
    const LONG_PRESS_DURATION = 500;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function toggleChatPanel() {
        const panel = document.getElementById('chatPanel');
        const chatWindow = document.getElementById('chatWindow');

        if (panel.classList.contains('open')) {
            panel.classList.remove('open');
        } else {
            panel.classList.add('open');
            chatWindow.classList.remove('open');
            loadConversations();
        }
    }

    function loadConversations() {
        fetch(`/owner/chat/conversations/${establishmentId}/`)
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('conversationsList');

                if (data.conversations && data.conversations.length > 0) {
                    list.innerHTML = data.conversations.map(conv => {
                        const safeName = conv.customer_name.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                        return `
                        <div class="chat-conversation-item" onclick="openConversation(${conv.customer_id}, '${safeName}')">
                            <div class="chat-avatar">${conv.customer_name.charAt(0).toUpperCase()}</div>
                            <div class="chat-conversation-info">
                                <div class="chat-conversation-name">${conv.customer_name}</div>
                                <div class="chat-conversation-preview">${conv.last_message || 'No messages yet'}</div>
                            </div>
                            <div class="chat-conversation-time">${conv.time || ''}</div>
                            ${conv.unread_count > 0 ? `<div class="chat-unread-badge">${conv.unread_count}</div>` : ''}
                        </div>
                    `}).join('');

                    const totalUnread = data.conversations.reduce((sum, conv) => sum + (conv.unread_count || 0), 0);
                    updateChatBadge(totalUnread);
                } else {
                    list.innerHTML = `
                        <div class="chat-empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No conversations yet</p>
                        </div>
                    `;
                    updateChatBadge(0);
                }
            })
            .catch(error => {
                console.error('Error loading conversations:', error);
            });
    }

    function openConversation(customerId, customerName) {
        activeCustomerId = customerId;

        document.getElementById('chatWindowName').textContent = customerName;
        document.getElementById('chatWindowAvatar').textContent = customerName.charAt(0).toUpperCase();

        document.getElementById('chatPanel').classList.remove('open');
        document.getElementById('chatWindow').classList.add('open');

        loadMessages(customerId);
        connectWebSocket(customerId);
    }

    function backToConversations() {
        document.getElementById('chatWindow').classList.remove('open');
        document.getElementById('chatPanel').classList.add('open');

        if (chatSocket) {
            chatSocket.close();
            chatSocket = null;
        }

        activeCustomerId = null;
        ownerPinnedMessages.clear();
        ownerMessagesCache = [];
        loadConversations();
    }

    function loadOwnerPinnedMessages() {
        if (!activeCustomerId) return;

        const stored = localStorage.getItem(`owner_pinned_${activeCustomerId}_${establishmentId}`);
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                ownerPinnedMessages = new Set(parsed);
            } catch (e) {
                ownerPinnedMessages = new Set();
            }
        }
    }

    function saveOwnerPinnedMessages() {
        if (!activeCustomerId) return;

        const arr = Array.from(ownerPinnedMessages);
        localStorage.setItem(`owner_pinned_${activeCustomerId}_${establishmentId}`, JSON.stringify(arr));
    }

    function loadMessages(customerId) {
        const container = document.getElementById('chatMessagesContainer');
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Loading messages...</div>';

        // Load pinned messages for this conversation
        loadOwnerPinnedMessages();
        ownerMessagesCache = [];

        fetch(`/owner/chat/messages/${customerId}/${establishmentId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    container.innerHTML = '';

                    data.messages.forEach(msg => {
                        const msgData = {
                            id: msg.id,
                            sender_id: msg.sender_id,
                            content: msg.content,
                            timestamp: msg.timestamp
                        };
                        ownerMessagesCache.push(msgData);

                        const senderId = parseInt(msg.sender_id);
                        const ownerId = parseInt(currentUserId);
                        const isMyMessage = senderId === ownerId;

                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${isMyMessage ? 'sent' : 'received'}`;
                        messageDiv.dataset.messageId = msg.id;

                        // Check if pinned
                        if (ownerPinnedMessages.has(msg.id)) {
                            messageDiv.classList.add('pinned');
                        }

                        const optionsButton = isMyMessage ? `
                            <button class="message-options-btn" onclick="showOwnerOptionsMenu(event, ${msg.id})">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        ` : '';

                        messageDiv.innerHTML = `
                            ${optionsButton}
                            <div class="chat-message-bubble">
                                <div>${escapeHtml(msg.content)}</div>
                                <span class="chat-message-time">${msg.timestamp}</span>
                            </div>
                        `;

                        if (isMyMessage) {
                            attachLongPressHandlers(messageDiv, msg.id);
                        }

                        container.appendChild(messageDiv);
                    });

                    updateOwnerPinnedSection();
                } else {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No messages yet. Start the conversation! ðŸ’¬</div>';
                }

                scrollToBottom();
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #f00;">Failed to load messages</div>';
            });
    }

    function connectWebSocket(customerId) {
        if (chatSocket) {
            chatSocket.close();
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${customerId}/${establishmentId}/`;

        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function(e) {
            console.log('âœ… Chat connected');
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if (data.type === 'chat_message') {
                addMessageToChat(data);
            }
            else if (data.type === 'message_unsent') {
                handleOwnerMessageUnsent(data);
            }
        };

        chatSocket.onerror = function(e) {
            console.error('Chat connection error');
        };

        chatSocket.onclose = function(e) {
            console.log('Chat disconnected');
        };
    }

    function sendMessage(event) {
        event.preventDefault();

        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message || !chatSocket || !activeCustomerId) {
            return;
        }

        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'message': message,
            'sender_id': currentUserId
        }));

        input.value = '';
        input.focus();
    }

    function addMessageToChat(data) {
        const container = document.getElementById('chatMessagesContainer');
        const messageDiv = document.createElement('div');

        const senderId = parseInt(data.sender_id);
        const ownerId = parseInt(currentUserId);
        const isMyMessage = senderId === ownerId;

        messageDiv.className = `chat-message ${isMyMessage ? 'sent' : 'received'}`;
        messageDiv.dataset.messageId = data.message_id;

        // Add to cache
        ownerMessagesCache.push({
            id: data.message_id,
            sender_id: data.sender_id,
            content: data.message,
            timestamp: data.timestamp
        });

        const optionsButton = isMyMessage ? `
            <button class="message-options-btn" onclick="showOwnerOptionsMenu(event, ${data.message_id})">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        ` : '';

        messageDiv.innerHTML = `
            ${optionsButton}
            <div class="chat-message-bubble">
                <div>${escapeHtml(data.message)}</div>
                <span class="chat-message-time">${data.timestamp}</span>
            </div>
        `;

        if (isMyMessage) {
            attachLongPressHandlers(messageDiv, data.message_id);
        }

        container.appendChild(messageDiv);
        scrollToBottom();
    }

    // ==========================================
    // LONG PRESS DETECTION (MOBILE)
    // ==========================================

    function attachLongPressHandlers(messageElement, messageId) {
        // Touch events
        messageElement.addEventListener('touchstart', function(e) {
            longPressTriggered = false;
            messageElement.classList.add('long-pressing');

            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                messageElement.classList.remove('long-pressing');

                const touch = e.touches[0];
                showOwnerContextMenuAtPosition(touch.clientX, touch.clientY, messageId);

                e.preventDefault();
            }, LONG_PRESS_DURATION);
        }, { passive: false });

        messageElement.addEventListener('touchend', function(e) {
            clearTimeout(longPressTimer);
            messageElement.classList.remove('long-pressing');

            if (longPressTriggered) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        messageElement.addEventListener('touchmove', function(e) {
            clearTimeout(longPressTimer);
            messageElement.classList.remove('long-pressing');
        });

        // Mouse events (for desktop)
        messageElement.addEventListener('mousedown', function(e) {
            if (e.button !== 0) return;

            longPressTriggered = false;

            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                showOwnerContextMenuAtPosition(e.clientX, e.clientY, messageId);
            }, LONG_PRESS_DURATION);
        });

        messageElement.addEventListener('mouseup', function(e) {
            clearTimeout(longPressTimer);
        });

        messageElement.addEventListener('mouseleave', function(e) {
            clearTimeout(longPressTimer);
        });
    }

    // ==========================================
    // CONTEXT MENU (DESKTOP & MOBILE FIX)
    // ==========================================

    function showOwnerOptionsMenu(event, messageId) {
        event.stopPropagation();
        event.preventDefault();

        const rect = event.target.closest('button').getBoundingClientRect();
        showOwnerContextMenuAtPosition(rect.left, rect.bottom + 5, messageId);
    }

    function showOwnerContextMenuAtPosition(x, y, messageId) {
        const contextMenu = document.getElementById('ownerMessageContextMenu');
        ownerContextMenuMessageId = messageId;

        // Update pin/unpin text
        const isPinned = ownerPinnedMessages.has(messageId);
        document.getElementById('ownerPinMenuText').textContent = isPinned ? 'Unpin' : 'Pin';

        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';

        // Adjust if menu goes off-screen
        setTimeout(() => {
            const menuRect = contextMenu.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (menuRect.right > windowWidth) {
                contextMenu.style.left = (x - menuRect.width) + 'px';
            }

            if (menuRect.bottom > windowHeight) {
                contextMenu.style.top = (y - menuRect.height - 10) + 'px';
            }
        }, 10);

        contextMenu.classList.add('active');

        // âœ… FIX: Delay listening for clicks slightly
        setTimeout(() => {
            document.addEventListener('click', hideOwnerContextMenu);
            document.addEventListener('touchstart', hideOwnerContextMenu);
        }, 100);
    }

    function hideOwnerContextMenu(e) {
        const contextMenu = document.getElementById('ownerMessageContextMenu');

        // âœ… CRITICAL FIX: Don't close if clicking INSIDE the menu
        if (contextMenu && contextMenu.contains(e.target)) {
            return;
        }

        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideOwnerContextMenu);
        document.removeEventListener('touchstart', hideOwnerContextMenu);
    }

    function updateChatBadge(count) {
        const badge = document.getElementById('chatBadge');
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }

    function scrollToBottom() {
        const container = document.getElementById('chatMessagesContainer');
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==========================================
    // PIN FUNCTIONALITY (PERSISTENT)
    // ==========================================

    function pinOwnerMessage() {
        // âœ… FORCE CLOSE MENU MANUALLY (Since we prevented auto-close inside menu)
        const contextMenu = document.getElementById('ownerMessageContextMenu');
        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideOwnerContextMenu);
        document.removeEventListener('touchstart', hideOwnerContextMenu);

        if (!ownerContextMenuMessageId) return;

        const messageEl = document.querySelector(`.chat-message[data-message-id="${ownerContextMenuMessageId}"]`);
        if (!messageEl) return;

        const isPinned = ownerPinnedMessages.has(ownerContextMenuMessageId);

        if (isPinned) {
            // Unpin
            ownerPinnedMessages.delete(ownerContextMenuMessageId);
            messageEl.classList.remove('pinned');
        } else {
            // Pin
            ownerPinnedMessages.add(ownerContextMenuMessageId);
            messageEl.classList.add('pinned');
        }

        saveOwnerPinnedMessages();
        updateOwnerPinnedSection();
    }

    function updateOwnerPinnedSection() {
        const pinnedSection = document.getElementById('ownerPinnedSection');
        const pinnedList = document.getElementById('ownerPinnedMessagesList');
        const seePinsLink = document.getElementById('ownerSeePinsLink');

        if (ownerPinnedMessages.size === 0) {
            pinnedSection.classList.remove('active');
            seePinsLink.classList.remove('active');
            return;
        }

        pinnedSection.classList.add('active');
        seePinsLink.classList.add('active');

        // Show max 3 pinned messages in section
        pinnedList.innerHTML = '';
        const pinnedArray = Array.from(ownerPinnedMessages).slice(-3);

        pinnedArray.forEach(msgId => {
            const msg = ownerMessagesCache.find(m => m.id === msgId);
            if (msg) {
                const item = document.createElement('div');
                item.className = 'pinned-message-item';
                item.onclick = function() {
                     // Scroll to message functionality
                    const el = document.querySelector(`.chat-message[data-message-id="${msgId}"]`);
                    if(el) el.scrollIntoView({behavior: "smooth", block: "center"});
                };
                item.innerHTML = `
                    <i class="fas fa-thumbtack"></i>
                    <span class="pinned-message-text">${escapeHtml(msg.content)}</span>
                    <button class="unpin-btn" onclick="unpinOwnerMessage(${msgId}, event)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                pinnedList.appendChild(item);
            }
        });
    }

    function unpinOwnerMessage(messageId, event) {
        if (event) {
            event.stopPropagation();
        }

        ownerPinnedMessages.delete(messageId);
        saveOwnerPinnedMessages();

        const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
        if (messageEl) {
            messageEl.classList.remove('pinned');
        }

        updateOwnerPinnedSection();
    }

    // âœ… UPDATED TOGGLE FUNCTION
    function toggleOwnerPinnedSection() {
        const list = document.getElementById('ownerPinnedMessagesList');
        const icon = document.querySelector('.owner-pinned-collapse i');

        if (list.style.display === 'none') {
            list.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
        } else {
            list.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
        }
    }

    // ==========================================
    // PINNED MESSAGES MODAL
    // ==========================================

    function openOwnerPinnedMessagesModal() {
        const modal = document.getElementById('ownerPinnedMessagesModal');
        const modalList = document.getElementById('ownerPinnedMessagesListModal');
        const emptyState = document.getElementById('ownerPinnedMessagesEmpty');

        if (ownerPinnedMessages.size === 0) {
            modalList.innerHTML = '';
            emptyState.style.display = 'block';
        } else {
            emptyState.style.display = 'none';
            modalList.innerHTML = '';

            Array.from(ownerPinnedMessages).forEach(msgId => {
                const msg = ownerMessagesCache.find(m => m.id === msgId);
                if (msg) {
                    const item = document.createElement('div');
                    item.className = 'pinned-message-item';
                    item.innerHTML = `
                        <i class="fas fa-thumbtack"></i>
                        <span class="pinned-message-text">${escapeHtml(msg.content)}</span>
                        <button class="unpin-btn" onclick="unpinOwnerMessage(${msgId}, event)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    modalList.appendChild(item);
                }
            });
        }

        modal.classList.add('active');
    }

    function closeOwnerPinnedMessagesModal() {
        const modal = document.getElementById('ownerPinnedMessagesModal');
        modal.classList.remove('active');
    }

    // ==========================================
    // UNSEND FUNCTIONALITY (PERSISTENT)
    // ==========================================

    function openOwnerUnsendModal() {
        // âœ… FORCE CLOSE MENU MANUALLY
        const contextMenu = document.getElementById('ownerMessageContextMenu');
        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideOwnerContextMenu);
        document.removeEventListener('touchstart', hideOwnerContextMenu);

        const modal = document.getElementById('ownerUnsendModal');
        modal.classList.add('active');
        ownerSelectedUnsendType = 'everyone';
    }

    function closeOwnerUnsendModal() {
        const modal = document.getElementById('ownerUnsendModal');
        modal.classList.remove('active');
        ownerContextMenuMessageId = null;
    }

    function selectOwnerUnsendOption(type) {
        ownerSelectedUnsendType = type;

        document.querySelectorAll('#ownerUnsendModal .unsend-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`#ownerUnsendModal .unsend-option[data-type="${type}"]`).classList.add('selected');
    }

    function confirmOwnerUnsend() {
        if (!ownerContextMenuMessageId || !chatSocket) {
            console.error('Cannot unsend: missing message ID or socket');
            return;
        }

        const removeBtn = document.querySelector('#ownerUnsendModal .btn-remove');
        removeBtn.disabled = true;
        removeBtn.textContent = 'Removing...';

        chatSocket.send(JSON.stringify({
            'type': 'unsend_message',
            'message_id': ownerContextMenuMessageId,
            'unsend_type': ownerSelectedUnsendType,
            'sender_id': currentUserId
        }));

        setTimeout(() => {
            closeOwnerUnsendModal();
            removeBtn.disabled = false;
            removeBtn.textContent = 'Remove';
        }, 500);
    }

    function handleOwnerMessageUnsent(data) {
        const messageId = data.message_id;
        const unsendType = data.unsend_type;
        const unsent_by = parseInt(data.unsent_by);
        const ownerId = parseInt(currentUserId);

        const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);

        if (!messageEl) {
            return;
        }

        if (unsendType === 'everyone') {
            const bubble = messageEl.querySelector('.chat-message-bubble');
            messageEl.classList.add('deleted');

            const optionsBtn = messageEl.querySelector('.message-options-btn');
            if (optionsBtn) {
                optionsBtn.remove();
            }

            bubble.innerHTML = `
                <div>Message was unsent</div>
                <span class="chat-message-time">${new Date().toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}</span>
            `;

            ownerMessagesCache = ownerMessagesCache.filter(msg => msg.id !== messageId);
        }
        else if (unsendType === 'you' && unsent_by === ownerId) {
            messageEl.remove();
            ownerMessagesCache = ownerMessagesCache.filter(msg => msg.id !== messageId);
        }

        // Remove from pinned if it was pinned
        if (ownerPinnedMessages.has(messageId)) {
            ownerPinnedMessages.delete(messageId);
            saveOwnerPinnedMessages();
            updateOwnerPinnedSection();
        }
    }

    function debugLog(message) {
        console.log('ðŸ” DEBUG:', message);
        const debugDiv = document.getElementById('debugInfo');
        const debugMsg = document.getElementById('debugMessage');
        if (debugDiv && debugMsg) {
            debugMsg.textContent = message;
            debugDiv.style.display = 'block';
            setTimeout(() => {
                debugDiv.style.display = 'none';
            }, 5000);
        }
    }


    {% block page_javascript %}
    // Page-specific JavaScript
    {% endblock %}
</script>
<button id="scrollToTopBtn" class="scroll-to-top" style="z-index: 10000;">
    <i class="fas fa-arrow-up"></i>
</button>
</body>
<!-- ========================================== -->
<!-- SALES REPORT MODAL -->
<!-- ========================================== -->
<div id="salesReportModal" class="sales-report-modal">
    <div class="sales-report-content">
        <div class="sales-report-header">
            <h2 class="sales-report-title">
                <i class="fas fa-chart-bar"></i>
                Sales Report
            </h2>
            <button class="close-report-btn" onclick="closeSalesReportModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Report Filters -->
        <div class="report-filters">
            <div class="filter-group">
                <label>Period</label>
                <select id="reportPeriod" onchange="updateSalesReport()">
                    <option value="today">Today</option>
                    <option value="week" selected>This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="filter-group" id="customDateRangeGroup" style="display: none;">
                <label>From Date</label>
                <input type="date" id="reportStartDate">
            </div>
            <div class="filter-group" id="customDateRangeGroup2" style="display: none;">
                <label>To Date</label>
                <input type="date" id="reportEndDate">
            </div>
            <div class="filter-group" style="align-self: end;">
                <button class="apply-filters-btn" onclick="applyReportFilters()">
                    <i class="fas fa-sync"></i> Apply
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="sales-summary-cards">
            <div class="summary-card">
                <div class="summary-card-icon revenue">
                    <i class="fas fa-peso-sign"></i>
                </div>
                <div class="summary-card-label">Total Revenue</div>
                <div class="summary-card-value" id="totalRevenue">â‚±0.00</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon orders">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="summary-card-label">Total Orders</div>
                <div class="summary-card-value" id="totalOrders">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon average">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="summary-card-label">Average Order</div>
                <div class="summary-card-value" id="averageOrder">â‚±0.00</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon items">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="summary-card-label">Items Sold</div>
                <div class="summary-card-value" id="itemsSold">0</div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <h3 class="chart-title">Sales Trend</h3>
            <canvas id="salesChart" height="100"></canvas>
        </div>

        <!-- Top Selling Items -->
        <div class="chart-container">
            <h3 class="chart-title">Top Selling Items</h3>
            <div id="topSellingItems">
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                    <p style="margin-top: 12px;">Loading data...</p>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div style="display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap;">
            <button class="export-btn" onclick="exportSalesReportPDF()">
                <i class="fas fa-file-pdf"></i>
                Export PDF
            </button>
            <button class="export-btn" onclick="exportSalesReportExcel()">
                <i class="fas fa-file-excel"></i>
                Export Excel
            </button>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- PAYMENT SUCCESS PAGE - BACK TO DASHBOARD BUTTON -->
<!-- ========================================== -->
{% if payment_success %}
<div class="payment-success-container">
    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
        <i class="fas fa-check" style="font-size: 40px; color: white;"></i>
    </div>
    <h1 style="font-size: 32px; font-weight: 800; color: #1a1a1a; margin-bottom: 12px;">
        Payment Successful!
    </h1>
    <p style="color: #6b7280; font-size: 16px; margin-bottom: 32px;">
        Your order has been confirmed. Thank you for your purchase!
    </p>
    <a href="{% url 'food_establishment_dashboard' %}" class="back-to-dashboard-btn">
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
    </a>
</div>
{% endif %}


<footer class="footer">
    <div class="footer-container">
        <div class="footer-section">
            <h3>
                <i class="fas fa-utensils"></i>
                KabsuEats
            </h3>
            <p>Your trusted food shops platform connecting you with the best local restaurants and food
                establishments.</p>
            <div class="footer-social">
                <a href="#" class="social-icon" aria-label="Facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="#" class="social-icon" aria-label="Instagram">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="#" class="social-icon" aria-label="Twitter">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="#" class="social-icon" aria-label="TikTok">
                    <i class="fab fa-tiktok"></i>
                </a>
            </div>
        </div>

        <div class="footer-section">
            <h3>
                <i class="fas fa-link"></i>
                Quick Links
            </h3>
            <ul class="footer-links">
                <li><a href="#"><i class="fas fa-chevron-right"></i> About Us</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> How It Works</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Partner With Us</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Careers</a></li>
            </ul>
        </div>

        <div class="footer-section">
            <h3>
                <i class="fas fa-file-alt"></i>
                Legal
            </h3>
            <ul class="footer-links">
                <li><a href="#"><i class="fas fa-chevron-right"></i> Terms & Conditions</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Privacy Policy</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Cookie Policy</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Refund Policy</a></li>
            </ul>
        </div>

        <div class="footer-section">
            <h3>
                <i class="fas fa-headset"></i>
                Contact Us
            </h3>
            <ul class="footer-links">
                <li><a href="mailto:support@kabsueats.com"><i class="fas fa-envelope"></i> support@kabsueats.com</a>
                </li>
                <li><a href="tel:+639123456789"><i class="fas fa-phone"></i> +63 920 772 6237</a></li>
                <li><a href="#"><i class="fas fa-map-marker-alt"></i> Cavite, Philippines</a></li>
                <li><a href="#"><i class="fas fa-clock"></i> 24/7 Support</a></li>
            </ul>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2024 <a href="#">KabsuEats</a>. All rights reserved. Made with <i class="fas fa-heart"
                                                                                    style="color: var(--primary);"></i>
            in the Philippines</p>
    </div>
</footer>
</html>