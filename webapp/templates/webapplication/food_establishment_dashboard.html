{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}"/>
    <title>{% block page_title %}{{ establishment.name }} - Dashboard{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    {% block extra_head_links %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    {% endblock %}
    <link rel="stylesheet" href="{% static 'css/owner_dashboard_styless.css' %}">
    <style>
        /* ==========================================
           CRITICAL NAVBAR Z-INDEX FIX
           Must load after external CSS to override
           ========================================== */
        nav.navbar {
            z-index: 1050 !important;
            position: fixed !important;
        }
        nav.navbar .navbar-actions,
        nav.navbar .notification-toggle-btn,
        nav.navbar .chat-toggle-btn,
        nav.navbar .navbar-btn,
        nav.navbar .navbar-dropdown {
            z-index: 1051 !important;
            position: relative !important;
            pointer-events: auto !important;
        }
        /* Dropdown must FLOAT above page, not push content down */
        nav.navbar .navbar-menu {
            position: absolute !important;
            top: 100% !important;
            right: 0 !important;
            z-index: 1052 !important;
            pointer-events: auto !important;
        }
        .main-content, .page-container {
            z-index: 0 !important;
            position: relative !important;
        }
        /* ==========================================
           COLLAPSIBLE NOTIFICATION - EMAIL ONLY VIEW
           Default: Email lang nakikita, click arrow to expand
           ========================================== */

        .notification-item {
            background: #ffffff;
            border-radius: 8px;
            margin-bottom: 4px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            transition: all 0.25s ease;
        }

        .notification-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .notification-item.unread {
            border-left: 3px solid #f59e0b;
            background: #fffbeb;
        }

        .notification-item.expanded {
            box-shadow: 0 3px 12px rgba(220, 38, 38, 0.12);
            border-color: #fca5a5;
        }

        /* ONE LINE HEADER - Email + Arrow only */
        .notif-line {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            gap: 10px;
            transition: background 0.15s;
        }

        .notif-line:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .notif-line:active {
            background: rgba(0, 0, 0, 0.04);
        }

        .notif-email-text {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: #1f2937;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 0;
        }

        .notif-arrow {
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: #f3f4f6;
            color: #6b7280;
            font-size: 12px;
            transition: all 0.25s ease;
            flex-shrink: 0;
        }

        .notif-line:hover .notif-arrow {
            background: #e5e7eb;
        }

        .notification-item.expanded .notif-arrow {
            background: #dc2626;
            color: white;
            transform: rotate(180deg);
        }

        /* EXPANDABLE DETAILS - Hidden by default */
        .notif-expand {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease;
        }

        .notification-item.expanded .notif-expand {
            max-height: 1000px;
        }

        .notif-inner {
            padding: 14px;
            border-top: 1px solid #f3f4f6;
        }

        /* Section Spacing */
        .notif-block {
            margin-bottom: 12px;
        }

        .notif-block:last-child {
            margin-bottom: 0;
        }

        /* Section Label */
        .notif-sec-label {
            font-size: 10px;
            font-weight: 700;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        /* Message */
        .notif-msg {
            font-size: 13px;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        /* Customer Card */
        .notif-cust {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .notif-pic {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .notif-cust-data {
            flex: 1;
            min-width: 0;
        }

        .notif-cust-name {
            font-weight: 600;
            font-size: 13px;
            color: #111827;
            margin-bottom: 2px;
        }

        .notif-cust-mail {
            font-size: 11px;
            color: #6b7280;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Order Box */
        .notif-ord {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px;
        }

        .notif-ord-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notif-ord-num {
            font-weight: 700;
            font-size: 13px;
            color: #111827;
        }

        .notif-ord-amt {
            font-weight: 800;
            font-size: 16px;
            color: #dc2626;
        }

        .notif-ref {
            background: #eff6ff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            color: #2563eb;
            margin-bottom: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .notif-ref i {
            font-size: 9px;
        }

        .notif-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 8px;
        }

        .notif-item-line {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #374151;
        }

        .notif-item-name { flex: 1; }

        .notif-item-price {
            font-weight: 600;
            color: #dc2626;
        }

        /* Order item rows inside expanded notification */
        .notif-prod {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #374151;
            padding: 3px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .notif-prod:last-child { border-bottom: none; }
        .notif-prod-name { flex: 1; }
        .notif-prod-price { font-weight: 600; color: #dc2626; margin-left: 8px; }

        /* Status badge colors */
        .notif-stat.completed, .notif-stat.paid { background: #10b981; }
        .notif-stat.pending { background: #f59e0b; }
        .notif-stat.processing { background: #3b82f6; }
        .notif-stat.cancelled { background: #ef4444; }

        .notif-stat {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: #10b981;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .notif-stat i {
            font-size: 10px;
        }

        /* Address */
        .notif-addr {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 12px;
            color: #4b5563;
            line-height: 1.5;
        }

        .notif-addr i {
            color: #dc2626;
            margin-top: 2px;
            flex-shrink: 0;
        }

        /* Time */
        .notif-when {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #9ca3af;
            margin-top: 12px;
            margin-bottom: 12px;
        }

        .notif-when i {
            font-size: 10px;
        }

        /* Action Buttons */
        .notif-btns { display: none; }
        .notif-btns-hidden {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .notif-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .notif-btn-view {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }

        .notif-btn-view:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
        }

        .notif-btn-dismiss {
            background: #f3f4f6;
            color: #6b7280;
        }

        .notif-btn-dismiss:hover {
            background: #e5e7eb;
            color: #374151;
        }

        /* Empty State */
        .notification-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .notification-empty-state i {
            font-size: 48px;
            color: #d1d5db;
            margin-bottom: 12px;
        }

        .notification-empty-state p {
            font-size: 13px;
            color: #6b7280;
            margin: 0;
        }

        /* Loading */
        .notification-loading {
            text-align: center;
            padding: 30px 20px;
            color: #9ca3af;
        }

        .notification-loading i {
            font-size: 28px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes slideOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .notif-line {
                padding: 10px 12px;
            }

            .notif-email-text {
                font-size: 13px;
            }

            .notif-arrow {
                width: 20px;
                height: 20px;
            }

            .notif-inner {
                padding: 12px;
            }

            .notif-btns { display: none; }
        .notif-btns-hidden {
                flex-direction: column;
            }

            .notif-btn {
                width: 100%;
            }
        }

        .notification-panel {
            position: fixed;
            right: 0;
            top: 70px;
            width: 370px;
            height: calc(100vh - 70px);
            background: #f9fafb;
            border-left: 1px solid #e5e7eb;
            border-top: 3px solid #dc2626;
            box-shadow: -4px 0 20px rgba(0,0,0,0.10);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 998;
            display: flex;
            flex-direction: column;
        }

        .notification-panel.open {
            transform: translateX(0);
        }

        .notification-panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
            color: #111827;
        }
        .notification-panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 15px;
            font-weight: 700;
            color: #111827;
        }
        .notification-panel-title i {
            font-size: 15px;
            color: #dc2626;
        }
        .notification-header-actions {
            display: flex;
            gap: 4px;
        }
        .mark-all-read-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 20px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .mark-all-read-btn i { color: #dc2626; font-size: 12px; }
        .mark-all-read-btn:hover { background: #fecaca; border-color: #f87171; }
        .close-notification-btn { display: none; }

        /* Filter Tabs */
        .notif-filter-tabs {
            display: flex;
            gap: 0;
            padding: 8px 12px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }
        .notif-filter-tab {
            flex: 1;
            padding: 7px 12px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            color: #6b7280;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .notif-filter-tab:first-child { border-radius: 6px 0 0 6px; }
        .notif-filter-tab:last-child { border-radius: 0 6px 6px 0; border-left: none; }
        .notif-filter-tab.active {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }
        .notif-filter-tab:hover:not(.active) {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }

        /* Delete button on notification */
        .notif-delete-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: transparent;
            border: none;
            color: #9ca3af;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .notif-delete-btn:hover {
            background: #fee2e2;
            color: #dc2626;
        }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .notification-list::-webkit-scrollbar {
            width: 5px;
        }

        .notification-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .notification-list::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }

        .notification-list::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .notification-panel {
                width: 100vw;
            }

            .notif-line {
                padding: 8px 10px;
            }

            .notif-email-text {
                font-size: 12px;
            }
        }
                width: 36px;
                height: 36px;
            }

            .customer-initial {
                font-size: 14px;
            }
        }

        .notification-toggle-btn {
            position: relative;
            background: transparent;
            border: none;
            color: #333;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
            width: 38px;
            height: 38px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Make navbar-btn (profile/settings) same size and color */
        .navbar-btn {
            background: transparent !important;
            border: none !important;
            color: #333 !important;
            font-size: 20px !important;
            cursor: pointer !important;
            padding: 8px !important;
            border-radius: 8px !important;
            width: 38px !important;
            height: 38px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: background 0.2s !important;
        }

        .notification-toggle-btn:hover,
        .navbar-btn:hover {
            background: #f0f0f0 !important;
        }

        /* â”€â”€ Same size on mobile too â”€â”€ */
        @media (max-width: 768px) {
            .notification-toggle-btn,
            .chat-toggle-btn,
            .navbar-btn {
                width: 36px !important;
                height: 36px !important;
                padding: 0 !important;
                font-size: 18px !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 8px !important;
                color: #333 !important;
            }
        }

        .notification-toggle-btn:hover {
            background: var(--bg-light, #f5f7fa);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #B71C1C;
            color: white;
            border-radius: 12px;
            padding: 3px 7px;
            font-size: 12px;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .notification-panel {
            position: fixed;
            right: 0;
            top: 70px;
            width: 370px;
            height: calc(100vh - 70px);
            background: #f9fafb;
            border-left: 1px solid #e5e7eb;
            border-top: 3px solid #dc2626;
            box-shadow: -4px 0 20px rgba(0,0,0,0.10);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 998;
            display: flex;
            flex-direction: column;
        }

        .notification-panel.open {
            transform: translateX(0);
        }

        .notification-panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
            color: #111827;
        }
        .notification-panel-header h3 {
            font-size: 15px;
            font-weight: 700;
            margin: 0;
            color: #111827;
        }
        .mark-all-read-btn,
        .notification-close-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 20px;
            transition: all 0.2s;
        }
        .notification-close-btn { display: none; }
        .mark-all-read-btn:hover { background: #fecaca; border-color: #f87171; }

        .notification-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .notification-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted, #65676b);
        }

        .notification-empty-state i {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 16px;
            display: block;
        }

        @media (max-width: 768px) {
            .notification-panel {
                width: 100vw !important;
                max-width: 100vw !important;
                top: 60px;
                height: calc(100vh - 60px);
            }
        }

        /* ==========================================
           DASHBOARD ALERTS - UPPER CENTER
           ========================================== */
        #dashboardAlertContainer {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: none;
            width: auto;
            max-width: 480px;
        }
        #dashboardAlertContainer .dash-alert {
            pointer-events: all;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 6px 24px rgba(0,0,0,0.18);
            min-width: 300px;
            max-width: 480px;
            border-left: 4px solid;
            background: #fff;
            animation: dashAlertIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes dashAlertIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes dashAlertOut {
            from { opacity: 1; transform: translateY(0) scale(1); }
            to   { opacity: 0; transform: translateY(-14px) scale(0.95); }
        }
        #dashboardAlertContainer .dash-alert.success { color: #166534; border-left-color: #16a34a; }
        #dashboardAlertContainer .dash-alert.error   { color: #991b1b; border-left-color: #dc2626; }
        #dashboardAlertContainer .dash-alert.info    { color: #1e40af; border-left-color: #3b82f6; }
        #dashboardAlertContainer .dash-alert.warning { color: #92400e; border-left-color: #f59e0b; }
        #dashboardAlertContainer .dash-alert .alert-icon { font-size: 18px; flex-shrink: 0; }
        #dashboardAlertContainer .dash-alert .alert-msg  { flex: 1; color: #111827; }
        #dashboardAlertContainer .dash-alert .alert-close-btn {
            background: none; border: none; color: #9ca3af; cursor: pointer;
            font-size: 16px; padding: 0; width: 22px; height: 22px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: background 0.15s;
        }
        #dashboardAlertContainer .dash-alert .alert-close-btn:hover { background: #f3f4f6; color: #374151; }

        /* ==========================================
           CHAT PANEL STYLES
           ========================================== */

        .chat-panel {
            position: fixed;
            right: 0;
            top: 70px;
            width: 360px;
            max-width: 100vw !important;
            height: calc(100vh - 70px);
            background: white;
            border-left: 1px solid var(--border, #e4e6eb);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 999;
            display: flex;
            flex-direction: column;
            overflow-x: hidden !important;
            box-sizing: border-box !important;
        }

        .chat-panel *,
        .chat-panel *::before,
        .chat-panel *::after {
            box-sizing: border-box !important;
        }

        .chat-panel.open {
            transform: translateX(0);
        }

        .chat-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border, #e4e6eb);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            flex-shrink: 0;
        }

        .chat-panel-header h3 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }

        .chat-close-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .chat-close-btn:hover {
            transform: scale(1.1);
        }

        .chat-conversations-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px;
        }

        .chat-conversation-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 8px;
            position: relative;
        }

        .chat-conversation-item:hover {
            background: var(--bg-light, #f5f7fa);
        }

        .chat-conversation-item.active {
            background: rgba(102, 126, 234, 0.1);
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .chat-conversation-info {
            flex: 1;
            min-width: 0;
        }

        .chat-conversation-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--text-dark, #333);
        }

        .chat-conversation-preview {
            font-size: 13px;
            color: var(--text-muted, #65676b);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-conversation-time {
            font-size: 11px;
            color: var(--text-muted, #65676b);
            position: absolute;
            top: 12px;
            right: 12px;
        }

        .chat-unread-badge {
            background: #dc2626;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 700;
            position: absolute;
            bottom: 12px;
            right: 12px;
        }

        .chat-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted, #65676b);
        }

        .chat-empty-state i {
            font-size: 64px;
            opacity: 0.2;
            margin-bottom: 16px;
            display: block;
        }

        /* ========================================
           CHAT WINDOW - FIXED DISPLAY & HEADER
           ======================================== */

        .chat-window {
            position: fixed;
            right: 0;
            top: 70px;
            width: 360px;
            max-width: 100vw !important;
            height: calc(100vh - 70px);
            background: white;
            border-left: 1px solid var(--border, #e4e6eb);
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            overflow-x: hidden !important;
            box-sizing: border-box !important;
            visibility: hidden;
        }

        .chat-window *,
        .chat-window *::before,
        .chat-window *::after {
            box-sizing: border-box !important;
        }

        .chat-window.open {
            transform: translateX(0);
            visibility: visible;
        }

        .chat-window-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border, #e4e6eb);
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            flex-shrink: 0;
        }

        .back-to-conversations {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            margin-right: 12px;
            transition: transform 0.2s;
        }

        .back-to-conversations:hover {
            transform: translateX(-3px);
        }

        .chat-header-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-name {
            font-weight: 700;
            font-size: 16px;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ========================================
           âœ… PINNED SECTION STYLES - REDESIGNED
           ======================================== */

        .owner-pinned-section {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            display: none; /* Hidden by default */
            flex-direction: column;
            width: 100%;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            position: relative;
            z-index: 90;
        }

        .owner-pinned-section.active {
            display: flex;
        }

        .owner-pinned-section-header {
            padding: 10px 16px;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
        }

        .owner-pinned-section-title {
            font-size: 13px;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .owner-pinned-collapse {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .owner-pinned-collapse:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
        }

        #ownerPinnedMessagesList {
            max-height: 120px;
            overflow-y: auto;
            background: #fff;
            display: block; /* Visible by default when section is active */
        }

        .pinned-message-item {
            padding: 10px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #475569;
            transition: background 0.2s;
            cursor: pointer;
        }

        .pinned-message-item:hover {
            background: #f8fafc;
        }

        .pinned-message-item:last-child {
            border-bottom: none;
        }

        .pinned-message-item i.fa-thumbtack {
            color: #667eea;
            font-size: 11px;
            transform: rotate(45deg);
        }

        .pinned-message-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        .unpin-btn {
            background: none;
            border: none;
            color: #cbd5e0;
            cursor: pointer;
            padding: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .unpin-btn:hover {
            color: #ef4444;
            background: #fee2e2;
        }

        /* Chat messages area */
        .chat-messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden !important;
            padding: 16px;
            background: #f0f2f5;
            width: 100%;
        }

        /* ========================================
           CHAT MESSAGES
           ======================================== */

        .chat-message {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            position: relative;
            max-width: 100%;
        }

        .chat-message.sent {
            justify-content: flex-end;
        }

        .chat-message.received {
            justify-content: flex-start;
        }

        .chat-message-bubble {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 16px;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
            font-size: 14px;
            position: relative;
        }

        .chat-message.sent .chat-message-bubble {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.received .chat-message-bubble {
            background: white;
            color: var(--text-dark, #333);
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .chat-message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
            display: block;
        }

        .message-options-btn {
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .chat-message.sent .message-options-btn {
            order: -1;
            margin-right: 10px;
        }

        .chat-message.received .message-options-btn {
            order: 1;
            margin-left: 10px;
        }

        @media (hover: hover) {
            .chat-message:hover .message-options-btn {
                opacity: 1;
            }

            .message-options-btn:hover {
                background: rgba(0, 0, 0, 0.7);
                transform: scale(1.1);
            }
        }

        .chat-message.active .message-options-btn {
            opacity: 1;
        }

        .chat-message.long-pressing .chat-message-bubble {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .chat-message.pinned .chat-message-bubble::before {
            content: 'ðŸ“Œ ';
            margin-right: 4px;
        }

        .owner-see-pins-link {
            background: #f0f2f5;
            padding: 10px 15px;
            border-top: 1px solid #e4e6eb;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
            font-weight: 600;
            color: #667eea;
            display: none;
            flex-shrink: 0;
        }

        .owner-see-pins-link.active {
            display: block;
        }

        .owner-see-pins-link:hover {
            background: #e4e6eb;
        }

        .chat-input-container {
            padding: 10px !important;
            border-top: 1px solid var(--border, #e4e6eb);
            background: white;
            position: relative;
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow: hidden !important;
            flex-shrink: 0 !important;
        }

        .chat-input-form {
            display: flex !important;
            gap: 8px !important;
            align-items: center;
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .chat-input {
            flex: 1 1 auto !important;
            min-width: 0 !important;
            width: 100% !important;
            padding: 10px 14px !important;
            border: 1px solid var(--border, #e4e6eb);
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            box-sizing: border-box !important;
            margin: 0 !important;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .chat-send-btn {
            width: 40px !important;
            height: 40px !important;
            min-width: 40px !important;
            max-width: 40px !important;
            flex: 0 0 40px !important;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex !important;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            padding: 0 !important;
            margin: 0 !important;
            box-sizing: border-box !important;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
        }

        .chat-send-btn:active {
            transform: scale(0.95);
        }

        .chat-toggle-btn {
            position: relative;
            background: transparent;
            border: none;
            color: var(--text-dark, #333);
            font-size: 20px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .chat-toggle-btn:hover {
            background: var(--bg-light, #f5f7fa);
        }

        .chat-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #B71C1C;
            color: white;
            border-radius: 12px;
            padding: 3px 7px;
            font-size: 12px;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ========================================
           CONTEXT MENU STYLES
           ======================================== */

        .message-context-menu {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.25);
            padding: 8px 0;
            min-width: 180px;
            z-index: 10002;
            display: none;
            animation: menuSlideIn 0.15s ease-out;
        }

        .message-context-menu.active {
            display: block;
        }

        @keyframes menuSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center; /* Ensures vertical center */
            gap: 12px;
            font-size: 0.9rem;
            color: #333;
            transition: background 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        .context-menu-item:hover {
            background: #f5f5f5;
        }

        .context-menu-item i {
            width: 18px;
            font-size: 1rem;
            text-align: center; /* Center icon in its width */
        }

        .context-menu-item.danger {
            color: #f02849;
        }

        .context-menu-item.danger:hover {
            background: #ffebee;
        }

        /* ========================================
           UNSEND MODAL STYLES
           ======================================== */

        .unsend-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10003;
            animation: fadeIn 0.2s ease;
        }

        .unsend-modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .unsend-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            animation: modalSlideUp 0.3s ease-out;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .unsend-modal h3 {
            margin: 0 0 16px 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .unsend-option {
            padding: 16px;
            border: 2px solid #e4e6eb;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .unsend-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .unsend-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .unsend-option-title {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .unsend-option-desc {
            font-size: 0.85rem;
            color: #65676b;
        }

        .unsend-modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .unsend-modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            /* FIX: Ensure text is centered */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-cancel {
            background: #e4e6eb;
            color: #333;
        }

        .btn-cancel:hover {
            background: #d0d2d7;
        }

        .btn-remove {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-remove:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-remove:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .chat-message.deleted .chat-message-bubble {
            background: #f5f5f5 !important;
            color: #999 !important;
            font-style: italic;
            opacity: 0.7;
        }

        .chat-message.deleted .chat-message-bubble::before {
            content: 'ðŸš« ';
        }

        .pinned-messages-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10004;
            animation: fadeIn 0.2s ease;
        }

        .pinned-messages-modal.active {
            display: flex;
        }

        .pinned-messages-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 70vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease-out;
        }

        .pinned-messages-modal h3 {
            margin: 0 0 16px 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .pinned-messages-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pinned-messages-list .pinned-message-item {
            padding: 12px;
            border: 1px solid #e4e6eb;
        }

        .pinned-messages-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .pinned-messages-empty i {
            font-size: 48px;
            opacity: 0.3;
            display: block;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            .chat-panel,
            .chat-window {
                width: 100vw !important;
                max-width: 100vw !important;
                top: 60px;
                height: calc(100vh - 60px);
            }

            .message-options-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
                opacity: 0.7;
            }

            .chat-message.sent .message-options-btn {
                margin-right: 12px;
            }

            .chat-message.received .message-options-btn {
                margin-left: 12px;
            }

            .context-menu-item {
                padding: 16px 20px;
                font-size: 1rem;
            }

            .unsend-option {
                padding: 18px;
            }

            .chat-input-container {
                padding: 8px !important;
            }

            .chat-input-form {
                gap: 6px !important;
            }

            .chat-input {
                padding: 9px 12px !important;
                font-size: 14px;
            }

            .chat-send-btn {
                width: 38px !important;
                height: 38px !important;
                min-width: 38px !important;
                max-width: 38px !important;
                flex: 0 0 38px !important;
            }

            .chat-send-btn i {
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            .chat-panel,
            .chat-window {
                width: 100vw !important;
                max-width: 100vw !important;
                top: 56px;
                height: calc(100vh - 56px);
            }

            .chat-input-container {
                padding: 8px !important;
            }

            .chat-input-form {
                gap: 6px !important;
            }

            .chat-input {
                padding: 8px 10px !important;
                font-size: 13px;
            }

            .chat-send-btn {
                width: 36px !important;
                height: 36px !important;
                min-width: 36px !important;
                max-width: 36px !important;
                flex: 0 0 36px !important;
            }

            .chat-send-btn i {
                font-size: 14px;
            }
        }

        @media (max-width: 360px) {
            .chat-panel,
            .chat-window {
                width: 100vw !important;
                max-width: 100vw !important;
            }

            .chat-input-container {
                padding: 6px !important;
            }

            .chat-input-form {
                gap: 5px !important;
            }

            .chat-input {
                padding: 7px 9px !important;
                font-size: 13px;
            }

            .chat-send-btn {
                width: 34px !important;
                height: 34px !important;
                min-width: 34px !important;
                max-width: 34px !important;
                flex: 0 0 34px !important;
            }

            .chat-send-btn i {
                font-size: 13px;
            }
        }

        /* Delete Establishment Link */
        .delete-establishment-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #dc2626;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .delete-establishment-link:hover {
            background: #fee2e2;
            transform: translateX(4px);
        }

        .delete-establishment-link i {
            font-size: 18px;
        }

        /* Delete Confirmation Modal */
        .delete-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 99999;
            animation: fadeIn 0.3s ease;
        }

        .delete-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        /* Compact style for menu item delete and toggle seller modals */
        #menuItemDeleteModal .delete-modal,
        #toggleSellerModal .delete-modal {
            max-width: 380px;
            padding: 24px;
            border-radius: 14px;
        }

        #menuItemDeleteModal .delete-modal-header,
        #toggleSellerModal .delete-modal-header {
            margin-bottom: 16px;
            gap: 12px;
        }

        #menuItemDeleteModal .delete-modal-icon,
        #toggleSellerModal .delete-modal-icon {
            width: 44px;
            height: 44px;
            font-size: 20px;
            flex-shrink: 0;
        }

        #menuItemDeleteModal .delete-modal-title h3,
        #toggleSellerModal .delete-modal-title h3 {
            font-size: 18px;
        }

        #menuItemDeleteModal .delete-modal-title p,
        #toggleSellerModal .delete-modal-title p {
            font-size: 13px;
        }

        #menuItemDeleteModal .delete-modal-body,
        #toggleSellerModal .delete-modal-body {
            margin-bottom: 16px;
        }

        #menuItemDeleteModal .delete-warning,
        #toggleSellerModal .delete-warning {
            padding: 12px;
            margin-bottom: 0;
        }

        #menuItemDeleteModal .delete-warning p,
        #toggleSellerModal .delete-warning p {
            font-size: 13px;
        }

        #menuItemDeleteModal .delete-consequences,
        #toggleSellerModal .delete-consequences {
            display: none;
        }

        #menuItemDeleteModal .delete-modal-actions,
        #toggleSellerModal .delete-modal-actions {
            gap: 10px;
        }

        #menuItemDeleteModal .btn-cancel,
        #menuItemDeleteModal .btn-delete,
        #toggleSellerModal .btn-cancel,
        #toggleSellerModal .btn-delete {
            padding: 10px 18px;
            font-size: 14px;
        }
        /* Confirm buttons always use red base â€” specific colors set via JS for toggle */
        #menuItemDeleteModal .btn-delete {
            background: linear-gradient(135deg, #dc2626, #991b1b) !important;
        }

        .delete-modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .delete-modal-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
        }

        .delete-modal-title {
            flex: 1;
        }

        .delete-modal-title h3 {
            margin: 0;
            font-size: 24px;
            color: #111827;
            font-weight: 700;
        }

        .delete-modal-title p {
            margin: 4px 0 0 0;
            color: #6b7280;
            font-size: 14px;
        }

        .delete-modal-body {
            margin-bottom: 24px;
        }

        .delete-warning {
            background: #fef2f2;
            border-left: 4px solid #dc2626;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .delete-warning p {
            margin: 0;
            color: #991b1b;
            font-weight: 600;
        }

        .delete-consequences {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
        }

        .delete-consequences h4 {
            margin: 0 0 12px 0;
            font-size: 16px;
            color: #111827;
            font-weight: 600;
        }

        .delete-consequences ul {
            margin: 0;
            padding-left: 20px;
        }

        .delete-consequences li {
            color: #6b7280;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .delete-modal-actions {
            display: flex;
            gap: 12px;
        }

        .btn-cancel,
        .btn-delete {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-cancel:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
        }

        .btn-delete:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        /* ========================================== */
        /* NEW FEATURES STYLES - ORDERS */
        /* ========================================== */

        .orders-table-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .orders-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .orders-table-title {
            font-size: 24px;
            font-weight: 800;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .orders-table-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .filter-btn, .export-btn,

        .filter-btn {
            background: #f3f4f6;
            color: #374151;
        }

        .filter-btn:hover {
            background: #e5e7eb;
        }

        .export-btn {
            background: #10b981;
            color: white;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .orders-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .orders-table thead {
            background: linear-gradient(135deg, #f02849 0%, #c62828 100%);
            color: white;
        }

        .orders-table th {
            padding: 16px;
            text-align: left;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .orders-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s;
        }

        .orders-table tbody tr:hover {
            background: #f9fafb;
        }

        .orders-table td {
            padding: 16px;
            color: #374151;
            font-size: 14px;
        }

        .order-id-cell {
            font-weight: 700;
            color: #1877F2;
        }

        .order-customer-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .customer-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .order-amount-cell {
            font-weight: 800;
            font-size: 16px;
            color: #B71C1C;
        }

        .status-preparing {
            background: #dbeafe;
            color: #3b82f6;
        }

        .status-ready {
            background: #e0e7ff;
            color: #6366f1;
        }

        .status-completed {
            background: #d1fae5;
            color: #059669;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #ef4444;
        }

        .order-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .view-btn {
            background: #3b82f6;
            color: white;
        }

        .view-btn:hover {
            background: #2563eb;
        }

        .pagination-container {
            margin-top: 24px;
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f9fafb;
            border-color: #f02849;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Back to Dashboard Button */
        .back-to-dashboard-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #f02849 0%, #c62828 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s;
            margin-top: 24px;
        }

        .back-to-dashboard-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(240, 40, 73, 0.4);
            color: white;
        }

        .payment-success-container {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 20px;
            max-width: 600px;
            margin: 40px auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        /* Transaction History Section */
        .transaction-history-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 16px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s;
        }

        .transaction-item:hover {
            background: #f9fafb;
        }

        .transaction-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .transaction-icon.payment {
            background: #d1fae5;
            color: #10b981;
        }

        .transaction-icon.refund {
            background: #fee2e2;
            color: #ef4444;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-title {
            font-weight: 700;
            font-size: 15px;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .transaction-date {
            font-size: 13px;
            color: #6b7280;
        }

        .transaction-amount {
            font-weight: 800;
            font-size: 18px;
        }

        .transaction-amount.positive {
            color: #10b981;
        }

        .transaction-amount.negative {
            color: #ef4444;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-family: 'Pacifico', cursive;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .sidebar-logo i {
            font-size: 28px;
            color: var(--primary);
        }

        .sidebar.collapsed .sidebar-logo span {
            display: none;
        }

        .sidebar-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .sidebar-item.active {
            background: rgba(183, 28, 28, 0.15);
            color: white;
            border-left-color: var(--primary);
        }

        .sidebar-item i {
            font-size: 20px;
            min-width: 20px;
            text-align: center;
        }

        .sidebar.collapsed .sidebar-item span {
            display: none;
        }

        .sidebar-footer {
            padding: 20px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-item.logout {
            color: rgba(255, 107, 107, 0.9);
        }

        .sidebar-item.logout:hover {
            background: rgba(255, 107, 107, 0.1);
            color: #ff6b6b;
        }

        /* Sidebar toggle button */
        .sidebar-toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-dark);
            font-size: 24px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s;
            display: none;
        }

        .sidebar-toggle-btn:hover {
            background: var(--bg-light);
        }

        .navbar-page-title {
            font-family: 'Pacifico', cursive;
            font-size: 24px;
            color: #000000;
            font-weight: 400;
            flex: 1;
        }

        /* Adjust navbar for sidebar layout */
        .navbar {
            left: 260px !important;
            width: calc(100% - 260px) !important;
            z-index: 1050 !important;
            position: fixed !important;
        }

        .navbar-actions,
        .navbar-actions *,
        .notification-toggle-btn,
        .chat-toggle-btn,
        .navbar-btn,
        .navbar-dropdown {
            pointer-events: auto !important;
            position: relative !important;
            z-index: 1051 !important;
        }

        /* Ensure main content never overlaps navbar */
        .main-content {
            position: relative !important;
            z-index: 0 !important;
        }

        .sidebar.collapsed ~ .navbar {
            left: 70px !important;
            width: calc(100% - 70px) !important;
        }

        /* Adjust body for sidebar */
        body {
            padding-left: 260px;
        }

        body.sidebar-collapsed {
            padding-left: 70px;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-toggle-btn {
                display: block;
            }

            .navbar {
                left: 0 !important;
                width: 100% !important;
            }

            body {
                padding-left: 0;
                padding-top: 70px;
            }

            .navbar-page-title {
                font-size: 20px;
            }
        }



/* ==========================================
   PROFILE MODAL STYLES
   ========================================== */

.profile-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
    overflow-y: auto;
}

.profile-modal-overlay.active {
    display: flex;
}

.profile-modal {
    background: white;
    border-radius: 16px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
}

.profile-modal-header {
    padding: 24px;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px 16px 0 0;
}

.profile-modal-header h2 {
    font-size: 24px;
    font-weight: 700;
    color: white;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.profile-modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.profile-modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.profile-modal-body {
    padding: 24px;
}

.profile-image-section {
    text-align: center;
    margin-bottom: 24px;
}

.profile-modal-image {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #667eea;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.profile-detail-group {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f3f4f6;
}

.profile-detail-group:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.profile-detail-label {
    font-size: 12px;
    font-weight: 700;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.profile-detail-label i {
    font-size: 14px;
    color: #667eea;
}

.profile-detail-value {
    font-size: 16px;
    font-weight: 600;
    color: #1a1a1a;
    line-height: 1.5;
}

.amenity-tag {
    display: inline-block;
    background: #eff6ff;
    color: #1e40af;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    margin-right: 8px;
    margin-bottom: 8px;
}

/* ==========================================
   UPDATED NAVBAR MENU STYLES
   ========================================== */

.navbar-menu-header {
    padding: 12px 18px;
    font-size: 11px;
    font-weight: 700;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #e5e7eb;
}

.navbar-menu-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 18px;
    color: #374151;
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    border-bottom: 1px solid #f3f4f6;
}

.navbar-menu-item:last-child {
    border-bottom: none;
}

.navbar-menu-item:hover {
    background: #f9fafb;
    color: #667eea;
    padding-left: 22px;
}

.navbar-menu-item i {
    font-size: 16px;
    width: 20px;
    text-align: center;
}

/* Profile button â€” no border, no circle, just plain icon */
.navbar-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    width: 44px;
    height: 44px;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.navbar-btn:hover {
    background: var(--bg-light);
    transform: scale(1.05);
}

.navbar-dropdown .navbar-btn i {
    font-size: 23px !important;
    color: #6b7280 !important;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .profile-modal {
        max-width: 100%;
        margin: 10px;
    }

    .profile-modal-image {
        width: 120px;
        height: 120px;
    }

    .profile-detail-value {
        font-size: 14px;
    }
}


        /* Statistics Cards Styling */
        .stats-card {
            cursor: default !important;
            pointer-events: none;
        }

        .stats-card:hover {
            transform: none !important;
        }

        .stats-card:hover::before {
            opacity: 0 !important;
        }

        .top-action-btn.total-items-card .btn-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .top-action-btn.bestsellers-card .btn-icon {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .stats-number {
            font-size: 28px !important;
            font-weight: 700 !important;
            color: #1f2937 !important;
        }

        .stats-card .btn-label {
            font-size: 14px !important;
            color: #6b7280 !important;
        }

        .stats-icon-items, .stats-icon-bestsellers {
            font-size: 24px;
        }

        /* ==========================================
           MODAL CLOSE BUTTON FIX
           Ensures X button is always visible inside modal
           ========================================== */
        .modal-content {
            position: relative !important;
        }

        .modal-close {
            position: absolute !important;
            top: 14px !important;
            right: 14px !important;
            width: 34px !important;
            height: 34px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: #f3f4f6 !important;
            border: none !important;
            border-radius: 50% !important;
            font-size: 20px !important;
            color: #374151 !important;
            cursor: pointer !important;
            z-index: 10 !important;
            transition: background 0.2s, color 0.2s !important;
            line-height: 1 !important;
        }

        .modal-close:hover {
            background: #dc2626 !important;
            color: white !important;
        }

        @media (max-width: 768px) {
            .modal-content {
                padding: 24px 16px !important;
                margin: 10px !important;
                width: calc(100% - 20px) !important;
                max-height: 90vh !important;
            }

            .modal-close {
                top: 10px !important;
                right: 10px !important;
            }
        }

        /* ==========================================
           MESSAGES: HIDE NAV BUTTON ON MOBILE,
           SHOW FLOATING CIRCLE BUTTON INSTEAD
           ========================================== */
        @media (max-width: 768px) {
            .chat-toggle-btn {
                display: none !important;
            }
        }

        /* Float button â€” mobile only */
        .chat-float-btn {
            display: none;
        }

        /* Hide float button when chat panel is open */
        .chat-panel.open ~ .chat-float-btn,
        body.chat-open .chat-float-btn {
            display: none !important;
        }

        @media (max-width: 768px) {
            .chat-float-btn {
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                bottom: 24px;
                right: 20px;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                color: white;
                font-size: 22px;
                border: none;
                cursor: pointer;
                z-index: 1200;
                box-shadow: 0 4px 16px rgba(220, 38, 38, 0.45);
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .chat-float-btn:hover,
            .chat-float-btn:active {
                transform: scale(1.08);
                box-shadow: 0 6px 20px rgba(220, 38, 38, 0.55);
            }

            .chat-float-btn .chat-float-badge {
                position: absolute;
                top: 2px;
                right: 2px;
                background: #f59e0b;
                color: white;
                border-radius: 50%;
                width: 18px;
                height: 18px;
                font-size: 11px;
                font-weight: 700;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px solid white;
            }
        }
        /* ==========================================
           ADD MENU ITEM BUTTON - IMPROVED MOBILE LAYOUT
           ========================================== */
        @media (max-width: 768px) {
            .top-action-buttons {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                grid-template-rows: auto auto !important;
                gap: 12px !important;
                padding: 0 16px !important;
                margin-bottom: 20px !important;
            }

            /* Add Menu Item spans full width on top */
            .top-action-btn.add-item-btn {
                grid-column: 1 / -1 !important;
                max-width: 100% !important;
                padding: 18px 20px !important;
                justify-content: center !important;
                background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
                border-color: #10b981 !important;
                box-shadow: 0 4px 16px rgba(16, 185, 129, 0.35) !important;
            }

            .top-action-btn.add-item-btn .btn-icon {
                background: rgba(255,255,255,0.25) !important;
                box-shadow: none !important;
                color: white !important;
            }

            .top-action-btn.add-item-btn .btn-label,
            .top-action-btn.add-item-btn .btn-desc {
                color: white !important;
            }

            /* Stats cards sit side by side below */
            .top-action-btn.stats-card {
                flex: unset !important;
                max-width: 100% !important;
                padding: 14px 16px !important;
                flex-direction: column !important;
                align-items: center !important;
                text-align: center !important;
                gap: 8px !important;
            }

            .top-action-btn.stats-card .btn-icon {
                width: 42px !important;
                height: 42px !important;
                font-size: 20px !important;
            }

            .top-action-btn.stats-card .btn-text {
                align-items: center !important;
            }

            .top-action-btn.stats-card .btn-label {
                font-size: 13px !important;
            }

            .top-action-btn.stats-card .btn-desc.stats-number {
                font-size: 22px !important;
            }
        }

</style>
    {% block extra_css %}{% endblock %}
</head>
<body>
<!-- SIDEBAR NAVIGATION -->
<div class="sidebar" id="mainSidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="fas fa-utensils"></i>
            <span>KabsuEats</span>
        </div>
    </div>

    <div class="sidebar-menu">
        <a href="{% url 'food_establishment_dashboard' %}" class="sidebar-item {% if request.resolver_match.url_name == 'food_establishment_dashboard' %}active{% endif %}">
            <i class="fas fa-chart-line"></i>
            <span>Menus</span>
        </a>
        <a href="{% url 'orders_list' %}" class="sidebar-item {% if request.resolver_match.url_name == 'orders_list' %}active{% endif %}">
            <i class="fas fa-shopping-bag"></i>
            <span>Orders</span>
        </a>
        <a href="{% url 'establishment_transaction_history' %}" class="sidebar-item {% if request.resolver_match.url_name == 'establishment_transaction_history' %}active{% endif %}">
            <i class="fas fa-history"></i>
            <span>Transactions</span>
        </a>
    </div>

</div>
<!-- END SIDEBAR -->
<nav class="navbar">
    <div class="navbar-container">
        <button class="sidebar-toggle-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <div class="navbar-actions" style="gap: 20px; margin-left: auto;">
            <button class="notification-toggle-btn" onclick="toggleNotificationPanel()" id="notificationToggleBtn"
                    title="Notifications">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationBadge" style="display:none;">0</span>
            </button>

            <button class="chat-toggle-btn" onclick="toggleChatPanel()" id="chatToggleBtn" title="Messages">
                <i class="fas fa-envelope"></i>
                <span class="chat-badge" id="chatBadge" style="display:none;">0</span>
            </button>

            <div class="navbar-dropdown">
                <button class="navbar-btn" onclick="toggleDropdown()" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="navbar-menu" id="navMenu">
                    <div class="navbar-menu-header">Settings</div>
                    <a href="{% url 'food_establishment_profile' %}" class="navbar-menu-item">
                        <i class="fas fa-user-cog"></i>
                        <span>Establishment</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</nav>


<!-- PROFILE MODAL -->
<div class="profile-modal-overlay" id="profileModal">
    <div class="profile-modal">
        <div class="profile-modal-header">
            <h2><i class="fas fa-user"></i> Establishment Profile</h2>
            <button class="profile-modal-close" onclick="closeProfileModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="profile-modal-body">
            <!-- Profile Image -->
            <div class="profile-image-section">
                <img src="{% if establishment.image %}{{ establishment.image.url }}{% else %}{% static 'images/default_profile.png' %}{% endif %}"
                     alt="{{ establishment.name }}"
                     class="profile-modal-image">
            </div>

            <!-- Establishment Name -->
            <div class="profile-detail-group">
                <div class="profile-detail-label">
                    <i class="fas fa-store"></i> Establishment Name
                </div>
                <div class="profile-detail-value">{{ establishment.name }}</div>
            </div>

            <!-- Address -->
            <div class="profile-detail-group">
                <div class="profile-detail-label">
                    <i class="fas fa-map-marker-alt"></i> Address
                </div>
                <div class="profile-detail-value">{{ establishment.address }}</div>
            </div>

            <!-- Category -->
            <div class="profile-detail-group">
                <div class="profile-detail-label">
                    <i class="fas fa-tag"></i> Category
                </div>
                <div class="profile-detail-value">{{ establishment.category.name|default:"N/A" }}</div>
            </div>

            <!-- Operating Hours -->
            <div class="profile-detail-group">
                <div class="profile-detail-label">
                    <i class="fas fa-clock"></i> Operating Hours
                </div>
                <div class="profile-detail-value">
                    {% if establishment.opening_time and establishment.closing_time %}
                        {{ establishment.opening_time|time:"g:i A" }} - {{ establishment.closing_time|time:"g:i A" }}
                    {% else %}
                        Not Set
                    {% endif %}
                </div>
            </div>

            <!-- Status -->
            <div class="profile-detail-group">
                <div class="profile-detail-label">
                    <i class="fas fa-circle"></i> Status
                </div>
                <div class="profile-detail-value">
                    <span class="status-badge status-{{ establishment.calculated_status|lower }}">
                        {% if establishment.calculated_status == 'Open' %}
                            Open Now
                        {% else %}
                            Closed Now
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- Amenities -->
            <div class="profile-detail-group">
                <div class="profile-detail-label">
                    <i class="fas fa-star"></i> Amenities
                </div>
                <div class="profile-detail-value">
                    {% for amenity in establishment.amenities.all %}
                        <span class="amenity-tag">{{ amenity.name }}</span>
                    {% empty %}
                        N/A
                    {% endfor %}
                </div>
            </div>

            <!-- Payment Methods -->
            <div class="profile-detail-group">
                <div class="profile-detail-label">
                    <i class="fas fa-credit-card"></i> Payment Methods
                </div>
                <div class="profile-detail-value">{{ establishment.payment_methods|default:"N/A" }}</div>
            </div>

            <!-- Location Coordinates -->
            <div class="profile-detail-group">
                <div class="profile-detail-label">
                    <i class="fas fa-map"></i> Location
                </div>
                <div class="profile-detail-value">
                    {% if establishment.latitude and establishment.longitude %}
                        {{ establishment.latitude|floatformat:6 }}, {{ establishment.longitude|floatformat:6 }}
                    {% else %}
                        Not Set
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Establishment Confirmation Modal -->
<!-- MENU ITEM DELETE CONFIRMATION MODAL -->
<div class="delete-modal-overlay" id="menuItemDeleteModal">
    <div class="delete-modal">
        <div class="delete-modal-header">
            <div class="delete-modal-icon">
                <i class="fas fa-trash-alt"></i>
            </div>
            <div class="delete-modal-title">
                <h3>Delete Menu Item?</h3>
                <p>This action cannot be undone</p>
            </div>
        </div>
        <div class="delete-modal-body">
            <div class="delete-warning">
                <p><i class="fas fa-info-circle"></i> You are about to permanently delete <strong id="menuItemDeleteName"></strong></p>
            </div>
            <div class="delete-consequences">
                <p style="margin:0;color:#6b7280;font-size:14px;">This menu item will be removed from your menu and will no longer be visible to customers.</p>
            </div>
        </div>
        <div class="delete-modal-actions">
            <button class="btn-cancel" onclick="closeMenuItemDeleteModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn-delete" onclick="confirmMenuItemDelete()" id="confirmMenuItemDeleteBtn">
                <i class="fas fa-trash-alt"></i> Yes, Delete
            </button>
        </div>
    </div>
</div>

<!-- MARK/UNMARK BEST SELLER CONFIRMATION MODAL -->
<div class="delete-modal-overlay" id="toggleSellerModal">
    <div class="delete-modal">
        <div class="delete-modal-header">
            <div class="delete-modal-icon" id="toggleSellerIcon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <i class="fas fa-award"></i>
            </div>
            <div class="delete-modal-title">
                <h3 id="toggleSellerTitle">Mark as Best Seller?</h3>
                <p id="toggleSellerSubtitle">This will highlight the item for customers</p>
            </div>
        </div>
        <div class="delete-modal-body">
            <div class="delete-warning" id="toggleSellerWarning" style="border-left-color:#f59e0b;background:#fffbeb;">
                <p style="color:#92400e;" id="toggleSellerWarningText"><i class="fas fa-star"></i> <strong id="toggleSellerItemName"></strong> will be marked as a Best Seller</p>
            </div>
            <div class="delete-consequences">
                <p style="margin:0;color:#6b7280;font-size:14px;" id="toggleSellerDesc">Best Seller items appear with a special badge and are highlighted to customers.</p>
            </div>
        </div>
        <div class="delete-modal-actions">
            <button class="btn-cancel" onclick="closeToggleSellerModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn-delete" onclick="confirmToggleSeller()" id="confirmToggleSellerBtn" style="background:linear-gradient(135deg,#f59e0b,#d97706);">
                <i class="fas fa-award"></i> <span id="confirmToggleSellerBtnText">Yes, Mark it</span>
            </button>
        </div>
    </div>
</div>

<div class="delete-modal-overlay" id="deleteModal">
    <div class="delete-modal">
        <div class="delete-modal-header">
            <div class="delete-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="delete-modal-title">
                <h3>Delete Establishment?</h3>
                <p>This action cannot be undone</p>
            </div>
        </div>
        <div class="delete-modal-body">
            <div class="delete-warning">
                <p><i class="fas fa-info-circle"></i> You are about to permanently delete your establishment</p>
            </div>
            <div class="delete-consequences">
                <h4>This will permanently remove:</h4>
                <ul>
                    <li><i class="fas fa-check"></i> Your establishment profile</li>
                    <li><i class="fas fa-check"></i> All menu items and categories</li>
                    <li><i class="fas fa-check"></i> Order history and customer data</li>
                    <li><i class="fas fa-check"></i> Reviews and ratings</li>
                    <li><i class="fas fa-check"></i> Chat conversations</li>
                </ul>
            </div>
        </div>
        <div class="delete-modal-actions">
            <button class="btn-cancel" onclick="hideDeleteConfirmation()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn-delete" onclick="confirmDeleteEstablishment()" id="confirmDeleteBtn">
                <i class="fas fa-trash-alt"></i> Yes, Delete
            </button>
        </div>
    </div>
</div>

<!-- PROFESSIONAL NOTIFICATION PANEL -->
<div class="notification-panel" id="notificationPanel">
    <!-- Panel Header -->
    <div class="notification-panel-header">
        <div class="notification-panel-title">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
        </div>
        <div class="notification-header-actions">
            <button class="mark-all-read-btn" id="markAllReadBtn" title="Mark all as read">
                <i class="fas fa-check-double"></i>
                <span>Mark all read</span>
            </button>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="notif-filter-tabs">
        <button class="notif-filter-tab active" id="notifTabAll" onclick="filterNotifications('all')">
            <i class="fas fa-list" style="margin-right:4px;"></i> All
        </button>
        <button class="notif-filter-tab" id="notifTabUnread" onclick="filterNotifications('unread')">
            <i class="fas fa-circle" style="margin-right:4px;font-size:8px;"></i> Unread
        </button>
    </div>

    <!-- Notification List -->
    <div class="notification-list" id="notificationList">
        <!-- Loading State (shows while fetching) -->
        <div class="notification-loading" id="notificationLoading" style="display: none;">
            <i class="fas fa-spinner"></i>
        </div>

        <!-- Empty State (shows when no notifications) -->
        <div class="notification-empty-state" id="notificationEmptyState" style="display: none;">
            <i class="fas fa-bell-slash"></i>
            <p>No notifications yet</p>
        </div>

        <!-- Notifications will be dynamically inserted here -->
    </div>
</div>

<!-- Notification Item Template (Hidden, used by JavaScript) -->
<template id="notificationItemTemplate">
    <div class="notification-item" data-notification-id="">
        <!-- ONE LINE: Email + Arrow ONLY -->
        <div class="notif-line">
            <span class="notif-email-text"></span>
            <div class="notif-arrow">
                <i class="fas fa-chevron-down"></i>
            </div>
            <button class="notif-delete-btn" title="Delete notification" onclick="event.stopPropagation(); deleteNotification(this.closest('.notification-item').dataset.notificationId)">
                <i class="fas fa-trash"></i>
            </button>
        </div>

        <!-- EXPANDABLE: All Details (Hidden by default) -->
        <div class="notif-expand">
            <div class="notif-inner">
                <div class="notif-msg"></div>

                <!-- Customer -->
                <div class="notif-block customer-block">
                    <div class="notif-sec-label">Customer</div>
                    <div class="notif-cust">
                        <div class="notif-pic"></div>
                        <div class="notif-cust-data">
                            <div class="notif-cust-name"></div>
                            <div class="notif-cust-mail"></div>
                        </div>
                    </div>
                </div>

                <!-- Order -->
                <div class="notif-block order-block">
                    <div class="notif-sec-label">Order Details</div>
                    <div class="notif-ord">
                        <div class="notif-ord-top">
                            <span class="notif-ord-num"></span>
                            <span class="notif-ord-amt"></span>
                        </div>
                        <div class="notif-ref">
                            <i class="fas fa-hashtag"></i>
                            <span class="ref-text"></span>
                        </div>
                        <div class="notif-list"></div>
                        <div class="notif-stat">
                            <i class="fas fa-clock"></i>
                            <span class="status-text"></span>
                        </div>
                    </div>
                </div>

                <!-- Delivery Address -->
                <div class="notif-block address-block" style="display: none;">
                    <div class="notif-sec-label">Delivery Address</div>
                    <div class="notif-addr">
                        <i class="fas fa-map-marker-alt"></i>
                        <span class="address-text"></span>
                    </div>
                </div>

                <div class="notif-when">
                    <i class="far fa-clock"></i>
                    <span class="time-ago-text"></span>
                </div>


            </div>
        </div>
    </div>
</template>




<div class="chat-panel" id="chatPanel">
    <div class="chat-panel-header">
        <h3><i class="fas fa-comments"></i> Messages</h3>
        <button class="chat-close-btn" onclick="toggleChatPanel(); document.body.classList.remove('chat-open')">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <!-- Chat Filter Tabs -->
    <div class="notif-filter-tabs" style="background:#fff;">
        <button class="notif-filter-tab active" id="chatTabAll" onclick="filterConversations('all')">
            <i class="fas fa-list" style="margin-right:4px;"></i> All
        </button>
        <button class="notif-filter-tab" id="chatTabUnread" onclick="filterConversations('unread')">
            <i class="fas fa-circle" style="margin-right:4px;font-size:8px;"></i> Unread
        </button>
    </div>
    <div class="chat-conversations-list" id="conversationsList">
        <div class="chat-empty-state">
            <i class="fas fa-inbox"></i>
            <p>No conversations yet</p>
        </div>
    </div>
</div>

<!-- FLOATING CHAT BUTTON - Mobile Only -->
<button class="chat-float-btn" id="chatFloatBtn" onclick="toggleChatPanel(); document.body.classList.toggle('chat-open', document.getElementById('chatPanel').classList.contains('open'))" title="Messages" aria-label="Open Messages">
    <i class="fas fa-comment-dots"></i>
    <span class="chat-float-badge" id="chatFloatBadge" style="display:none;">0</span>
</button>

<div class="chat-window" id="chatWindow">
    <div class="chat-window-header">
        <button class="back-to-conversations" onclick="backToConversations()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="chat-avatar" id="chatWindowAvatar">U</div>
        <div class="chat-header-info">
            <h4 class="chat-header-name" id="chatWindowName">Customer</h4>
        </div>
    </div>

    <!-- âœ… REDESIGNED: PINNED MESSAGE SECTION -->
    <div class="owner-pinned-section" id="ownerPinnedSection">
        <div class="owner-pinned-section-header">
            <span class="owner-pinned-section-title">
                <i class="fas fa-thumbtack"></i> Pinned Messages
            </span>
            <button class="owner-pinned-collapse" onclick="toggleOwnerPinnedSection()">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div id="ownerPinnedMessagesList">
            <!-- Messages injected here -->
        </div>
    </div>

    <div class="chat-messages-container" id="chatMessagesContainer">
    </div>

    <div class="owner-see-pins-link" id="ownerSeePinsLink" onclick="openOwnerPinnedMessagesModal()">
        <i class="fas fa-thumbtack"></i> See All Pins
    </div>

    <div class="chat-input-container">
        <form class="chat-input-form" id="chatInputForm" onsubmit="sendMessage(event)">
            <input
                    type="text"
                    class="chat-input"
                    id="chatInput"
                    placeholder="Type a message..."
                    autocomplete="off"
            >
            <button type="submit" class="chat-send-btn" id="chatSendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>


{% block main_content %}
<main class="main-content">
    {% if is_suspended %}
    <div class="suspension-warning">
        <i class="fas fa-exclamation-circle"></i> Your store is currently suspended. Please contact an administrator.
    </div>
    {% endif %}

    <!-- ACTION BUTTONS AT TOP -->
    <div class="top-action-buttons">
        <button class="top-action-btn add-item-btn" onclick="openModal('addMenuItemModal')">
            <div class="btn-icon">
                <i class="fas fa-plus-circle"></i>
            </div>
            <div class="btn-text">
                <span class="btn-label">Add Menu Item</span>
                <span class="btn-desc">Create new dish</span>
            </div>
        </button>
        <div class="top-action-btn stats-card total-items-card">
            <div class="btn-icon stats-icon-items">
                <i class="fas fa-utensils"></i>
            </div>
            <div class="btn-text">
                <span class="btn-label">Total Items</span>
                <span class="btn-desc stats-number">{{ menu_items|length }}</span>
            </div>
        </div>
        <div class="top-action-btn stats-card bestsellers-card">
            <div class="btn-icon stats-icon-bestsellers">
                <i class="fas fa-star"></i>
            </div>
            <div class="btn-text">
                <span class="btn-label">Top Sellers</span>
                <span class="btn-desc stats-number">{{ top_sellers_count|default:"0" }}</span>
            </div>
        </div>
    </div>

    <!-- FULL WIDTH MENU SECTION -->
    <div class="full-width-container">
        <div class="card menu-section">
            <div class="card-title-center">
                <i class="fas fa-hamburger"></i> Your Menu
            </div>
            {% if menu_items %}
            <div class="menu-grid">
                {% for item in menu_items %}
                <div class="menu-card" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}"
                     data-item-description="{{ item.description }}" data-item-price="{{ item.price|floatformat:2 }}"
                     data-item-quantity="{{ item.quantity|default:0 }}"
                     data-item-image-url="{% if item.image %}{{ item.image.url }}{% endif %}">
                    <div class="menu-image">
                        <img src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/default_menu_item.png' %}{% endif %}"
                             alt="{{ item.name }}">
                        <div class="badges-container">
                            {% if item.is_top_seller %}
                            <span class="badge bestseller">
                                    <i class="fas fa-award"></i> Best Seller
                                </span>
                            {% endif %}
                            {% if item.quantity > 0 %}
                            <span class="badge available">Available: {{ item.quantity }}</span>
                            {% else %}
                            <span class="badge soldout">Out of Stock</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="menu-info">
                        <div class="menu-name">{{ item.name }}</div>
                        <div class="menu-desc">{{ item.description }}</div>
                        <div class="menu-price">â‚±{{ item.price|floatformat:2 }}</div>
                        <div class="menu-actions">
                            <button class="action-btn edit" onclick="openEditModal('{{ item.id }}')">
                                <i class="fas fa-pen"></i> Edit
                            </button>
                            <button type="button" class="action-btn seller"
                                    onclick="openToggleSellerModal('{{ item.id }}')">
                                <i class="fas fa-award"></i> {% if item.is_top_seller %}Unmark{% else %}Mark{% endif %}
                            </button>
                            <button type="button" class="action-btn delete"
                                    onclick="deleteMenuItem('{{ item.id }}', this)">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-items">
                <i class="fas fa-inbox"></i>
                <p>No menu items yet. Add your first item to get started!</p>
            </div>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}


<div class="modal" id="viewStoreDetailsModal">
    <div class="modal-content" style="max-width: 450px;">
        <button class="modal-close" onclick="closeModal('viewStoreDetailsModal')">Ã—</button>
        <h2><i class="fas fa-info-circle"></i> Store Details</h2>
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <!-- Category -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">Category</label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentCategory">
                    {{ establishment.category.name|default:"N/A" }}
                </p>
            </div>

            <!-- Operating Hours -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">
                    <i class="fas fa-clock"></i> Operating Hours
                </label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentHours">
                    {% if establishment.opening_time and establishment.closing_time %}
                    {{ establishment.opening_time|time:"g:i A" }} - {{ establishment.closing_time|time:"g:i A" }}
                    {% else %}
                    Not Set
                    {% endif %}
                </p>
            </div>

            <!-- Amenities -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">Amenities</label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentAmenities">
                    {% for amenity in establishment.amenities.all %}
                    {{ amenity.name }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                    N/A
                    {% endfor %}
                </p>
            </div>

            <!-- Payment Methods -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">Payment
                    Methods</label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentPaymentMethods">
                    {{ establishment.payment_methods|default:"N/A" }}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="updateStoreDetailsModal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeModal('updateStoreDetailsModal')">Ã—</button>
        <h2><i class="fas fa-edit"></i> Update Store Details</h2>
        <form method="POST" enctype="multipart/form-data" class="modal-form" id="updateStoreDetailsForm"
              action="{% url 'update_establishment_details_ajax' pk=pk %}">
            {% csrf_token %}
            <input type="hidden" name="update_status" value="1">
            <input type="hidden" name="update_token" id="update_token" value="{{ update_token }}">

            <!-- Establishment Name -->
            <div class="form-group">
                {{ status_form.name.label_tag }}
                {{ status_form.name }}
            </div>

            <!-- Address (Auto-filled, Read-only) -->
            <div class="form-group">
                <label for="id_address">
                    Address
                    <span style="color: #999; font-size: 11px; font-weight: normal;">
            (Auto-filled from pin location)
        </span>
                </label>
                <textarea
                        name="address"
                        id="id_address"
                        rows="3"
                        readonly
                        placeholder="Pin your location on the map to auto-fill address">{{ establishment.address }}</textarea>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 4px;">
                    <i class="fas fa-info-circle"></i> Address is automatically set when you pin your location on the
                    map
                </small>
            </div>

            <!-- Pin Location Button -->
            <div class="form-group">
                <label>Pin Location <span style="color: red;">*</span></label>
                <button type="button" class="btn btn-secondary" onclick="openLocationModal()"
                        style="width: 100%; justify-content: center;">
                    <i class="fas fa-map-marker-alt"></i> Set Location on Map
                </button>
                <small id="locationStatus">
                    {% if establishment.latitude and establishment.longitude %}
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Location set: {{ establishment.latitude|floatformat:6 }}, {{ establishment.longitude|floatformat:6
                    }}
                    {% else %}
                    <i class="fas fa-exclamation-circle" style="color: var(--error);"></i>
                    No location set yet
                    {% endif %}
                </small>
            </div>

            <!-- Hidden fields for coordinates -->
            <input type="hidden" name="latitude" id="id_latitude" value="{{ establishment.latitude|default:'' }}">
            <input type="hidden" name="longitude" id="id_longitude" value="{{ establishment.longitude|default:'' }}">
            <input type="hidden" id="previous_lat" value="{{ establishment.latitude|default:'' }}">
            <input type="hidden" id="previous_lng" value="{{ establishment.longitude|default:'' }}">

            <!-- Status -->
            <div class="form-group">
                <label for="id_opening_time">
                    <i class="fas fa-clock"></i> Opening Time
                </label>
                <input type="time"
                       id="id_opening_time"
                       name="opening_time"
                       value="{{ establishment.opening_time|time:'H:i'|default:'' }}"
                       class="form-control">
                <small class="form-text text-muted">Example: 08:00 for 8:00 AM</small>
            </div>

            <div class="form-group">
                <label for="id_closing_time">
                    <i class="fas fa-moon"></i> Closing Time
                </label>
                <input type="time"
                       id="id_closing_time"
                       name="closing_time"
                       value="{{ establishment.closing_time|time:'H:i'|default:'' }}"
                       class="form-control">
                <small class="form-text text-muted">Example: 22:00 for 10:00 PM</small>
            </div>

            <!-- Category -->
            <div class="form-group">
                {{ status_form.category.label_tag }}
                {{ status_form.category }}
            </div>

            <!-- Amenities -->
            <div class="form-group">
                {{ status_form.amenities.label_tag }}
                {{ status_form.amenities }}
            </div>

            <!-- Payment Methods -->
            <div class="form-group">
                <label>Payment Methods</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="payment_cash" name="payment_methods" value="Cash"
                               {% if 'Cash' in establishment.payment_methods %}checked{% endif %}>
                        <label for="payment_cash">Cash</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="payment_gcash" name="payment_methods" value="GCash"
                               {% if 'GCash' in establishment.payment_methods %}checked{% endif %}>
                        <label for="payment_gcash">GCash</label>
                    </div>
                </div>
            </div>

            <!-- Store Image -->
            <div class="form-group">
                {{ status_form.image.label_tag }}
                {% if establishment.image %}
                <img src="{{ establishment.image.url }}" alt="Current"
                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; display: block;">
                {% endif %}
                {{ status_form.image }}
            </div>

            <!-- Submit Button -->
            <button type="submit" name="update_status" class="btn btn-primary"
                    style="width: 100%; justify-content: center; margin-top: 16px;">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </form>
    </div>
</div>

<div class="modal" id="addMenuItemModal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeModal('addMenuItemModal')">Ã—</button>
        <h2><i class="fas fa-plus"></i> Add New Menu Item</h2>

        <div id="debugInfo"
             style="display:none; background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 12px;">
            <strong>Debug:</strong> <span id="debugMessage"></span>
        </div>

        <form method="POST" enctype="multipart/form-data" class="modal-form" id="addMenuItemForm">
            {% csrf_token %}
            <input type="hidden" name="add_menu_item" value="1">
            <input type="hidden" name="menu_add_token" value="{{ menu_add_token }}">

            <div class="form-group">
                <label for="id_name">Menu Name *</label>
                <input type="text" name="name" id="id_name" required maxlength="100">
            </div>

            <div class="form-group">
                <label for="id_description">Description *</label>
                <textarea name="description" id="id_description" required rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="id_price">Price (â‚±) *</label>
                <input type="number" name="price" id="id_price" step="0.01" min="0" required>
            </div>

            <div class="form-group">
                <label for="id_quantity">Quantity</label>
                <input type="number" name="quantity" id="id_quantity" min="0" value="0">
            </div>

            <div class="form-group">
                <label for="id_image">Image (Optional)</label>
                <input type="file" name="image" id="id_image" accept="image/*">
                <small style="color: #666; font-size: 12px;">Recommended: JPG or PNG, max 5MB</small>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                <i class="fas fa-plus"></i> Add Item
            </button>
        </form>
    </div>
</div>

<div class="modal" id="editMenuItemModal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeModal('editMenuItemModal')">Ã—</button>
        <h2><i class="fas fa-edit"></i> Edit Menu Item</h2>
        <form id="editMenuItemForm" method="post" action="" enctype="multipart/form-data" class="modal-form">
            {% csrf_token %}
            <input type="hidden" name="item_id" id="edit_item_id">
            <div class="form-group">
                <label for="edit_item_name">Menu Name</label>
                <input type="text" name="name" id="edit_item_name" required>
            </div>
            <div class="form-group">
                <label for="edit_item_description">Description</label>
                <textarea name="description" id="edit_item_description" required></textarea>
            </div>
            <div class="form-group">
                <label for="edit_item_price">Price</label>
                <input type="text" name="price" id="edit_item_price" required>
            </div>
            <div class="form-group">
                <label for="id_quantity_edit">Quantity</label>
                <input type="number" name="quantity" id="id_quantity_edit" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="edit_item_image">New Image</label>
                <input type="file" name="image" id="edit_item_image" accept="image/*">
                <img id="edit_current_item_image" src="" alt="Current"
                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-top: 8px; display: none;">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </form>
    </div>
</div>

<div class="modal" id="storeReviewsModal">
    <div class="modal-content" style="max-width: 600px; max-height: 70vh;">
        <button class="modal-close" onclick="closeModal('storeReviewsModal')">Ã—</button>
        <h2><i class="fas fa-star"></i> Customer Reviews</h2>
        <div style="display: flex; gap: 16px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
            <div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">{{ total_reviews }}</div>
                <div style="font-size: 13px; color: var(--text-muted);">Total Reviews</div>
            </div>
            {% if average_rating > 0 %}
            <div>
                <div style="font-size: 24px; font-weight: 700; color: var(--primary);">{{ average_rating }}/5.0</div>
                <div style="font-size: 13px; color: var(--text-muted);">
                    {% for i in "12345" %}
                    <i class="fas fa-star{% if forloop.counter > average_rating|floatformat:0 %}-o{% endif %}"
                       style="color: #ffb400;"></i>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            {% for review in dashboard_reviews %}
            <div style="padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div style="font-weight: 700;">{{ review.user.username }}</div>
                    <div style="color: #ffb400;">
                        {% for i in "12345" %}
                        <i class="fas fa-star{% if forloop.counter > review.rating %}-o{% endif %}"></i>
                        {% endfor %}
                    </div>
                </div>
                <p style="margin-bottom: 8px; color: var(--text-muted); font-size: 14px;">{{ review.comment }}</p>
                {% if review.image %}
                <img src="{{ review.image.url }}" alt="Review"
                     style="max-width: 100%; max-height: 150px; border-radius: 6px; margin-bottom: 8px;">
                {% endif %}
                <div style="font-size: 12px; color: #9aa0a6;">{{ review.created_at|date:"M d, Y" }}</div>
            </div>
            {% empty %}
            <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                <i class="fas fa-inbox" style="font-size: 32px; opacity: 0.3; display: block; margin-bottom: 12px;"></i>
                No reviews yet
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal" id="ownerProfileImageModal" style="background: rgba(0, 0, 0, 0.9);">
    <button class="modal-close" onclick="closeModal('ownerProfileImageModal')" style="color: white;">Ã—</button>
    <img id="ownerModalImageView" src="" alt="Profile"
         style="max-width: 90%; max-height: 90vh; border-radius: var(--radius);">
</div>

<div class="modal" id="mapModal">
    <div class="modal-content" style="max-width: 900px; padding: 16px;">
        <button class="modal-close" onclick="closeModal('mapModal')">Ã—</button>

        <h2 style="margin-bottom: 8px;">
            <i class="fas fa-map-marker-alt"></i> Set Establishment Location
        </h2>

        <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
            ðŸ“ Click or drag the pin inside the red circle (500m from CvSU-Bacoor)
        </p>

        <!-- Current Location Display - Simplified & Responsive -->
        <div class="location-display-card">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="location-icon"
                     style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                    ðŸ“
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="location-label"
                         style="font-size: 11px; opacity: 0.9; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        Current Location
                    </div>
                    <div class="location-coords" id="currentLocationDisplay"
                         style="font-size: 16px; font-weight: 700; margin-top: 2px; word-break: break-all;">
                        {{ location_display }}
                    </div>
                    <div class="location-status" style="font-size: 11px; opacity: 0.8; margin-top: 2px;">
                        {% if has_location %}
                        âœ“ Location is set
                        {% else %}
                        âš  Please pin location
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Address Display - Simplified & Responsive -->
        <div class="address-display-card" id="geocodedAddressDisplay" style="display: none;">
            <div style="display: flex; align-items: start; gap: 10px;">
                <div class="address-icon" style="font-size: 22px; flex-shrink: 0;">ðŸ </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="address-title"
                         style="font-weight: 700; color: #2e7d32; margin-bottom: 4px; font-size: 12px;">
                        NEW ADDRESS FOR THIS LOCATION
                    </div>
                    <div class="address-text" id="geocodedAddressText"
                         style="color: #1b5e20; font-size: 13px; line-height: 1.5; word-break: break-word;">
                        <i class="fas fa-spinner fa-spin"></i> Getting address...
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Container - Responsive -->
        <div id="map"></div>

        <!-- Action Buttons - Responsive -->
        <div class="map-actions">
            <button type="button" class="btn btn-secondary" onclick="resetToCvSU()">
                <i class="fas fa-crosshairs"></i> Reset to CvSU
            </button>

            <div class="map-info-text" style="text-align: center; font-size: 12px; color: #666;">
                <i class="fas fa-info-circle"></i> Drag pin or click to set location
            </div>

            <button type="button" class="btn btn-primary" onclick="confirmMapLocation()">
                <i class="fas fa-check-circle"></i> Confirm Location
            </button>
        </div>
    </div>
</div>

<input type="hidden" name="latitude" id="id_latitude" value="{{ current_lat }}">
<input type="hidden" name="longitude" id="id_longitude" value="{{ current_lng }}">
<input type="hidden" id="previous_lat" value="{{ current_lat }}">
<input type="hidden" id="previous_lng" value="{{ current_lng }}">

<div class="message-context-menu" id="ownerMessageContextMenu">
    <div class="context-menu-item" onclick="pinOwnerMessage()">
        <i class="fas fa-thumbtack"></i>
        <span id="ownerPinMenuText">Pin</span>
    </div>
    <div class="context-menu-item danger" onclick="openOwnerUnsendModal()">
        <i class="fas fa-undo"></i>
        <span>Unsend</span>
    </div>
</div>

<div class="unsend-modal" id="ownerUnsendModal">
    <div class="unsend-modal-content">
        <h3>Who do you want to unsend this message for?</h3>

        <div class="unsend-option selected" data-type="everyone" onclick="selectOwnerUnsendOption('everyone')">
            <div class="unsend-option-title">
                <i class="fas fa-users"></i>
                Unsend for everyone
            </div>
            <div class="unsend-option-desc">
                This message will be unsent for everyone in the chat. Others may have already seen or forwarded it.
            </div>
        </div>

        <div class="unsend-option" data-type="you" onclick="selectOwnerUnsendOption('you')">
            <div class="unsend-option-title">
                <i class="fas fa-user"></i>
                Unsend for you
            </div>
            <div class="unsend-option-desc">
                This will remove the message from your devices. Other chat members will still be able to see it.
            </div>
        </div>

        <div class="unsend-modal-buttons">
            <button class="btn-cancel" onclick="closeOwnerUnsendModal()">Cancel</button>
            <button class="btn-remove" onclick="confirmOwnerUnsend()">Remove</button>
        </div>
    </div>
</div>

<div class="pinned-messages-modal" id="ownerPinnedMessagesModal">
    <div class="pinned-messages-modal-content">
        <h3><i class="fas fa-thumbtack"></i> Pinned Messages</h3>
        <div class="pinned-messages-list" id="ownerPinnedMessagesListModal">
        </div>
        <div class="pinned-messages-empty" id="ownerPinnedMessagesEmpty" style="display: none;">
            <i class="fas fa-inbox"></i>
            <p>No pinned messages</p>
        </div>
        <div style="margin-top: 20px; text-align: center;">
            <button class="btn-cancel" onclick="closeOwnerPinnedMessagesModal()">Close</button>
        </div>
    </div>
</div>


{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/food_establishment_dashboard.js' %}"></script>

<!-- ============================================================
     DASHBOARD OVERRIDES â€” must run AFTER food_establishment_dashboard.js
     ============================================================ -->
<script>
// ====================================================
// MARK-ALL-READ BUTTON WIRING
// ====================================================
document.addEventListener('DOMContentLoaded', function() {
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function() {
            if (typeof markAllNotificationsRead === 'function') markAllNotificationsRead();
        });
    }
});

// ====================================================
// MENU ITEM DELETE â€” Custom modal (replaces confirm())
// ====================================================
let _pendingDeleteItemId = null;

window.deleteMenuItem = function(itemId, button) {
    _pendingDeleteItemId = itemId;
    const menuCard = document.querySelector(`.menu-card[data-item-id="${itemId}"]`);
    const itemName = menuCard ? (menuCard.querySelector('.menu-name')?.textContent?.trim() || 'this item') : 'this item';
    document.getElementById('menuItemDeleteName').textContent = '"' + itemName + '"';
    document.getElementById('menuItemDeleteModal').classList.add('active');
};

function closeMenuItemDeleteModal() {
    document.getElementById('menuItemDeleteModal').classList.remove('active');
    _pendingDeleteItemId = null;
}

function confirmMenuItemDelete() {
    const itemId = _pendingDeleteItemId;
    if (!itemId) return;

    const confirmBtn = document.getElementById('confirmMenuItemDeleteBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

    fetch(`/owner/dashboard/delete_menu_item/${itemId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        closeMenuItemDeleteModal();
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Yes, Delete';

        if (data.success) {
            const menuCard = document.querySelector(`.menu-card[data-item-id="${itemId}"]`);
            if (menuCard) {
                menuCard.style.animation = 'fadeOut 0.35s ease forwards';
                setTimeout(() => {
                    menuCard.remove();
                    if (!document.querySelectorAll('.menu-card').length) {
                        const grid = document.querySelector('.menu-grid');
                        if (grid) grid.innerHTML = `<div class="no-items" style="grid-column:1/-1;"><i class="fas fa-inbox"></i><p>No menu items yet. Add your first item!</p></div>`;
                    }
                }, 350);
            }
            showNotification('âœ… ' + data.message, 'success');
        } else {
            showNotification('âŒ ' + (data.message || 'Failed to delete item'), 'error');
        }
    })
    .catch(() => {
        closeMenuItemDeleteModal();
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Yes, Delete';
        showNotification('âŒ An error occurred while deleting', 'error');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const _d = document.getElementById('menuItemDeleteModal');
    if (_d) _d.addEventListener('click', function(e) { if (e.target === this) closeMenuItemDeleteModal(); });
    const _t = document.getElementById('toggleSellerModal');
    if (_t) _t.addEventListener('click', function(e) { if (e.target === this) closeToggleSellerModal(); });
});

// ====================================================
// GLOBAL getCookie HELPER (used by confirmToggleSeller & others)
// ====================================================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ====================================================
// BEST SELLER TOGGLE â€” CLEAN REWRITE
// ====================================================

// Stores the item ID currently pending confirmation
let _activeToggleItemId = null;

function openToggleSellerModal(itemId) {
    _activeToggleItemId = String(itemId);

    // Find the menu card by data-item-id
    const card = document.querySelector('[data-item-id="' + _activeToggleItemId + '"]');

    // Get item name from .menu-name inside the card, fallback to data attribute
    let itemName = 'this item';
    if (card) {
        const nameEl = card.querySelector('.menu-name');
        if (nameEl) itemName = nameEl.textContent.trim() || itemName;
    }

    // Determine current state from the DOM badge
    const isSeller = card ? !!card.querySelector('.badge.bestseller') : false;

    // Update modal UI based on current state
    if (isSeller) {
        document.getElementById('toggleSellerIcon').style.background = 'linear-gradient(135deg,#6b7280,#374151)';
        document.getElementById('toggleSellerTitle').textContent = 'Unmark Best Seller?';
        document.getElementById('toggleSellerSubtitle').textContent = 'Remove the Best Seller badge from this item';
        document.getElementById('toggleSellerWarning').style.cssText = 'border-left:4px solid #6b7280;background:#f9fafb;padding:12px;border-radius:8px;';
        document.getElementById('toggleSellerWarningText').innerHTML = '<i class="fas fa-award"></i> <strong>' + itemName + '</strong> will be unmarked as a Best Seller';
        document.getElementById('toggleSellerWarningText').style.color = '#374151';
        document.getElementById('toggleSellerDesc').textContent = 'The Best Seller badge will be removed. The item will appear as a regular menu item.';
        document.getElementById('confirmToggleSellerBtn').style.background = 'linear-gradient(135deg,#6b7280,#374151)';
        document.getElementById('confirmToggleSellerBtn').innerHTML = '<i class="fas fa-times-circle"></i> Yes, Unmark it';
    } else {
        document.getElementById('toggleSellerIcon').style.background = 'linear-gradient(135deg,#f59e0b,#d97706)';
        document.getElementById('toggleSellerTitle').textContent = 'Mark as Best Seller?';
        document.getElementById('toggleSellerSubtitle').textContent = 'Highlight this item with a Best Seller badge';
        document.getElementById('toggleSellerWarning').style.cssText = 'border-left:4px solid #f59e0b;background:#fffbeb;padding:12px;border-radius:8px;';
        document.getElementById('toggleSellerWarningText').innerHTML = '<i class="fas fa-star"></i> <strong>' + itemName + '</strong> will be marked as a Best Seller';
        document.getElementById('toggleSellerWarningText').style.color = '#92400e';
        document.getElementById('toggleSellerDesc').textContent = 'Best Seller items get a special badge and are highlighted to customers browsing your menu.';
        document.getElementById('confirmToggleSellerBtn').style.background = 'linear-gradient(135deg,#f59e0b,#d97706)';
        document.getElementById('confirmToggleSellerBtn').innerHTML = '<i class="fas fa-award"></i> Yes, Mark it';
    }

    document.getElementById('toggleSellerModal').classList.add('active');
}

function closeToggleSellerModal() {
    document.getElementById('toggleSellerModal').classList.remove('active');
    _activeToggleItemId = null;
}

function confirmToggleSeller() {
    if (!_activeToggleItemId) return;

    const itemId  = _activeToggleItemId;
    const btn     = document.getElementById('confirmToggleSellerBtn');
    const card    = document.querySelector('[data-item-id="' + itemId + '"]');
    const csrfToken = (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value
                   || getCookie('csrftoken');

    // Show loading state on button
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

    fetch('/toggle-top-seller/' + itemId + '/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(function(response) {
        if (!response.ok) throw new Error('Server error: ' + response.status);
        return response.json();
    })
    .then(function(data) {
        closeToggleSellerModal();
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-award"></i> Yes, Mark it';

        if (data.success) {
            // --- Realtime DOM update ---
            if (card) {
                // 1. Update the badges container
                const badgesContainer = card.querySelector('.badges-container');
                if (badgesContainer) {
                    const qty = parseInt(card.dataset.itemQuantity) || 0;
                    const bestsellerBadge = data.is_top_seller
                        ? '<span class="badge bestseller"><i class="fas fa-award"></i> Best Seller</span>'
                        : '';
                    const stockBadge = qty > 0
                        ? '<span class="badge available">Available: ' + qty + '</span>'
                        : '<span class="badge soldout">Out of Stock</span>';
                    badgesContainer.innerHTML = bestsellerBadge + stockBadge;
                }

                // 2. Update the Mark/Unmark button text
                const sellerBtn = card.querySelector('.action-btn.seller');
                if (sellerBtn) {
                    sellerBtn.innerHTML = '<i class="fas fa-award"></i> ' + (data.is_top_seller ? 'Unmark' : 'Mark');
                }

                // 3. Flash the card so the owner sees the change
                card.style.transition = 'box-shadow 0.3s ease';
                card.style.boxShadow = data.is_top_seller
                    ? '0 0 0 3px #f59e0b'
                    : '0 0 0 3px #6b7280';
                setTimeout(function() { card.style.boxShadow = ''; }, 1200);
            }

            // 4. Update the Top Sellers stat counter
            if (typeof updateStoreStats === 'function') updateStoreStats();

            // 5. Show success notification
            const icon = data.is_top_seller ? 'â­' : 'âœ…';
            showNotification(icon + ' ' + data.message, 'success');

        } else {
            showNotification('âŒ ' + (data.message || 'Failed to update. Please try again.'), 'error');
        }
    })
    .catch(function(err) {
        closeToggleSellerModal();
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-award"></i> Yes, Mark it';
        console.error('Best Seller toggle error:', err);
        showNotification('âŒ Connection error. Please check your internet and try again.', 'error');
    });
}


</script>

<script src="{% static 'js/status_updater.js' %}"></script>

<script>
    const establishmentId = {{ establishment.id }};
    const currentUserId = {{ request.user.id }};
    let activeCustomerId = null;
    let chatSocket = null;
    let ownerContextMenuMessageId = null;
    let ownerSelectedUnsendType = 'everyone';
    let ownerPinnedMessages = new Set();
    let ownerMessagesCache = [];

    // Long press detection variables
    let longPressTimer = null;
    let longPressTriggered = false;
    const LONG_PRESS_DURATION = 500;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ==========================================
    // NOTIFICATION PANEL FUNCTIONS
    // ==========================================
    function toggleNotificationPanel() {
        const panel = document.getElementById('notificationPanel');
        const chatPanel = document.getElementById('chatPanel');

        if (panel.classList.contains('open')) {
            panel.classList.remove('open');
        } else {
            panel.classList.add('open');
            // Close chat panel if open
            if (chatPanel) {
                chatPanel.classList.remove('open');
            }
            loadNotifications();
        }
    }

    function loadNotifications() {
        fetch('/api/notifications/', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Filter out locally-deleted notifications
                const deleted = getDeletedNotifIds();
                window._allNotifications = (data.notifications || []).filter(n => !deleted.has(String(n.id)));
                renderFilteredNotifications(window._currentFilter || 'all');
                // Badge should only count unread that aren't deleted
                updateNotificationBadge(window._allNotifications.filter(n => n.is_new).length);
            } else {
                window._allNotifications = [];
                renderFilteredNotifications('all');
            }
        })
        .catch(err => { console.error('Error loading notifications:', err); window._allNotifications = []; renderFilteredNotifications('all'); });
    }

    window.filterNotifications = function(filter) {
        window._currentFilter = filter;
        document.getElementById('notifTabAll').classList.toggle('active', filter === 'all');
        document.getElementById('notifTabUnread').classList.toggle('active', filter === 'unread');
        renderFilteredNotifications(filter);
    };

    function renderFilteredNotifications(filter) {
        const all = window._allNotifications || [];
        const filtered = filter === 'unread' ? all.filter(n => n.is_new) : all;
        displayNotifications(filtered, filter);
    }

    function displayNotifications(notifications, filter) {
        const notificationList = document.getElementById('notificationList');
        const notificationEmptyState = document.getElementById('notificationEmptyState');
        const notificationLoading = document.getElementById('notificationLoading');
        notificationList.querySelectorAll('.notification-item').forEach(el => el.remove());
        if (notificationLoading) notificationLoading.style.display = 'none';
        if (!notifications || notifications.length === 0) {
            if (notificationEmptyState) {
                notificationEmptyState.style.display = 'flex';
                const p = notificationEmptyState.querySelector('p');
                if (p) p.textContent = filter === 'unread' ? 'No unread notifications' : 'No notifications yet';
            }
            return;
        }
        if (notificationEmptyState) notificationEmptyState.style.display = 'none';
        notifications.forEach(notif => notificationList.appendChild(createNotificationElement(notif)));
    }

    function createNotificationElement(notif) {
        const isUnread = notif.is_new ? 'unread' : '';
        const initial = (notif.customer && notif.customer.name) ? notif.customer.name.charAt(0).toUpperCase() : 'U';
        const email = (notif.customer && notif.customer.email) ? notif.customer.email : '';
        const orderId = (notif.order && notif.order.id) ? notif.order.id : 'N/A';
        const status = notif.order ? (notif.order.status || 'pending').toLowerCase() : 'pending';
        const statusIcons = { 'paid': 'check-circle', 'completed': 'check-circle', 'pending': 'clock', 'processing': 'spinner', 'cancelled': 'times-circle' };
        const statusIcon = statusIcons[status] || 'clock';

        const items = (notif.order && notif.order.items) ? notif.order.items.map(item =>
            `<div class="notif-prod">
                <span class="notif-prod-name"><strong>${item.quantity}x</strong> ${escapeHtml(item.name)}</span>
                <span class="notif-prod-price">&#8369;${parseFloat(item.total || item.price || 0).toFixed(2)}</span>
            </div>`
        ).join('') : '';

        const wrapper = document.createElement('div');
        wrapper.className = `notification-item ${isUnread}`;
        wrapper.dataset.nid = notif.id;
        wrapper.innerHTML = `
            <div class="notif-line">
                <span class="notif-email-text">${escapeHtml(email)}</span>
                <div class="notif-arrow"><i class="fas fa-chevron-down"></i></div>
                <button class="notif-delete-btn" title="Delete notification"><i class="fas fa-trash"></i></button>
            </div>
            <div class="notif-expand">
                <div class="notif-inner">
                    ${notif.message ? `<div class="notif-msg">${escapeHtml(notif.message)}</div>` : ''}
                    <div class="notif-block">
                        <div class="notif-sec-label">Customer</div>
                        <div class="notif-cust">
                            <div class="notif-pic">${initial}</div>
                            <div class="notif-cust-data">
                                <div class="notif-cust-name">${escapeHtml(notif.customer ? notif.customer.name : '')}</div>
                                <div class="notif-cust-mail">${escapeHtml(email)}</div>
                            </div>
                        </div>
                    </div>
                    ${notif.order ? `
                    <div class="notif-block">
                        <div class="notif-sec-label">Order Details</div>
                        <div class="notif-ord">
                            <div class="notif-ord-top">
                                <span class="notif-ord-num">Order #${escapeHtml(String(orderId))}</span>
                                <span class="notif-ord-amt">&#8369;${parseFloat(notif.order.total_amount || 0).toFixed(2)}</span>
                            </div>
                            ${notif.order.reference_number && notif.order.reference_number !== 'N/A' ? `<div class="notif-ref"><i class="fas fa-hashtag"></i> Ref: ${escapeHtml(notif.order.reference_number)}</div>` : ''}
                            ${items ? `<div class="notif-list">${items}</div>` : ''}
                            <div class="notif-stat ${status}"><i class="fas fa-${statusIcon}"></i> ${escapeHtml(notif.order.status || 'Pending')}</div>
                        </div>
                    </div>` : ''}
                    <div class="notif-when"><i class="far fa-clock"></i> ${notif.time_ago || 'Just now'}</div>
                </div>
            </div>`;

        wrapper.querySelector('.notif-line').addEventListener('click', function(e) {
            if (e.target.closest('.notif-delete-btn')) return;
            const wasExpanded = wrapper.classList.contains('expanded');
            document.querySelectorAll('.notification-item.expanded').forEach(el => el.classList.remove('expanded'));
            if (!wasExpanded) {
                wrapper.classList.add('expanded');
                if (wrapper.classList.contains('unread')) {
                    wrapper.classList.remove('unread');
                    const n = (window._allNotifications || []).find(x => x.id == notif.id);
                    if (n) n.is_new = false;
                    markNotificationRead(notif.id);
                    updateNotificationBadge((window._allNotifications || []).filter(x => x.is_new).length);
                }
            }
        });

        wrapper.querySelector('.notif-delete-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            window.deleteNotification(notif.id);
        });

        return wrapper;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return String(text).replace(/[&<>"']/g, c => map[c]);
    }

    // Helper: get/set deleted notification IDs from localStorage
    function getDeletedNotifIds() {
        try { return new Set(JSON.parse(localStorage.getItem('_deletedNotifIds') || '[]')); }
        catch(e) { return new Set(); }
    }
    function saveDeletedNotifId(id) {
        try {
            const ids = getDeletedNotifIds();
            ids.add(String(id));
            localStorage.setItem('_deletedNotifIds', JSON.stringify([...ids]));
        } catch(e) {}
    }

    window.deleteNotification = function(notificationId) {
        const item = document.querySelector(`[data-nid="${notificationId}"]`);
        if (!item) return;
        item.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            item.remove();
            // Remove from memory
            window._allNotifications = (window._allNotifications || []).filter(n => n.id != notificationId);
            // Save to localStorage so it stays deleted after refresh + polling
            saveDeletedNotifId(notificationId);
            const list = document.getElementById('notificationList');
            const emptyState = document.getElementById('notificationEmptyState');
            if (list && list.querySelectorAll('.notification-item').length === 0 && emptyState) {
                emptyState.style.display = 'flex';
                const p = emptyState.querySelector('p');
                if (p) p.textContent = (window._currentFilter === 'unread') ? 'No unread notifications' : 'No notifications yet';
            }
            updateNotificationBadge((window._allNotifications || []).filter(n => n.is_new).length);
        }, 300);
        // Mark as read on server (no dismiss endpoint â€” use mark-read to prevent re-showing as unread)
        fetch(`/api/notifications/${notificationId}/mark-read/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
        }).catch(err => console.error('Error on delete/mark-read:', err));
    };

    function markNotificationRead(notificationId) {
        // Mark in-memory permanently
        const n = (window._allNotifications || []).find(x => x.id == notificationId);
        if (n) n.is_new = false;
        fetch(`/api/notifications/${notificationId}/mark-read/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
        }).catch(err => console.error('Error marking notification as read:', err));
    }

    function markAllNotificationsRead() {
        fetch('/api/notifications/mark-all-read/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                (window._allNotifications || []).forEach(n => n.is_new = false);
                updateNotificationBadge(0);
                renderFilteredNotifications(window._currentFilter || 'all');
            }
        })
        .catch(err => console.error('Error marking all as read:', err));
    }

    function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;

        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Realtime: poll every 15s â€” update badge, reload panel if open
    setInterval(() => {
        fetch('/api/notifications/', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                // Filter out deleted IDs before updating
                const deleted = getDeletedNotifIds();
                const filtered = (data.notifications || []).filter(n => !deleted.has(String(n.id)));
                const unreadCount = filtered.filter(n => n.is_new).length;
                updateNotificationBadge(unreadCount);
                // If panel is open, refresh the list
                const panel = document.getElementById('notificationPanel');
                if (panel && panel.classList.contains('open')) {
                    window._allNotifications = filtered;
                    renderFilteredNotifications(window._currentFilter || 'all');
                }
            }
        })
        .catch(err => console.error('Error polling notifications:', err));
    }, 15000);

    // Load initial notification count on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/notifications/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const deleted = getDeletedNotifIds();
                const unreadCount = (data.notifications || []).filter(n => !deleted.has(String(n.id)) && n.is_new).length;
                updateNotificationBadge(unreadCount);
            }
        })
        .catch(error => console.error('Error loading initial notifications:', error));
    });

    // ==========================================
    // CHAT PANEL FUNCTIONS (ORIGINAL)
    // ==========================================

    function loadConversations() {
        fetch(`/owner/chat/conversations/${establishmentId}/`)
            .then(response => response.json())
            .then(data => {
                window._allConversations = data.conversations || [];
                const filter = window._currentChatFilter || 'all';
                renderConversations(window._allConversations, filter);
            })
            .catch(error => {
                console.error('Error loading conversations:', error);
            });
    }

    window.filterConversations = function(filter) {
        window._currentChatFilter = filter;
        document.getElementById('chatTabAll').classList.toggle('active', filter === 'all');
        document.getElementById('chatTabUnread').classList.toggle('active', filter === 'unread');
        renderConversations(window._allConversations || [], filter);
    };

    function renderConversations(conversations, filter) {
        const list = document.getElementById('conversationsList');
        const filtered = filter === 'unread'
            ? conversations.filter(c => c.unread_count > 0)
            : conversations;

        if (filtered && filtered.length > 0) {
            list.innerHTML = filtered.map(conv => {
                const safeName = conv.customer_name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <div class="chat-conversation-item" onclick="openConversation(${conv.customer_id}, '${safeName}')">
                    <div class="chat-avatar">${conv.customer_name.charAt(0).toUpperCase()}</div>
                    <div class="chat-conversation-info">
                        <div class="chat-conversation-name">${conv.customer_name}</div>
                        <div class="chat-conversation-preview">${conv.last_message || 'No messages yet'}</div>
                    </div>
                    <div class="chat-conversation-time">${conv.time || ''}</div>
                    ${conv.unread_count > 0 ? `<div class="chat-unread-badge">${conv.unread_count}</div>` : ''}
                </div>
            `}).join('');

            const totalUnread = conversations.reduce((sum, conv) => sum + (conv.unread_count || 0), 0);
            updateChatBadge(totalUnread);
        } else {
            list.innerHTML = `
                <div class="chat-empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>${filter === 'unread' ? 'No unread messages' : 'No conversations yet'}</p>
                </div>
            `;
            if (filter !== 'unread') updateChatBadge(0);
        }
    }

    function openConversation(customerId, customerName) {
        activeCustomerId = customerId;

        document.getElementById('chatWindowName').textContent = customerName;
        document.getElementById('chatWindowAvatar').textContent = customerName.charAt(0).toUpperCase();

        document.getElementById('chatPanel').classList.remove('open');
        document.getElementById('chatWindow').classList.add('open');

        // Clear this conversation's unread count from badge immediately
        if (window._allConversations) {
            const conv = window._allConversations.find(c => c.customer_id == customerId);
            if (conv) conv.unread_count = 0;
            const totalUnread = window._allConversations.reduce((sum, c) => sum + (c.unread_count || 0), 0);
            updateChatBadge(totalUnread);
        }

        loadMessages(customerId);
        connectWebSocket(customerId);
    }

    function backToConversations() {
        document.getElementById('chatWindow').classList.remove('open');
        document.getElementById('chatPanel').classList.add('open');

        if (chatSocket) {
            chatSocket.close();
            chatSocket = null;
        }

        activeCustomerId = null;
        ownerPinnedMessages.clear();
        ownerMessagesCache = [];
        loadConversations();
    }

    function loadOwnerPinnedMessages() {
        if (!activeCustomerId) return;

        const stored = localStorage.getItem(`owner_pinned_${activeCustomerId}_${establishmentId}`);
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                ownerPinnedMessages = new Set(parsed);
            } catch (e) {
                ownerPinnedMessages = new Set();
            }
        }
    }

    function saveOwnerPinnedMessages() {
        if (!activeCustomerId) return;

        const arr = Array.from(ownerPinnedMessages);
        localStorage.setItem(`owner_pinned_${activeCustomerId}_${establishmentId}`, JSON.stringify(arr));
    }

    function loadMessages(customerId) {
        const container = document.getElementById('chatMessagesContainer');
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Loading messages...</div>';

        // Load pinned messages for this conversation
        loadOwnerPinnedMessages();
        ownerMessagesCache = [];

        fetch(`/owner/chat/messages/${customerId}/${establishmentId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    container.innerHTML = '';

                    data.messages.forEach(msg => {
                        const msgData = {
                            id: msg.id,
                            sender_id: msg.sender_id,
                            content: msg.content,
                            timestamp: msg.timestamp
                        };
                        ownerMessagesCache.push(msgData);

                        const senderId = parseInt(msg.sender_id);
                        const ownerId = parseInt(currentUserId);
                        const isMyMessage = senderId === ownerId;

                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${isMyMessage ? 'sent' : 'received'}`;
                        messageDiv.dataset.messageId = msg.id;

                        // Check if pinned
                        if (ownerPinnedMessages.has(msg.id)) {
                            messageDiv.classList.add('pinned');
                        }

                        const optionsButton = isMyMessage ? `
                            <button class="message-options-btn" onclick="showOwnerOptionsMenu(event, ${msg.id})">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        ` : '';

                        messageDiv.innerHTML = `
                            ${optionsButton}
                            <div class="chat-message-bubble">
                                <div>${escapeHtml(msg.content)}</div>
                                <span class="chat-message-time">${msg.timestamp}</span>
                            </div>
                        `;

                        if (isMyMessage) {
                            attachLongPressHandlers(messageDiv, msg.id);
                        }

                        container.appendChild(messageDiv);
                    });

                    updateOwnerPinnedSection();
                } else {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No messages yet. Start the conversation! ðŸ’¬</div>';
                }

                scrollToBottom();
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #f00;">Failed to load messages</div>';
            });
    }

    function connectWebSocket(customerId) {
        if (chatSocket) {
            chatSocket.close();
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${customerId}/${establishmentId}/`;

        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function(e) {
            console.log('âœ… Chat connected');
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if (data.type === 'chat_message') {
                addMessageToChat(data);
            }
            else if (data.type === 'message_unsent') {
                handleOwnerMessageUnsent(data);
            }
        };

        chatSocket.onerror = function(e) {
            console.error('Chat connection error');
        };

        chatSocket.onclose = function(e) {
            console.log('Chat disconnected');
        };
    }

    function sendMessage(event) {
        event.preventDefault();

        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message || !chatSocket || !activeCustomerId) {
            return;
        }

        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'message': message,
            'sender_id': currentUserId
        }));

        input.value = '';
        input.focus();
    }

    function addMessageToChat(data) {
        const container = document.getElementById('chatMessagesContainer');
        const messageDiv = document.createElement('div');

        const senderId = parseInt(data.sender_id);
        const ownerId = parseInt(currentUserId);
        const isMyMessage = senderId === ownerId;

        messageDiv.className = `chat-message ${isMyMessage ? 'sent' : 'received'}`;
        messageDiv.dataset.messageId = data.message_id;

        // Add to cache
        ownerMessagesCache.push({
            id: data.message_id,
            sender_id: data.sender_id,
            content: data.message,
            timestamp: data.timestamp
        });

        const optionsButton = isMyMessage ? `
            <button class="message-options-btn" onclick="showOwnerOptionsMenu(event, ${data.message_id})">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        ` : '';

        messageDiv.innerHTML = `
            ${optionsButton}
            <div class="chat-message-bubble">
                <div>${escapeHtml(data.message)}</div>
                <span class="chat-message-time">${data.timestamp}</span>
            </div>
        `;

        if (isMyMessage) {
            attachLongPressHandlers(messageDiv, data.message_id);
        }

        container.appendChild(messageDiv);
        scrollToBottom();
    }

    // ==========================================
    // LONG PRESS DETECTION (MOBILE)
    // ==========================================

    function attachLongPressHandlers(messageElement, messageId) {
        // Touch events
        messageElement.addEventListener('touchstart', function(e) {
            longPressTriggered = false;
            messageElement.classList.add('long-pressing');

            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                messageElement.classList.remove('long-pressing');

                const touch = e.touches[0];
                showOwnerContextMenuAtPosition(touch.clientX, touch.clientY, messageId);

                e.preventDefault();
            }, LONG_PRESS_DURATION);
        }, { passive: false });

        messageElement.addEventListener('touchend', function(e) {
            clearTimeout(longPressTimer);
            messageElement.classList.remove('long-pressing');

            if (longPressTriggered) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        messageElement.addEventListener('touchmove', function(e) {
            clearTimeout(longPressTimer);
            messageElement.classList.remove('long-pressing');
        });

        // Mouse events (for desktop)
        messageElement.addEventListener('mousedown', function(e) {
            if (e.button !== 0) return;

            longPressTriggered = false;

            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                showOwnerContextMenuAtPosition(e.clientX, e.clientY, messageId);
            }, LONG_PRESS_DURATION);
        });

        messageElement.addEventListener('mouseup', function(e) {
            clearTimeout(longPressTimer);
        });

        messageElement.addEventListener('mouseleave', function(e) {
            clearTimeout(longPressTimer);
        });
    }

    // ==========================================
    // CONTEXT MENU (DESKTOP & MOBILE FIX)
    // ==========================================

    function showOwnerOptionsMenu(event, messageId) {
        event.stopPropagation();
        event.preventDefault();

        const rect = event.target.closest('button').getBoundingClientRect();
        showOwnerContextMenuAtPosition(rect.left, rect.bottom + 5, messageId);
    }

    function showOwnerContextMenuAtPosition(x, y, messageId) {
        const contextMenu = document.getElementById('ownerMessageContextMenu');
        ownerContextMenuMessageId = messageId;

        // Update pin/unpin text
        const isPinned = ownerPinnedMessages.has(messageId);
        document.getElementById('ownerPinMenuText').textContent = isPinned ? 'Unpin' : 'Pin';

        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';

        // Adjust if menu goes off-screen
        setTimeout(() => {
            const menuRect = contextMenu.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (menuRect.right > windowWidth) {
                contextMenu.style.left = (x - menuRect.width) + 'px';
            }

            if (menuRect.bottom > windowHeight) {
                contextMenu.style.top = (y - menuRect.height - 10) + 'px';
            }
        }, 10);

        contextMenu.classList.add('active');

        // âœ… FIX: Delay listening for clicks slightly
        setTimeout(() => {
            document.addEventListener('click', hideOwnerContextMenu);
            document.addEventListener('touchstart', hideOwnerContextMenu);
        }, 100);
    }

    function hideOwnerContextMenu(e) {
        const contextMenu = document.getElementById('ownerMessageContextMenu');

        // âœ… CRITICAL FIX: Don't close if clicking INSIDE the menu
        if (contextMenu && contextMenu.contains(e.target)) {
            return;
        }

        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideOwnerContextMenu);
        document.removeEventListener('touchstart', hideOwnerContextMenu);
    }

    function updateChatBadge(count) {
        const badge = document.getElementById('chatBadge');
        if (!badge) return;
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }

    function scrollToBottom() {
        const container = document.getElementById('chatMessagesContainer');
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==========================================
    // PIN FUNCTIONALITY (PERSISTENT)
    // ==========================================

    function pinOwnerMessage() {
        // âœ… FORCE CLOSE MENU MANUALLY (Since we prevented auto-close inside menu)
        const contextMenu = document.getElementById('ownerMessageContextMenu');
        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideOwnerContextMenu);
        document.removeEventListener('touchstart', hideOwnerContextMenu);

        if (!ownerContextMenuMessageId) return;

        const messageEl = document.querySelector(`.chat-message[data-message-id="${ownerContextMenuMessageId}"]`);
        if (!messageEl) return;

        const isPinned = ownerPinnedMessages.has(ownerContextMenuMessageId);

        if (isPinned) {
            // Unpin
            ownerPinnedMessages.delete(ownerContextMenuMessageId);
            messageEl.classList.remove('pinned');
        } else {
            // Pin
            ownerPinnedMessages.add(ownerContextMenuMessageId);
            messageEl.classList.add('pinned');
        }

        saveOwnerPinnedMessages();
        updateOwnerPinnedSection();
    }

    function updateOwnerPinnedSection() {
        const pinnedSection = document.getElementById('ownerPinnedSection');
        const pinnedList = document.getElementById('ownerPinnedMessagesList');
        const seePinsLink = document.getElementById('ownerSeePinsLink');

        if (ownerPinnedMessages.size === 0) {
            pinnedSection.classList.remove('active');
            seePinsLink.classList.remove('active');
            return;
        }

        pinnedSection.classList.add('active');
        seePinsLink.classList.add('active');

        // Show max 3 pinned messages in section
        pinnedList.innerHTML = '';
        const pinnedArray = Array.from(ownerPinnedMessages).slice(-3);

        pinnedArray.forEach(msgId => {
            const msg = ownerMessagesCache.find(m => m.id === msgId);
            if (msg) {
                const item = document.createElement('div');
                item.className = 'pinned-message-item';
                item.onclick = function() {
                     // Scroll to message functionality
                    const el = document.querySelector(`.chat-message[data-message-id="${msgId}"]`);
                    if(el) el.scrollIntoView({behavior: "smooth", block: "center"});
                };
                item.innerHTML = `
                    <i class="fas fa-thumbtack"></i>
                    <span class="pinned-message-text">${escapeHtml(msg.content)}</span>
                    <button class="unpin-btn" onclick="unpinOwnerMessage(${msgId}, event)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                pinnedList.appendChild(item);
            }
        });
    }

    function unpinOwnerMessage(messageId, event) {
        if (event) {
            event.stopPropagation();
        }

        ownerPinnedMessages.delete(messageId);
        saveOwnerPinnedMessages();

        const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
        if (messageEl) {
            messageEl.classList.remove('pinned');
        }

        updateOwnerPinnedSection();
    }

    // âœ… UPDATED TOGGLE FUNCTION
    function toggleOwnerPinnedSection() {
        const list = document.getElementById('ownerPinnedMessagesList');
        const icon = document.querySelector('.owner-pinned-collapse i');

        if (list.style.display === 'none') {
            list.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
        } else {
            list.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
        }
    }

    // ==========================================
    // PINNED MESSAGES MODAL
    // ==========================================

    function openOwnerPinnedMessagesModal() {
        const modal = document.getElementById('ownerPinnedMessagesModal');
        const modalList = document.getElementById('ownerPinnedMessagesListModal');
        const emptyState = document.getElementById('ownerPinnedMessagesEmpty');

        if (ownerPinnedMessages.size === 0) {
            modalList.innerHTML = '';
            emptyState.style.display = 'block';
        } else {
            emptyState.style.display = 'none';
            modalList.innerHTML = '';

            Array.from(ownerPinnedMessages).forEach(msgId => {
                const msg = ownerMessagesCache.find(m => m.id === msgId);
                if (msg) {
                    const item = document.createElement('div');
                    item.className = 'pinned-message-item';
                    item.innerHTML = `
                        <i class="fas fa-thumbtack"></i>
                        <span class="pinned-message-text">${escapeHtml(msg.content)}</span>
                        <button class="unpin-btn" onclick="unpinOwnerMessage(${msgId}, event)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    modalList.appendChild(item);
                }
            });
        }

        modal.classList.add('active');
    }

    function closeOwnerPinnedMessagesModal() {
        const modal = document.getElementById('ownerPinnedMessagesModal');
        modal.classList.remove('active');
    }

    // ==========================================
    // UNSEND FUNCTIONALITY (PERSISTENT)
    // ==========================================

    function openOwnerUnsendModal() {
        // âœ… FORCE CLOSE MENU MANUALLY
        const contextMenu = document.getElementById('ownerMessageContextMenu');
        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideOwnerContextMenu);
        document.removeEventListener('touchstart', hideOwnerContextMenu);

        const modal = document.getElementById('ownerUnsendModal');
        modal.classList.add('active');
        ownerSelectedUnsendType = 'everyone';
    }

    function closeOwnerUnsendModal() {
        const modal = document.getElementById('ownerUnsendModal');
        modal.classList.remove('active');
        ownerContextMenuMessageId = null;
    }

    function selectOwnerUnsendOption(type) {
        ownerSelectedUnsendType = type;

        document.querySelectorAll('#ownerUnsendModal .unsend-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`#ownerUnsendModal .unsend-option[data-type="${type}"]`).classList.add('selected');
    }

    function confirmOwnerUnsend() {
        if (!ownerContextMenuMessageId || !chatSocket) {
            console.error('Cannot unsend: missing message ID or socket');
            return;
        }

        const removeBtn = document.querySelector('#ownerUnsendModal .btn-remove');
        removeBtn.disabled = true;
        removeBtn.textContent = 'Removing...';

        chatSocket.send(JSON.stringify({
            'type': 'unsend_message',
            'message_id': ownerContextMenuMessageId,
            'unsend_type': ownerSelectedUnsendType,
            'sender_id': currentUserId
        }));

        setTimeout(() => {
            closeOwnerUnsendModal();
            removeBtn.disabled = false;
            removeBtn.textContent = 'Remove';
        }, 500);
    }

    function handleOwnerMessageUnsent(data) {
        const messageId = data.message_id;
        const unsendType = data.unsend_type;
        const unsent_by = parseInt(data.unsent_by);
        const ownerId = parseInt(currentUserId);

        const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);

        if (!messageEl) {
            return;
        }

        if (unsendType === 'everyone') {
            const bubble = messageEl.querySelector('.chat-message-bubble');
            messageEl.classList.add('deleted');

            const optionsBtn = messageEl.querySelector('.message-options-btn');
            if (optionsBtn) {
                optionsBtn.remove();
            }

            bubble.innerHTML = `
                <div>Message was unsent</div>
                <span class="chat-message-time">${new Date().toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}</span>
            `;

            ownerMessagesCache = ownerMessagesCache.filter(msg => msg.id !== messageId);
        }
        else if (unsendType === 'you' && unsent_by === ownerId) {
            messageEl.remove();
            ownerMessagesCache = ownerMessagesCache.filter(msg => msg.id !== messageId);
        }

        // Remove from pinned if it was pinned
        if (ownerPinnedMessages.has(messageId)) {
            ownerPinnedMessages.delete(messageId);
            saveOwnerPinnedMessages();
            updateOwnerPinnedSection();
        }
    }

    function debugLog(message) {
        console.log('ðŸ” DEBUG:', message);
        const debugDiv = document.getElementById('debugInfo');
        const debugMsg = document.getElementById('debugMessage');
        if (debugDiv && debugMsg) {
            debugMsg.textContent = message;
            debugDiv.style.display = 'block';
            setTimeout(() => {
                debugDiv.style.display = 'none';
            }, 5000);
        }
    }



    // Sidebar toggle functionality
    function toggleSidebar() {
        const sidebar = document.getElementById('mainSidebar');
        const body = document.body;

        if (window.innerWidth <= 768) {
            // Mobile: slide in/out
            sidebar.classList.toggle('mobile-open');
        } else {
            // Desktop: collapse/expand
            sidebar.classList.toggle('collapsed');
            body.classList.toggle('sidebar-collapsed');
        }
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById('mainSidebar');
            const toggleBtn = document.querySelector('.sidebar-toggle-btn');

            if (sidebar && sidebar.classList.contains('mobile-open') &&
                !sidebar.contains(e.target) &&
                !toggleBtn?.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        }
    });



// Profile Modal Functions
function openProfileModal() {
    const modal = document.getElementById('profileModal');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeProfileModal() {
    const modal = document.getElementById('profileModal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

function closeDropdown() {
    const menu = document.getElementById('navMenu');
    if (menu) {
        menu.classList.remove('show');
    }
}

// Close profile modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('profileModal');
    if (modal && e.target === modal) {
        closeProfileModal();
    }
});

// Close profile modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeProfileModal();
    }
});


        {% block page_javascript %}
    // Page-specific JavaScript
    {% endblock %}
</script>
<button id="scrollToTopBtn" class="scroll-to-top" style="z-index: 10000;">
    <i class="fas fa-arrow-up"></i>
</button>

<!-- Dashboard Alert Container - Upper Center -->
<div id="dashboardAlertContainer"></div>

<script>
// Override showNotification to show at upper center of dashboard
window.showNotification = function(message, type = 'success') {
    const container = document.getElementById('dashboardAlertContainer');
    if (!container) return;

    const iconMap = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'info': 'info-circle',
        'warning': 'exclamation-triangle'
    };

    const alert = document.createElement('div');
    alert.className = `dash-alert ${type}`;
    alert.innerHTML = `
        <i class="fas fa-${iconMap[type] || 'info-circle'} alert-icon"></i>
        <span class="alert-msg">${message}</span>
        <button class="alert-close-btn" title="Close"><i class="fas fa-times"></i></button>
    `;

    alert.querySelector('.alert-close-btn').addEventListener('click', () => removeDashAlert(alert));
    container.appendChild(alert);

    // Auto-remove after 4 seconds
    setTimeout(() => removeDashAlert(alert), 4000);
};

function removeDashAlert(el) {
    if (!el || !el.parentNode) return;
    el.style.animation = 'dashAlertOut 0.3s ease forwards';
    setTimeout(() => { if (el.parentNode) el.remove(); }, 300);
}
</script>


<!-- ========================================== -->
<!-- PAYMENT SUCCESS PAGE - BACK TO DASHBOARD BUTTON -->
<!-- ========================================== -->
{% if payment_success %}
<div class="payment-success-container">
    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
        <i class="fas fa-check" style="font-size: 40px; color: white;"></i>
    </div>
    <h1 style="font-size: 32px; font-weight: 800; color: #1a1a1a; margin-bottom: 12px;">
        Payment Successful!
    </h1>
    <p style="color: #6b7280; font-size: 16px; margin-bottom: 32px;">
        Your order has been confirmed. Thank you for your purchase!
    </p>
    <a href="{% url 'food_establishment_dashboard' %}" class="back-to-dashboard-btn">
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
    </a>
</div>
{% endif %}


<footer class="footer">
    <div class="footer-container">
        <div class="footer-section">
            <h3>
                <i class="fas fa-utensils"></i>
                KabsuEats
            </h3>
            <p>Your trusted food shops platform connecting you with the best local restaurants and food
                establishments.</p>
            <div class="footer-social">
                <a href="#" class="social-icon" aria-label="Facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="#" class="social-icon" aria-label="Instagram">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="#" class="social-icon" aria-label="Twitter">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="#" class="social-icon" aria-label="TikTok">
                    <i class="fab fa-tiktok"></i>
                </a>
            </div>
        </div>

        <div class="footer-section">
            <h3>
                <i class="fas fa-link"></i>
                Quick Links
            </h3>
            <ul class="footer-links">
                <li><a href="#"><i class="fas fa-chevron-right"></i> About Us</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> How It Works</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Partner With Us</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Careers</a></li>
            </ul>
        </div>

        <div class="footer-section">
            <h3>
                <i class="fas fa-file-alt"></i>
                Legal
            </h3>
            <ul class="footer-links">
                <li><a href="#"><i class="fas fa-chevron-right"></i> Terms & Conditions</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Privacy Policy</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Cookie Policy</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Refund Policy</a></li>
            </ul>
        </div>

        <div class="footer-section">
            <h3>
                <i class="fas fa-headset"></i>
                Contact Us
            </h3>
            <ul class="footer-links">
                <li><a href="mailto:support@kabsueats.com"><i class="fas fa-envelope"></i> support@kabsueats.com</a>
                </li>
                <li><a href="tel:+639123456789"><i class="fas fa-phone"></i> +63 920 772 6237</a></li>
                <li><a href="#"><i class="fas fa-map-marker-alt"></i> Cavite, Philippines</a></li>
                <li><a href="#"><i class="fas fa-clock"></i> 24/7 Support</a></li>
            </ul>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2024 <a href="#">KabsuEats</a>. All rights reserved. Made with <i class="fas fa-heart"
                                                                                    style="color: var(--primary);"></i>
            in the Philippines</p>
    </div>
</footer>
<script>
// ====================================================
// MARK-ALL-READ BUTTON WIRING
// ====================================================
document.addEventListener('DOMContentLoaded', function() {
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function() {
            if (typeof markAllNotificationsRead === 'function') markAllNotificationsRead();
        });
    }
});

// ====================================================
// MENU ITEM DELETE â€” Custom modal (replaces confirm())
// ====================================================
let _pendingDeleteItemId = null;

window.deleteMenuItem = function(itemId, button) {
    _pendingDeleteItemId = itemId;
    const menuCard = document.querySelector(`.menu-card[data-item-id="${itemId}"]`);
    const itemName = menuCard ? (menuCard.querySelector('.menu-name')?.textContent?.trim() || 'this item') : 'this item';
    document.getElementById('menuItemDeleteName').textContent = '"' + itemName + '"';
    document.getElementById('menuItemDeleteModal').classList.add('active');
};

function closeMenuItemDeleteModal() {
    document.getElementById('menuItemDeleteModal').classList.remove('active');
    _pendingDeleteItemId = null;
}

function confirmMenuItemDelete() {
    const itemId = _pendingDeleteItemId;
    if (!itemId) return;

    const confirmBtn = document.getElementById('confirmMenuItemDeleteBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

    fetch(`/owner/dashboard/delete_menu_item/${itemId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        closeMenuItemDeleteModal();
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Yes, Delete';

        if (data.success) {
            const menuCard = document.querySelector(`.menu-card[data-item-id="${itemId}"]`);
            if (menuCard) {
                menuCard.style.animation = 'fadeOut 0.35s ease forwards';
                setTimeout(() => {
                    menuCard.remove();
                    if (!document.querySelectorAll('.menu-card').length) {
                        const grid = document.querySelector('.menu-grid');
                        if (grid) grid.innerHTML = `<div class="no-items" style="grid-column:1/-1;"><i class="fas fa-inbox"></i><p>No menu items yet. Add your first item!</p></div>`;
                    }
                }, 350);
            }
            showNotification('âœ… ' + data.message, 'success');
        } else {
            showNotification('âŒ ' + (data.message || 'Failed to delete item'), 'error');
        }
    })
    .catch(() => {
        closeMenuItemDeleteModal();
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Yes, Delete';
        showNotification('âŒ An error occurred while deleting', 'error');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const _d = document.getElementById('menuItemDeleteModal');
    if (_d) _d.addEventListener('click', function(e) { if (e.target === this) closeMenuItemDeleteModal(); });
    const _t = document.getElementById('toggleSellerModal');
    if (_t) _t.addEventListener('click', function(e) { if (e.target === this) closeToggleSellerModal(); });
});

// Sync float chat badge with navbar chat badge
(function syncChatFloatBadge() {
    const navBadge = document.getElementById('chatBadge');
    const floatBadge = document.getElementById('chatFloatBadge');
    if (!navBadge || !floatBadge) return;

    function update() {
        const text = navBadge.textContent.trim();
        const hidden = navBadge.style.display === 'none';
        if (!hidden && text && text !== '0') {
            floatBadge.textContent = text;
            floatBadge.style.display = 'flex';
        } else {
            floatBadge.style.display = 'none';
        }
    }

    // Watch for changes to navBadge
    const observer = new MutationObserver(update);
    observer.observe(navBadge, { childList: true, subtree: true, attributes: true });
    update(); // initial sync
})();
</script>
{% endblock %}

</body>
</html>