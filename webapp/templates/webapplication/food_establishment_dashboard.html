{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}"/>
    <title>{% block page_title %}{{ establishment.name }} - Dashboard{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    {% block extra_head_links %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
    {% endblock %}
    <link rel="stylesheet" href="{% static 'css/owner_dashboard_styless.css' %}">
</head>
<body>
<nav class="navbar">
    <div class="navbar-container">
        <a href="{% url 'food_establishment_dashboard' %}" class="navbar-logo">
            KabsuEats
        </a>
        <div class="navbar-actions">
            <!-- Dashboard Button (Active) -->
            <a href="{% url 'food_establishment_dashboard' %}" class="nav-icon-btn {% if request.resolver_match.url_name == 'food_establishment_dashboard' %}active{% endif %}" title="Dashboard" style="text-decoration: none; color: inherit;">
                <i class="fas fa-chart-line"></i>
                <span class="nav-btn-label">Dashboard</span>
            </a>

            <!-- Orders Button -->
            <a href="{% url 'orders_list' %}" class="nav-icon-btn {% if request.resolver_match.url_name == 'orders_list' %}active{% endif %}" title="Orders" style="text-decoration: none; color: inherit;">
                <i class="fas fa-shopping-bag"></i>
                <span class="nav-btn-label">Orders</span>
            </a>

            <!-- Transaction History Button -->
            <a href="{% url 'user_transactions' %}" class="nav-icon-btn {% if request.resolver_match.url_name == 'transaction_history' %}active{% endif %}" title="Transaction History" style="text-decoration: none; color: inherit;">
                <i class="fas fa-history"></i>
                <span class="nav-btn-label">Transactions</span>
            </a>

            <button class="notification-toggle-btn" onclick="toggleNotificationPanel()" id="notificationToggleBtn"
                    title="Notifications">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>

            <button class="chat-toggle-btn" onclick="toggleChatPanel()" id="chatToggleBtn" title="Messages">
                <i class="fas fa-envelope"></i>
                <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
            </button>

            <div class="navbar-dropdown">
                <button class="navbar-btn" onclick="toggleDropdown()" title="Menu">
                    <i class="fas fa-user-circle"></i>
                    <span>{{ establishment.name }}</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="navbar-menu" id="navMenu">
                    <a href="#" onclick="showDeleteConfirmation(event)" class="delete-establishment-link">
                        <i class="fas fa-trash-alt"></i>
                        <span>Delete Establishment</span>
                    </a>
                    <a href="{% url 'logout_owner' %}" class="logout-link">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Delete Establishment Confirmation Modal -->
<div class="delete-modal-overlay" id="deleteModal">
    <div class="delete-modal">
        <div class="delete-modal-header">
            <div class="delete-modal-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="delete-modal-title">
                <h3>Delete Establishment?</h3>
                <p>This action cannot be undone</p>
            </div>
        </div>
        <div class="delete-modal-body">
            <div class="delete-warning">
                <p><i class="fas fa-info-circle"></i> You are about to permanently delete your establishment</p>
            </div>
            <div class="delete-consequences">
                <h4>This will permanently remove:</h4>
                <ul>
                    <li><i class="fas fa-check"></i> Your establishment profile</li>
                    <li><i class="fas fa-check"></i> All menu items and categories</li>
                    <li><i class="fas fa-check"></i> Order history and customer data</li>
                    <li><i class="fas fa-check"></i> Reviews and ratings</li>
                    <li><i class="fas fa-check"></i> Chat conversations</li>
                </ul>
            </div>
        </div>
        <div class="delete-modal-actions">
            <button class="btn-cancel" onclick="hideDeleteConfirmation()">
                <i class="fas fa-times"></i> Cancel
            </button>
            <button class="btn-delete" onclick="confirmDeleteEstablishment()" id="confirmDeleteBtn">
                <i class="fas fa-trash-alt"></i> Yes, Delete
            </button>
        </div>
    </div>
</div>

<!-- IMPROVED COMPACT NOTIFICATION PANEL -->
<div class="notification-panel" id="notificationPanel">
    <!-- Panel Header -->
    <div class="notification-panel-header">
        <div class="notification-panel-title">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
        </div>
        <div class="notification-header-actions">
            <button class="mark-all-read-btn" id="markAllReadBtn" title="Mark all as read">
                <i class="fas fa-check-double"></i>
            </button>
            <button class="close-notification-btn" id="closeNotificationBtn" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Notification List -->
    <div class="notification-list" id="notificationList">
        <!-- Loading State -->
        <div class="notification-loading" id="notificationLoading" style="display: none;">
            <i class="fas fa-spinner"></i>
        </div>

        <!-- Empty State -->
        <div class="notification-empty-state" id="notificationEmptyState" style="display: none;">
            <i class="fas fa-bell-slash"></i>
            <p>No notifications yet</p>
        </div>

        <!-- Notifications will be dynamically inserted here -->
    </div>
</div>

<!-- Compact Notification Item Template -->
<template id="notificationItemTemplate">
    <div class="notification-item" data-notification-id="">
        <!-- Top Row: Icon + Title + Badge -->
        <div class="notification-top-row">
            <div class="notification-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="notification-title-section">
                <div class="notification-title-text">New Order</div>
                <p class="notification-message">Order has been completed</p>
            </div>
            <span class="notification-type-badge order">ORDER</span>
        </div>

        <!-- Customer Info - Compact -->
        <div class="customer-info-compact">
            <div class="customer-avatar-small">
                <span class="customer-initial">R</span>
            </div>
            <div class="customer-details-compact">
                <div class="customer-name-compact">Customer Name</div>
                <div class="customer-email-compact">customer@email.com</div>
            </div>
        </div>

        <!-- Order Summary - Compact -->
        <div class="order-summary-compact">
            <div class="order-header-compact">
                <span class="order-id-compact">Order #1</span>
                <span class="order-total-compact">‚Ç±150.00</span>
            </div>

            <div class="order-reference-compact">
                <i class="fas fa-link"></i>
                <span>Ref: link_xxxxx</span>
            </div>

            <div class="order-items-compact">
                <div class="order-item-compact">
                    <span class="item-name-compact">
                        <span class="item-quantity">1x</span> Item Name
                    </span>
                    <span class="item-price-compact">‚Ç±75.00</span>
                </div>
            </div>

            <div class="order-status-compact completed">
                <i class="fas fa-check-circle"></i>
                <span>COMPLETED</span>
            </div>
        </div>

        <!-- Notification Footer -->
        <div class="notification-footer-compact">
            <div class="time-ago-compact">
                <i class="far fa-clock"></i>
                <span class="time-text">1 hour ago</span>
            </div>
        </div>
    </div>
</template>

<script>
// Compact Notification Panel JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const notificationToggle = document.getElementById('notificationToggle');
    const notificationPanel = document.getElementById('notificationPanel');
    const closeNotificationBtn = document.getElementById('closeNotificationBtn');
    const markAllReadBtn = document.getElementById('markAllReadBtn');
    const notificationList = document.getElementById('notificationList');
    const notificationLoading = document.getElementById('notificationLoading');
    const notificationEmptyState = document.getElementById('notificationEmptyState');
    const notificationBadge = document.querySelector('.notification-badge');

    // Toggle notification panel
    if (notificationToggle) {
        notificationToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            notificationPanel.classList.toggle('show');
            if (notificationPanel.classList.contains('show')) {
                loadNotifications();
            }
        });
    }

    // Close notification panel
    if (closeNotificationBtn) {
        closeNotificationBtn.addEventListener('click', function() {
            notificationPanel.classList.remove('show');
        });
    }

    // Mark all as read
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function() {
            markAllNotificationsAsRead();
        });
    }

    // Close panel when clicking outside
    document.addEventListener('click', function(e) {
        if (notificationPanel.classList.contains('show') &&
            !notificationPanel.contains(e.target) &&
            !notificationToggle.contains(e.target)) {
            notificationPanel.classList.remove('show');
        }
    });

    // Load notifications from server
    function loadNotifications() {
        notificationLoading.style.display = 'flex';
        notificationEmptyState.style.display = 'none';

        const existingItems = notificationList.querySelectorAll('.notification-item');
        existingItems.forEach(item => item.remove());

        fetch('/api/notifications/')
            .then(response => response.json())
            .then(data => {
                notificationLoading.style.display = 'none';

                if (data.notifications && data.notifications.length > 0) {
                    renderNotifications(data.notifications);
                    updateNotificationBadge(data.unread_count);
                } else {
                    notificationEmptyState.style.display = 'flex';
                }
            })
            .catch(error => {
                console.error('Error loading notifications:', error);
                notificationLoading.style.display = 'none';
                notificationEmptyState.style.display = 'flex';
            });
    }

    // Render notifications
    function renderNotifications(notifications) {
        const template = document.getElementById('notificationItemTemplate');

        notifications.forEach(notification => {
            const clone = template.content.cloneNode(true);
            const item = clone.querySelector('.notification-item');

            item.dataset.notificationId = notification.id;
            if (!notification.is_read) {
                item.classList.add('unread');
            }

            const titleText = clone.querySelector('.notification-title-text');
            const message = clone.querySelector('.notification-message');
            titleText.textContent = notification.title || 'New Order';
            message.textContent = notification.message || 'Order has been completed';

            const typeBadge = clone.querySelector('.notification-type-badge');
            typeBadge.textContent = notification.notification_type ? notification.notification_type.toUpperCase() : 'ORDER';

            if (notification.customer_name && notification.customer_email) {
                const customerInitial = clone.querySelector('.customer-initial');
                const customerName = clone.querySelector('.customer-name-compact');
                const customerEmail = clone.querySelector('.customer-email-compact');

                customerInitial.textContent = notification.customer_name.charAt(0).toUpperCase();
                customerName.textContent = notification.customer_name;
                customerEmail.textContent = notification.customer_email;
            } else {
                clone.querySelector('.customer-info-compact').remove();
            }

            if (notification.order_id) {
                const orderIdText = clone.querySelector('.order-id-compact');
                const orderTotalAmount = clone.querySelector('.order-total-compact');
                const orderReference = clone.querySelector('.order-reference-compact span');

                orderIdText.textContent = `Order #${notification.order_id}`;
                orderTotalAmount.textContent = `‚Ç±${parseFloat(notification.total_amount || 0).toFixed(2)}`;

                if (notification.payment_reference) {
                    orderReference.textContent = `Ref: ${notification.payment_reference}`;
                } else {
                    clone.querySelector('.order-reference-compact').remove();
                }

                const orderItemsContainer = clone.querySelector('.order-items-compact');
                orderItemsContainer.innerHTML = '';

                if (notification.order_items && notification.order_items.length > 0) {
                    notification.order_items.forEach(orderItem => {
                        const itemRow = document.createElement('div');
                        itemRow.className = 'order-item-compact';
                        itemRow.innerHTML = `
                            <span class="item-name-compact">
                                <span class="item-quantity">${orderItem.quantity}x</span> ${orderItem.item_name}
                            </span>
                            <span class="item-price-compact">‚Ç±${parseFloat(orderItem.price).toFixed(2)}</span>
                        `;
                        orderItemsContainer.appendChild(itemRow);
                    });
                }

                const statusBadge = clone.querySelector('.order-status-compact');
                const status = (notification.order_status || 'pending').toLowerCase();
                statusBadge.className = `order-status-compact ${status}`;
                statusBadge.querySelector('span').textContent = status.toUpperCase();

                const statusIcon = statusBadge.querySelector('i');
                const statusIcons = {
                    'completed': 'fa-check-circle',
                    'pending': 'fa-clock',
                    'preparing': 'fa-fire',
                    'ready': 'fa-box-open',
                    'cancelled': 'fa-times-circle'
                };
                statusIcon.className = `fas ${statusIcons[status] || 'fa-circle'}`;
            } else {
                clone.querySelector('.order-summary-compact').remove();
            }

            const timeAgoText = clone.querySelector('.time-text');
            timeAgoText.textContent = getTimeAgo(notification.created_at);

            item.addEventListener('click', function() {
                markNotificationAsRead(notification.id);
            });

            notificationList.appendChild(clone);
        });
    }

    // Mark single notification as read
    function markNotificationAsRead(notificationId) {
        fetch(`/api/notifications/${notificationId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (item) {
                    item.classList.remove('unread');
                }
                updateNotificationBadge(data.unread_count);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Mark all notifications as read
    function markAllNotificationsAsRead() {
        fetch('/api/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                });
                updateNotificationBadge(0);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Update notification badge count
    function updateNotificationBadge(count) {
        if (notificationBadge) {
            if (count > 0) {
                notificationBadge.textContent = count > 99 ? '99+' : count;
                notificationBadge.style.display = 'block';
            } else {
                notificationBadge.style.display = 'none';
            }
        }
    }

    // Get time ago text
    function getTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        const intervals = {
            year: 31536000,
            month: 2592000,
            week: 604800,
            day: 86400,
            hour: 3600,
            minute: 60
        };

        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = Math.floor(seconds / secondsInUnit);
            if (interval >= 1) {
                return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
            }
        }

        return 'Just now';
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Auto-refresh notifications every 30 seconds
    setInterval(function() {
        if (notificationPanel.classList.contains('show')) {
            loadNotifications();
        }
    }, 30000);
});
</script>


<div class="chat-panel" id="chatPanel">
    <div class="chat-panel-header">
        <h3><i class="fas fa-comments"></i> Messages</h3>
        <button class="chat-close-btn" onclick="toggleChatPanel()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="chat-conversations-list" id="conversationsList">
        <div class="chat-empty-state">
            <i class="fas fa-inbox"></i>
            <p>No conversations yet</p>
        </div>
    </div>
</div>

<div class="chat-window" id="chatWindow">
    <div class="chat-window-header">
        <button class="back-to-conversations" onclick="backToConversations()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="chat-avatar" id="chatWindowAvatar">U</div>
        <div class="chat-header-info">
            <h4 class="chat-header-name" id="chatWindowName">Customer</h4>
        </div>
    </div>

    <!-- ‚úÖ REDESIGNED: PINNED MESSAGE SECTION -->
    <div class="owner-pinned-section" id="ownerPinnedSection">
        <div class="owner-pinned-section-header">
            <span class="owner-pinned-section-title">
                <i class="fas fa-thumbtack"></i> Pinned Messages
            </span>
            <button class="owner-pinned-collapse" onclick="toggleOwnerPinnedSection()">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div id="ownerPinnedMessagesList">
            <!-- Messages injected here -->
        </div>
    </div>

    <div class="chat-messages-container" id="chatMessagesContainer">
    </div>

    <div class="owner-see-pins-link" id="ownerSeePinsLink" onclick="openOwnerPinnedMessagesModal()">
        <i class="fas fa-thumbtack"></i> See All Pins
    </div>

    <div class="chat-input-container">
        <form class="chat-input-form" id="chatInputForm" onsubmit="sendMessage(event)">
            <input
                    type="text"
                    class="chat-input"
                    id="chatInput"
                    placeholder="Type a message..."
                    autocomplete="off"
            >
            <button type="submit" class="chat-send-btn" id="chatSendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>


{% block main_content %}
<main class="main-content">
    {% if is_suspended %}
    <div class="suspension-warning">
        <i class="fas fa-exclamation-circle"></i> Your store is currently suspended. Please contact an administrator.
    </div>
    {% endif %}

    <div class="dashboard-layout">

        <aside class="dashboard-sidebar">

            <header class="store-header">
                <div class="cover-photo" onclick="openProfileImageModal()">
                    <img id="storeCoverPhoto"
                         src="{% if establishment.image %}{{ establishment.image.url }}{% else %}{% static 'images/cover_photo_default.jpg' %}{% endif %}"
                         alt="Cover">
                </div>
                <div class="header-info">
                    <div class="profile-pic" onclick="openProfileImageModal()">
                        <img id="profileImageView"
                             src="{% if establishment.image %}{{ establishment.image.url }}{% else %}{% static 'images/default_profile.png' %}{% endif %}"
                             alt="Profile">
                    </div>
                    <div class="store-info">
                        <h1 id="establishmentName">{{ establishment.name }}</h1>
                        <p id="establishmentAddress">{{ establishment.address }}</p>
                        <span class="status-badge status-{{ establishment.calculated_status|lower }}"
                              id="establishmentStatus"
                              data-opening-time="{{ establishment.opening_time|time:'H:i' }}"
                              data-closing-time="{{ establishment.closing_time|time:'H:i' }}">
    {% if establishment.calculated_status == 'Open' %}
          Open Now
    {% else %}
         Closed Now
    {% endif %}
</span>
                    </div>
                </div>
            </header>
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-bolt"></i> Quick Actions
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-transparent" onclick="openModal('addMenuItemModal')">
                            <i class="fas fa-plus"></i> Add Menu Item
                        </button>
                        <button class="btn btn-transparent" onclick="openModal('updateStoreDetailsModal')">
                            <i class="fas fa-edit"></i> Update Details
                        </button>
                        <button class="btn btn-transparent" onclick="openModal('storeReviewsModal')">
                            <i class="fas fa-star"></i> View Reviews
                        </button>
                        <button class="btn btn-transparent" onclick="openModal('viewStoreDetailsModal')">
                            <i class="fas fa-info-circle"></i> View Details
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-chart-bar"></i> Statistics
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div>
                                <div class="stat-number">{{ total_reviews }}</div>
                                <div class="stat-label">Total Reviews</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div>
                                <div class="stat-number">{{ average_rating }}/5.0</div>
                                <div class="stat-label">Average Rating</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <section class="dashboard-content">
<div style="background: white; border-radius: 12px; padding: 14px 18px; margin-bottom: 24px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; gap: 20px;">
    <!-- LEFT SIDE: Welcome Text -->
    <div style="flex: 1;">
        <h2 style="font-size: 18px; font-weight: 700; color: var(--text-dark); margin-bottom: 3px;">
            Owner Dashboard
        </h2>
        <p style="color: var(--text-muted); font-size: 13px;">
            Welcome back! Manage your establishment <span style="color: var(--primary); font-weight: 600;">{{ establishment.name }}</span> here.
        </p>
    </div>

    <!-- RIGHT SIDE: Stats Display -->
    <div class="store-stats-display" style="margin: 0; flex-shrink: 0;">
        <div class="stat-card">
            <div class="stat-icon bestseller">
                <i class="fas fa-award"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="bestSellerCount">0</div>
                <div class="stat-label">Best Sellers</div>
            </div>
        </div>

        <div class="stat-divider"></div>

        <div class="stat-card">
            <div class="stat-icon available">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number" id="availableCount">0</div>
                <div class="stat-label">Available Items</div>
            </div>
        </div>
    </div>
</div>

            <div class="card menu-section">
                <div class="card-title-center">
                    <i class="fas fa-hamburger"></i> Your Menu
                </div>
                {% if menu_items %}
                <div class="menu-grid">
                    {% for item in menu_items %}
                    <div class="menu-card" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}"
                         data-item-description="{{ item.description }}" data-item-price="{{ item.price|floatformat:2 }}"
                         data-item-quantity="{{ item.quantity|default:0 }}"
                         data-item-image-url="{% if item.image %}{{ item.image.url }}{% endif %}">
                        <div class="menu-image">
                            <img src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/default_menu_item.png' %}{% endif %}"
                                 alt="{{ item.name }}">
                            <div class="badges-container">
                                {% if item.is_top_seller %}
                                <span class="badge bestseller">
                                        <i class="fas fa-award"></i> Best Seller
                                    </span>
                                {% endif %}
                                {% if item.quantity > 0 %}
                                <span class="badge available">Available: {{ item.quantity }}</span>
                                {% else %}
                                <span class="badge soldout">Out of Stock</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="menu-info">
                            <div class="menu-name">{{ item.name }}</div>
                            <div class="menu-desc">{{ item.description }}</div>
                            <div class="menu-price">‚Ç±{{ item.price|floatformat:2 }}</div>
                            <div class="menu-actions">
                                <button class="action-btn edit" onclick="openEditModal('{{ item.id }}')">
                                    <i class="fas fa-pen"></i> Edit
                                </button>
                                <form action="{% url 'toggle_top_seller' item.id %}" method="post"
                                      style="display: contents;">
                                    {% csrf_token %}
                                    <button type="submit" class="action-btn seller">
                                        <i class="fas fa-award"></i> {% if item.is_top_seller %}Unmark{% else %}Mark
                                        {% endif %}
                                    </button>
                                </form>
                                <button type="button" class="action-btn delete"
                                        onclick="deleteMenuItem('{{ item.id }}', this)">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-items">
                    <i class="fas fa-inbox"></i>
                    <p>No menu items yet. Add your first item to get started!</p>
                </div>
                {% endif %}
            </div>
        </section>
    </div>
</main>
{% endblock %}


<div class="modal" id="viewStoreDetailsModal">
    <div class="modal-content" style="max-width: 450px;">
        <button class="modal-close" onclick="closeModal('viewStoreDetailsModal')">√ó</button>
        <h2><i class="fas fa-info-circle"></i> Store Details</h2>
        <div style="display: flex; flex-direction: column; gap: 16px;">
            <!-- Category -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">Category</label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentCategory">
                    {{ establishment.category.name|default:"N/A" }}
                </p>
            </div>

            <!-- Operating Hours -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">
                    <i class="fas fa-clock"></i> Operating Hours
                </label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentHours">
                    {% if establishment.opening_time and establishment.closing_time %}
                    {{ establishment.opening_time|time:"g:i A" }} - {{ establishment.closing_time|time:"g:i A" }}
                    {% else %}
                    Not Set
                    {% endif %}
                </p>
            </div>

            <!-- Amenities -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">Amenities</label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentAmenities">
                    {% for amenity in establishment.amenities.all %}
                    {{ amenity.name }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                    N/A
                    {% endfor %}
                </p>
            </div>

            <!-- Payment Methods -->
            <div>
                <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; font-weight: 600;">Payment
                    Methods</label>
                <p style="font-weight: 600; margin-top: 4px; font-size: 15px;" id="establishmentPaymentMethods">
                    {{ establishment.payment_methods|default:"N/A" }}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="updateStoreDetailsModal">
    <div class="modal-content" style="max-width: 600px;">
        <button class="modal-close" onclick="closeModal('updateStoreDetailsModal')">√ó</button>
        <h2><i class="fas fa-edit"></i> Update Store Details</h2>
        <form method="POST" enctype="multipart/form-data" class="modal-form" id="updateStoreDetailsForm"
              action="{% url 'update_establishment_details_ajax' pk=pk %}">
            {% csrf_token %}
            <input type="hidden" name="update_status" value="1">
            <input type="hidden" name="update_token" id="update_token" value="{{ update_token }}">

            <!-- Establishment Name -->
            <div class="form-group">
                {{ status_form.name.label_tag }}
                {{ status_form.name }}
            </div>

            <!-- Address (Auto-filled, Read-only) -->
            <div class="form-group">
                <label for="id_address">
                    Address
                    <span style="color: #999; font-size: 11px; font-weight: normal;">
            (Auto-filled from pin location)
        </span>
                </label>
                <textarea
                        name="address"
                        id="id_address"
                        rows="3"
                        readonly
                        placeholder="Pin your location on the map to auto-fill address">{{ establishment.address }}</textarea>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 4px;">
                    <i class="fas fa-info-circle"></i> Address is automatically set when you pin your location on the
                    map
                </small>
            </div>

            <!-- Pin Location Button -->
            <div class="form-group">
                <label>Pin Location <span style="color: red;">*</span></label>
                <button type="button" class="btn btn-secondary" onclick="openLocationModal()"
                        style="width: 100%; justify-content: center;">
                    <i class="fas fa-map-marker-alt"></i> Set Location on Map
                </button>
                <small id="locationStatus">
                    {% if establishment.latitude and establishment.longitude %}
                    <i class="fas fa-check-circle" style="color: var(--success);"></i>
                    Location set: {{ establishment.latitude|floatformat:6 }}, {{ establishment.longitude|floatformat:6
                    }}
                    {% else %}
                    <i class="fas fa-exclamation-circle" style="color: var(--error);"></i>
                    No location set yet
                    {% endif %}
                </small>
            </div>

            <!-- Hidden fields for coordinates -->
            <input type="hidden" name="latitude" id="id_latitude" value="{{ establishment.latitude|default:'' }}">
            <input type="hidden" name="longitude" id="id_longitude" value="{{ establishment.longitude|default:'' }}">
            <input type="hidden" id="previous_lat" value="{{ establishment.latitude|default:'' }}">
            <input type="hidden" id="previous_lng" value="{{ establishment.longitude|default:'' }}">

            <!-- Status -->
            <div class="form-group">
                <label for="id_opening_time">
                    <i class="fas fa-clock"></i> Opening Time
                </label>
                <input type="time"
                       id="id_opening_time"
                       name="opening_time"
                       value="{{ establishment.opening_time|time:'H:i'|default:'' }}"
                       class="form-control">
                <small class="form-text text-muted">Example: 08:00 for 8:00 AM</small>
            </div>

            <div class="form-group">
                <label for="id_closing_time">
                    <i class="fas fa-moon"></i> Closing Time
                </label>
                <input type="time"
                       id="id_closing_time"
                       name="closing_time"
                       value="{{ establishment.closing_time|time:'H:i'|default:'' }}"
                       class="form-control">
                <small class="form-text text-muted">Example: 22:00 for 10:00 PM</small>
            </div>

            <!-- Category -->
            <div class="form-group">
                {{ status_form.category.label_tag }}
                {{ status_form.category }}
            </div>

            <!-- Amenities -->
            <div class="form-group">
                {{ status_form.amenities.label_tag }}
                {{ status_form.amenities }}
            </div>

            <!-- Payment Methods -->
            <div class="form-group">
                <label>Payment Methods</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="payment_cash" name="payment_methods" value="Cash"
                               {% if 'Cash' in establishment.payment_methods %}checked{% endif %}>
                        <label for="payment_cash">Cash</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="payment_gcash" name="payment_methods" value="GCash"
                               {% if 'GCash' in establishment.payment_methods %}checked{% endif %}>
                        <label for="payment_gcash">GCash</label>
                    </div>
                </div>
            </div>

            <!-- Store Image -->
            <div class="form-group">
                {{ status_form.image.label_tag }}
                {% if establishment.image %}
                <img src="{{ establishment.image.url }}" alt="Current"
                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; display: block;">
                {% endif %}
                {{ status_form.image }}
            </div>

            <!-- Submit Button -->
            <button type="submit" name="update_status" class="btn btn-primary"
                    style="width: 100%; justify-content: center; margin-top: 16px;">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </form>
    </div>
</div>

<div class="modal" id="addMenuItemModal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeModal('addMenuItemModal')">√ó</button>
        <h2><i class="fas fa-plus"></i> Add New Menu Item</h2>

        <div id="debugInfo"
             style="display:none; background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 5px; font-size: 12px;">
            <strong>Debug:</strong> <span id="debugMessage"></span>
        </div>

        <form method="POST" enctype="multipart/form-data" class="modal-form" id="addMenuItemForm">
            {% csrf_token %}
            <input type="hidden" name="add_menu_item" value="1">
            <input type="hidden" name="menu_add_token" value="{{ menu_add_token }}">

            <div class="form-group">
                <label for="id_name">Menu Name *</label>
                <input type="text" name="name" id="id_name" required maxlength="100">
            </div>

            <div class="form-group">
                <label for="id_description">Description *</label>
                <textarea name="description" id="id_description" required rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="id_price">Price (‚Ç±) *</label>
                <input type="number" name="price" id="id_price" step="0.01" min="0" required>
            </div>

            <div class="form-group">
                <label for="id_quantity">Quantity</label>
                <input type="number" name="quantity" id="id_quantity" min="0" value="0">
            </div>

            <div class="form-group">
                <label for="id_image">Image (Optional)</label>
                <input type="file" name="image" id="id_image" accept="image/*">
                <small style="color: #666; font-size: 12px;">Recommended: JPG or PNG, max 5MB</small>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                <i class="fas fa-plus"></i> Add Item
            </button>
        </form>
    </div>
</div>

<div class="modal" id="editMenuItemModal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="closeModal('editMenuItemModal')">√ó</button>
        <h2><i class="fas fa-edit"></i> Edit Menu Item</h2>
        <form id="editMenuItemForm" method="post" action="" enctype="multipart/form-data" class="modal-form">
            {% csrf_token %}
            <input type="hidden" name="item_id" id="edit_item_id">
            <div class="form-group">
                <label for="edit_item_name">Menu Name</label>
                <input type="text" name="name" id="edit_item_name" required>
            </div>
            <div class="form-group">
                <label for="edit_item_description">Description</label>
                <textarea name="description" id="edit_item_description" required></textarea>
            </div>
            <div class="form-group">
                <label for="edit_item_price">Price</label>
                <input type="text" name="price" id="edit_item_price" required>
            </div>
            <div class="form-group">
                <label for="id_quantity_edit">Quantity</label>
                <input type="number" name="quantity" id="id_quantity_edit" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="edit_item_image">New Image</label>
                <input type="file" name="image" id="edit_item_image" accept="image/*">
                <img id="edit_current_item_image" src="" alt="Current"
                     style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-top: 8px; display: none;">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </form>
    </div>
</div>

<div class="modal" id="storeReviewsModal">
    <div class="modal-content" style="max-width: 600px; max-height: 70vh;">
        <button class="modal-close" onclick="closeModal('storeReviewsModal')">√ó</button>
        <h2><i class="fas fa-star"></i> Customer Reviews</h2>
        <div style="display: flex; gap: 16px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
            <div>
                <div style="font-size: 28px; font-weight: 700; color: var(--primary);">{{ total_reviews }}</div>
                <div style="font-size: 13px; color: var(--text-muted);">Total Reviews</div>
            </div>
            {% if average_rating > 0 %}
            <div>
                <div style="font-size: 24px; font-weight: 700; color: var(--primary);">{{ average_rating }}/5.0</div>
                <div style="font-size: 13px; color: var(--text-muted);">
                    {% for i in "12345" %}
                    <i class="fas fa-star{% if forloop.counter > average_rating|floatformat:0 %}-o{% endif %}"
                       style="color: #ffb400;"></i>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            {% for review in dashboard_reviews %}
            <div style="padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div style="font-weight: 700;">{{ review.user.username }}</div>
                    <div style="color: #ffb400;">
                        {% for i in "12345" %}
                        <i class="fas fa-star{% if forloop.counter > review.rating %}-o{% endif %}"></i>
                        {% endfor %}
                    </div>
                </div>
                <p style="margin-bottom: 8px; color: var(--text-muted); font-size: 14px;">{{ review.comment }}</p>
                {% if review.image %}
                <img src="{{ review.image.url }}" alt="Review"
                     style="max-width: 100%; max-height: 150px; border-radius: 6px; margin-bottom: 8px;">
                {% endif %}
                <div style="font-size: 12px; color: #9aa0a6;">{{ review.created_at|date:"M d, Y" }}</div>
            </div>
            {% empty %}
            <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                <i class="fas fa-inbox" style="font-size: 32px; opacity: 0.3; display: block; margin-bottom: 12px;"></i>
                No reviews yet
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div class="modal" id="ownerProfileImageModal" style="background: rgba(0, 0, 0, 0.9);">
    <button class="modal-close" onclick="closeModal('ownerProfileImageModal')" style="color: white;">√ó</button>
    <img id="ownerModalImageView" src="" alt="Profile"
         style="max-width: 90%; max-height: 90vh; border-radius: var(--radius);">
</div>

<div class="modal" id="mapModal">
    <div class="modal-content" style="max-width: 900px; padding: 16px;">
        <button class="modal-close" onclick="closeModal('mapModal')">√ó</button>

        <h2 style="margin-bottom: 8px;">
            <i class="fas fa-map-marker-alt"></i> Set Establishment Location
        </h2>

        <p style="color: #666; font-size: 14px; margin-bottom: 12px;">
            üìç Click or drag the pin inside the red circle (500m from CvSU-Bacoor)
        </p>

        <!-- Current Location Display - Simplified & Responsive -->
        <div class="location-display-card">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="location-icon"
                     style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                    üìç
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="location-label"
                         style="font-size: 11px; opacity: 0.9; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                        Current Location
                    </div>
                    <div class="location-coords" id="currentLocationDisplay"
                         style="font-size: 16px; font-weight: 700; margin-top: 2px; word-break: break-all;">
                        {{ location_display }}
                    </div>
                    <div class="location-status" style="font-size: 11px; opacity: 0.8; margin-top: 2px;">
                        {% if has_location %}
                        ‚úì Location is set
                        {% else %}
                        ‚ö† Please pin location
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Address Display - Simplified & Responsive -->
        <div class="address-display-card" id="geocodedAddressDisplay" style="display: none;">
            <div style="display: flex; align-items: start; gap: 10px;">
                <div class="address-icon" style="font-size: 22px; flex-shrink: 0;">üè†</div>
                <div style="flex: 1; min-width: 0;">
                    <div class="address-title"
                         style="font-weight: 700; color: #2e7d32; margin-bottom: 4px; font-size: 12px;">
                        NEW ADDRESS FOR THIS LOCATION
                    </div>
                    <div class="address-text" id="geocodedAddressText"
                         style="color: #1b5e20; font-size: 13px; line-height: 1.5; word-break: break-word;">
                        <i class="fas fa-spinner fa-spin"></i> Getting address...
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Container - Responsive -->
        <div id="map"></div>

        <!-- Action Buttons - Responsive -->
        <div class="map-actions">
            <button type="button" class="btn btn-secondary" onclick="resetToCvSU()">
                <i class="fas fa-crosshairs"></i> Reset to CvSU
            </button>

            <div class="map-info-text" style="text-align: center; font-size: 12px; color: #666;">
                <i class="fas fa-info-circle"></i> Drag pin or click to set location
            </div>

            <button type="button" class="btn btn-primary" onclick="confirmMapLocation()">
                <i class="fas fa-check-circle"></i> Confirm Location
            </button>
        </div>
    </div>
</div>

<input type="hidden" name="latitude" id="id_latitude" value="{{ current_lat }}">
<input type="hidden" name="longitude" id="id_longitude" value="{{ current_lng }}">
<input type="hidden" id="previous_lat" value="{{ current_lat }}">
<input type="hidden" id="previous_lng" value="{{ current_lng }}">

<div class="message-context-menu" id="ownerMessageContextMenu">
    <div class="context-menu-item" onclick="pinOwnerMessage()">
        <i class="fas fa-thumbtack"></i>
        <span id="ownerPinMenuText">Pin</span>
    </div>
    <div class="context-menu-item danger" onclick="openOwnerUnsendModal()">
        <i class="fas fa-undo"></i>
        <span>Unsend</span>
    </div>
</div>

<div class="unsend-modal" id="ownerUnsendModal">
    <div class="unsend-modal-content">
        <h3>Who do you want to unsend this message for?</h3>

        <div class="unsend-option selected" data-type="everyone" onclick="selectOwnerUnsendOption('everyone')">
            <div class="unsend-option-title">
                <i class="fas fa-users"></i>
                Unsend for everyone
            </div>
            <div class="unsend-option-desc">
                This message will be unsent for everyone in the chat. Others may have already seen or forwarded it.
            </div>
        </div>

        <div class="unsend-option" data-type="you" onclick="selectOwnerUnsendOption('you')">
            <div class="unsend-option-title">
                <i class="fas fa-user"></i>
                Unsend for you
            </div>
            <div class="unsend-option-desc">
                This will remove the message from your devices. Other chat members will still be able to see it.
            </div>
        </div>

        <div class="unsend-modal-buttons">
            <button class="btn-cancel" onclick="closeOwnerUnsendModal()">Cancel</button>
            <button class="btn-remove" onclick="confirmOwnerUnsend()">Remove</button>
        </div>
    </div>
</div>

<div class="pinned-messages-modal" id="ownerPinnedMessagesModal">
    <div class="pinned-messages-modal-content">
        <h3><i class="fas fa-thumbtack"></i> Pinned Messages</h3>
        <div class="pinned-messages-list" id="ownerPinnedMessagesListModal">
        </div>
        <div class="pinned-messages-empty" id="ownerPinnedMessagesEmpty" style="display: none;">
            <i class="fas fa-inbox"></i>
            <p>No pinned messages</p>
        </div>
        <div style="margin-top: 20px; text-align: center;">
            <button class="btn-cancel" onclick="closeOwnerPinnedMessagesModal()">Close</button>
        </div>
    </div>
</div>


{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/food_establishment_dashboard.js' %}"></script>
{% endblock %}

<script src="{% static 'js/status_updater.js' %}"></script>

<script>
    const establishmentId = {{ establishment.id }};
    const currentUserId = {{ request.user.id }};
    let activeCustomerId = null;
    let chatSocket = null;
    let ownerContextMenuMessageId = null;
    let ownerSelectedUnsendType = 'everyone';
    let ownerPinnedMessages = new Set();
    let ownerMessagesCache = [];

    // Long press detection variables
    let longPressTimer = null;
    let longPressTriggered = false;
    const LONG_PRESS_DURATION = 500;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ==========================================
    // NOTIFICATION PANEL FUNCTIONS
    // ==========================================
    function toggleNotificationPanel() {
        const panel = document.getElementById('notificationPanel');
        const chatPanel = document.getElementById('chatPanel');

        if (panel.classList.contains('open')) {
            panel.classList.remove('open');
        } else {
            panel.classList.add('open');
            // Close chat panel if open
            if (chatPanel) {
                chatPanel.classList.remove('open');
            }
            loadNotifications();
        }
    }

    function loadNotifications() {
        console.log('üîî Loading notifications...');
        fetch('/api/notifications/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            console.log('üì¶ Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Notifications data received:', data);
            if (data.success) {
                console.log(`üìã Number of notifications: ${data.notifications.length}`);
                console.log(`üîî Unread count: ${data.unread_count}`);
                displayNotifications(data.notifications);
                updateNotificationBadge(data.unread_count);
            } else {
                console.error('‚ùå API returned success=false:', data);
                displayNotifications([]);
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading notifications:', error);
            displayNotifications([]);
        });
    }

    function displayNotifications(notifications) {
        const notificationList = document.getElementById('notificationList');

        if (!notifications || notifications.length === 0) {
            notificationList.innerHTML = `
                <div class="notification-empty-state">
                    <i class="fas fa-bell-slash"></i>
                    <p>No new notifications</p>
                </div>
            `;
            return;
        }

        notificationList.innerHTML = notifications.map(notif => {
            // Backend returns 'is_new' (true for unread), we need to invert it
            const unreadClass = notif.is_new ? 'unread' : '';
            const timeAgo = notif.time_ago || formatTimeAgo(notif.created_at);

            let content = '';
            // Backend returns 'type' not 'notification_type'
            if (notif.type === 'new_order' || notif.order) {
                content = `
                    <div class="notification-item ${unreadClass}" onclick="markNotificationRead(${notif.id})">
                        <div class="notification-header">
                            <div class="notification-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">
                                    <span>New Order</span>
                                    <span class="notification-type-badge">Order</span>
                                </div>
                                <div class="notification-message">${notif.message}</div>

                                ${notif.customer && notif.order ? `
                                    <div class="customer-info">
                                        <div class="customer-avatar">${notif.customer.name ? notif.customer.name.charAt(0).toUpperCase() : 'U'}</div>
                                        <div class="customer-details">
                                            <div class="customer-name">${notif.customer.name || 'Unknown'}</div>
                                            <div class="customer-email">${notif.customer.email || ''}</div>
                                        </div>
                                    </div>

                                    <div class="order-summary">
                                        <div class="order-summary-header">
                                            <span class="order-id">Order #${notif.order.id}</span>
                                            <span class="order-total">‚Ç±${parseFloat(notif.order.total_amount || 0).toFixed(2)}</span>
                                        </div>

                                        ${notif.order.reference_number && notif.order.reference_number !== 'N/A' ? `
                                            <div class="order-reference">
                                                <i class="fas fa-receipt"></i> Ref: ${notif.order.reference_number}
                                            </div>
                                        ` : ''}

                                        ${notif.order.items && notif.order.items.length > 0 ? `
                                            <div class="order-items-list">
                                                ${notif.order.items.map(item => `
                                                    <div class="order-item-row">
                                                        <span class="item-name-qty">${item.quantity}x ${item.name}</span>
                                                        <span class="item-price">‚Ç±${parseFloat(item.price).toFixed(2)}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}

                                        <div class="order-status-badge ${notif.is_paid ? 'paid' : 'pending'}">
                                            <i class="fas fa-${notif.is_paid ? 'check-circle' : 'money-bill-wave'}"></i>
                                            ${notif.is_paid ? 'Paid Online' : notif.order.status || 'Pending'}
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="notification-time">
                                    <i class="fas fa-clock"></i>
                                    <span class="time-ago">${timeAgo}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Generic notification
                content = `
                    <div class="notification-item ${unreadClass}" onclick="markNotificationRead(${notif.id})">
                        <div class="notification-header">
                            <div class="notification-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="notification-content">
                                <div class="notification-title">
                                    <span>Notification</span>
                                </div>
                                <div class="notification-message">${notif.message}</div>
                                <div class="notification-time">
                                    <i class="fas fa-clock"></i>
                                    <span class="time-ago">${timeAgo}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            return content;
        }).join('');
    }

    function markNotificationRead(notificationId) {
        fetch(`/api/notifications/${notificationId}/mark-read/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadNotifications(); // Reload to update UI
            }
        })
        .catch(error => {
            console.error('Error marking notification as read:', error);
        });
    }

    function markAllNotificationsRead() {
        fetch('/api/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadNotifications(); // Reload to update UI
            }
        })
        .catch(error => {
            console.error('Error marking all notifications as read:', error);
        });
    }

    function updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;

        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Auto-refresh notifications every 30 seconds
    setInterval(() => {
        if (!document.getElementById('notificationPanel').classList.contains('open')) {
            // Just update badge without showing notifications
            fetch('/api/notifications/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateNotificationBadge(data.unread_count);
                }
            })
            .catch(error => console.error('Error updating notification badge:', error));
        }
    }, 30000);

    // Load initial notification count on page load
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/notifications/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateNotificationBadge(data.unread_count);
            }
        })
        .catch(error => console.error('Error loading initial notifications:', error));
    });

    // ==========================================
    // CHAT PANEL FUNCTIONS (ORIGINAL)
    // ==========================================

    function loadConversations() {
        fetch(`/owner/chat/conversations/${establishmentId}/`)
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('conversationsList');

                if (data.conversations && data.conversations.length > 0) {
                    list.innerHTML = data.conversations.map(conv => {
                        const safeName = conv.customer_name.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                        return `
                        <div class="chat-conversation-item" onclick="openConversation(${conv.customer_id}, '${safeName}')">
                            <div class="chat-avatar">${conv.customer_name.charAt(0).toUpperCase()}</div>
                            <div class="chat-conversation-info">
                                <div class="chat-conversation-name">${conv.customer_name}</div>
                                <div class="chat-conversation-preview">${conv.last_message || 'No messages yet'}</div>
                            </div>
                            <div class="chat-conversation-time">${conv.time || ''}</div>
                            ${conv.unread_count > 0 ? `<div class="chat-unread-badge">${conv.unread_count}</div>` : ''}
                        </div>
                    `}).join('');

                    const totalUnread = data.conversations.reduce((sum, conv) => sum + (conv.unread_count || 0), 0);
                    updateChatBadge(totalUnread);
                } else {
                    list.innerHTML = `
                        <div class="chat-empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No conversations yet</p>
                        </div>
                    `;
                    updateChatBadge(0);
                }
            })
            .catch(error => {
                console.error('Error loading conversations:', error);
            });
    }

    function openConversation(customerId, customerName) {
        activeCustomerId = customerId;

        document.getElementById('chatWindowName').textContent = customerName;
        document.getElementById('chatWindowAvatar').textContent = customerName.charAt(0).toUpperCase();

        document.getElementById('chatPanel').classList.remove('open');
        document.getElementById('chatWindow').classList.add('open');

        loadMessages(customerId);
        connectWebSocket(customerId);
    }

    function backToConversations() {
        document.getElementById('chatWindow').classList.remove('open');
        document.getElementById('chatPanel').classList.add('open');

        if (chatSocket) {
            chatSocket.close();
            chatSocket = null;
        }

        activeCustomerId = null;
        ownerPinnedMessages.clear();
        ownerMessagesCache = [];
        loadConversations();
    }

    function loadOwnerPinnedMessages() {
        if (!activeCustomerId) return;

        const stored = localStorage.getItem(`owner_pinned_${activeCustomerId}_${establishmentId}`);
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                ownerPinnedMessages = new Set(parsed);
            } catch (e) {
                ownerPinnedMessages = new Set();
            }
        }
    }

    function saveOwnerPinnedMessages() {
        if (!activeCustomerId) return;

        const arr = Array.from(ownerPinnedMessages);
        localStorage.setItem(`owner_pinned_${activeCustomerId}_${establishmentId}`, JSON.stringify(arr));
    }

    function loadMessages(customerId) {
        const container = document.getElementById('chatMessagesContainer');
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">Loading messages...</div>';

        // Load pinned messages for this conversation
        loadOwnerPinnedMessages();
        ownerMessagesCache = [];

        fetch(`/owner/chat/messages/${customerId}/${establishmentId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    container.innerHTML = '';

                    data.messages.forEach(msg => {
                        const msgData = {
                            id: msg.id,
                            sender_id: msg.sender_id,
                            content: msg.content,
                            timestamp: msg.timestamp
                        };
                        ownerMessagesCache.push(msgData);

                        const senderId = parseInt(msg.sender_id);
                        const ownerId = parseInt(currentUserId);
                        const isMyMessage = senderId === ownerId;

                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${isMyMessage ? 'sent' : 'received'}`;
                        messageDiv.dataset.messageId = msg.id;

                        // Check if pinned
                        if (ownerPinnedMessages.has(msg.id)) {
                            messageDiv.classList.add('pinned');
                        }

                        const optionsButton = isMyMessage ? `
                            <button class="message-options-btn" onclick="showOwnerOptionsMenu(event, ${msg.id})">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        ` : '';

                        messageDiv.innerHTML = `
                            ${optionsButton}
                            <div class="chat-message-bubble">
                                <div>${escapeHtml(msg.content)}</div>
                                <span class="chat-message-time">${msg.timestamp}</span>
                            </div>
                        `;

                        if (isMyMessage) {
                            attachLongPressHandlers(messageDiv, msg.id);
                        }

                        container.appendChild(messageDiv);
                    });

                    updateOwnerPinnedSection();
                } else {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No messages yet. Start the conversation! üí¨</div>';
                }

                scrollToBottom();
            })
            .catch(error => {
                console.error('Error loading messages:', error);
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #f00;">Failed to load messages</div>';
            });
    }

    function connectWebSocket(customerId) {
        if (chatSocket) {
            chatSocket.close();
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat/${customerId}/${establishmentId}/`;

        chatSocket = new WebSocket(wsUrl);

        chatSocket.onopen = function(e) {
            console.log('‚úÖ Chat connected');
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            if (data.type === 'chat_message') {
                addMessageToChat(data);
            }
            else if (data.type === 'message_unsent') {
                handleOwnerMessageUnsent(data);
            }
        };

        chatSocket.onerror = function(e) {
            console.error('Chat connection error');
        };

        chatSocket.onclose = function(e) {
            console.log('Chat disconnected');
        };
    }

    function sendMessage(event) {
        event.preventDefault();

        const input = document.getElementById('chatInput');
        const message = input.value.trim();

        if (!message || !chatSocket || !activeCustomerId) {
            return;
        }

        chatSocket.send(JSON.stringify({
            'type': 'chat_message',
            'message': message,
            'sender_id': currentUserId
        }));

        input.value = '';
        input.focus();
    }

    function addMessageToChat(data) {
        const container = document.getElementById('chatMessagesContainer');
        const messageDiv = document.createElement('div');

        const senderId = parseInt(data.sender_id);
        const ownerId = parseInt(currentUserId);
        const isMyMessage = senderId === ownerId;

        messageDiv.className = `chat-message ${isMyMessage ? 'sent' : 'received'}`;
        messageDiv.dataset.messageId = data.message_id;

        // Add to cache
        ownerMessagesCache.push({
            id: data.message_id,
            sender_id: data.sender_id,
            content: data.message,
            timestamp: data.timestamp
        });

        const optionsButton = isMyMessage ? `
            <button class="message-options-btn" onclick="showOwnerOptionsMenu(event, ${data.message_id})">
                <i class="fas fa-ellipsis-v"></i>
            </button>
        ` : '';

        messageDiv.innerHTML = `
            ${optionsButton}
            <div class="chat-message-bubble">
                <div>${escapeHtml(data.message)}</div>
                <span class="chat-message-time">${data.timestamp}</span>
            </div>
        `;

        if (isMyMessage) {
            attachLongPressHandlers(messageDiv, data.message_id);
        }

        container.appendChild(messageDiv);
        scrollToBottom();
    }

    // ==========================================
    // LONG PRESS DETECTION (MOBILE)
    // ==========================================

    function attachLongPressHandlers(messageElement, messageId) {
        // Touch events
        messageElement.addEventListener('touchstart', function(e) {
            longPressTriggered = false;
            messageElement.classList.add('long-pressing');

            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                messageElement.classList.remove('long-pressing');

                const touch = e.touches[0];
                showOwnerContextMenuAtPosition(touch.clientX, touch.clientY, messageId);

                e.preventDefault();
            }, LONG_PRESS_DURATION);
        }, { passive: false });

        messageElement.addEventListener('touchend', function(e) {
            clearTimeout(longPressTimer);
            messageElement.classList.remove('long-pressing');

            if (longPressTriggered) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        messageElement.addEventListener('touchmove', function(e) {
            clearTimeout(longPressTimer);
            messageElement.classList.remove('long-pressing');
        });

        // Mouse events (for desktop)
        messageElement.addEventListener('mousedown', function(e) {
            if (e.button !== 0) return;

            longPressTriggered = false;

            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                showOwnerContextMenuAtPosition(e.clientX, e.clientY, messageId);
            }, LONG_PRESS_DURATION);
        });

        messageElement.addEventListener('mouseup', function(e) {
            clearTimeout(longPressTimer);
        });

        messageElement.addEventListener('mouseleave', function(e) {
            clearTimeout(longPressTimer);
        });
    }

    // ==========================================
    // CONTEXT MENU (DESKTOP & MOBILE FIX)
    // ==========================================

    function showOwnerOptionsMenu(event, messageId) {
        event.stopPropagation();
        event.preventDefault();

        const rect = event.target.closest('button').getBoundingClientRect();
        showOwnerContextMenuAtPosition(rect.left, rect.bottom + 5, messageId);
    }

    function showOwnerContextMenuAtPosition(x, y, messageId) {
        const contextMenu = document.getElementById('ownerMessageContextMenu');
        ownerContextMenuMessageId = messageId;

        // Update pin/unpin text
        const isPinned = ownerPinnedMessages.has(messageId);
        document.getElementById('ownerPinMenuText').textContent = isPinned ? 'Unpin' : 'Pin';

        contextMenu.style.left = x + 'px';
        contextMenu.style.top = y + 'px';

        // Adjust if menu goes off-screen
        setTimeout(() => {
            const menuRect = contextMenu.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            if (menuRect.right > windowWidth) {
                contextMenu.style.left = (x - menuRect.width) + 'px';
            }

            if (menuRect.bottom > windowHeight) {
                contextMenu.style.top = (y - menuRect.height - 10) + 'px';
            }
        }, 10);

        contextMenu.classList.add('active');

        // ‚úÖ FIX: Delay listening for clicks slightly
        setTimeout(() => {
            document.addEventListener('click', hideOwnerContextMenu);
            document.addEventListener('touchstart', hideOwnerContextMenu);
        }, 100);
    }

    function hideOwnerContextMenu(e) {
        const contextMenu = document.getElementById('ownerMessageContextMenu');

        // ‚úÖ CRITICAL FIX: Don't close if clicking INSIDE the menu
        if (contextMenu && contextMenu.contains(e.target)) {
            return;
        }

        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideOwnerContextMenu);
        document.removeEventListener('touchstart', hideOwnerContextMenu);
    }

    function updateChatBadge(count) {
        const badge = document.getElementById('chatBadge');
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }

    function scrollToBottom() {
        const container = document.getElementById('chatMessagesContainer');
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==========================================
    // PIN FUNCTIONALITY (PERSISTENT)
    // ==========================================

    function pinOwnerMessage() {
        // ‚úÖ FORCE CLOSE MENU MANUALLY (Since we prevented auto-close inside menu)
        const contextMenu = document.getElementById('ownerMessageContextMenu');
        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideOwnerContextMenu);
        document.removeEventListener('touchstart', hideOwnerContextMenu);

        if (!ownerContextMenuMessageId) return;

        const messageEl = document.querySelector(`.chat-message[data-message-id="${ownerContextMenuMessageId}"]`);
        if (!messageEl) return;

        const isPinned = ownerPinnedMessages.has(ownerContextMenuMessageId);

        if (isPinned) {
            // Unpin
            ownerPinnedMessages.delete(ownerContextMenuMessageId);
            messageEl.classList.remove('pinned');
        } else {
            // Pin
            ownerPinnedMessages.add(ownerContextMenuMessageId);
            messageEl.classList.add('pinned');
        }

        saveOwnerPinnedMessages();
        updateOwnerPinnedSection();
    }

    function updateOwnerPinnedSection() {
        const pinnedSection = document.getElementById('ownerPinnedSection');
        const pinnedList = document.getElementById('ownerPinnedMessagesList');
        const seePinsLink = document.getElementById('ownerSeePinsLink');

        if (ownerPinnedMessages.size === 0) {
            pinnedSection.classList.remove('active');
            seePinsLink.classList.remove('active');
            return;
        }

        pinnedSection.classList.add('active');
        seePinsLink.classList.add('active');

        // Show max 3 pinned messages in section
        pinnedList.innerHTML = '';
        const pinnedArray = Array.from(ownerPinnedMessages).slice(-3);

        pinnedArray.forEach(msgId => {
            const msg = ownerMessagesCache.find(m => m.id === msgId);
            if (msg) {
                const item = document.createElement('div');
                item.className = 'pinned-message-item';
                item.onclick = function() {
                     // Scroll to message functionality
                    const el = document.querySelector(`.chat-message[data-message-id="${msgId}"]`);
                    if(el) el.scrollIntoView({behavior: "smooth", block: "center"});
                };
                item.innerHTML = `
                    <i class="fas fa-thumbtack"></i>
                    <span class="pinned-message-text">${escapeHtml(msg.content)}</span>
                    <button class="unpin-btn" onclick="unpinOwnerMessage(${msgId}, event)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                pinnedList.appendChild(item);
            }
        });
    }

    function unpinOwnerMessage(messageId, event) {
        if (event) {
            event.stopPropagation();
        }

        ownerPinnedMessages.delete(messageId);
        saveOwnerPinnedMessages();

        const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
        if (messageEl) {
            messageEl.classList.remove('pinned');
        }

        updateOwnerPinnedSection();
    }

    // ‚úÖ UPDATED TOGGLE FUNCTION
    function toggleOwnerPinnedSection() {
        const list = document.getElementById('ownerPinnedMessagesList');
        const icon = document.querySelector('.owner-pinned-collapse i');

        if (list.style.display === 'none') {
            list.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
        } else {
            list.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
        }
    }

    // ==========================================
    // PINNED MESSAGES MODAL
    // ==========================================

    function openOwnerPinnedMessagesModal() {
        const modal = document.getElementById('ownerPinnedMessagesModal');
        const modalList = document.getElementById('ownerPinnedMessagesListModal');
        const emptyState = document.getElementById('ownerPinnedMessagesEmpty');

        if (ownerPinnedMessages.size === 0) {
            modalList.innerHTML = '';
            emptyState.style.display = 'block';
        } else {
            emptyState.style.display = 'none';
            modalList.innerHTML = '';

            Array.from(ownerPinnedMessages).forEach(msgId => {
                const msg = ownerMessagesCache.find(m => m.id === msgId);
                if (msg) {
                    const item = document.createElement('div');
                    item.className = 'pinned-message-item';
                    item.innerHTML = `
                        <i class="fas fa-thumbtack"></i>
                        <span class="pinned-message-text">${escapeHtml(msg.content)}</span>
                        <button class="unpin-btn" onclick="unpinOwnerMessage(${msgId}, event)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    modalList.appendChild(item);
                }
            });
        }

        modal.classList.add('active');
    }

    function closeOwnerPinnedMessagesModal() {
        const modal = document.getElementById('ownerPinnedMessagesModal');
        modal.classList.remove('active');
    }

    // ==========================================
    // UNSEND FUNCTIONALITY (PERSISTENT)
    // ==========================================

    function openOwnerUnsendModal() {
        // ‚úÖ FORCE CLOSE MENU MANUALLY
        const contextMenu = document.getElementById('ownerMessageContextMenu');
        contextMenu.classList.remove('active');
        document.removeEventListener('click', hideOwnerContextMenu);
        document.removeEventListener('touchstart', hideOwnerContextMenu);

        const modal = document.getElementById('ownerUnsendModal');
        modal.classList.add('active');
        ownerSelectedUnsendType = 'everyone';
    }

    function closeOwnerUnsendModal() {
        const modal = document.getElementById('ownerUnsendModal');
        modal.classList.remove('active');
        ownerContextMenuMessageId = null;
    }

    function selectOwnerUnsendOption(type) {
        ownerSelectedUnsendType = type;

        document.querySelectorAll('#ownerUnsendModal .unsend-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`#ownerUnsendModal .unsend-option[data-type="${type}"]`).classList.add('selected');
    }

    function confirmOwnerUnsend() {
        if (!ownerContextMenuMessageId || !chatSocket) {
            console.error('Cannot unsend: missing message ID or socket');
            return;
        }

        const removeBtn = document.querySelector('#ownerUnsendModal .btn-remove');
        removeBtn.disabled = true;
        removeBtn.textContent = 'Removing...';

        chatSocket.send(JSON.stringify({
            'type': 'unsend_message',
            'message_id': ownerContextMenuMessageId,
            'unsend_type': ownerSelectedUnsendType,
            'sender_id': currentUserId
        }));

        setTimeout(() => {
            closeOwnerUnsendModal();
            removeBtn.disabled = false;
            removeBtn.textContent = 'Remove';
        }, 500);
    }

    function handleOwnerMessageUnsent(data) {
        const messageId = data.message_id;
        const unsendType = data.unsend_type;
        const unsent_by = parseInt(data.unsent_by);
        const ownerId = parseInt(currentUserId);

        const messageEl = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);

        if (!messageEl) {
            return;
        }

        if (unsendType === 'everyone') {
            const bubble = messageEl.querySelector('.chat-message-bubble');
            messageEl.classList.add('deleted');

            const optionsBtn = messageEl.querySelector('.message-options-btn');
            if (optionsBtn) {
                optionsBtn.remove();
            }

            bubble.innerHTML = `
                <div>Message was unsent</div>
                <span class="chat-message-time">${new Date().toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}</span>
            `;

            ownerMessagesCache = ownerMessagesCache.filter(msg => msg.id !== messageId);
        }
        else if (unsendType === 'you' && unsent_by === ownerId) {
            messageEl.remove();
            ownerMessagesCache = ownerMessagesCache.filter(msg => msg.id !== messageId);
        }

        // Remove from pinned if it was pinned
        if (ownerPinnedMessages.has(messageId)) {
            ownerPinnedMessages.delete(messageId);
            saveOwnerPinnedMessages();
            updateOwnerPinnedSection();
        }
    }

    function debugLog(message) {
        console.log('üîç DEBUG:', message);
        const debugDiv = document.getElementById('debugInfo');
        const debugMsg = document.getElementById('debugMessage');
        if (debugDiv && debugMsg) {
            debugMsg.textContent = message;
            debugDiv.style.display = 'block';
            setTimeout(() => {
                debugDiv.style.display = 'none';
            }, 5000);
        }
    }


    {% block page_javascript %}
    // Page-specific JavaScript
    {% endblock %}
</script>
<button id="scrollToTopBtn" class="scroll-to-top" style="z-index: 10000;">
    <i class="fas fa-arrow-up"></i>
</button>
</body>
<!-- ========================================== -->
<!-- SALES REPORT MODAL -->
<!-- ========================================== -->
<div id="salesReportModal" class="sales-report-modal">
    <div class="sales-report-content">
        <div class="sales-report-header">
            <h2 class="sales-report-title">
                <i class="fas fa-chart-bar"></i>
                Sales Report
            </h2>
            <button class="close-report-btn" onclick="closeSalesReportModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Report Filters -->
        <div class="report-filters">
            <div class="filter-group">
                <label>Period</label>
                <select id="reportPeriod" onchange="updateSalesReport()">
                    <option value="today">Today</option>
                    <option value="week" selected>This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom Range</option>
                </select>
            </div>
            <div class="filter-group" id="customDateRangeGroup" style="display: none;">
                <label>From Date</label>
                <input type="date" id="reportStartDate">
            </div>
            <div class="filter-group" id="customDateRangeGroup2" style="display: none;">
                <label>To Date</label>
                <input type="date" id="reportEndDate">
            </div>
            <div class="filter-group" style="align-self: end;">
                <button class="apply-filters-btn" onclick="applyReportFilters()">
                    <i class="fas fa-sync"></i> Apply
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="sales-summary-cards">
            <div class="summary-card">
                <div class="summary-card-icon revenue">
                    <i class="fas fa-peso-sign"></i>
                </div>
                <div class="summary-card-label">Total Revenue</div>
                <div class="summary-card-value" id="totalRevenue">‚Ç±0.00</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon orders">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="summary-card-label">Total Orders</div>
                <div class="summary-card-value" id="totalOrders">0</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon average">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="summary-card-label">Average Order</div>
                <div class="summary-card-value" id="averageOrder">‚Ç±0.00</div>
            </div>
            <div class="summary-card">
                <div class="summary-card-icon items">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="summary-card-label">Items Sold</div>
                <div class="summary-card-value" id="itemsSold">0</div>
            </div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <h3 class="chart-title">Sales Trend</h3>
            <canvas id="salesChart" height="100"></canvas>
        </div>

        <!-- Top Selling Items -->
        <div class="chart-container">
            <h3 class="chart-title">Top Selling Items</h3>
            <div id="topSellingItems">
                <div style="text-align: center; padding: 20px; color: #6b7280;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                    <p style="margin-top: 12px;">Loading data...</p>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div style="display: flex; gap: 12px; margin-top: 24px; flex-wrap: wrap;">
            <button class="export-btn" onclick="exportSalesReportPDF()">
                <i class="fas fa-file-pdf"></i>
                Export PDF
            </button>
            <button class="export-btn" onclick="exportSalesReportExcel()">
                <i class="fas fa-file-excel"></i>
                Export Excel
            </button>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- PAYMENT SUCCESS PAGE - BACK TO DASHBOARD BUTTON -->
<!-- ========================================== -->
{% if payment_success %}
<div class="payment-success-container">
    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
        <i class="fas fa-check" style="font-size: 40px; color: white;"></i>
    </div>
    <h1 style="font-size: 32px; font-weight: 800; color: #1a1a1a; margin-bottom: 12px;">
        Payment Successful!
    </h1>
    <p style="color: #6b7280; font-size: 16px; margin-bottom: 32px;">
        Your order has been confirmed. Thank you for your purchase!
    </p>
    <a href="{% url 'food_establishment_dashboard' %}" class="back-to-dashboard-btn">
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
    </a>
</div>
{% endif %}


<footer class="footer">
    <div class="footer-container">
        <div class="footer-section">
            <h3>
                <i class="fas fa-utensils"></i>
                KabsuEats
            </h3>
            <p>Your trusted food shops platform connecting you with the best local restaurants and food
                establishments.</p>
            <div class="footer-social">
                <a href="#" class="social-icon" aria-label="Facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="#" class="social-icon" aria-label="Instagram">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="#" class="social-icon" aria-label="Twitter">
                    <i class="fab fa-twitter"></i>
                </a>
                <a href="#" class="social-icon" aria-label="TikTok">
                    <i class="fab fa-tiktok"></i>
                </a>
            </div>
        </div>

        <div class="footer-section">
            <h3>
                <i class="fas fa-link"></i>
                Quick Links
            </h3>
            <ul class="footer-links">
                <li><a href="#"><i class="fas fa-chevron-right"></i> About Us</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> How It Works</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Partner With Us</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Careers</a></li>
            </ul>
        </div>

        <div class="footer-section">
            <h3>
                <i class="fas fa-file-alt"></i>
                Legal
            </h3>
            <ul class="footer-links">
                <li><a href="#"><i class="fas fa-chevron-right"></i> Terms & Conditions</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Privacy Policy</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Cookie Policy</a></li>
                <li><a href="#"><i class="fas fa-chevron-right"></i> Refund Policy</a></li>
            </ul>
        </div>

        <div class="footer-section">
            <h3>
                <i class="fas fa-headset"></i>
                Contact Us
            </h3>
            <ul class="footer-links">
                <li><a href="mailto:support@kabsueats.com"><i class="fas fa-envelope"></i> support@kabsueats.com</a>
                </li>
                <li><a href="tel:+639123456789"><i class="fas fa-phone"></i> +63 920 772 6237</a></li>
                <li><a href="#"><i class="fas fa-map-marker-alt"></i> Cavite, Philippines</a></li>
                <li><a href="#"><i class="fas fa-clock"></i> 24/7 Support</a></li>
            </ul>
        </div>
    </div>

    <div class="footer-bottom">
        <p>&copy; 2024 <a href="#">KabsuEats</a>. All rights reserved. Made with <i class="fas fa-heart"
                                                                                    style="color: var(--primary);"></i>
            in the Philippines</p>
    </div>
</footer>
</html>