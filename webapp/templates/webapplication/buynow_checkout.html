{% extends "webapplication/kabsueats.html" %}
{% load static %}

{% block title %}Checkout - KabsuEats{% endblock %}

{% block extra_css %}
<style>
/* ========================================
   BUY NOW CHECKOUT PAGE
   Matches cart page design language
   ======================================== */

#buynow-checkout-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 32px 16px 60px;
    font-family: 'Poppins', sans-serif;
}

/* ── Page Header ── */
.buynow-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 28px;
}
.buynow-header h1 {
    font-size: 22px;
    font-weight: 800;
    color: #111827;
    margin: 0;
}
.buynow-header .back-link {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #6b7280;
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    transition: color 0.2s;
}
.buynow-header .back-link:hover { color: #B71C1C; }

/* ── Two-column layout ── */
.buynow-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
    align-items: start;
}

/* ── Item Card ── */
.buynow-item-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.buynow-item-header {
    padding: 18px 20px 14px;
    border-bottom: 1px solid #f3f4f6;
    display: flex;
    align-items: center;
    gap: 10px;
}
.buynow-item-header i { color: #B71C1C; font-size: 16px; }
.buynow-item-header h2 {
    font-size: 15px;
    font-weight: 700;
    color: #111827;
    margin: 0;
}

.buynow-item-row {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
}
.buynow-item-img {
    width: 90px;
    height: 90px;
    border-radius: 12px;
    object-fit: cover;
    flex-shrink: 0;
    background: #f3f4f6;
}
.buynow-item-img-placeholder {
    width: 90px;
    height: 90px;
    border-radius: 12px;
    background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.buynow-item-img-placeholder i { color: #9ca3af; font-size: 28px; }
.buynow-item-details { flex: 1; min-width: 0; }
.buynow-item-name {
    font-size: 16px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.buynow-item-est {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
}
.buynow-item-price {
    font-size: 15px;
    font-weight: 700;
    color: #B71C1C;
}
.buynow-item-qty {
    font-size: 12px;
    color: #6b7280;
    margin-top: 2px;
}
.buynow-item-subtotal {
    font-size: 18px;
    font-weight: 800;
    color: #111827;
    flex-shrink: 0;
}

/* ── Order Summary (Right Column) ── */
.buynow-summary {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    position: sticky;
    top: 80px;
}
.buynow-summary h2 {
    font-size: 16px;
    font-weight: 800;
    color: #111827;
    margin: 0 0 18px;
    padding-bottom: 14px;
    border-bottom: 1px solid #f3f4f6;
}
.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    color: #374151;
    margin-bottom: 10px;
}
.summary-row strong { font-weight: 700; color: #111827; }
.summary-divider {
    height: 1px;
    background: #f3f4f6;
    margin: 12px 0;
}
.summary-total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 22px;
}
.summary-total-row span:first-child { font-size: 15px; font-weight: 700; color: #111827; }
.summary-total-amount { font-size: 22px; font-weight: 800; color: #B71C1C; }

/* ── Payment Method Section ── */
.payment-method-title {
    font-size: 14px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 12px;
}

.btn-payment-method {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    background: #fff;
    cursor: pointer;
    margin-bottom: 10px;
    transition: border-color 0.2s, box-shadow 0.2s, transform 0.1s;
    font-family: 'Poppins', sans-serif;
    text-align: left;
}
.btn-payment-method:hover {
    border-color: #B71C1C;
    box-shadow: 0 2px 12px rgba(183,28,28,0.10);
    transform: translateY(-1px);
}
.btn-payment-method:active { transform: scale(0.98); }
.btn-payment-method i {
    font-size: 22px;
    flex-shrink: 0;
    width: 32px;
    text-align: center;
}
.payment-method-info { flex: 1; }
.payment-method-name { display: block; font-size: 14px; font-weight: 700; color: #111827; }
.payment-method-desc { display: block; font-size: 11px; color: #9ca3af; margin-top: 2px; }

.btn-paymongo { border-color: #dbeafe; }
.btn-paymongo i { color: #3b82f6; }
.btn-paymongo:hover { border-color: #3b82f6; box-shadow: 0 2px 12px rgba(59,130,246,0.12); }

.btn-cash { border-color: #dcfce7; }
.btn-cash i { color: #16a34a; }
.btn-cash:hover { border-color: #16a34a; box-shadow: 0 2px 12px rgba(22,163,74,0.12); }

/* Loading overlay */
.buynow-loading-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.45);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
}
.buynow-loading-overlay.active { display: flex; }
.buynow-loading-overlay .spinner {
    width: 52px; height: 52px;
    border: 5px solid rgba(255,255,255,0.25);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
.buynow-loading-overlay p {
    color: #fff;
    font-family: 'Poppins', sans-serif;
    font-size: 15px;
    font-weight: 600;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Responsive */
@media (max-width: 700px) {
    .buynow-layout {
        grid-template-columns: 1fr;
    }
    .buynow-summary {
        position: static;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- Loading overlay -->
<div class="buynow-loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p id="loadingText">Processing your order...</p>
</div>

<div id="buynow-checkout-container">

    <!-- Page Header -->
    <div class="buynow-header">
        <a href="{% url 'kabsueats_home' %}" class="back-link">
            <i class="fas fa-arrow-left"></i> Back
        </a>
        <h1><i class="fas fa-bolt" style="color:#16a34a;margin-right:6px;font-size:18px;"></i>Buy Now Checkout</h1>
    </div>

    <div class="buynow-layout">

        <!-- Left: Item Detail -->
        <div class="buynow-item-card">
            <div class="buynow-item-header">
                <i class="fas fa-shopping-bag"></i>
                <h2>Your Order</h2>
            </div>
            <div class="buynow-item-row">
                {% if order.orderitem_set.first.menu_item.image %}
                    <img src="{{ order.orderitem_set.first.menu_item.image.url }}"
                         alt="{{ order.orderitem_set.first.menu_item.name }}"
                         class="buynow-item-img">
                {% else %}
                    <div class="buynow-item-img-placeholder">
                        <i class="fas fa-utensils"></i>
                    </div>
                {% endif %}

                <div class="buynow-item-details">
                    <div class="buynow-item-name">{{ order.orderitem_set.first.menu_item.name }}</div>
                    <div class="buynow-item-est">
                        <i class="fas fa-store"></i>
                        {{ order.establishment.name }}
                    </div>
                    <div class="buynow-item-price">₱{{ order.orderitem_set.first.menu_item.price|floatformat:2 }} each</div>
                    <div class="buynow-item-qty">Quantity: {{ order.orderitem_set.first.quantity }}</div>
                </div>
                <div class="buynow-item-subtotal">₱{{ order.total_amount|floatformat:2 }}</div>
            </div>
        </div>

        <!-- Right: Summary + Payment -->
        <div class="buynow-summary">
            <h2>Order Summary</h2>

            <div class="summary-row">
                <span>Item</span>
                <strong>{{ order.orderitem_set.first.menu_item.name }}</strong>
            </div>
            <div class="summary-row">
                <span>Quantity</span>
                <strong>x{{ order.orderitem_set.first.quantity }}</strong>
            </div>
            <div class="summary-row">
                <span>Unit Price</span>
                <strong>₱{{ order.orderitem_set.first.menu_item.price|floatformat:2 }}</strong>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-total-row">
                <span>Total</span>
                <span class="summary-total-amount">₱{{ order.total_amount|floatformat:2 }}</span>
            </div>

            <!-- Payment Method Selection -->
            <div class="payment-method-title">
                <i class="fas fa-credit-card" style="margin-right:6px;color:#B71C1C;"></i>
                Choose Payment Method
            </div>

            <button type="button"
                    class="btn-payment-method btn-paymongo"
                    onclick="buynowPayOnline(this)">
                <i class="fas fa-credit-card"></i>
                <div class="payment-method-info">
                    <span class="payment-method-name">Online Payment</span>
                    <span class="payment-method-desc">Pay via GCash / Card</span>
                </div>
                <i class="fas fa-chevron-right" style="color:#d1d5db;font-size:12px;"></i>
            </button>

            <button type="button"
                    class="btn-payment-method btn-cash"
                    onclick="buynowPayCash(this)">
                <i class="fas fa-money-bill-wave"></i>
                <div class="payment-method-info">
                    <span class="payment-method-name">Cash Payment</span>
                    <span class="payment-method-desc">Pay when you claim</span>
                </div>
                <i class="fas fa-chevron-right" style="color:#d1d5db;font-size:12px;"></i>
            </button>

            <div style="display:flex;align-items:center;gap:6px;margin-top:14px;padding-top:14px;border-top:1px solid #f3f4f6;">
                <i class="fas fa-shield-alt" style="color:#10b981;font-size:13px;"></i>
                <span style="font-size:11px;color:#9ca3af;">Secure payment via PayMongo</span>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const BUYNOW_ORDER_ID = {{ order.id }};
    const CSRF_TOKEN = '{{ csrf_token }}';

    // ── Online Payment (PayMongo) ──
    function buynowPayOnline(button) {
        showLoading('Connecting to payment gateway...');
        button.disabled = true;

        const formData = new FormData();
        formData.append('order_id', BUYNOW_ORDER_ID);

        fetch('/create-buynow-payment/', {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN },
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success && data.checkout_url) {
                document.getElementById('loadingText').textContent = 'Redirecting to payment...';
                window.location.href = data.checkout_url;
            } else {
                hideLoading();
                button.disabled = false;
                showToastMsg(data.message || 'Could not create payment link.', 'error');
            }
        })
        .catch(() => {
            hideLoading();
            button.disabled = false;
            showToastMsg('Network error. Please try again.', 'error');
        });
    }

    // ── Cash Payment ──
    function buynowPayCash(button) {
        showLoading('Placing your order...');
        button.disabled = true;

        const formData = new FormData();
        formData.append('order_id', BUYNOW_ORDER_ID);

        fetch('/buynow/pay-cash/', {
            method: 'POST',
            headers: { 'X-CSRFToken': CSRF_TOKEN },
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('loadingText').textContent = 'Order placed! Redirecting...';
                setTimeout(() => {
                    window.location.href = '/payment/success/?order_id=' + BUYNOW_ORDER_ID + '&payment_method=cash';
                }, 800);
            } else {
                hideLoading();
                button.disabled = false;
                showToastMsg(data.message || 'Could not place order.', 'error');
            }
        })
        .catch(() => {
            hideLoading();
            button.disabled = false;
            showToastMsg('Network error. Please try again.', 'error');
        });
    }

    function showLoading(msg) {
        document.getElementById('loadingText').textContent = msg || 'Processing...';
        document.getElementById('loadingOverlay').classList.add('active');
    }
    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }
    function showToastMsg(msg, type) {
        if (typeof showToast === 'function') { showToast(msg, type); return; }
        const colors = { success:'#10b981', error:'#ef4444', warning:'#f59e0b', info:'#3b82f6' };
        const t = document.createElement('div');
        t.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:#fff;border-left:5px solid ${colors[type]||'#3b82f6'};border-radius:10px;padding:14px 20px;box-shadow:0 6px 20px rgba(0,0,0,0.15);z-index:99999;font-family:Poppins,sans-serif;font-size:14px;font-weight:500;color:#1f2937;min-width:280px;`;
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => { t.style.opacity='0'; t.style.transition='opacity .4s'; setTimeout(()=>t.remove(),400); }, 3000);
    }
</script>
{% endblock %}