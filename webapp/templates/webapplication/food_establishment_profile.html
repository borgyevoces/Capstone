{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}"/>
    <title>{{ establishment.name }} - Profile Settings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/owner_dashboard_styless.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

    <style>
        /* ─────────────────────────── Base ─────────────────────────── */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            background: #f0f2f5;
            margin-left: 260px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
        }
        body.sidebar-collapsed { margin-left: 70px; }

        /* ──────────────────────── Sidebar ──────────────────────────── */
        .sidebar {
            position: fixed; left: 0; top: 0;
            width: 260px; height: 100vh;
            background: linear-gradient(180deg,#1a1a1a 0%,#2d2d2d 100%);
            z-index: 1001;
            display: flex; flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,.15);
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,.1); }
        .sidebar-logo { display:flex; align-items:center; gap:12px; color:#fff; font-family:'Pacifico',cursive; font-size:24px; }
        .sidebar-logo i { font-size:28px; color:#B71C1C; }
        .sidebar-menu { flex:1; padding:20px 0; }
        .sidebar-item {
            display:flex; align-items:center; gap:15px;
            padding:15px 20px; color:rgba(255,255,255,.7);
            text-decoration:none; border-left:3px solid transparent;
            cursor:pointer;
        }
        .sidebar-item:hover { background:rgba(255,255,255,.05); color:#fff; }
        .sidebar-item.active { background:rgba(183,28,28,.15); color:#fff; border-left-color:#B71C1C; }
        .sidebar-item i { font-size:20px; min-width:20px; }
        .sidebar-footer { padding:20px 0; border-top:1px solid rgba(255,255,255,.1); }
        .sidebar-item.logout { color:rgba(255,107,107,.9); }
        .sidebar-item.logout:hover { background:rgba(255,107,107,.1); color:#ff6b6b; }

        /* ─────────────────────── Page wrapper ──────────────────────── */
        .page-wrapper { padding: 24px 28px; }

        /* ─────────────────────── Back button ───────────────────────── */
        .back-btn {
            display:inline-flex; align-items:center; gap:8px;
            padding:10px 18px; background:#fff; color:#1f2937;
            text-decoration:none; border-radius:8px; font-weight:600;
            border:1px solid #e5e7eb; font-size:14px; margin-bottom:22px;
            transition: background .2s, box-shadow .2s;
        }
        .back-btn:hover { background:#f9fafb; box-shadow:0 2px 8px rgba(0,0,0,.08); }

        /* ─────────────────────── Two-column grid ────────────────────── */
        .profile-grid {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 24px;
            align-items: start;
        }

        /* ══════════════════ LEFT COLUMN ══════════════════ */
        .left-column { display:flex; flex-direction:column; gap:18px; }

        /* Establishment image card */
        .img-card {
            background:#fff; border-radius:14px;
            box-shadow:0 2px 10px rgba(0,0,0,.08);
            overflow:hidden;
        }
        .img-wrapper {
            position:relative; width:100%; height:210px;
            background:#f3f4f6; overflow:hidden;
        }
        .img-wrapper img { width:100%; height:100%; object-fit:cover; display:block; }
        .img-overlay {
            position:absolute; inset:0;
            background:rgba(0,0,0,.55);
            display:flex; align-items:center; justify-content:center;
            opacity:0; transition:opacity .25s; cursor:pointer;
        }
        .img-wrapper:hover .img-overlay { opacity:1; }
        .img-overlay label {
            color:#fff; font-size:13px; font-weight:600;
            display:flex; align-items:center; gap:6px; cursor:pointer;
        }

        /* Details card */
        .details-card {
            background:#fff; border-radius:14px;
            box-shadow:0 2px 10px rgba(0,0,0,.08);
            overflow:hidden;
        }
        .details-card-header {
            padding:14px 18px;
            background:linear-gradient(135deg,#B71C1C,#c62828);
            display:flex; align-items:center; gap:10px;
        }
        .details-card-header span {
            color:#fff; font-size:13px; font-weight:700;
            text-transform:uppercase; letter-spacing:.5px;
        }
        .details-card-header i { color:rgba(255,255,255,.85); font-size:15px; }

        /* Each detail row */
        .detail-row {
            display:flex; align-items:flex-start; gap:13px;
            padding:13px 18px; border-bottom:1px solid #f3f4f6;
        }
        .detail-row:last-child { border-bottom:none; }
        .detail-icon {
            width:34px; height:34px; border-radius:8px;
            display:flex; align-items:center; justify-content:center;
            flex-shrink:0; font-size:14px; margin-top:1px;
        }
        .di-red   { background:#fde8e8; color:#B71C1C; }
        .di-blue  { background:#dbeafe; color:#1d4ed8; }
        .di-green { background:#d1fae5; color:#065f46; }
        .di-amber { background:#fef3c7; color:#92400e; }
        .di-purple{ background:#ede9fe; color:#5b21b6; }
        .di-teal  { background:#ccfbf1; color:#0f766e; }
        .di-gray  { background:#f3f4f6; color:#4b5563; }

        .detail-content { flex:1; min-width:0; }
        .detail-label {
            font-size:10.5px; color:#9ca3af; font-weight:700;
            text-transform:uppercase; letter-spacing:.4px; margin-bottom:3px;
        }
        .detail-value {
            font-size:14px; font-weight:600; color:#111827; word-break:break-word;
        }
        .detail-value.small { font-size:12.5px; font-weight:500; color:#374151; }

        /* Status badge */
        .badge {
            display:inline-flex; align-items:center; gap:5px;
            padding:3px 10px; border-radius:20px;
            font-size:12px; font-weight:700;
        }
        .badge-open  { background:#d1fae5; color:#065f46; }
        .badge-closed{ background:#fee2e2; color:#991b1b; }
        .badge-inactive{ background:#fef3c7; color:#92400e; }
        .badge .dot { width:7px; height:7px; border-radius:50%; background:currentColor; }

        /* Amenity + payment chips */
        .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:4px; }
        .chip {
            padding:3px 10px; border-radius:20px; font-size:11.5px; font-weight:600;
            background:#f3f4f6; color:#374151; border:1px solid #e5e7eb;
            display:flex; align-items:center; gap:4px;
        }
        .chip i { font-size:10px; color:#B71C1C; }
        .chip.payment { background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe; }
        .chip.payment i { color:#1d4ed8; }

        /* Hours display */
        .hours-wrap { display:flex; align-items:center; gap:8px; }
        .hours-sep { color:#9ca3af; font-size:12px; }

        /* ══════════════════ RIGHT COLUMN — Edit Form ══════════════════ */
        .edit-card {
            background:#fff; border-radius:14px;
            box-shadow:0 2px 10px rgba(0,0,0,.08);
            overflow:hidden;
        }
        .edit-card-header {
            padding:16px 24px;
            border-bottom:2px solid #f3f4f6;
            display:flex; align-items:center; justify-content:space-between;
        }
        .edit-card-header-left { display:flex; align-items:center; gap:10px; }
        .edit-card-header h2 {
            margin:0; font-size:18px; font-weight:700; color:#1a1a1a;
        }
        .edit-card-header i.icon-edit { color:#B71C1C; font-size:20px; }

        /* Saving indicator */
        .save-indicator {
            display:flex; align-items:center; gap:6px;
            font-size:12px; font-weight:600; color:#6b7280;
            opacity:0; transition:opacity .3s;
        }
        .save-indicator.visible { opacity:1; }
        .save-indicator.success { color:#059669; }
        .save-indicator.error   { color:#dc2626; }
        .save-indicator .spinner {
            width:14px; height:14px; border:2px solid #e5e7eb;
            border-top-color:#B71C1C; border-radius:50%;
            animation: spin .7s linear infinite;
        }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* Form body */
        .form-body { padding:22px 24px; }

        /* Section divider */
        .form-section { margin-bottom:24px; }
        .form-section-title {
            font-size:11px; font-weight:700; color:#B71C1C;
            text-transform:uppercase; letter-spacing:.6px;
            margin-bottom:12px; display:flex; align-items:center; gap:7px;
        }
        .form-section-title::after {
            content:''; flex:1; height:1px; background:#f3f4f6;
        }

        /* Form grid */
        .form-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; }
        .full { grid-column:1/-1; }

        /* Input groups */
        .field label {
            display:block; font-size:11.5px; font-weight:700; color:#374151;
            text-transform:uppercase; letter-spacing:.3px; margin-bottom:6px;
        }
        .field label i { color:#B71C1C; margin-right:5px; }
        .form-control {
            width:100%; padding:10px 13px;
            border:2px solid #e5e7eb; border-radius:8px;
            font-size:14px; color:#111827; background:#fff;
            transition:border-color .2s, box-shadow .2s;
        }
        .form-control:focus {
            outline:none; border-color:#B71C1C;
            box-shadow:0 0 0 3px rgba(183,28,28,.1);
        }
        .form-control[readonly] { background:#f9fafb; color:#6b7280; cursor:default; }
        select.form-control { cursor:pointer; }
        textarea.form-control { resize:vertical; min-height:64px; }

        /* Map button */
        .map-btn {
            width:100%; padding:11px;
            background:linear-gradient(135deg,#3b82f6,#1d4ed8);
            color:#fff; border:none; border-radius:8px;
            font-size:14px; font-weight:600; cursor:pointer;
            display:flex; align-items:center; justify-content:center; gap:8px;
            transition: transform .15s, box-shadow .15s;
        }
        .map-btn:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(59,130,246,.35); }

        /* Location status */
        .loc-status {
            margin-top:6px; font-size:11.5px; font-weight:600;
            display:flex; align-items:center; gap:5px;
        }
        .loc-status.set   { color:#059669; }
        .loc-status.unset { color:#dc2626; }

        /* Checkbox grid */
        .checkbox-grid { display:flex; flex-wrap:wrap; gap:8px 20px; }
        .checkbox-item { display:flex; align-items:center; gap:7px; }
        .checkbox-item input[type="checkbox"] {
            width:16px; height:16px; cursor:pointer;
            accent-color:#B71C1C;
        }
        .checkbox-item label {
            font-size:13px !important; text-transform:none !important;
            margin:0 !important; letter-spacing:0 !important; cursor:pointer;
            font-weight:500 !important; color:#374151 !important;
        }

        /* Save button */
        .save-btn {
            width:100%; padding:13px;
            background:linear-gradient(135deg,#10b981,#059669);
            color:#fff; border:none; border-radius:8px;
            font-size:15px; font-weight:700; cursor:pointer;
            display:flex; align-items:center; justify-content:center; gap:8px;
            transition: transform .15s, box-shadow .15s;
            margin-top:4px;
        }
        .save-btn:hover { transform:translateY(-1px); box-shadow:0 4px 14px rgba(16,185,129,.35); }
        .save-btn:active { transform:translateY(0); }

        /* Danger zone */
        .danger-zone {
            margin:0 24px 24px;
            background:#fff5f5; border:2px solid #fee2e2;
            border-radius:10px; padding:16px;
        }
        .danger-zone-header {
            display:flex; align-items:center; gap:8px; margin-bottom:12px;
        }
        .danger-zone-header h3 { margin:0; font-size:14px; color:#991b1b; font-weight:700; }
        .danger-zone-header i { color:#dc2626; }
        .danger-actions { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
        .danger-btn {
            padding:11px; border:none; border-radius:7px;
            font-size:13px; font-weight:600; cursor:pointer;
            display:flex; align-items:center; justify-content:center; gap:6px;
            transition: transform .15s, box-shadow .15s;
        }
        .danger-btn.delete   { background:#dc2626; color:#fff; }
        .danger-btn.deactivate{ background:#f59e0b; color:#fff; }
        .danger-btn:hover    { transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.2); }

        /* ──────────────── Modal ─────────────────── */
        .modal {
            display:none; position:fixed; inset:0;
            background:rgba(0,0,0,.6); z-index:10000;
            align-items:center; justify-content:center;
        }
        .modal.active { display:flex; }
        .modal-content {
            background:#fff; border-radius:14px;
            padding:24px; max-width:820px; width:90%;
            max-height:90vh; overflow-y:auto;
            box-shadow:0 20px 60px rgba(0,0,0,.3);
        }
        .modal-content h3 { margin:0 0 4px; font-size:18px; }
        #map { height:400px; border-radius:8px; margin:16px 0; }

        /* ──────────────── Responsive ───────────────── */
        @media (max-width:1100px) {
            .profile-grid { grid-template-columns:1fr; }
            .left-column  { flex-direction:row; flex-wrap:wrap; }
            .img-card     { flex:0 0 260px; }
            .details-card { flex:1; min-width:260px; }
        }
        @media (max-width:768px) {
            body { margin-left:0; }
            .sidebar { transform:translateX(-100%); }
            .sidebar.mobile-open { transform:translateX(0); }
            .page-wrapper { padding:16px; }
            .form-grid    { grid-template-columns:1fr; }
            .danger-actions { grid-template-columns:1fr; }
            .left-column  { flex-direction:column; }
        }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar" id="mainSidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="fas fa-utensils"></i>
            <span>KabsuEats</span>
        </div>
    </div>
    <div class="sidebar-menu">
        <a href="#" class="sidebar-item active">
            <i class="fas fa-cog"></i>
            <span>Profile Settings</span>
        </a>
    </div>
    <div class="sidebar-footer">
        <a href="{% url 'logout_owner' %}" class="sidebar-item logout">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </a>
    </div>
</div>

<!-- ════════════════ MAIN CONTENT ════════════════ -->
<div class="page-wrapper">

    <a href="{% url 'food_establishment_dashboard' %}" class="back-btn">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>

    <div class="profile-grid">

        <!-- ══════ LEFT — Details Panel ══════ -->
        <div class="left-column">

            <!-- Image Card -->
            <div class="img-card">
                <form id="imageForm" method="POST" enctype="multipart/form-data"
                      action="{% url 'update_establishment_details_ajax' pk=pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="update_status" value="1">
                    <div class="img-wrapper">
                        <img id="establishmentImage"
                             src="{% if establishment.image %}{{ establishment.image.url }}{% else %}{% static 'images/default_profile.png' %}{% endif %}"
                             alt="{{ establishment.name }}">
                        <div class="img-overlay">
                            <label for="imageInput">
                                <i class="fas fa-camera"></i> Change Photo
                                <input type="file" id="imageInput" name="image"
                                       accept="image/*" style="display:none"
                                       onchange="uploadImage()">
                            </label>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Details Card -->
            <div class="details-card">
                <div class="details-card-header">
                    <i class="fas fa-info-circle"></i>
                    <span>Establishment Details</span>
                </div>

                <!-- Establishment Name -->
                <div class="detail-row">
                    <div class="detail-icon di-red"><i class="fas fa-store"></i></div>
                    <div class="detail-content">
                        <div class="detail-label">Establishment Name</div>
                        <div class="detail-value" id="display-name">{{ establishment.name }}</div>
                    </div>
                </div>

                <!-- Category -->
                <div class="detail-row">
                    <div class="detail-icon di-blue"><i class="fas fa-tag"></i></div>
                    <div class="detail-content">
                        <div class="detail-label">Category</div>
                        <div class="detail-value" id="display-category">{{ establishment.category.name|default:"—" }}</div>
                    </div>
                </div>

                <!-- Status -->
                <div class="detail-row">
                    <div class="detail-icon di-green"><i class="fas fa-circle"></i></div>
                    <div class="detail-content">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            <span class="badge badge-{{ establishment.calculated_status|lower }}" id="display-status">
                                <span class="dot"></span>
                                {{ establishment.calculated_status }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Operating Hours -->
                <div class="detail-row">
                    <div class="detail-icon di-amber"><i class="fas fa-clock"></i></div>
                    <div class="detail-content">
                        <div class="detail-label">Operating Hours</div>
                        <div class="detail-value hours-wrap">
                            <span id="display-opening">{{ establishment.opening_time|time:"g:i A"|default:"—" }}</span>
                            <span class="hours-sep">→</span>
                            <span id="display-closing">{{ establishment.closing_time|time:"g:i A"|default:"—" }}</span>
                        </div>
                    </div>
                </div>

                <!-- Address -->
                <div class="detail-row">
                    <div class="detail-icon di-purple"><i class="fas fa-map-marker-alt"></i></div>
                    <div class="detail-content">
                        <div class="detail-label">Address</div>
                        <div class="detail-value small" id="display-address">{{ establishment.address|default:"—" }}</div>
                    </div>
                </div>

                <!-- Location Pin -->
                <div class="detail-row">
                    <div class="detail-icon di-teal"><i class="fas fa-map-pin"></i></div>
                    <div class="detail-content">
                        <div class="detail-label">GPS Coordinates</div>
                        <div class="detail-value small" id="display-coords">
                            {% if establishment.latitude and establishment.longitude %}
                                {{ establishment.latitude|floatformat:6 }}, {{ establishment.longitude|floatformat:6 }}
                            {% else %}
                                <span style="color:#dc2626;">Not set</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Amenities -->
                <div class="detail-row">
                    <div class="detail-icon di-red"><i class="fas fa-star"></i></div>
                    <div class="detail-content">
                        <div class="detail-label">Amenities</div>
                        <div id="display-amenities">
                            <div class="chips">
                                {% for amenity in establishment.amenities.all %}
                                    <span class="chip"><i class="fas fa-check"></i>{{ amenity.name }}</span>
                                {% empty %}
                                    <span style="font-size:13px;color:#9ca3af;">None listed</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="detail-row">
                    <div class="detail-icon di-blue"><i class="fas fa-credit-card"></i></div>
                    <div class="detail-content">
                        <div class="detail-label">Payment Methods</div>
                        <div id="display-payments">
                            <div class="chips">
                                {% if 'Cash' in establishment.payment_methods %}
                                    <span class="chip payment"><i class="fas fa-money-bill"></i>Cash</span>
                                {% endif %}
                                {% if 'GCash' in establishment.payment_methods %}
                                    <span class="chip payment"><i class="fas fa-mobile-alt"></i>GCash</span>
                                {% endif %}
                                {% if 'Cash' not in establishment.payment_methods and 'GCash' not in establishment.payment_methods %}
                                    <span style="font-size:13px;color:#9ca3af;">None listed</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

            </div><!-- /details-card -->
        </div><!-- /left-column -->

        <!-- ══════ RIGHT — Edit Form ══════ -->
        <div class="edit-card">
            <div class="edit-card-header">
                <div class="edit-card-header-left">
                    <i class="fas fa-edit icon-edit"></i>
                    <h2>Edit Establishment Details</h2>
                </div>
                <div class="save-indicator" id="saveIndicator">
                    <div class="spinner" id="saveSpinner" style="display:none"></div>
                    <i id="saveIcon" class="fas fa-check-circle" style="display:none"></i>
                    <span id="saveText"></span>
                </div>
            </div>

            <form id="updateForm" method="POST"
                  action="{% url 'update_establishment_details_ajax' pk=pk %}">
                {% csrf_token %}
                <input type="hidden" name="update_status" value="1">
                <input type="hidden" name="latitude"  id="latitude"  value="{{ establishment.latitude|default:'' }}">
                <input type="hidden" name="longitude" id="longitude" value="{{ establishment.longitude|default:'' }}">

                <div class="form-body">

                    <!-- Basic Info -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-store"></i> Basic Info</div>
                        <div class="form-grid">
                            <div class="field full">
                                <label for="name"><i class="fas fa-store"></i> Establishment Name</label>
                                <input type="text" id="name" name="name"
                                       class="form-control"
                                       value="{{ establishment.name }}" required>
                            </div>
                            <div class="field">
                                <label for="category"><i class="fas fa-tag"></i> Category</label>
                                <select id="category" name="category" class="form-control" required>
                                    {% for cat in categories %}
                                    <option value="{{ cat.id }}"
                                        {% if establishment.category.id == cat.id %}selected{% endif %}>
                                        {{ cat.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field">
                                <!-- placeholder to keep grid balanced -->
                            </div>
                        </div>
                    </div>

                    <!-- Schedule -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-clock"></i> Operating Hours</div>
                        <div class="form-grid">
                            <div class="field">
                                <label for="opening_time"><i class="fas fa-sun"></i> Opening Time</label>
                                <input type="time" id="opening_time" name="opening_time"
                                       class="form-control"
                                       value="{{ establishment.opening_time|time:'H:i'|default:'' }}">
                            </div>
                            <div class="field">
                                <label for="closing_time"><i class="fas fa-moon"></i> Closing Time</label>
                                <input type="time" id="closing_time" name="closing_time"
                                       class="form-control"
                                       value="{{ establishment.closing_time|time:'H:i'|default:'' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-map-marker-alt"></i> Location</div>
                        <div class="form-grid">
                            <div class="field full">
                                <label for="address"><i class="fas fa-map-marker-alt"></i> Address</label>
                                <input type="text" id="address" name="address"
                                       class="form-control"
                                       value="{{ establishment.address }}" readonly>
                            </div>
                            <div class="field full">
                                <label><i class="fas fa-map"></i> Pin on Map</label>
                                <button type="button" class="map-btn" onclick="openLocationModal()">
                                    <i class="fas fa-map-pin"></i>
                                    {% if establishment.latitude and establishment.longitude %}
                                        Update Location on Map
                                    {% else %}
                                        Set Location on Map
                                    {% endif %}
                                </button>
                                <div class="loc-status {% if establishment.latitude and establishment.longitude %}set{% else %}unset{% endif %}"
                                     id="locationStatus">
                                    {% if establishment.latitude and establishment.longitude %}
                                        <i class="fas fa-check-circle"></i>
                                        Location: {{ establishment.latitude|floatformat:6 }}, {{ establishment.longitude|floatformat:6 }}
                                    {% else %}
                                        <i class="fas fa-exclamation-circle"></i> No location set
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Amenities -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-star"></i> Amenities</div>
                        <div class="checkbox-grid" id="amenitiesCheckboxGrid">
                            {% for amenity in amenities %}
                            <div class="checkbox-item">
                                <input type="checkbox" id="amenity_{{ amenity.id }}"
                                       name="amenities" value="{{ amenity.id }}"
                                       {% if amenity in establishment.amenities.all %}checked{% endif %}>
                                <label for="amenity_{{ amenity.id }}">{{ amenity.name }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Payment Methods -->
                    <div class="form-section">
                        <div class="form-section-title"><i class="fas fa-credit-card"></i> Payment Methods</div>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="payment_cash"
                                       name="payment_methods" value="Cash"
                                       {% if 'Cash' in establishment.payment_methods %}checked{% endif %}>
                                <label for="payment_cash">Cash</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="payment_gcash"
                                       name="payment_methods" value="GCash"
                                       {% if 'GCash' in establishment.payment_methods %}checked{% endif %}>
                                <label for="payment_gcash">GCash</label>
                            </div>
                        </div>
                    </div>

                    <!-- Save -->
                    <button type="submit" class="save-btn">
                        <i class="fas fa-save"></i> Save All Changes
                    </button>

                </div><!-- /form-body -->
            </form>

            <!-- Danger Zone -->
            <div class="danger-zone">
                <div class="danger-zone-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Danger Zone</h3>
                </div>
                <div class="danger-actions">
                    <button type="button" class="danger-btn delete"
                            onclick="showDeleteModal()">
                        <i class="fas fa-trash-alt"></i> Delete Establishment
                    </button>
                    <button type="button" class="danger-btn deactivate"
                            onclick="showDeactivateModal()">
                        <i class="fas fa-ban"></i> Deactivate
                    </button>
                </div>
            </div>

        </div><!-- /edit-card -->
    </div><!-- /profile-grid -->
</div><!-- /page-wrapper -->


<!-- ════════ Location Modal ════════ -->
<div class="modal" id="locationModal">
    <div class="modal-content">
        <h3><i class="fas fa-map-marker-alt"></i> Set Your Location</h3>
        <p style="color:#6b7280;font-size:13px;margin:4px 0 0;">Click on the map or drag the pin to set your exact location.</p>
        <div id="map"></div>
        <button type="button" class="save-btn" onclick="saveLocation()" style="margin-top:0">
            <i class="fas fa-check"></i> Confirm Location
        </button>
        <button type="button" class="save-btn"
                onclick="closeLocationModal()"
                style="background:#6b7280;margin-top:8px;">
            Cancel
        </button>
    </div>
</div>

<!-- ════════ Delete Modal ════════ -->
<div class="modal" id="deleteModal">
    <div class="modal-content" style="max-width:420px;">
        <h3 style="color:#dc2626;">
            <i class="fas fa-exclamation-triangle"></i> Delete Establishment?
        </h3>
        <p style="color:#6b7280;font-size:14px;">
            This action is <strong>permanent</strong> and cannot be undone.
            Type <strong>DELETE</strong> below to confirm.
        </p>
        <input type="text" id="deleteConfirm" class="form-control" placeholder="Type DELETE">
        <form method="POST" action="{% url 'delete_establishment' %}" style="margin-top:14px;">
            {% csrf_token %}
            <button type="submit" class="danger-btn delete" id="deleteBtn"
                    disabled style="width:100%;margin-bottom:8px;">
                <i class="fas fa-trash-alt"></i> Delete Permanently
            </button>
            <button type="button" class="save-btn"
                    onclick="closeDeleteModal()"
                    style="background:#6b7280;">
                Cancel
            </button>
        </form>
    </div>
</div>

<!-- ════════ Deactivate Modal ════════ -->
<div class="modal" id="deactivateModal">
    <div class="modal-content" style="max-width:420px;">
        <h3 style="color:#f59e0b;">
            <i class="fas fa-pause-circle"></i> Deactivate Establishment?
        </h3>
        <p style="color:#6b7280;font-size:14px;">
            Your establishment will be temporarily hidden from customers.
            You can reactivate it at any time.
        </p>
        <form method="POST" action="{% url 'deactivate_establishment' %}" style="margin-top:14px;">
            {% csrf_token %}
            <button type="submit" class="danger-btn deactivate"
                    style="width:100%;margin-bottom:8px;">
                <i class="fas fa-ban"></i> Deactivate Now
            </button>
            <button type="button" class="save-btn"
                    onclick="closeDeactivateModal()"
                    style="background:#6b7280;">
                Cancel
            </button>
        </form>
    </div>
</div>


<!-- ════════════════ SCRIPTS ════════════════ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
/* ─────────────────── Map / Location ─────────────────── */
let map, marker;
const CVSU_LAT = {{ CVSU_LATITUDE|default:"14.1649" }};
const CVSU_LNG = {{ CVSU_LONGITUDE|default:"120.9881" }};

function openLocationModal() {
    document.getElementById('locationModal').classList.add('active');
    setTimeout(() => {
        if (!map) {
            const lat = parseFloat(document.getElementById('latitude').value) || CVSU_LAT;
            const lng = parseFloat(document.getElementById('longitude').value) || CVSU_LNG;
            map = L.map('map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([lat, lng], {draggable: true}).addTo(map);
            marker.on('dragend', () => {
                const p = marker.getLatLng();
                geocodeLocation(p.lat, p.lng);
            });
            map.on('click', (e) => {
                marker.setLatLng(e.latlng);
                geocodeLocation(e.latlng.lat, e.latlng.lng);
            });
        } else {
            map.invalidateSize();
        }
    }, 150);
}

function geocodeLocation(lat, lng) {
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(r => r.json())
        .then(d => {
            document.getElementById('address').value   = d.display_name;
            document.getElementById('latitude').value  = lat;
            document.getElementById('longitude').value = lng;
            const locStatus = document.getElementById('locationStatus');
            locStatus.className = 'loc-status set';
            locStatus.innerHTML = `<i class="fas fa-check-circle"></i> Location: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            // Update left panel live
            document.getElementById('display-address').textContent = d.display_name;
            document.getElementById('display-coords').textContent  = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        });
}

function saveLocation() { closeLocationModal(); }
function closeLocationModal() { document.getElementById('locationModal').classList.remove('active'); }

/* ─────────────── Image Upload ─────────────── */
function uploadImage() {
    const file = document.getElementById('imageInput').files[0];
    if (!file) return;
    // Preview instantly
    const reader = new FileReader();
    reader.onload = e => { document.getElementById('establishmentImage').src = e.target.result; };
    reader.readAsDataURL(file);
    document.getElementById('imageForm').submit();
}

/* ─────────────── Delete Modal ─────────────── */
function showDeleteModal()  { document.getElementById('deleteModal').classList.add('active'); }
function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    document.getElementById('deleteConfirm').value = '';
    document.getElementById('deleteBtn').disabled = true;
}
document.getElementById('deleteConfirm').addEventListener('input', function () {
    document.getElementById('deleteBtn').disabled = this.value !== 'DELETE';
});

/* ─────────────── Deactivate Modal ─────────────── */
function showDeactivateModal()  { document.getElementById('deactivateModal').classList.add('active'); }
function closeDeactivateModal() { document.getElementById('deactivateModal').classList.remove('active'); }

/* ─────────────── Save Indicator ─────────────── */
function showSaving() {
    const ind = document.getElementById('saveIndicator');
    ind.className = 'save-indicator visible';
    document.getElementById('saveSpinner').style.display = 'inline-block';
    document.getElementById('saveIcon').style.display    = 'none';
    document.getElementById('saveText').textContent      = 'Saving…';
}
function showSaveSuccess() {
    const ind = document.getElementById('saveIndicator');
    ind.className = 'save-indicator visible success';
    document.getElementById('saveSpinner').style.display = 'none';
    const icon = document.getElementById('saveIcon');
    icon.className = 'fas fa-check-circle';
    icon.style.display = 'inline-block';
    document.getElementById('saveText').textContent = 'Saved!';
    setTimeout(() => { ind.className = 'save-indicator'; }, 3000);
}
function showSaveError(msg) {
    const ind = document.getElementById('saveIndicator');
    ind.className = 'save-indicator visible error';
    document.getElementById('saveSpinner').style.display = 'none';
    const icon = document.getElementById('saveIcon');
    icon.className = 'fas fa-times-circle';
    icon.style.display = 'inline-block';
    document.getElementById('saveText').textContent = msg || 'Error saving';
    setTimeout(() => { ind.className = 'save-indicator'; }, 4000);
}

/* ─────────────── Live Left Panel Updates ─────────────── */
function formatTime12(val) {
    if (!val) return '—';
    const [h, m] = val.split(':');
    const hour = parseInt(h);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const h12  = hour % 12 || 12;
    return `${h12}:${m} ${ampm}`;
}

function liveUpdatePanel(data) {
    // Name
    if (data.name !== undefined)
        document.getElementById('display-name').textContent = data.name || '—';
    // Category
    const catSel = document.getElementById('category');
    const catOpt = catSel.options[catSel.selectedIndex];
    if (catOpt) document.getElementById('display-category').textContent = catOpt.text;
    // Hours
    const op = document.getElementById('opening_time').value;
    const cl = document.getElementById('closing_time').value;
    document.getElementById('display-opening').textContent = formatTime12(op);
    document.getElementById('display-closing').textContent = formatTime12(cl);
    // Address (already updated via geocode)
    // Amenities chips
    const checked = [...document.querySelectorAll('input[name="amenities"]:checked')];
    const amenDiv = document.getElementById('display-amenities');
    if (checked.length) {
        amenDiv.innerHTML = '<div class="chips">' +
            checked.map(cb => {
                const lbl = document.querySelector(`label[for="${cb.id}"]`);
                return `<span class="chip"><i class="fas fa-check"></i>${lbl ? lbl.textContent : cb.value}</span>`;
            }).join('') + '</div>';
    } else {
        amenDiv.innerHTML = '<span style="font-size:13px;color:#9ca3af;">None listed</span>';
    }
    // Payment chips
    const payments = [...document.querySelectorAll('input[name="payment_methods"]:checked')];
    const payDiv = document.getElementById('display-payments');
    const iconMap = { Cash: 'fa-money-bill', GCash: 'fa-mobile-alt' };
    if (payments.length) {
        payDiv.innerHTML = '<div class="chips">' +
            payments.map(cb => `<span class="chip payment"><i class="fas ${iconMap[cb.value]||'fa-credit-card'}"></i>${cb.value}</span>`).join('') +
            '</div>';
    } else {
        payDiv.innerHTML = '<span style="font-size:13px;color:#9ca3af;">None listed</span>';
    }
}

/* ─────────────── Real-time field listeners ─────────────── */
['name','category','opening_time','closing_time'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', () => liveUpdatePanel({}));
    if (el && el.tagName === 'INPUT') el.addEventListener('input', () => liveUpdatePanel({}));
});
document.querySelectorAll('input[name="amenities"], input[name="payment_methods"]').forEach(cb => {
    cb.addEventListener('change', () => liveUpdatePanel({}));
});

/* ─────────────── Form Submission (AJAX) ─────────────── */
document.getElementById('updateForm').addEventListener('submit', function (e) {
    e.preventDefault();
    showSaving();
    const formData = new FormData(this);
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showSaveSuccess();
            liveUpdatePanel(data);  // update panel with server values if returned
        } else {
            showSaveError(data.error || 'Could not save changes');
        }
    })
    .catch(err => {
        console.error(err);
        showSaveError('Network error');
    });
});

/* ─────────────── Close modals on backdrop click ─────────────── */
document.querySelectorAll('.modal').forEach(m => {
    m.addEventListener('click', function (e) {
        if (e.target === this) this.classList.remove('active');
    });
});
</script>

</body>
</html>